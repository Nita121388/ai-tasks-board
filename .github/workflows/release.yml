name: Release

on:
  push:
    tags:
      # Recommended (standalone): plain semver tags.
      - "v*"
      # Back-compat with the former demo-lab namespaced tags.
      - "ai-tasks-board-v*"
      - "ai-tasks-board/v*"

permissions:
  contents: write

jobs:
  meta:
    name: Parse Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Parse version from tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION=""
          if [[ "$TAG" =~ ^ai-tasks-board[-/]v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          elif [[ "$TAG" =~ ^v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Unsupported tag: $TAG" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  plugin:
    name: Build Obsidian Plugin
    needs: meta
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync versions (manifest/pyproject)
        run: python3 scripts/ai_tasks_board_bump_version.py "${{ needs.meta.outputs.version }}"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: obsidian-plugin/package-lock.json

      - name: Build Obsidian plugin
        working-directory: obsidian-plugin
        run: |
          npm ci
          npm test
          npm run build

      - name: Package plugin assets
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.meta.outputs.version }}"
          mkdir -p dist

          # Flat plugin zip (for manual install): contains main.js/manifest.json/styles.css/versions.json.
          zip -j "dist/ai-tasks-board-obsidian-plugin-${VERSION}.zip" \
            "obsidian-plugin/main.js" \
            "obsidian-plugin/manifest.json" \
            "obsidian-plugin/styles.css" \
            "obsidian-plugin/versions.json"

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-dist
          if-no-files-found: error
          path: |
            obsidian-plugin/main.js
            obsidian-plugin/manifest.json
            obsidian-plugin/styles.css
            obsidian-plugin/versions.json
            dist/ai-tasks-board-obsidian-plugin-${{ needs.meta.outputs.version }}.zip

  runtime-wheel:
    name: Build Runtime (wheel/sdist)
    needs: meta
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Sync versions (manifest/pyproject)
        run: python scripts/ai_tasks_board_bump_version.py "${{ needs.meta.outputs.version }}"

      - name: Build runtime (wheel/sdist)
        working-directory: runtime
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build

      - name: Upload runtime wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-wheel
          if-no-files-found: error
          path: runtime/dist/*

  runtime-binary:
    name: Build Runtime Binary (${{ matrix.platform }}-${{ matrix.arch }})
    needs: meta
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            exe: ai-tasks-runtime
            python_arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
            exe: ai-tasks-runtime.exe
            python_arch: x64
          - os: macos-14
            platform: darwin
            arch: arm64
            exe: ai-tasks-runtime
            python_arch: arm64
          - os: macos-14
            platform: darwin
            arch: x64
            exe: ai-tasks-runtime
            python_arch: x64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rosetta (macOS x64 build)
        if: runner.os == 'macOS' && matrix.python_arch == 'x64'
        run: /usr/sbin/softwareupdate --install-rosetta --agree-to-license

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: "${{ matrix.python_arch }}"

      - name: Sync versions (manifest/pyproject)
        run: python scripts/ai_tasks_board_bump_version.py "${{ needs.meta.outputs.version }}"

      - name: Build runtime binary (PyInstaller)
        working-directory: runtime
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -e .
          python -m pip install pyinstaller==6.4.0

          pyinstaller --noconfirm --clean --onefile \
            --name ai-tasks-runtime \
            --collect-submodules ai_tasks_runtime \
            pyinstaller_entrypoint.py

      - name: Upload runtime binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-bin-${{ matrix.platform }}-${{ matrix.arch }}
          if-no-files-found: error
          path: runtime/dist/${{ matrix.exe }}

  release:
    name: Create GitHub Release
    needs: [meta, plugin, runtime-wheel, runtime-binary]
    runs-on: ubuntu-latest
    steps:
      - name: Download plugin artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-dist
          path: plugin-dist

      - name: Download runtime wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: runtime-wheel
          path: runtime-wheel

      - name: Download runtime binaries
        uses: actions/download-artifact@v4
        with:
          pattern: runtime-bin-*
          path: runtime-bin
          merge-multiple: false

      - name: Package release assets
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.meta.outputs.version }}"

          mkdir -p dist

          # Copy plugin files.
          cp plugin-dist/obsidian-plugin/main.js dist/main.js
          cp plugin-dist/obsidian-plugin/manifest.json dist/manifest.json
          cp plugin-dist/obsidian-plugin/styles.css dist/styles.css
          cp plugin-dist/obsidian-plugin/versions.json dist/versions.json
          cp "plugin-dist/dist/ai-tasks-board-obsidian-plugin-${VERSION}.zip" dist/

          # Copy wheel/sdist.
          # NOTE: actions/upload-artifact strips the common path prefix when all
          # uploaded files share the same root (here: runtime/dist). As a result,
          # the downloaded artifact contains the wheel/sdist at the artifact root.
          cp runtime-wheel/* dist/

          # Helper: build runtime + bundle zips.
          build_bundle() {
            local platform="$1"
            local arch="$2"
            local exe="$3"
            local src="runtime-bin/runtime-bin-${platform}-${arch}/runtime/dist/${exe}"
            local runtime_zip="dist/ai-tasks-runtime-${VERSION}-${platform}-${arch}.zip"
            local bundle_zip="dist/ai-tasks-board-bundle-${VERSION}-${platform}-${arch}.zip"

            if [[ ! -f "$src" ]]; then
              echo "Missing runtime binary: $src" >&2
              exit 1
            fi

            zip -j "$runtime_zip" "$src"

            rm -rf bundle
            mkdir -p "bundle/ai-tasks-board/bin/${platform}-${arch}"
            cp dist/main.js dist/manifest.json dist/styles.css dist/versions.json bundle/ai-tasks-board/
            cp "$src" "bundle/ai-tasks-board/bin/${platform}-${arch}/${exe}"
            chmod +x "bundle/ai-tasks-board/bin/${platform}-${arch}/${exe}" 2>/dev/null || true
            (cd bundle && zip -r "../$bundle_zip" ai-tasks-board)
            rm -rf bundle
          }

          build_bundle linux x64 ai-tasks-runtime
          build_bundle win32 x64 ai-tasks-runtime.exe
          build_bundle darwin x64 ai-tasks-runtime
          build_bundle darwin arm64 ai-tasks-runtime

          # Checksums for everything we upload.
          (cd dist && sha256sum * > sha256sums.txt)

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "AI Tasks Board v${{ needs.meta.outputs.version }}"
          tag_name: "${{ needs.meta.outputs.tag }}"
          generate_release_notes: true
          files: |
            dist/*
