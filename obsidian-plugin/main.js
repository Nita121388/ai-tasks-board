/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var mt=Object.defineProperty;var Kt=Object.getOwnPropertyDescriptor;var jt=Object.getOwnPropertyNames;var qt=Object.prototype.hasOwnProperty;var Vt=(n,e)=>{for(var t in e)mt(n,t,{get:e[t],enumerable:!0})},Ht=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of jt(e))!qt.call(n,a)&&a!==t&&mt(n,a,{get:()=>e[a],enumerable:!(s=Kt(e,a))||s.enumerable});return n};var Wt=n=>Ht(mt({},"__esModule",{value:!0}),n);var Re={};Vt(Re,{default:()=>ht});module.exports=Wt(Re);var z=require("obsidian"),Mt=require("child_process"),V=require("fs"),Ot=require("os"),q=require("path");var T=require("obsidian"),kt={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",autoStartRuntime:!0,tagPresets:`work
\u5B66\u4E60
\u6548\u7387
\u8FD0\u7EF4
openclaw
obsidian
pixel`,boardLayout:"split",uiLanguage:"auto",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function ft(n,e){let t=Number(n);return Number.isFinite(t)?t:e}var dt=class extends T.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new T.Setting(e).setName(this.plugin.t("settings.ui_language.name")).setDesc(this.plugin.t("settings.ui_language.desc")).addDropdown(i=>{i.addOption("auto",this.plugin.t("settings.ui_language.opt.auto")),i.addOption("zh-CN",this.plugin.t("settings.ui_language.opt.zh")),i.addOption("en",this.plugin.t("settings.ui_language.opt.en")),i.setValue(this.plugin.settings.uiLanguage||"auto"),i.onChange(async r=>{this.plugin.settings.uiLanguage=r,await this.plugin.saveSettings(),this.plugin.requestOverlayRefresh(),this.display()})}),new T.Setting(e).setName(this.plugin.t("settings.board_path.name")).setDesc(this.plugin.t("settings.board_path.desc")).addText(i=>{i.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new T.Setting(e).setName(this.plugin.t("settings.render_board_in_note.name")).setDesc(this.plugin.t("settings.render_board_in_note.desc")).addToggle(i=>{i.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async r=>{this.plugin.settings.renderBoardInNote=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new T.Setting(e).setName(this.plugin.t("settings.board_layout.name")).setDesc(this.plugin.t("settings.board_layout.desc")).addDropdown(i=>{i.addOption("split",this.plugin.t("settings.board_layout.opt.split")),i.addOption("kanban",this.plugin.t("settings.board_layout.opt.kanban")),i.addOption("md",this.plugin.t("settings.board_layout.opt.md")),i.setValue(this.plugin.settings.boardLayout||"split"),i.onChange(async r=>{this.plugin.settings.boardLayout=r,await this.plugin.saveSettings(),this.plugin.requestOverlayRefresh()})}),new T.Setting(e).setName(this.plugin.t("settings.archive_folder.name")).setDesc(this.plugin.t("settings.archive_folder.desc")).addText(i=>{i.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.tag_presets.name")).setDesc(this.plugin.t("settings.tag_presets.desc")).addTextArea(i=>{i.setPlaceholder("work\\n\u5B66\u4E60\\n\u6548\u7387\\nopenclaw").setValue(this.plugin.settings.tagPresets||"").onChange(async r=>{this.plugin.settings.tagPresets=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.runtime_url.name")).setDesc(this.plugin.t("settings.runtime_url.desc")).addText(i=>{i.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.runtime_auto_start.name")).setDesc(this.plugin.t("settings.runtime_auto_start.desc")).addToggle(i=>{i.setValue(!!this.plugin.settings.autoStartRuntime).onChange(async r=>{this.plugin.settings.autoStartRuntime=r,await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.runtime_service.heading")});let s=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:this.plugin.t("settings.runtime.status.unchecked")}),a=async()=>{s.textContent=await this.plugin.refreshRuntimeStatus()};new T.Setting(e).setName(this.plugin.t("settings.runtime_control.name")).setDesc(this.plugin.t("settings.runtime_control.desc")).addButton(i=>{i.setButtonText(this.plugin.t("settings.runtime_control.btn.check")).onClick(async()=>{await a()})}).addButton(i=>{i.setButtonText(this.plugin.t("settings.runtime_control.btn.start")).onClick(async()=>{await this.plugin.startRuntime(),await a()})}).addButton(i=>{i.setButtonText(this.plugin.t("settings.runtime_control.btn.stop")).onClick(async()=>{await this.plugin.stopRuntime(),await a()})}),new T.Setting(e).setName(this.plugin.t("settings.runtime_command.name")).setDesc(this.plugin.t("settings.runtime_command.desc")).addText(i=>{i.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.runtime_args.name")).setDesc(this.plugin.t("settings.runtime_args.desc")).addText(i=>{i.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.runtime_cwd.name")).setDesc(this.plugin.t("settings.runtime_cwd.desc")).addText(i=>{i.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.model.heading")}),new T.Setting(e).setName(this.plugin.t("settings.model_provider.name")).setDesc(this.plugin.t("settings.model_provider.desc")).addDropdown(i=>{i.addOption("codex-cli",this.plugin.t("settings.model_provider.opt.codex")),i.addOption("openai-compatible",this.plugin.t("settings.model_provider.opt.openai")),i.setValue(this.plugin.settings.modelProvider),i.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_name.name")).setDesc(this.plugin.t("settings.model_name.desc")).addText(i=>{i.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_base_url.name")).setDesc(this.plugin.t("settings.model_base_url.desc")).addText(i=>{i.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_api_key.name")).setDesc(this.plugin.t("settings.model_api_key.desc")).addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_temperature.name")).setDesc(this.plugin.t("settings.model_temperature.desc")).addText(i=>{i.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=ft(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_top_p.name")).setDesc(this.plugin.t("settings.model_top_p.desc")).addText(i=>{i.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let o=ft(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,o)),await this.plugin.saveSettings()})}),new T.Setting(e).setName(this.plugin.t("settings.model_max_tokens.name")).setDesc(this.plugin.t("settings.model_max_tokens.desc")).addText(i=>{i.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let o=Math.max(0,Math.floor(ft(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=o,await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.diagnostics.heading")}),new T.Setting(e).setName(this.plugin.t("settings.diagnostics.test_ai.name")).setDesc(this.plugin.t("settings.diagnostics.test_ai.desc")).addButton(i=>{i.setButtonText(this.plugin.t("settings.diagnostics.test_ai.btn")).onClick(async()=>{await this.plugin.runTestAi()})}),new T.Setting(e).setName(this.plugin.t("settings.diagnostics.test_agent.name")).setDesc(this.plugin.t("settings.diagnostics.test_agent.desc")).addButton(i=>{i.setButtonText(this.plugin.t("settings.diagnostics.test_agent.btn")).onClick(async()=>{await this.plugin.runTestAgent()})}),a()}};var K=require("obsidian");var vt="<!-- AI-TASKS:BEGIN -->",yt="<!-- AI-TASKS:END -->",wt=["Unassigned","Todo","Doing","Review","Done"],xt=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function G(n){if(!n.includes("\\n")&&!n.includes("\\r\\n")&&!n.includes(`\r
`))return{next:n,changed:!1};let e=n;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==n}}function _t(n){let e=n.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function Gt(n){let e=n.split(`
`);for(let t of e){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function Jt(n){let e=n.split(`
`);for(let t of e){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(a=>a.trim()).filter(a=>a.length>0)}return[]}function Yt(n){var t;let e=n.split(`
`);for(let s of e){let a=s.match(/^>\s*status::\s*(.+)\s*$/i);if(a!=null&&a[1])return(t=_t(a[1]))!=null?t:null}return null}function Tt(n){let e=n.indexOf(vt),t=n.indexOf(yt);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${vt} / ${yt}).`);return{autoStart:e+vt.length,autoEnd:t}}function St(n,e,t){var l;let a=n.slice(e,t).split(`
`),i=e,r=[];for(let d of a){let p=d.trimStart();if(p.startsWith("## ")){let c=p.slice(3).trim(),g=_t(c);if(g){let b=i+d.indexOf("## "),f=i+d.length;r.push({status:g,start:b,end:f})}}i+=d.length+1}let o=new Map;for(let d=0;d<r.length;d++){let p=r[d];if(!p)continue;let c=r[d+1],g=p.end+1,b=c?c.start:t,f=n.slice(g,b),h=[];xt.lastIndex=0;let m;for(;m=xt.exec(f);){let u=m[1];if(!u)continue;let x=m.index,w=g+x,y=`<!-- AI-TASKS:TASK ${u} END -->`,k=f.indexOf(y,x);if(k===-1)continue;let D=g+k+y.length;for(;D<n.length&&n[D]===`
`;){D+=1,D<n.length&&n[D]===`
`&&(D+=1);break}let A=n.slice(w,D),H=(l=Yt(A))!=null?l:p.status,L=Gt(A),R=Jt(A);h.push({uuid:u,title:L,status:H,tags:R,rawBlock:A,start:w,end:D})}o.set(p.status,{status:p.status,headingStart:p.start,headingEnd:p.end,sectionStart:g,sectionEnd:b,tasks:h})}return o}function N(n){let{autoStart:e,autoEnd:t}=Tt(n),s=St(n,e,t);return{content:n,autoStart:e,autoEnd:t,sections:s}}function At(n){let{autoStart:e,autoEnd:t}=Tt(n),s=St(n,e,t),a=wt.filter(d=>!s.has(d));if(a.length===0)return n;let i=[];for(let d of wt)a.includes(d)&&i.push(`## ${d}`,"");let r=i.join(`
`);r.endsWith(`
`)||(r+=`
`);let o=n.slice(0,t),l=n.slice(t);return o.length>0&&!o.endsWith(`
`)&&(o+=`
`),o+r+l}function Zt(n,e){let t=n.split(`
`),s=!1,a=t.map(i=>i.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${e}`):i);if(!s)for(let i=0;i<a.length;i++){let r=a[i];if(r&&r.match(/^>\s*\[![^\]]+\]/)){a.splice(i+1,0,`> status:: ${e}`);break}}return a.join(`
`)}function Bt(n,e,t){let s=n.sections.get(e);if(!s)throw new Error(`Missing status section: ${e}`);if(t){for(let i of s.tasks)if(i.uuid===t)return i.start}let a=s.tasks.at(-1);return a?a.end:s.sectionStart}function Q(n,e,t,s){let a=At(n),i=N(a),r=null,o=null;for(let[x,w]of i.sections.entries()){for(let y of w.tasks)if(y.uuid===e){r=y,o=x;break}if(r)break}if(!r||!o)throw new Error(`Task not found: ${e}`);let l=s===e?null:s,d=r.rawBlock;o!==t&&(d=Zt(d,t));let p=a.slice(0,r.start)+a.slice(r.end),c=N(p),g=Bt(c,t,l),b=p.slice(0,g),f=p.slice(g),h=b.length>0&&!b.endsWith(`
`),m=!d.endsWith(`
`),u=(h?`
`:"")+d+(m?`
`:"");return p=b+u+f,p}function X(n,e,t,s){let a=At(n),i=N(a),r=Bt(i,e,t),o=a.slice(0,r),l=a.slice(r),d=o.length>0&&!o.endsWith(`
`),p=!s.endsWith(`
`),c=(d?`
`:"")+s+(p?`
`:"");return o+c+l}function ut(n,e,t){let s=N(n),a=null;for(let o of s.sections.values()){for(let l of o.tasks)if(l.uuid===e){a=l;break}if(a)break}if(!a)throw new Error(`Task not found: ${e}`);let i=!t.endsWith(`
`),r=t+(i?`
`:"");return n.slice(0,a.start)+r+n.slice(a.end)}function Dt(n,e){let t=N(n),s=null;for(let i of t.sections.values()){for(let r of i.tasks)if(r.uuid===e){s=r;break}if(s)break}if(!s)throw new Error(`Task not found: ${e}`);let a=n.slice(0,s.start)+n.slice(s.end);return{removed:s,next:a}}var It=require("obsidian");function Qt(){return new Date().toISOString().replace(/[:.]/g,"-")}function Xt(n,e){var r;let s=((r=n.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${e}.md`),a=n.lastIndexOf("/Boards/");return a!==-1?`${n.slice(0,a)}/History/Boards/${s}`:`${n.split("/").slice(0,-1).join("/")}/History/${s}`}function Pt(n,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),s=n.lastIndexOf("/Boards/");return s!==-1?`${n.slice(0,s)}/History/Logs/ai-tasks.${t}.jsonl`:`${n.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function O(n,e){let t=e.split("/").filter(a=>a.length>0),s="";for(let a of t)s=s?`${s}/${a}`:a,n.getAbstractFileByPath(s)||await n.createFolder(s)}async function U(n,e,t){let s=await n.read(e),a=Qt(),i=Xt(e.path,a),r=i.split("/").slice(0,-1).join("/");await O(n,r),await n.create(i,s),await n.modify(e,t)}async function Et(n,e,t){let s=e.split("/").slice(0,-1).join("/");s&&await O(n,s);let a=JSON.stringify(t)+`
`,i=n.getAbstractFileByPath(e);if(i instanceof It.TFile){let r=await n.read(i);await n.modify(i,r+a);return}await n.create(e,a)}async function B(n,e){let t=new Date().toISOString(),s=t.slice(0,10),a=Pt(n.settings.boardPath,s);await Et(n.app.vault,a,{ts:t,...e})}function bt(n){return n instanceof Error?n.message:String(n)}function zt(n,e,t){let s=bt(e),a={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${n}: ${s}`,a)}function te(n){let e=(n!=null?n:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ee(){let n=globalThis.crypto;return n!=null&&n.randomUUID?n.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function se(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function ie(n){let e=n.settings.boardPath,t=n.app.vault.getAbstractFileByPath(e);if(t instanceof K.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await O(n.app.vault,s),await n.app.vault.create(e,se())}function ne(n,e){return n.replace(/\/+$/g,"")+e}async function ae(n,e){let t=ne(n.settings.runtimeUrl,"/v1/board/propose"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function Lt(n){return n.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function re(n){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${n.uuid} BEGIN -->`),t.push(`> [!todo] ${n.title}`),t.push(`> status:: ${n.status}`),n.tags.length>0&&t.push(`> tags:: ${n.tags.join(", ")}`),t.push(`> created:: ${e}`),n.sourcePath&&t.push(`> source:: [[${n.sourcePath}]]`),t.push(">"),t.push(...Lt(n.body)),t.push(`<!-- AI-TASKS:TASK ${n.uuid} END -->`),t.join(`
`)+`
`}function oe(n,e){var d,p,c;let t=n.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),a=t.findIndex(g=>s.test(g.trim()));if(a===-1)throw new Error("Malformed task block (missing END marker).");let i=t.findIndex(g=>/^>\\s*\\[![^\\]]+\\]/.test(g));if(i!==-1){let g=(d=t[i])==null?void 0:d.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),b=(p=g==null?void 0:g[1])!=null?p:"[!todo]";t[i]=`> ${b} ${e.title}`}let r=t.findIndex(g=>/^>\\s*status::/i.test(g));if(r!==-1)t[r]=`> status:: ${e.status}`;else{let g=i!==-1?i+1:1;t.splice(g,0,`> status:: ${e.status}`),r=g}if(e.tags.length>0){let g=t.findIndex(b=>/^>\\s*tags::/i.test(b));g!==-1?t[g]=`> tags:: ${e.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${e.tags.join(", ")}`)}let o=new Date().toISOString(),l=[];return l.push(">"),l.push("> ---"),l.push(`> updated:: ${o}`),(c=e.instruction)!=null&&c.trim()&&l.push(`> instruction:: ${e.instruction.trim()}`),l.push(...Lt(e.body)),t.splice(a,0,...l),t.join(`
`)+`
`}var it=class extends K.Modal{constructor(t,s){var a;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?this.plugin.t("draft_modal.title.add"):this.plugin.t("draft_modal.title.update")});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.draft")});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.value=this.draft,a.addEventListener("input",()=>{this.draft=a.value});let i=t.createDiv({cls:"ai-tasks-instr-box"});i.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.instruction")});let r=i.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder=this.plugin.t("draft_modal.placeholder.instruction"),r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:this.plugin.t("draft_modal.btn.generate_preview")}),d=o.createEl("button",{text:this.plugin.t("draft_modal.btn.confirm_write")}),p=o.createEl("button",{text:this.plugin.t("btn.cancel")});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let c=t.createDiv({cls:"ai-tasks-draft-preview"}),g=c.createDiv({cls:"ai-tasks-draft-side"});g.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.before")}),this.beforeEl=g.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let b=c.createDiv({cls:"ai-tasks-draft-side"});b.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.after")}),this.afterEl=b.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,l.addEventListener("click",async()=>{await this.generate()}),d.addEventListener("click",async()=>{await this.apply()}),p.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,a,i,r,o,l,d,p,c,g,b,f,h,m,u,x,w;try{this.setStatus(this.plugin.t("draft_modal.status.generating")),this.boardFile=await ie(this.plugin);let y=await this.plugin.app.vault.read(this.boardFile),k=G(y);k.changed&&await U(this.plugin.app.vault,this.boardFile,k.next),this.boardContent=k.next;let S=N(this.boardContent),D=Array.from(S.sections.values()).flatMap(E=>E.tasks.map(I=>({uuid:I.uuid,title:I.title,status:I.status,tags:I.tags}))),A={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:D,ai_model:this.plugin.getModelConfig(),tag_presets:this.plugin.getTagPresets()};await B(this.plugin,{type:"board.propose.request",mode:A.mode,draft_len:A.draft.length,instruction_len:((t=A.instruction)!=null?t:"").length,tasks_count:A.tasks.length,tag_presets_count:(a=(s=A.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(i=A.ai_model)==null?void 0:i.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});try{this.proposal=await ae(this.plugin,A),await B(this.plugin,{type:"board.propose.response",engine:(o=this.proposal.engine)!=null?o:null,provider:(l=this.proposal.provider)!=null?l:null,thread_id:(d=this.proposal.thread_id)!=null?d:null,ai_fallback:(p=this.proposal.ai_fallback)!=null?p:null,action:this.proposal.action,target_uuid:(c=this.proposal.target_uuid)!=null?c:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(g=this.proposal.confidence)!=null?g:null,reasoning:(b=this.proposal.reasoning)!=null?b:null})}catch(E){let I=E instanceof Error?E.message:String(E);throw await B(this.plugin,{type:"board.propose.error",error:I}),E}let H=this.proposal.action,L=te(this.proposal.status);if(H==="update"&&this.proposal.target_uuid){let E=this.proposal.target_uuid,I=null;for(let[v,_]of S.sections.entries()){for(let P of _.tasks)if(P.uuid===E){I={rawBlock:P.rawBlock,sectionStatus:v};break}if(I)break}if(!I)this.proposal.action="create";else{this.beforeBlock=I.rawBlock,this.afterBlock=oe(this.beforeBlock,{uuid:E,title:this.proposal.title||"(Untitled)",status:L,tags:(f=this.proposal.tags)!=null?f:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let v=ut(this.boardContent,E,this.afterBlock);I.sectionStatus!==L&&(v=Q(v,E,L,null)),this.nextBoardContent=v}}if(this.proposal.action==="create"){let E=ee();this.beforeBlock="",this.afterBlock=re({uuid:E,title:this.proposal.title||"(Untitled)",status:L,tags:(h=this.proposal.tags)!=null?h:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let I=(w=(x=(u=(m=S.sections.get(L))==null?void 0:m.tasks)==null?void 0:u[0])==null?void 0:x.uuid)!=null?w:null;this.nextBoardContent=X(this.boardContent,L,I,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let R=[];this.proposal.engine&&R.push(`engine=${this.proposal.engine}`),this.proposal.thread_id&&R.push(`thread=${this.proposal.thread_id}`),this.proposal.ai_fallback&&R.push(`ai_fallback=${this.proposal.ai_fallback}`),this.proposal.reasoning&&R.push(this.proposal.reasoning),this.proposal.confidence!=null&&R.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(R.length?R.join(" | "):this.plugin.t("draft_modal.status.preview_ready"))}catch(y){let k=bt(y);zt("\u751F\u6210\u9884\u89C8\u5931\u8D25",y,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(this.plugin.t("draft_modal.status.failed",{error:k})),new K.Notice(this.plugin.t("draft_modal.notice.preview_failed",{error:k}))}}async apply(){var t,s,a,i,r,o;if(!this.boardFile){new K.Notice(this.plugin.t("draft_modal.notice.board_not_ready"));return}if(!this.nextBoardContent){new K.Notice(this.plugin.t("draft_modal.notice.generate_first"));return}try{await U(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await B(this.plugin,{type:"board.write",via:"draft_modal",action:(s=(t=this.proposal)==null?void 0:t.action)!=null?s:null,target_uuid:(i=(a=this.proposal)==null?void 0:a.target_uuid)!=null?i:null}),new K.Notice(this.plugin.t("draft_modal.notice.wrote_update")),this.close()}catch(l){let d=bt(l);zt("\u5199\u5165\u770B\u677F\u5931\u8D25",l,{boardPath:(o=(r=this.boardFile)==null?void 0:r.path)!=null?o:this.plugin.settings.boardPath}),new K.Notice(this.plugin.t("draft_modal.notice.write_failed",{error:d}))}}};var j=require("obsidian");var le=["Unassigned","Todo","Doing","Review","Done"];function Rt(n){let e=(n!=null?n:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function de(){let n=globalThis.crypto;return n!=null&&n.randomUUID?n.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ue(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function ce(n){let e=n.settings.boardPath,t=n.app.vault.getAbstractFileByPath(e);if(t instanceof j.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await O(n.app.vault,s),await n.app.vault.create(e,ue())}function ge(n,e){return n.replace(/\/+$/g,"")+e}async function pe(n,e){let t=ge(n.settings.runtimeUrl,"/v1/board/split"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function he(n){return n.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function Ct(n){let t=(n!=null?n:[]).filter(i=>typeof i=="string").flatMap(i=>i.split(/[,，]/g)).map(i=>i.trim()).filter(i=>i.length>0),s=new Set,a=[];for(let i of t){let r=i.toLowerCase();s.has(r)||(s.add(r),a.push(i))}return a}function me(n){let e=new Date().toISOString(),t=(n.title||"").trim()||"(Untitled)",s=[];return s.push(`<!-- AI-TASKS:TASK ${n.uuid} BEGIN -->`),s.push(`> [!todo] ${t}`),s.push(`> status:: ${n.status}`),n.tags.length>0&&s.push(`> tags:: ${n.tags.join(", ")}`),s.push(`> created:: ${e}`),n.sourcePath&&s.push(`> source:: [[${n.sourcePath}]]`),s.push(">"),n.body.trim().length>0?s.push(...he(n.body)):s.push(">"),s.push(`<!-- AI-TASKS:TASK ${n.uuid} END -->`),s.join(`
`)+`
`}var Z=class extends j.Modal{constructor(t,s){var a,i;super(t.app);this.instruction="";this.boardFile=null;this.tasks=[];this.proposalMeta=null;this.statusEl=null;this.listEl=null;this.plugin=t,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.text=(i=s.selection)!=null?i:""}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-bulk-import-modal"),t.createEl("h2",{text:this.plugin.t("bulk_modal.title")});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("bulk_modal.label.text")});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.placeholder=this.plugin.t("bulk_modal.placeholder.text"),a.value=this.text,a.addEventListener("input",()=>{this.text=a.value});let i=t.createDiv({cls:"ai-tasks-instr-box"});i.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("bulk_modal.label.instruction")});let r=i.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder=this.plugin.t("bulk_modal.placeholder.instruction"),r.value=this.instruction,r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:this.plugin.t("btn.generate"),cls:"mod-cta"}),d=o.createEl("button",{text:this.plugin.t("bulk_modal.btn.import_to_board")});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""}),this.listEl=t.createDiv({cls:"ai-tasks-bulk-list"}),l.addEventListener("click",()=>void this.generate()),d.addEventListener("click",()=>void this.apply())}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}renderList(){var t;if(this.listEl){if(this.listEl.empty(),!this.tasks.length){this.listEl.createDiv({cls:"ai-tasks-board-empty",text:this.plugin.t("bulk_modal.empty")});return}for(let s of this.tasks){let a=this.listEl.createDiv({cls:"ai-tasks-bulk-row"}),i=(s.title||"").trim()||"(Untitled)",r=Rt((t=s.status)!=null?t:"Unassigned"),o=Ct(s.tags);a.createDiv({cls:"ai-tasks-bulk-title",text:i}),a.createDiv({cls:"ai-tasks-bulk-meta",text:`${r}${o.length?" | "+o.join(", "):""}`})}}}async generate(){var t,s,a,i,r,o,l,d,p,c,g,b,f,h,m,u,x,w;try{this.setStatus(this.plugin.t("bulk_modal.status.generating")),this.boardFile=await ce(this.plugin);let y={text:this.text,instruction:this.instruction||null,tag_presets:this.plugin.getTagPresets(),max_tasks:60,ai_model:this.plugin.getModelConfig()};await B(this.plugin,{type:"board.split.request",text_len:y.text.length,instruction_len:((t=y.instruction)!=null?t:"").length,tag_presets_count:(a=(s=y.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(i=y.ai_model)==null?void 0:i.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});let k=await pe(this.plugin,y);this.tasks=Array.isArray(k.tasks)?k.tasks.slice(0,Math.max(1,(o=y.max_tasks)!=null?o:60)):[],this.proposalMeta={engine:(l=k.engine)!=null?l:null,provider:(d=k.provider)!=null?d:null,thread_id:(p=k.thread_id)!=null?p:null,ai_fallback:(c=k.ai_fallback)!=null?c:null,reasoning:(g=k.reasoning)!=null?g:null,confidence:(b=k.confidence)!=null?b:null},await B(this.plugin,{type:"board.split.response",engine:(f=k.engine)!=null?f:null,provider:(h=k.provider)!=null?h:null,thread_id:(m=k.thread_id)!=null?m:null,ai_fallback:(u=k.ai_fallback)!=null?u:null,tasks_count:this.tasks.length,confidence:(x=k.confidence)!=null?x:null,reasoning:(w=k.reasoning)!=null?w:null}),this.renderList();let S=[];k.engine&&S.push(`engine=${k.engine}`),k.thread_id&&S.push(`thread=${k.thread_id}`),k.ai_fallback&&S.push(`ai_fallback=${k.ai_fallback}`),k.confidence!=null&&S.push(`confidence=${k.confidence.toFixed(2)}`),k.reasoning&&S.push(k.reasoning),this.setStatus(S.length?S.join(" | "):this.plugin.t("bulk_modal.status.ready",{count:this.tasks.length}))}catch(y){let k=y instanceof Error?y.message:String(y);this.setStatus(this.plugin.t("bulk_modal.status.failed",{error:k})),new j.Notice(this.plugin.t("bulk_modal.notice.generate_failed",{error:k}))}}async apply(){var t,s,a,i,r,o,l,d,p,c,g,b,f;if(!this.boardFile){new j.Notice(this.plugin.t("bulk_modal.notice.board_not_ready"));return}if(!this.tasks.length){new j.Notice(this.plugin.t("bulk_modal.notice.generate_first"));return}try{let h=await this.plugin.app.vault.read(this.boardFile),m=G(h),u=m.next;m.changed&&(await U(this.plugin.app.vault,this.boardFile,m.next),await B(this.plugin,{type:"board.normalize_escaped_newlines"}));let x=N(u),w=new Map;for(let k of le){let S=(i=(a=(s=(t=x.sections.get(k))==null?void 0:t.tasks)==null?void 0:s[0])==null?void 0:a.uuid)!=null?i:null;w.set(k,S)}let y=[];for(let k of this.tasks){let S=(k.title||"").trim().slice(0,120)||"(Untitled)",D=Rt((r=k.status)!=null?r:"Unassigned"),A=Ct(k.tags),H=String((o=k.body)!=null?o:"").trim(),L=de(),R=me({uuid:L,title:S,status:D,tags:A,body:H,sourcePath:this.sourcePath});u=X(u,D,(l=w.get(D))!=null?l:null,R),y.push({uuid:L,title:S,status:D,tags:A})}await U(this.plugin.app.vault,this.boardFile,u),await B(this.plugin,{type:"board.bulk_import.write",via:"bulk_import_modal",tasks_count:y.length,engine:(p=(d=this.proposalMeta)==null?void 0:d.engine)!=null?p:null,provider:(g=(c=this.proposalMeta)==null?void 0:c.provider)!=null?g:null,thread_id:(f=(b=this.proposalMeta)==null?void 0:b.thread_id)!=null?f:null}),new j.Notice(this.plugin.t("bulk_modal.notice.imported",{count:y.length})),this.close()}catch(h){let m=h instanceof Error?h.message:String(h);new j.Notice(this.plugin.t("bulk_modal.notice.import_failed",{error:m}))}}};var Ut=require("obsidian");var et=require("obsidian");var nt=require("obsidian");var fe=["Unassigned","Todo","Doing","Review","Done"];function ke(){let n=globalThis.crypto;return n!=null&&n.randomUUID?n.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ve(n){let e=(n!=null?n:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function be(n){let e=n.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(r=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(r.trim()));if(t===-1)return"";let s=e.findIndex(r=>r.trim()===">");return s===-1||s>=t?"":e.slice(s+1,t).map(r=>{let o=r.match(/^>\s?(.*)$/);return o?o[1]:r}).join(`
`).replace(/\n$/,"")}function ye(n,e){var h,m;let t=n.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(u=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(u.trim()));if(s===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(u=>/^>\s*\[![^\]]+\]/.test(u));if(a!==-1){let u=(h=t[a])==null?void 0:h.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),x=(m=u==null?void 0:u[1])!=null?m:"[!todo]";t[a]=`> ${x} ${e.title||"(Untitled)"}`}let i=t.findIndex(u=>/^>\s*status::/i.test(u));if(i!==-1)t[i]=`> status:: ${e.status}`;else{let u=a!==-1?a+1:1;t.splice(u,0,`> status:: ${e.status}`),i=u}let r=t.findIndex(u=>/^>\s*tags::/i.test(u));if(e.tags.length>0){let u=`> tags:: ${e.tags.join(", ")}`;r!==-1?t[r]=u:t.splice(i+1,0,u)}else r!==-1&&t.splice(r,1);let o=t.findIndex(u=>/^>\s*updated::/i.test(u)),l=`> updated:: ${e.updatedAtIso}`;if(o!==-1)t[o]=l;else{let u=t.findIndex(w=>/^>\s*created::/i.test(w)),x=u!==-1?u+1:i+1;t.splice(x,0,l)}let d=t.findIndex(u=>u.trim()===">");(d===-1||d>=s)&&(d=s,t.splice(d,0,">"));let p=t.findIndex(u=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(u.trim()));if(p===-1)throw new Error("Malformed task block (missing END marker).");let c=[],g=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let u of g)u.trim()===""?c.push(">"):c.push(`> ${u}`);let b=t.slice(0,d+1),f=t.slice(p);return b.concat(c,f).join(`
`)+`
`}function we(n){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${n.uuid} BEGIN -->`),t.push(`> [!todo] ${n.title||"(Untitled)"}`),t.push(`> status:: ${n.status}`),n.tags.length>0&&t.push(`> tags:: ${n.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),n.sourcePath&&t.push(`> source:: [[${n.sourcePath}]]`),t.push(">");for(let s of(n.body||"").replace(/\r\n/g,`
`).split(`
`))s.trim()===""?t.push(">"):t.push(`> ${s}`);return t.push(`<!-- AI-TASKS:TASK ${n.uuid} END -->`),t.join(`
`)+`
`}var at=class extends nt.Modal{constructor(e,t){var s,a,i,r,o;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(s=t.task)!=null?s:null,this.defaultStatus=(r=t.defaultStatus)!=null?r:(i=(a=this.task)==null?void 0:a.status)!=null?i:"Unassigned",this.sourcePath=(o=t.sourcePath)!=null?o:null,this.onDidWrite=t.onDidWrite}onOpen(){var f,h,m,u,x,w;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?this.plugin.t("task_modal.title.edit"):this.plugin.t("task_modal.title.new")});let s=e.createDiv({cls:"ai-tasks-form-row"});s.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.title")});let a=s.createEl("input",{type:"text",cls:"ai-tasks-form-input"});a.value=(h=(f=this.task)==null?void 0:f.title)!=null?h:"";let i=e.createDiv({cls:"ai-tasks-form-row"});i.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.status")});let r=i.createEl("select",{cls:"ai-tasks-form-select"});for(let y of fe)r.add(new Option(y,y));r.value=(u=(m=this.task)==null?void 0:m.status)!=null?u:this.defaultStatus;let o=e.createDiv({cls:"ai-tasks-form-row"});o.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.tags")});let l=o.createEl("input",{type:"text",cls:"ai-tasks-form-input"});l.placeholder=this.plugin.t("task_modal.placeholder.tags"),l.value=((w=(x=this.task)==null?void 0:x.tags)!=null?w:[]).join(", ");let d=e.createDiv({cls:"ai-tasks-form-row"});d.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.body")});let p=d.createEl("textarea",{cls:"ai-tasks-form-textarea"});p.value=this.task?be(this.task.rawBlock):"";let c=e.createDiv({cls:"ai-tasks-form-buttons"}),g=c.createEl("button",{text:this.plugin.t("btn.save"),cls:"mod-cta"});c.createEl("button",{text:this.plugin.t("btn.cancel")}).addEventListener("click",()=>this.close()),g.addEventListener("click",()=>{this.save({title:a.value,status:ve(r.value),tagsRaw:l.value,body:p.value})})}async save(e){var t,s,a,i,r,o;try{let l=e.tagsRaw.split(/[,，]/).map(h=>h.trim()).filter(h=>h.length>0),d=await this.plugin.app.vault.read(this.boardFile),c=G(d).next,g=N(c),b=new Date().toISOString(),f=c;if(this.task){let h=null,m=null;for(let[x,w]of g.sections.entries()){for(let y of w.tasks)if(y.uuid===this.task.uuid){h=y,m=x;break}if(h)break}if(!h||!m)throw new Error(`Task not found: ${this.task.uuid}`);let u=ye(h.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:l,body:(t=e.body)!=null?t:"",updatedAtIso:b});f=ut(f,h.uuid,u),m!==e.status&&(f=Q(f,h.uuid,e.status,null)),await U(this.plugin.app.vault,this.boardFile,f),await B(this.plugin,{type:"task.edit",uuid:h.uuid,from_status:m,status:e.status})}else{let h=ke(),m=we({uuid:h,title:e.title||"(Untitled)",status:e.status,tags:l,body:(s=e.body)!=null?s:"",sourcePath:this.sourcePath}),u=(o=(r=(i=(a=g.sections.get(e.status))==null?void 0:a.tasks)==null?void 0:i[0])==null?void 0:r.uuid)!=null?o:null;f=X(f,e.status,u,m),await U(this.plugin.app.vault,this.boardFile,f),await B(this.plugin,{type:"task.create",uuid:h,status:e.status})}new nt.Notice(this.plugin.t("task_modal.notice.saved")),this.close(),this.onDidWrite()}catch(l){let d=l instanceof Error?l.message:String(l);new nt.Notice(this.plugin.t("task_modal.notice.save_failed",{error:d}))}}};var tt=["Unassigned","Todo","Doing","Review","Done"];function xe(){let n=new Date,e=String(n.getFullYear()),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}function _e(n,e){let t=(n||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function Te(n){return["---","schema: ai-tasks-archive/v1",`date: ${n}`,"---","",`# Archive ${n}`,"",""].join(`
`)}function Se(n,e){let t=n.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(l=>/^>\s*archived::/i.test(l));if(s!==-1)return t[s]=`> archived:: ${e}`,t.join(`
`)+`
`;let a=t.findIndex(l=>/^>\s*created::/i.test(l)),i=t.findIndex(l=>/^>\s*status::/i.test(l)),r=t.findIndex(l=>/^>\s*\[![^\]]+\]/.test(l)),o=a!==-1?a+1:i!==-1?i+1:r!==-1?r+1:1;return t.splice(o,0,`> archived:: ${e}`),t.join(`
`)+`
`}function Ae(n){return Array.from(new Set(n.flatMap(e=>e.tags))).sort()}function Be(n,e){let t=e.trim().toLowerCase();return t?n.title.toLowerCase().includes(t)||n.tags.some(s=>s.toLowerCase().includes(t)):!0}var ct=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.selectedUuid=null;this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=G(e);return t.changed&&(await U(this.plugin.app.vault,this.boardFile,t.next),new et.Notice(this.plugin.t("board.notice.fixed_escaped_newlines")),await B(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return Be(e,this.searchText)}renderHeader(e,t,s){let a=e.createDiv({cls:"ai-tasks-board-header"});a.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:this.plugin.t("board.title")});let r=a.createDiv({cls:"ai-tasks-board-controls"}),o=r.createEl("select",{cls:"ai-tasks-board-view-select"});if(o.add(new Option(this.plugin.t("board.view.kanban"),"kanban")),o.add(new Option(this.plugin.t("board.view.split"),"split")),o.add(new Option(this.plugin.t("board.view.md"),"md")),o.value=s,o.addEventListener("change",()=>{(async()=>{let f=o.value;this.plugin.settings.boardLayout=f,await this.plugin.saveSettings(),await this.render(e)})()}),r.createEl("button",{text:this.plugin.t("btn.import"),cls:"ai-tasks-board-import"}).addEventListener("click",()=>{new Z(this.plugin,{selection:"",sourcePath:this.boardFile.path}).open()}),s==="md")return;let d=r.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:this.plugin.t("board.search.placeholder")}});d.value=this.searchText,d.addEventListener("input",async()=>{this.searchText=d.value,await this.render(e)});let p=r.createEl("select",{cls:"ai-tasks-board-select"});p.add(new Option(this.plugin.t("board.status_filter.all"),"All"));for(let f of tt)p.add(new Option(f,f));p.value=this.statusFilter,p.addEventListener("change",async()=>{let f=p.value;this.statusFilter=f==="All"?"All":f,await this.render(e)});let c=r.createDiv({cls:"ai-tasks-board-tags"}),g=c.createDiv({cls:"ai-tasks-board-tags-title",text:this.plugin.t("board.tags.title")}),b=c.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)b.createDiv({cls:"ai-tasks-board-tags-empty",text:this.plugin.t("board.tags.empty")});else for(let f of t){let h=b.createEl("button",{cls:"ai-tasks-tag-chip",text:f});this.tagFilter.has(f)&&h.classList.add("is-active"),h.addEventListener("click",async m=>{m.preventDefault(),this.tagFilter.has(f)?this.tagFilter.delete(f):this.tagFilter.add(f),await this.render(e)})}g.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}extractBodyFromBlock(e){let t=e.replace(/\r\n/g,`
`).split(`
`),s=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+BEGIN\s*-->\s*$/i,a=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->\s*$/i,i=!1,r=[];for(let o of t){let l=o.trim();if(!s.test(l)){if(a.test(l))break;if(!i){l===">"&&(i=!0);continue}if(o.startsWith(">")){let d=o.slice(1);d.startsWith(" ")&&(d=d.slice(1)),r.push(d)}else r.push(o)}}if(r.length===0){for(let o of t)if(!(s.test(o.trim())||a.test(o.trim()))&&o.startsWith(">")){let l=o.slice(1);l.startsWith(" ")&&(l=l.slice(1)),r.push(l)}}return r.join(`
`).replace(/\n{3,}/g,`

`).trim()}createCard(e,t,s,a,i){let r=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});r.draggable=!0,r.addEventListener("click",c=>{var g,b;(b=(g=c.target)==null?void 0:g.closest)!=null&&b.call(g,"select, button, a, input, textarea")||i(t)});let o=r.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let l=o.createDiv({cls:"ai-task-actions"}),d=l.createEl("select",{cls:"ai-task-status"});for(let c of tt)d.add(new Option(c,c));if(d.value=t.status,d.addEventListener("click",c=>c.stopPropagation()),d.addEventListener("change",async c=>{c.stopPropagation(),await s(t.uuid,d.value,null)}),l.createEl("button",{cls:"ai-task-edit",text:this.plugin.t("btn.edit")}).addEventListener("click",c=>{c.stopPropagation(),i(t)}),t.status==="Done"&&l.createEl("button",{text:this.plugin.t("btn.archive"),cls:"ai-task-archive"}).addEventListener("click",async g=>{g.stopPropagation(),await a(t.uuid)}),t.tags.length>0){let c=r.createDiv({cls:"ai-task-tags"});for(let g of t.tags)c.createSpan({cls:"ai-task-tag",text:g})}return r.addEventListener("dragstart",c=>{var g,b;(g=c.dataTransfer)==null||g.setData("application/x-ai-task-uuid",t.uuid),(b=c.dataTransfer)==null||b.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(e,t,s){e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async a=>{var d,p,c;a.preventDefault(),e.classList.remove("is-drop-target");let i=(d=a.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid");if(!i)return;let r=a.target,o=(p=r==null?void 0:r.closest)==null?void 0:p.call(r,".ai-task-card"),l=(c=o==null?void 0:o.getAttribute("data-uuid"))!=null?c:null;await s(i,t,l)})}attachSplitDnD(e,t,s){e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async a=>{var d,p,c;a.preventDefault(),e.classList.remove("is-drop-target");let i=(d=a.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid");if(!i)return;let r=a.target,o=(p=r==null?void 0:r.closest)==null?void 0:p.call(r,".ai-tasks-split-task"),l=(c=o==null?void 0:o.getAttribute("data-uuid"))!=null?c:null;await s(i,t,l)})}async appendToArchive(e,t,s,a){let i=t.split("/").slice(0,-1).join("/");i&&await O(e,i);let r=e.getAbstractFileByPath(t);if(r instanceof et.TFile){let o=await e.read(r),l=o.endsWith(`
`)?`
`:`

`;await e.modify(r,o+l+s);return}await e.create(t,Te(a)+s)}async render(e){var A,H,L,R,E,I;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t=this.plugin.settings.boardLayout==="kanban"?"kanban":this.plugin.settings.boardLayout==="md"?"md":"split",s;try{s=await this.readBoardNormalized()}catch(v){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:v instanceof Error?v.message:this.plugin.t("board.md.read_failed")});return}if(t==="md"){this.renderHeader(e,[],t);let v=e.createDiv({cls:"ai-tasks-md-root"}),_=v.createDiv({cls:"ai-tasks-md-actions"}),P=_.createEl("button",{text:this.plugin.t("btn.reload")}),F=_.createEl("button",{text:this.plugin.t("btn.save"),cls:"mod-cta"}),$=v.createEl("textarea",{cls:"ai-tasks-md-textarea"});$.value=s,P.addEventListener("click",()=>void this.render(e)),F.addEventListener("click",()=>{(async()=>(await U(this.plugin.app.vault,this.boardFile,$.value.replace(/\r\n/g,`
`)),await B(this.plugin,{type:"board.write",via:"md_view"}),new et.Notice(this.plugin.t("board.md.saved_notice")),await this.render(e)))()});return}let a;try{a=N(s)}catch(v){this.renderHeader(e,[],t);let _=e.createDiv({cls:"ai-tasks-board-error"});_.createDiv({text:v instanceof Error?v.message:this.plugin.t("board.md.parse_failed")}),_.createDiv({text:this.plugin.t("board.md.tip_switch_md")});return}let i=Array.from(a.sections.values()).flatMap(v=>v.tasks),r=Ae(i);this.renderHeader(e,r,t);let o=async(v,_,P)=>{let F=await this.readBoardNormalized(),$=Q(F,v,_,P);await U(this.plugin.app.vault,this.boardFile,$),await B(this.plugin,{type:"task.move",uuid:v,status:_,before_uuid:P}),await this.render(e)},l=async v=>{if(!window.confirm(this.plugin.t("board.confirm.archive")))return;let _=await this.readBoardNormalized(),{removed:P,next:F}=Dt(_,v),$=xe(),J=_e(this.plugin.settings.archiveFolderPath,$),W=Se(P.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,J,W,$),await U(this.plugin.app.vault,this.boardFile,F),new et.Notice(this.plugin.t("board.notice.archived_to",{path:J})),await B(this.plugin,{type:"task.archive",uuid:v,archive_path:J}),await this.render(e)},d=v=>{new at(this.plugin,{boardFile:this.boardFile,task:v,onDidWrite:()=>{this.render(e)}}).open()},p=v=>{new at(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:v,onDidWrite:()=>{this.render(e)}}).open()};if(t==="kanban"){let v=e.createDiv({cls:"ai-tasks-board-columns"});for(let _ of tt){let P=v.createDiv({cls:"ai-tasks-column"}),F=P.createDiv({cls:"ai-tasks-column-head"});F.createDiv({cls:"ai-tasks-column-title",text:_}),F.createEl("button",{cls:"ai-tasks-column-add",text:this.plugin.t("board.btn.add")}).addEventListener("click",()=>p(_));let J=P.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(J,_,o);let W=a.sections.get(_),M=((A=W==null?void 0:W.tasks)!=null?A:[]).filter(C=>this.shouldShowTask(C));for(let C of M)this.createCard(J,C,o,l,d)}return}let c=e.createDiv({cls:"ai-tasks-board-split"}),g=c.createDiv({cls:"ai-tasks-board-split-left"}),b=c.createDiv({cls:"ai-tasks-board-split-right"}),f=new Map;for(let v of i)f.set(v.uuid,v);let h=[];for(let v of tt){let _=a.sections.get(v);h.push(...((H=_==null?void 0:_.tasks)!=null?H:[]).filter(P=>this.shouldShowTask(P)))}this.selectedUuid&&!f.has(this.selectedUuid)&&(this.selectedUuid=null),this.selectedUuid&&!h.some(v=>v.uuid===this.selectedUuid)&&(this.selectedUuid=null),!this.selectedUuid&&h.length>0&&(this.selectedUuid=(R=(L=h[0])==null?void 0:L.uuid)!=null?R:null);for(let v of tt){let _=a.sections.get(v),P=((E=_==null?void 0:_.tasks)!=null?E:[]).filter(M=>this.shouldShowTask(M)),F=g.createDiv({cls:"ai-tasks-split-section"}),$=F.createDiv({cls:"ai-tasks-split-section-head"});$.createDiv({cls:"ai-tasks-split-section-title",text:v}),$.createDiv({cls:"ai-tasks-split-section-count",text:String(P.length)}),$.createEl("button",{cls:"ai-tasks-split-add",text:this.plugin.t("board.btn.add")}).addEventListener("click",()=>p(v));let W=F.createDiv({cls:"ai-tasks-split-tasklist"});this.attachSplitDnD(W,v,o);for(let M of P){let C=W.createDiv({cls:"ai-tasks-split-task",attr:{"data-uuid":M.uuid}});M.uuid===this.selectedUuid&&C.classList.add("is-selected"),C.draggable=!0,C.createDiv({cls:"ai-tasks-split-task-title",text:M.title}),M.tags.length>0&&C.createDiv({cls:"ai-tasks-split-task-tags",text:M.tags.join(", ")}),C.addEventListener("click",async lt=>{var Y,st;(st=(Y=lt.target)==null?void 0:Y.closest)!=null&&st.call(Y,"select, button, a, input, textarea")||(this.selectedUuid=M.uuid,await this.render(e))}),C.addEventListener("dragstart",lt=>{var Y,st;(Y=lt.dataTransfer)==null||Y.setData("application/x-ai-task-uuid",M.uuid),(st=lt.dataTransfer)==null||st.setDragImage(C,8,8),C.classList.add("is-dragging")}),C.addEventListener("dragend",()=>{C.classList.remove("is-dragging")})}}let m=this.selectedUuid&&(I=f.get(this.selectedUuid))!=null?I:null;if(!m){b.createDiv({cls:"ai-tasks-detail-empty",text:this.plugin.t("board.task.select_to_view")});return}let u=b.createDiv({cls:"ai-tasks-detail"});u.createDiv({cls:"ai-tasks-detail-title",text:m.title}),u.createDiv({cls:"ai-tasks-detail-uuid",text:m.uuid});let x=u.createDiv({cls:"ai-tasks-detail-meta"}),w=x.createEl("select",{cls:"ai-tasks-detail-status"});for(let v of tt)w.add(new Option(v,v));if(w.value=m.status,w.addEventListener("change",async()=>{await o(m.uuid,w.value,null)}),x.createEl("button",{text:this.plugin.t("btn.edit"),cls:"ai-tasks-detail-edit"}).addEventListener("click",()=>d(m)),m.status==="Done"&&x.createEl("button",{text:this.plugin.t("btn.archive"),cls:"ai-tasks-detail-archive"}).addEventListener("click",async()=>{await l(m.uuid)}),m.tags.length>0){let v=u.createDiv({cls:"ai-tasks-detail-tags"});for(let _ of m.tags)v.createSpan({cls:"ai-task-tag",text:_})}let k=u.createDiv({cls:"ai-tasks-detail-body"}),S=this.extractBodyFromBlock(m.rawBlock),D=k.createEl("pre",{cls:"ai-tasks-detail-body-pre"});D.textContent=S||this.plugin.t("board.task.no_details")}};var gt=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let s of e){let a=s.view;if(!(a instanceof Ut.MarkdownView))continue;let i=a.file;if(!i){this.unmount(a);continue}let r=!!this.plugin.settings.renderBoardInNote,o=i.path===this.plugin.settings.boardPath;if(!r||!o){this.unmount(a);continue}t.add(a),await this.mount(a,i)}for(let s of Array.from(this.overlays.keys()))t.has(s)||this.unmount(s)}async mount(e,t){let s=this.overlays.get(e);if(s&&s.file.path===t.path)return;s&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let a=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),i=new ct(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:a,panel:i});try{await i.render(a)}catch(r){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};var rt=require("obsidian");async function De(n){var s,a;let e=(a=(s=globalThis.navigator)==null?void 0:s.clipboard)==null?void 0:a.writeText;if(e){await e(n);return}let t=document.createElement("textarea");t.value=n,t.setAttribute("readonly","true"),t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}var ot=class extends rt.Modal{constructor(e,t){super(e.app),this.plugin=e,this.result=t}onOpen(){let{contentEl:e}=this;e.empty();let t=this.result.kind==="agent"?"diagnostics.modal.title.agent":"diagnostics.modal.title.ai";e.createEl("h2",{text:this.plugin.t(t)});let s=e.createDiv({cls:"ai-tasks-diagnostics-summary"});s.createSpan({text:this.result.ok?this.plugin.t("diagnostics.modal.summary.ok"):this.plugin.t("diagnostics.modal.summary.fail")}),s.createSpan({text:" | "+this.plugin.t("diagnostics.modal.latency",{ms:this.result.latency_ms})}),typeof this.result.http_status=="number"&&s.createSpan({text:` | HTTP ${this.result.http_status}`}),s.createDiv({text:this.result.url,cls:"ai-tasks-diagnostics-url"}),this.result.error&&e.createDiv({cls:"ai-tasks-diagnostics-error"}).createDiv({text:String(this.result.error)});let a=e.createEl("pre",{cls:"ai-tasks-diagnostics-json"});a.textContent=JSON.stringify(this.result,null,2);let i=e.createDiv({cls:"ai-tasks-diagnostics-buttons"}),r=i.createEl("button",{text:this.plugin.t("btn.copy_json")}),o=i.createEl("button",{text:this.plugin.t("btn.close")});r.addEventListener("click",()=>{(async()=>{try{await De(a.textContent||""),new rt.Notice(this.plugin.t("notice.clipboard.copied"))}catch(l){let d=l instanceof Error?l.message:String(l);new rt.Notice(this.plugin.t("notice.clipboard.copy_failed",{error:d}))}})()}),o.addEventListener("click",()=>this.close())}};function Nt(n,e){return n==="en"?"en":n==="zh-CN"||(e||"").toLowerCase().startsWith("zh")?"zh-CN":"en"}function Ie(n,e){return e?n.replace(/\{\{([a-zA-Z0-9_]+)\}\}/g,(t,s)=>{let a=e[s];return a==null?"":String(a)}):n}var Pe={"cmd.open_board_note":{en:"AI Tasks: Open board note",zh:"AI Tasks\uFF1A\u6253\u5F00\u770B\u677F\u7B14\u8BB0"},"cmd.bulk_import":{en:"AI Tasks: Import tasks (AI)",zh:"AI Tasks\uFF1A\u5BFC\u5165\u4EFB\u52A1\uFF08AI\uFF09"},"menu.add_to_board":{en:"AI Tasks: Add to board",zh:"AI Tasks\uFF1A\u6DFB\u52A0\u5230\u770B\u677F"},"menu.update_board_ai":{en:"AI Tasks: Update board (AI)",zh:"AI Tasks\uFF1A\u66F4\u65B0\u770B\u677F\uFF08AI\uFF09"},"menu.import_selection_ai":{en:"AI Tasks: Import selection as tasks (AI)",zh:"AI Tasks\uFF1A\u5C06\u9009\u4E2D\u6587\u672C\u5BFC\u5165\u4E3A\u4EFB\u52A1\uFF08AI\uFF09"},"btn.cancel":{en:"Cancel",zh:"\u53D6\u6D88"},"btn.close":{en:"Close",zh:"\u5173\u95ED"},"btn.save":{en:"Save",zh:"\u4FDD\u5B58"},"btn.reload":{en:"Reload",zh:"\u91CD\u65B0\u52A0\u8F7D"},"btn.copy_json":{en:"Copy JSON",zh:"\u590D\u5236 JSON"},"btn.edit":{en:"Edit",zh:"\u7F16\u8F91"},"btn.archive":{en:"Archive",zh:"\u5F52\u6863"},"btn.import":{en:"Import",zh:"\u5BFC\u5165"},"btn.generate":{en:"Generate",zh:"\u751F\u6210"},"notice.runtime.already_running":{en:"AI Tasks: runtime already running.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u5DF2\u5728\u8FD0\u884C\u3002"},"notice.runtime.already_online":{en:"AI Tasks: runtime already online.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u5DF2\u5728\u7EBF\u3002"},"notice.runtime.command_empty":{en:"AI Tasks: runtime command is empty.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u542F\u52A8\u547D\u4EE4\u4E3A\u7A7A\u3002"},"notice.runtime.start_failed":{en:"AI Tasks: runtime start failed: {{error}}",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u542F\u52A8\u5931\u8D25\uFF1A{{error}}"},"notice.runtime.starting":{en:"AI Tasks: runtime starting.",zh:"AI Tasks\uFF1A\u6B63\u5728\u542F\u52A8\u8FD0\u884C\u65F6\u3002"},"notice.runtime.starting_pid":{en:"AI Tasks: runtime starting (pid {{pid}}).",zh:"AI Tasks\uFF1A\u6B63\u5728\u542F\u52A8\u8FD0\u884C\u65F6\uFF08pid {{pid}}\uFF09\u3002"},"notice.runtime.stop_requested":{en:"AI Tasks: runtime stop requested.",zh:"AI Tasks\uFF1A\u5DF2\u8BF7\u6C42\u505C\u6B62\u8FD0\u884C\u65F6\u3002"},"notice.runtime.not_running":{en:"AI Tasks: runtime not running.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u672A\u5728\u8FD0\u884C\u3002"},"notice.clipboard.copied":{en:"Copied to clipboard.",zh:"\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F\u3002"},"notice.clipboard.copy_failed":{en:"Copy failed: {{error}}",zh:"\u590D\u5236\u5931\u8D25\uFF1A{{error}}"},"settings.board_path.name":{en:"Board file path",zh:"\u770B\u677F\u6587\u4EF6\u8DEF\u5F84"},"settings.board_path.desc":{en:"Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).",zh:"Vault \u5185 Board.md \u7684\u8DEF\u5F84\uFF08\u4F8B\u5982 Tasks/Boards/Board.md\uFF09\u3002"},"settings.render_board_in_note.name":{en:"Render board in note",zh:"\u5728\u7B14\u8BB0\u533A\u57DF\u6E32\u67D3\u770B\u677F"},"settings.render_board_in_note.desc":{en:"Replace Board.md with a draggable visual board in the note area (editor + preview).",zh:"\u5728\u7B14\u8BB0\u533A\u57DF\uFF08\u7F16\u8F91 + \u9884\u89C8\uFF09\u7528\u53EF\u62D6\u62FD\u53EF\u89C6\u5316\u770B\u677F\u66FF\u6362 Board.md\u3002"},"settings.board_layout.name":{en:"Board layout",zh:"\u770B\u677F\u5E03\u5C40"},"settings.board_layout.desc":{en:"Default view for the in-note board UI.",zh:"\u7B14\u8BB0\u5185\u770B\u677F UI \u7684\u9ED8\u8BA4\u89C6\u56FE\u3002"},"settings.board_layout.opt.split":{en:"Split (list + detail)",zh:"\u62C6\u5206\uFF08\u5217\u8868 + \u8BE6\u60C5\uFF09"},"settings.board_layout.opt.kanban":{en:"Kanban (columns)",zh:"\u770B\u677F\uFF08\u5217\uFF09"},"settings.board_layout.opt.md":{en:"MD (raw editor)",zh:"MD\uFF08\u539F\u59CB\u7F16\u8F91\uFF09"},"settings.archive_folder.name":{en:"Archive folder path",zh:"\u5F52\u6863\u6587\u4EF6\u5939\u8DEF\u5F84"},"settings.archive_folder.desc":{en:"Folder for archived tasks (daily files), e.g. Archive.",zh:"\u5F52\u6863\u4EFB\u52A1\u7684\u6587\u4EF6\u5939\uFF08\u6309\u5929\u5199\u6587\u4EF6\uFF09\uFF0C\u4F8B\u5982 Archive\u3002"},"settings.tag_presets.name":{en:"Tag presets",zh:"\u6807\u7B7E\u9884\u8BBE"},"settings.tag_presets.desc":{en:"One tag per line. AI will prefer these tags when proposing/importing tasks.",zh:"\u6BCF\u884C\u4E00\u4E2A\u6807\u7B7E\u3002AI \u751F\u6210/\u5BFC\u5165\u4EFB\u52A1\u65F6\u4F1A\u4F18\u5148\u4F7F\u7528\u8FD9\u4E9B\u6807\u7B7E\u3002"},"settings.runtime_url.name":{en:"Runtime URL",zh:"\u8FD0\u884C\u65F6 URL"},"settings.runtime_url.desc":{en:"Local runtime base URL (Agno + FastAPI).",zh:"\u672C\u5730\u8FD0\u884C\u65F6\u57FA\u5730\u5740\uFF08Agno + FastAPI\uFF09\u3002"},"settings.runtime_auto_start.name":{en:"Auto-start runtime",zh:"\u81EA\u52A8\u542F\u52A8\u8FD0\u884C\u65F6"},"settings.runtime_auto_start.desc":{en:"Start the local runtime automatically when Obsidian starts.",zh:"\u6253\u5F00 Obsidian \u65F6\u81EA\u52A8\u542F\u52A8\u672C\u5730\u8FD0\u884C\u65F6\u3002"},"settings.ui_language.name":{en:"UI language",zh:"\u754C\u9762\u8BED\u8A00"},"settings.ui_language.desc":{en:"Auto follows Obsidian language. You can also override it.",zh:"\u81EA\u52A8\u8DDF\u968F Obsidian \u8BED\u8A00\uFF1B\u4E5F\u53EF\u4EE5\u624B\u52A8\u8986\u76D6\u3002"},"settings.ui_language.opt.auto":{en:"Auto",zh:"\u81EA\u52A8"},"settings.ui_language.opt.zh":{en:"Chinese (Simplified)",zh:"\u4E2D\u6587"},"settings.ui_language.opt.en":{en:"English",zh:"English"},"settings.runtime_service.heading":{en:"Runtime Service",zh:"\u8FD0\u884C\u65F6\u670D\u52A1"},"settings.runtime.status.unchecked":{en:"Status: unchecked",zh:"\u72B6\u6001\uFF1A\u672A\u68C0\u67E5"},"runtime.status.online":{en:"online",zh:"\u5728\u7EBF"},"runtime.status.offline":{en:"offline",zh:"\u79BB\u7EBF"},"runtime.status.uptime":{en:"uptime {{mins}}m",zh:"\u8FD0\u884C {{mins}}m"},"runtime.status.local_pid":{en:"local pid {{pid}}",zh:"\u672C\u5730 pid {{pid}}"},"settings.runtime_control.name":{en:"Runtime control",zh:"\u8FD0\u884C\u65F6\u63A7\u5236"},"settings.runtime_control.desc":{en:"Start/stop local ai-tasks-runtime and refresh status.",zh:"\u542F\u52A8/\u505C\u6B62\u672C\u5730 ai-tasks-runtime \u5E76\u5237\u65B0\u72B6\u6001\u3002"},"settings.runtime_control.btn.check":{en:"Check status",zh:"\u68C0\u67E5\u72B6\u6001"},"settings.runtime_control.btn.start":{en:"Start",zh:"\u542F\u52A8"},"settings.runtime_control.btn.stop":{en:"Stop",zh:"\u505C\u6B62"},"settings.runtime_command.name":{en:"Runtime start command",zh:"\u8FD0\u884C\u65F6\u542F\u52A8\u547D\u4EE4"},"settings.runtime_command.desc":{en:"Executable to start the runtime (e.g. ai-tasks-runtime).",zh:"\u542F\u52A8\u8FD0\u884C\u65F6\u7684\u53EF\u6267\u884C\u6587\u4EF6\uFF08\u4F8B\u5982 ai-tasks-runtime\uFF09\u3002"},"settings.runtime_args.name":{en:"Runtime args",zh:"\u8FD0\u884C\u65F6\u53C2\u6570"},"settings.runtime_args.desc":{en:"Arguments for runtime start (e.g. serve).",zh:"\u8FD0\u884C\u65F6\u542F\u52A8\u53C2\u6570\uFF08\u4F8B\u5982 serve\uFF09\u3002"},"settings.runtime_cwd.name":{en:"Runtime working directory",zh:"\u8FD0\u884C\u65F6\u5DE5\u4F5C\u76EE\u5F55"},"settings.runtime_cwd.desc":{en:"Optional working directory for the runtime process.",zh:"\u8FD0\u884C\u65F6\u8FDB\u7A0B\u7684\u53EF\u9009\u5DE5\u4F5C\u76EE\u5F55\u3002"},"settings.model.heading":{en:"Model Settings",zh:"\u6A21\u578B\u8BBE\u7F6E"},"settings.model_provider.name":{en:"Model provider",zh:"\u6A21\u578B\u63D0\u4F9B\u8005"},"settings.model_provider.desc":{en:"codex-cli (local) or OpenAI-compatible API.",zh:"codex-cli\uFF08\u672C\u5730\uFF09\u6216 OpenAI-compatible API\u3002"},"settings.model_provider.opt.codex":{en:"codex-cli (local)",zh:"codex-cli\uFF08\u672C\u5730\uFF09"},"settings.model_provider.opt.openai":{en:"OpenAI-compatible API",zh:"OpenAI-compatible API"},"settings.model_name.name":{en:"Model name",zh:"\u6A21\u578B\u540D\u79F0"},"settings.model_name.desc":{en:"Model identifier (for OpenAI-compatible providers).",zh:"\u6A21\u578B\u6807\u8BC6\uFF08\u7528\u4E8E OpenAI-compatible provider\uFF09\u3002"},"settings.model_base_url.name":{en:"API base URL",zh:"API base URL"},"settings.model_base_url.desc":{en:"Base URL for OpenAI-compatible API (e.g. https://api.openai.com).",zh:"OpenAI-compatible \u7684 base URL\uFF08\u4F8B\u5982 https://api.openai.com\uFF09\u3002"},"settings.model_api_key.name":{en:"API key",zh:"API key"},"settings.model_api_key.desc":{en:"API key for OpenAI-compatible providers (stored locally).",zh:"OpenAI-compatible \u7684 API key\uFF08\u4EC5\u4FDD\u5B58\u5728\u672C\u5730\uFF09\u3002"},"settings.model_temperature.name":{en:"Temperature",zh:"\u6E29\u5EA6"},"settings.model_temperature.desc":{en:"Sampling temperature (e.g. 0.2).",zh:"\u91C7\u6837\u6E29\u5EA6\uFF08\u4F8B\u5982 0.2\uFF09\u3002"},"settings.model_top_p.name":{en:"Top P",zh:"Top P"},"settings.model_top_p.desc":{en:"Nucleus sampling (0-1).",zh:"\u6838\u91C7\u6837\uFF080-1\uFF09\u3002"},"settings.model_max_tokens.name":{en:"Max tokens",zh:"\u6700\u5927 tokens"},"settings.model_max_tokens.desc":{en:"Max output tokens (OpenAI-compatible).",zh:"\u6700\u5927\u8F93\u51FA tokens\uFF08OpenAI-compatible\uFF09\u3002"},"settings.diagnostics.heading":{en:"Diagnostics",zh:"\u8BCA\u65AD"},"settings.diagnostics.test_ai.name":{en:"Test AI",zh:"\u6D4B\u8BD5 AI"},"settings.diagnostics.test_ai.desc":{en:"Send a safe dry-run request to verify AI configuration (no writes).",zh:"\u53D1\u8D77\u4E00\u6B21\u5B89\u5168\u7684\u6D4B\u8BD5\u8BF7\u6C42\uFF0C\u7528\u4E8E\u9A8C\u8BC1 AI \u914D\u7F6E\u4E0E\u8FDE\u901A\u6027\uFF08\u4E0D\u4F1A\u5199\u5165/\u4FEE\u6539\u4EFB\u4F55\u6587\u4EF6\uFF09\u3002"},"settings.diagnostics.test_ai.btn":{en:"Run",zh:"\u8FD0\u884C"},"settings.diagnostics.test_agent.name":{en:"Test Agent",zh:"\u6D4B\u8BD5 Agent"},"settings.diagnostics.test_agent.desc":{en:"Call the Agent pipeline to verify agent/tooling is working (no writes).",zh:"\u8C03\u7528 Agent \u7BA1\u7EBF\uFF0C\u7528\u4E8E\u9A8C\u8BC1 agent/tooling \u662F\u5426\u53EF\u7528\uFF08\u4E0D\u4F1A\u5199\u5165/\u4FEE\u6539\u4EFB\u4F55\u6587\u4EF6\uFF09\u3002"},"settings.diagnostics.test_agent.btn":{en:"Run",zh:"\u8FD0\u884C"},"diagnostics.modal.title.ai":{en:"AI Tasks: Test AI result",zh:"AI Tasks\uFF1A\u6D4B\u8BD5 AI \u7ED3\u679C"},"diagnostics.modal.title.agent":{en:"AI Tasks: Test Agent result",zh:"AI Tasks\uFF1A\u6D4B\u8BD5 Agent \u7ED3\u679C"},"diagnostics.modal.summary.ok":{en:"OK",zh:"\u6210\u529F"},"diagnostics.modal.summary.fail":{en:"FAILED",zh:"\u5931\u8D25"},"diagnostics.modal.latency":{en:"Latency: {{ms}} ms",zh:"\u8017\u65F6\uFF1A{{ms}} ms"},"board.title":{en:"AI Tasks Board",zh:"AI Tasks Board"},"board.view.kanban":{en:"Kanban",zh:"\u770B\u677F"},"board.view.split":{en:"Kan Detail",zh:"\u8BE6\u60C5"},"board.view.md":{en:"MD",zh:"MD"},"board.search.placeholder":{en:"Search title/tags...",zh:"\u641C\u7D22\u6807\u9898/\u6807\u7B7E..."},"board.status_filter.all":{en:"All statuses",zh:"\u5168\u90E8\u72B6\u6001"},"board.tags.title":{en:"Tags",zh:"\u6807\u7B7E"},"board.tags.empty":{en:"(none)",zh:"\uFF08\u65E0\uFF09"},"board.md.saved_notice":{en:"AI Tasks: saved Board.md (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u4FDD\u5B58 Board.md\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"board.md.read_failed":{en:"Failed to read Board.md.",zh:"\u8BFB\u53D6 Board.md \u5931\u8D25\u3002"},"board.md.parse_failed":{en:"Failed to parse Board.md (unknown error).",zh:"\u89E3\u6790 Board.md \u5931\u8D25\uFF08\u672A\u77E5\u9519\u8BEF\uFF09\u3002"},"board.md.tip_switch_md":{en:"Tip: switch view to MD to edit/fix the file.",zh:"\u63D0\u793A\uFF1A\u5207\u6362\u5230 MD \u89C6\u56FE\u7F16\u8F91/\u4FEE\u590D\u6587\u4EF6\u3002"},"board.task.select_to_view":{en:"Select a task to view details.",zh:"\u9009\u62E9\u4E00\u4E2A\u4EFB\u52A1\u67E5\u770B\u8BE6\u60C5\u3002"},"board.task.no_details":{en:"(no details)",zh:"\uFF08\u65E0\u8BE6\u60C5\uFF09"},"board.confirm.archive":{en:"Archive this task?",zh:"\u5F52\u6863\u8FD9\u4E2A\u4EFB\u52A1\uFF1F"},"board.notice.archived_to":{en:"Archived task to {{path}}",zh:"\u5DF2\u5F52\u6863\u5230 {{path}}"},"board.notice.fixed_escaped_newlines":{en:"AI Tasks: fixed escaped newlines in Board.md.",zh:"AI Tasks\uFF1A\u5DF2\u4FEE\u590D Board.md \u4E2D\u7684\u8F6C\u4E49\u6362\u884C\u3002"},"board.btn.add":{en:"+ Add",zh:"+ \u65B0\u5EFA"},"draft_modal.title.add":{en:"AI Tasks: Add to board",zh:"AI Tasks\uFF1A\u6DFB\u52A0\u5230\u770B\u677F"},"draft_modal.title.update":{en:"AI Tasks: Update board",zh:"AI Tasks\uFF1A\u66F4\u65B0\u770B\u677F"},"draft_modal.label.draft":{en:"Draft (editable)",zh:"Draft\uFF08\u53EF\u7F16\u8F91\uFF09"},"draft_modal.label.instruction":{en:"Extra instruction (optional)",zh:"\u989D\u5916\u6307\u4EE4\uFF08\u53EF\u9009\uFF09"},"draft_modal.placeholder.instruction":{en:"e.g. set status=Todo, add tag=release, update existing task if it matches...",zh:"\u4F8B\u5982\uFF1A\u8BBE\u7F6E status=Todo\uFF0C\u6DFB\u52A0 tag=release\uFF1B\u5982\u679C\u5339\u914D\u5219\u66F4\u65B0\u5DF2\u6709\u4EFB\u52A1\u2026\u2026"},"draft_modal.btn.generate_preview":{en:"Generate preview",zh:"\u751F\u6210\u9884\u89C8"},"draft_modal.btn.confirm_write":{en:"Confirm & write",zh:"\u786E\u8BA4\u5E76\u5199\u5165"},"draft_modal.label.before":{en:"Before",zh:"\u5199\u5165\u524D"},"draft_modal.label.after":{en:"After",zh:"\u5199\u5165\u540E"},"draft_modal.status.generating":{en:"Generating preview...",zh:"\u6B63\u5728\u751F\u6210\u9884\u89C8..."},"draft_modal.status.preview_ready":{en:"Preview ready.",zh:"\u9884\u89C8\u5DF2\u5C31\u7EEA\u3002"},"draft_modal.status.failed":{en:"Failed: {{error}}",zh:"\u5931\u8D25\uFF1A{{error}}"},"draft_modal.notice.preview_failed":{en:"AI Tasks: preview failed: {{error}} (see console)",zh:"AI Tasks\uFF1A\u9884\u89C8\u5931\u8D25\uFF1A{{error}}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09"},"draft_modal.notice.board_not_ready":{en:"AI Tasks: board file not ready.",zh:"AI Tasks\uFF1A\u770B\u677F\u6587\u4EF6\u672A\u5C31\u7EEA\u3002"},"draft_modal.notice.generate_first":{en:"AI Tasks: please generate preview first.",zh:"AI Tasks\uFF1A\u8BF7\u5148\u751F\u6210\u9884\u89C8\u3002"},"draft_modal.notice.wrote_update":{en:"AI Tasks: wrote board update (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u5199\u5165\u770B\u677F\u66F4\u65B0\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"draft_modal.notice.write_failed":{en:"AI Tasks: write failed: {{error}} (see console)",zh:"AI Tasks\uFF1A\u5199\u5165\u5931\u8D25\uFF1A{{error}}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09"},"bulk_modal.title":{en:"AI Tasks: Import tasks",zh:"AI Tasks\uFF1A\u5BFC\u5165\u4EFB\u52A1"},"bulk_modal.label.text":{en:"Text to split into tasks (editable)",zh:"\u5F85\u62C6\u5206\u4E3A\u4EFB\u52A1\u7684\u6587\u672C\uFF08\u53EF\u7F16\u8F91\uFF09"},"bulk_modal.placeholder.text":{en:"Paste a task list here...",zh:"\u5728\u8FD9\u91CC\u7C98\u8D34\u4EFB\u52A1\u5217\u8868..."},"bulk_modal.label.instruction":{en:"Extra instruction (optional)",zh:"\u989D\u5916\u6307\u4EE4\uFF08\u53EF\u9009\uFF09"},"bulk_modal.placeholder.instruction":{en:"e.g. Use tags from presets; keep titles short; group by category...",zh:"\u4F8B\u5982\uFF1A\u4F18\u5148\u4F7F\u7528\u6807\u7B7E\u9884\u8BBE\uFF1B\u6807\u9898\u5C3D\u91CF\u77ED\uFF1B\u6309\u7C7B\u522B\u5206\u7EC4\u2026\u2026"},"bulk_modal.btn.import_to_board":{en:"Import to board",zh:"\u5BFC\u5165\u5230\u770B\u677F"},"bulk_modal.empty":{en:"(no tasks yet)",zh:"\uFF08\u8FD8\u6CA1\u6709\u4EFB\u52A1\uFF09"},"bulk_modal.status.generating":{en:"Generating...",zh:"\u6B63\u5728\u751F\u6210..."},"bulk_modal.status.ready":{en:"Ready ({{count}} tasks).",zh:"\u5C31\u7EEA\uFF08{{count}} \u4E2A\u4EFB\u52A1\uFF09\u3002"},"bulk_modal.status.failed":{en:"Failed: {{error}}",zh:"\u5931\u8D25\uFF1A{{error}}"},"bulk_modal.notice.generate_failed":{en:"AI Tasks: generate failed: {{error}}",zh:"AI Tasks\uFF1A\u751F\u6210\u5931\u8D25\uFF1A{{error}}"},"bulk_modal.notice.board_not_ready":{en:"AI Tasks: board file not ready.",zh:"AI Tasks\uFF1A\u770B\u677F\u6587\u4EF6\u672A\u5C31\u7EEA\u3002"},"bulk_modal.notice.generate_first":{en:"AI Tasks: please generate tasks first.",zh:"AI Tasks\uFF1A\u8BF7\u5148\u751F\u6210\u4EFB\u52A1\u3002"},"bulk_modal.notice.imported":{en:"AI Tasks: imported {{count}} tasks (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u5BFC\u5165 {{count}} \u4E2A\u4EFB\u52A1\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"bulk_modal.notice.import_failed":{en:"AI Tasks: import failed: {{error}}",zh:"AI Tasks\uFF1A\u5BFC\u5165\u5931\u8D25\uFF1A{{error}}"},"task_modal.title.edit":{en:"Edit task",zh:"\u7F16\u8F91\u4EFB\u52A1"},"task_modal.title.new":{en:"New task",zh:"\u65B0\u5EFA\u4EFB\u52A1"},"task_modal.label.title":{en:"Title",zh:"\u6807\u9898"},"task_modal.label.status":{en:"Status",zh:"\u72B6\u6001"},"task_modal.label.tags":{en:"Tags (comma separated)",zh:"\u6807\u7B7E\uFF08\u9017\u53F7\u5206\u9694\uFF09"},"task_modal.placeholder.tags":{en:"e.g. release, bug, v1",zh:"\u4F8B\u5982\uFF1Arelease, bug, v1"},"task_modal.label.body":{en:"Body",zh:"\u5185\u5BB9"},"task_modal.notice.saved":{en:"AI Tasks: saved.",zh:"AI Tasks\uFF1A\u5DF2\u4FDD\u5B58\u3002"},"task_modal.notice.save_failed":{en:"AI Tasks: save failed: {{error}}",zh:"AI Tasks\uFF1A\u4FDD\u5B58\u5931\u8D25\uFF1A{{error}}"}};function $t(n,e,t){let s=Pe[n],a=e==="zh-CN"?s.zh:s.en;return Ie(a,t)}function pt(n,e){return n.replace(/\/+$/g,"")+e}function Ee(n){var a,i;if(!n)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,s;for(;(s=t.exec(n))!==null;){let r=(i=(a=s[1])!=null?a:s[2])!=null?i:s[3];r&&e.push(r)}return e}function ze(n){let e=(n||"").trim();if(!e)return null;try{let t=new URL(e),s=t.hostname||"127.0.0.1",a=t.port?Number(t.port):17890;return!Number.isFinite(a)||a<=0?null:{host:s,port:a}}catch(t){return null}}function Ft(n,e){let t=e.toLowerCase();for(let s=0;s<n.length;s++){let a=(n[s]||"").toLowerCase();if(a===t||a.startsWith(t+"="))return!0}return!1}function Le(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var ht=class extends z.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.boardOverlay=null;this.autoStartPromise=null}getObsidianLanguageCode(){var t;try{return((t=z.getLanguage)==null?void 0:t())||"en"}catch(s){return"en"}}getResolvedLanguage(){var t;return Nt((t=this.settings)==null?void 0:t.uiLanguage,this.getObsidianLanguageCode())}t(t,s){return $t(t,this.getResolvedLanguage(),s)}getPluginDir(){var a;let t=this.app.vault.adapter,s=(a=t==null?void 0:t.getBasePath)==null?void 0:a.call(t);return s?(0,q.join)(s,this.app.vault.configDir,"plugins","ai-tasks-board"):null}getDefaultAgentDir(){try{return(0,q.join)((0,Ot.homedir)(),".ai-tasks-board","agent")}catch(t){return null}}getBundledRuntimeCommand(){let t=this.getPluginDir();if(!t)return null;let s=process.platform==="win32"?"ai-tasks-runtime.exe":"ai-tasks-runtime",a=[(0,q.join)(t,"bin",`${process.platform}-${process.arch}`,s),(0,q.join)(t,"bin",process.platform,process.arch,s),(0,q.join)(t,"bin",process.platform,s),(0,q.join)(t,"bin",s)];for(let i of a)if((0,V.existsSync)(i))return i;return null}async autoStartRuntimeIfNeeded(){this.settings.autoStartRuntime&&(this.autoStartPromise||(this.autoStartPromise=(async()=>{let t=await this.fetchRuntimeStatus();t!=null&&t.ok||await this.startRuntime()})().finally(()=>{this.autoStartPromise=null}),await this.autoStartPromise))}async onload(){await this.loadSettings(),this.boardOverlay=new gt(this),this.addCommand({id:"open-ai-tasks-board-note",name:this.t("cmd.open_board_note"),callback:async()=>{let t=this.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);if(s instanceof z.TFile){await this.app.workspace.getLeaf().openFile(s);return}let a=t.split("/").slice(0,-1).join("/");a&&await O(this.app.vault,a);let i=await this.app.vault.create(t,Le());await this.app.workspace.getLeaf().openFile(i)}}),this.addCommand({id:"bulk-import-ai-tasks",name:this.t("cmd.bulk_import"),callback:()=>{var s,a;let t=(a=(s=this.app.workspace.getActiveFile())==null?void 0:s.path)!=null?a:null;new Z(this,{selection:"",sourcePath:t}).open()}}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var s;t.path===this.settings.boardPath&&((s=this.boardOverlay)==null||s.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,a)=>{let i=s.getSelection();!i||i.trim().length===0||(t.addItem(r=>{r.setTitle(this.t("menu.add_to_board")).setIcon("plus").onClick(()=>{var o;new it(this,{mode:"create",selection:i,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle(this.t("menu.update_board_ai")).setIcon("wand-2").onClick(()=>{var o;new it(this,{mode:"auto",selection:i,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle(this.t("menu.import_selection_ai")).setIcon("list-plus").onClick(()=>{var o;new Z(this,{selection:i,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}))})),this.addSettingTab(new dt(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.autoStartRuntimeIfNeeded()})}onunload(){var t;if((t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null,this.runtimeProcess&&this.runtimeProcess.exitCode===null)try{this.runtimeProcess.kill()}catch(s){}this.runtimeProcess=null,this.runtimePid=null}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}requestOverlayRefresh(){var t;(t=this.boardOverlay)==null||t.requestRefresh()}async loadSettings(){this.settings=Object.assign({},kt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var s,a,i;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((s=this.settings.modelName)==null?void 0:s.trim())||void 0,base_url:((a=this.settings.modelBaseUrl)==null?void 0:a.trim())||void 0,api_key:((i=this.settings.modelApiKey)==null?void 0:i.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}getTagPresets(){let s=(this.settings.tagPresets||"").replace(/\r\n/g,`
`).split(/\n|[,，]/g).map(r=>r.trim()).filter(r=>r.length>0),a=new Set,i=[];for(let r of s){let o=r.toLowerCase();a.has(o)||(a.add(o),i.push(r))}return i}async startRuntime(){var g,b,f;let t=await this.fetchRuntimeStatus();if(t!=null&&t.ok){new z.Notice(this.t("notice.runtime.already_online"));return}if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new z.Notice(this.t("notice.runtime.already_running"));return}let s=this.getBundledRuntimeCommand(),a=this.settings.runtimeCommand.trim()===kt.runtimeCommand,i=this.settings.runtimeCommand.trim();if((!i||a)&&s&&(i=s,process.platform!=="win32"))try{(0,V.chmodSync)(i,493)}catch(h){}if(!i){new z.Notice(this.t("notice.runtime.command_empty"));return}let r=Ee(this.settings.runtimeArgs||""),o=ze(this.settings.runtimeUrl);r.length>0&&r[0]==="serve"&&o&&(Ft(r,"--host")||r.push("--host",o.host),Ft(r,"--port")||r.push("--port",String(o.port)));let l=this.getPluginDir(),d=this.settings.runtimeCwd.trim()||i===s&&l||void 0,p={...process.env};o&&(p.AI_TASKS_HOST=o.host,p.AI_TASKS_PORT=String(o.port));let c=this.getDefaultAgentDir();c&&(p.AI_TASKS_AGENT_DIR=c);try{let h=(0,Mt.spawn)(i,r,{cwd:d,windowsHide:!0,shell:!1,env:p});this.runtimeProcess=h,this.runtimePid=(g=h.pid)!=null?g:null;let m=this.getPluginDir();if(m)try{(0,V.mkdirSync)(m,{recursive:!0});let u=(0,q.join)(m,"runtime.stdout.log"),x=(0,q.join)(m,"runtime.stderr.log");(b=h.stdout)==null||b.on("data",w=>{(0,V.appendFileSync)(u,w.toString())}),(f=h.stderr)==null||f.on("data",w=>{(0,V.appendFileSync)(x,w.toString())}),console.info(`[ai-tasks-board] runtime logs: ${u} / ${x}`)}catch(u){console.error("[ai-tasks-board] failed to init runtime log files",u)}h.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),h.on("error",u=>{new z.Notice(this.t("notice.runtime.start_failed",{error:u.message}))}),new z.Notice(h.pid?this.t("notice.runtime.starting_pid",{pid:h.pid}):this.t("notice.runtime.starting"))}catch(h){let m=h instanceof Error?h.message:String(h);new z.Notice(this.t("notice.runtime.start_failed",{error:m}))}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new z.Notice(this.t("notice.runtime.stop_requested")):new z.Notice(this.t("notice.runtime.not_running"))}async runTestAi(){let t=pt(this.settings.runtimeUrl,"/v1/board/propose"),s={mode:"create",draft:this.getResolvedLanguage()==="zh-CN"?"\u8FD9\u662F\u4E00\u4E2A\u8BCA\u65AD\u6D4B\u8BD5\u8BF7\u6C42\uFF1A\u8BF7\u751F\u6210\u4E00\u4E2A\u6807\u9898\u4E3A\u201CTest AI OK\u201D\u7684\u4EFB\u52A1\uFF08\u4E0D\u4F1A\u5199\u5165\u6587\u4EF6\uFF09\u3002":"This is a diagnostic request: please propose a task titled 'Test AI OK' (no writes).",instruction:null,tasks:[],ai_model:this.getModelConfig(),tag_presets:this.getTagPresets()},a=Date.now(),i={kind:"ai",url:t,latency_ms:0,request:s,ok:!1};try{let r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),o=await r.text().catch(()=>"");if(i.latency_ms=Math.max(0,Date.now()-a),i.http_status=r.status,!r.ok)i.error=o||`HTTP ${r.status}`;else{i.ok=!0;try{i.response=JSON.parse(o)}catch(l){i.ok=!1,i.error="invalid_json",i.response=o}}}catch(r){i.latency_ms=Math.max(0,Date.now()-a),i.error=r instanceof Error?r.message:String(r)}new ot(this,i).open()}async runTestAgent(){let t=pt(this.settings.runtimeUrl,"/v1/agent/ask"),s={prompt:this.getResolvedLanguage()==="zh-CN"?"\u8FD9\u662F\u4E00\u4E2A\u8BCA\u65AD\u6D4B\u8BD5\u8BF7\u6C42\uFF1A\u8BF7\u53EA\u56DE\u590D OK\u3002":"This is a diagnostic request: reply with OK only.",include_memory:!1,record_memory:!1,timeout_s:60},a=Date.now(),i={kind:"agent",url:t,latency_ms:0,request:s,ok:!1};try{let r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),o=await r.text().catch(()=>"");if(i.latency_ms=Math.max(0,Date.now()-a),i.http_status=r.status,!r.ok)i.error=o||`HTTP ${r.status}`;else{i.ok=!0;try{i.response=JSON.parse(o)}catch(l){i.ok=!1,i.error="invalid_json",i.response=o}}}catch(r){i.latency_ms=Math.max(0,Date.now()-a),i.error=r instanceof Error?r.message:String(r)}new ot(this,i).open()}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),s=t==null?void 0:t.ok,a=s?this.t("runtime.status.online"):this.t("runtime.status.offline");if(s&&(t!=null&&t.pid)&&(a+=` (pid ${t.pid})`),s&&typeof(t==null?void 0:t.uptime_s)=="number"){let i=Math.floor(t.uptime_s/60);a+=` ${this.t("runtime.status.uptime",{mins:i})}`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(a+=` | ${this.t("runtime.status.local_pid",{pid:this.runtimePid})}`),a}async fetchRuntimeStatus(){let t=pt(this.settings.runtimeUrl,"/v1/runtime/status");try{let s=await fetch(t,{method:"GET"});return s.ok?await s.json():null}catch(s){return null}}async requestRuntimeShutdown(){let t=pt(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(s){return!1}}};
