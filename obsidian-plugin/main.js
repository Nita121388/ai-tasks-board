/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var pt=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames;var Nt=Object.prototype.hasOwnProperty;var Ct=(i,e)=>{for(var t in e)pt(i,t,{get:e[t],enumerable:!0})},Ot=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Rt(e))!Nt.call(i,a)&&a!==t&&pt(i,a,{get:()=>e[a],enumerable:!(s=_t(e,a))||s.enumerable});return i};var jt=i=>Ot(pt({},"__esModule",{value:!0}),i);var Se={};Ct(Se,{default:()=>ut});module.exports=jt(Se);var N=require("obsidian"),Mt=require("child_process"),at=require("fs"),ct=require("path");var S=require("obsidian"),mt={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",tagPresets:`work
\u5B66\u4E60
\u6548\u7387
\u8FD0\u7EF4
openclaw
obsidian
pixel`,boardLayout:"split",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function gt(i,e){let t=Number(i);return Number.isFinite(t)?t:e}var rt=class extends S.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new S.Setting(e).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(n=>{n.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Render board in note").setDesc("Replace Board.md with a draggable visual board in the note area (editor + preview).").addToggle(n=>{n.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async r=>{this.plugin.settings.renderBoardInNote=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Board layout").setDesc("Default view for the in-note board UI.").addDropdown(n=>{n.addOption("split","Split (list + detail)"),n.addOption("kanban","Kanban (columns)"),n.addOption("md","MD (raw editor)"),n.setValue(this.plugin.settings.boardLayout||"split"),n.onChange(async r=>{this.plugin.settings.boardLayout=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(n=>{n.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Tag presets").setDesc("One tag per line. AI will prefer these tags when proposing/importing tasks.").addTextArea(n=>{n.setPlaceholder("work\\n\u5B66\u4E60\\n\u6548\u7387\\nopenclaw").setValue(this.plugin.settings.tagPresets||"").onChange(async r=>{this.plugin.settings.tagPresets=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(n=>{n.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Runtime Service"});let s=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:"Status: unchecked"}),a=async()=>{s.textContent=await this.plugin.refreshRuntimeStatus()};new S.Setting(e).setName("Runtime control").setDesc("Start/stop local ai-tasks-runtime and refresh status.").addButton(n=>{n.setButtonText("Check status").onClick(async()=>{await a()})}).addButton(n=>{n.setButtonText("Start").onClick(async()=>{await this.plugin.startRuntime(),await a()})}).addButton(n=>{n.setButtonText("Stop").onClick(async()=>{await this.plugin.stopRuntime(),await a()})}),new S.Setting(e).setName("Runtime start command").setDesc("Executable to start the runtime (e.g. ai-tasks-runtime).").addText(n=>{n.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime args").setDesc("Arguments for runtime start (e.g. serve).").addText(n=>{n.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime working directory").setDesc("Optional working directory for the runtime process.").addText(n=>{n.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Model Settings"}),new S.Setting(e).setName("Model provider").setDesc("codex-cli (local) or OpenAI-compatible API.").addDropdown(n=>{n.addOption("codex-cli","codex-cli (local)"),n.addOption("openai-compatible","OpenAI-compatible API"),n.setValue(this.plugin.settings.modelProvider),n.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Model name").setDesc("Model identifier (for OpenAI-compatible providers).").addText(n=>{n.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("API base URL").setDesc("Base URL for OpenAI-compatible API (e.g. https://api.openai.com).").addText(n=>{n.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("API key").setDesc("API key for OpenAI-compatible providers (stored locally).").addText(n=>{n.inputEl.type="password",n.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Temperature").setDesc("Sampling temperature (e.g. 0.2).").addText(n=>{n.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=gt(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Top P").setDesc("Nucleus sampling (0-1).").addText(n=>{n.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let o=gt(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,o)),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Max tokens").setDesc("Max output tokens (OpenAI-compatible).").addText(n=>{n.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let o=Math.max(0,Math.floor(gt(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=o,await this.plugin.saveSettings()})}),a()}};var K=require("obsidian");var ht="<!-- AI-TASKS:BEGIN -->",kt="<!-- AI-TASKS:END -->",vt=["Unassigned","Todo","Doing","Review","Done"],xt=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function W(i){if(!i.includes("\\n")&&!i.includes("\\r\\n")&&!i.includes(`\r
`))return{next:i,changed:!1};let e=i;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==i}}function wt(i){let e=i.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function Kt(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function Ht(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(a=>a.trim()).filter(a=>a.length>0)}return[]}function Vt(i){var t;let e=i.split(`
`);for(let s of e){let a=s.match(/^>\s*status::\s*(.+)\s*$/i);if(a!=null&&a[1])return(t=wt(a[1]))!=null?t:null}return null}function bt(i){let e=i.indexOf(ht),t=i.indexOf(kt);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${ht} / ${kt}).`);return{autoStart:e+ht.length,autoEnd:t}}function Tt(i,e,t){var l;let a=i.slice(e,t).split(`
`),n=e,r=[];for(let d of a){let p=d.trimStart();if(p.startsWith("## ")){let c=p.slice(3).trim(),u=wt(c);if(u){let x=n+d.indexOf("## "),h=n+d.length;r.push({status:u,start:x,end:h})}}n+=d.length+1}let o=new Map;for(let d=0;d<r.length;d++){let p=r[d];if(!p)continue;let c=r[d+1],u=p.end+1,x=c?c.start:t,h=i.slice(u,x),k=[];xt.lastIndex=0;let v;for(;v=xt.exec(h);){let g=v[1];if(!g)continue;let T=v.index,y=u+T,w=`<!-- AI-TASKS:TASK ${g} END -->`,f=h.indexOf(w,T);if(f===-1)continue;let D=u+f+w.length;for(;D<i.length&&i[D]===`
`;){D+=1,D<i.length&&i[D]===`
`&&(D+=1);break}let A=i.slice(y,D),V=(l=Vt(A))!=null?l:p.status,L=Kt(A),F=Ht(A);k.push({uuid:g,title:L,status:V,tags:F,rawBlock:A,start:y,end:D})}o.set(p.status,{status:p.status,headingStart:p.start,headingEnd:p.end,sectionStart:u,sectionEnd:x,tasks:k})}return o}function _(i){let{autoStart:e,autoEnd:t}=bt(i),s=Tt(i,e,t);return{content:i,autoStart:e,autoEnd:t,sections:s}}function yt(i){let{autoStart:e,autoEnd:t}=bt(i),s=Tt(i,e,t),a=vt.filter(d=>!s.has(d));if(a.length===0)return i;let n=[];for(let d of vt)a.includes(d)&&n.push(`## ${d}`,"");let r=n.join(`
`);r.endsWith(`
`)||(r+=`
`);let o=i.slice(0,t),l=i.slice(t);return o.length>0&&!o.endsWith(`
`)&&(o+=`
`),o+r+l}function qt(i,e){let t=i.split(`
`),s=!1,a=t.map(n=>n.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${e}`):n);if(!s)for(let n=0;n<a.length;n++){let r=a[n];if(r&&r.match(/^>\s*\[![^\]]+\]/)){a.splice(n+1,0,`> status:: ${e}`);break}}return a.join(`
`)}function St(i,e,t){let s=i.sections.get(e);if(!s)throw new Error(`Missing status section: ${e}`);if(t){for(let n of s.tasks)if(n.uuid===t)return n.start}let a=s.tasks.at(-1);return a?a.end:s.sectionStart}function Y(i,e,t,s){let a=yt(i),n=_(a),r=null,o=null;for(let[T,y]of n.sections.entries()){for(let w of y.tasks)if(w.uuid===e){r=w,o=T;break}if(r)break}if(!r||!o)throw new Error(`Task not found: ${e}`);let l=s===e?null:s,d=r.rawBlock;o!==t&&(d=qt(d,t));let p=a.slice(0,r.start)+a.slice(r.end),c=_(p),u=St(c,t,l),x=p.slice(0,u),h=p.slice(u),k=x.length>0&&!x.endsWith(`
`),v=!d.endsWith(`
`),g=(k?`
`:"")+d+(v?`
`:"");return p=x+g+h,p}function Q(i,e,t,s){let a=yt(i),n=_(a),r=St(n,e,t),o=a.slice(0,r),l=a.slice(r),d=o.length>0&&!o.endsWith(`
`),p=!s.endsWith(`
`),c=(d?`
`:"")+s+(p?`
`:"");return o+c+l}function ot(i,e,t){let s=_(i),a=null;for(let o of s.sections.values()){for(let l of o.tasks)if(l.uuid===e){a=l;break}if(a)break}if(!a)throw new Error(`Task not found: ${e}`);let n=!t.endsWith(`
`),r=t+(n?`
`:"");return i.slice(0,a.start)+r+i.slice(a.end)}function Bt(i,e){let t=_(i),s=null;for(let n of t.sections.values()){for(let r of n.tasks)if(r.uuid===e){s=r;break}if(s)break}if(!s)throw new Error(`Task not found: ${e}`);let a=i.slice(0,s.start)+i.slice(s.end);return{removed:s,next:a}}var At=require("obsidian");function Wt(){return new Date().toISOString().replace(/[:.]/g,"-")}function zt(i,e){var r;let s=((r=i.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${e}.md`),a=i.lastIndexOf("/Boards/");return a!==-1?`${i.slice(0,a)}/History/Boards/${s}`:`${i.split("/").slice(0,-1).join("/")}/History/${s}`}function Et(i,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),s=i.lastIndexOf("/Boards/");return s!==-1?`${i.slice(0,s)}/History/Logs/ai-tasks.${t}.jsonl`:`${i.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function j(i,e){let t=e.split("/").filter(a=>a.length>0),s="";for(let a of t)s=s?`${s}/${a}`:a,i.getAbstractFileByPath(s)||await i.createFolder(s)}async function M(i,e,t){let s=await i.read(e),a=Wt(),n=zt(e.path,a),r=n.split("/").slice(0,-1).join("/");await j(i,r),await i.create(n,s),await i.modify(e,t)}async function Dt(i,e,t){let s=e.split("/").slice(0,-1).join("/");s&&await j(i,s);let a=JSON.stringify(t)+`
`,n=i.getAbstractFileByPath(e);if(n instanceof At.TFile){let r=await i.read(n);await i.modify(n,r+a);return}await i.create(e,a)}async function E(i,e){let t=new Date().toISOString(),s=t.slice(0,10),a=Et(i.settings.boardPath,s);await Dt(i.app.vault,a,{ts:t,...e})}function ft(i){return i instanceof Error?i.message:String(i)}function Pt(i,e,t){let s=ft(e),a={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${i}: ${s}`,a)}function Gt(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Jt(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Yt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function Qt(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof K.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await j(i.app.vault,s),await i.app.vault.create(e,Yt())}function Xt(i,e){return i.replace(/\/+$/g,"")+e}async function Zt(i,e){let t=Xt(i.settings.runtimeUrl,"/v1/board/propose"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function It(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function te(i){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">"),t.push(...It(i.body)),t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}function ee(i,e){var d,p,c;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),a=t.findIndex(u=>s.test(u.trim()));if(a===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(u=>/^>\\s*\\[![^\\]]+\\]/.test(u));if(n!==-1){let u=(d=t[n])==null?void 0:d.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),x=(p=u==null?void 0:u[1])!=null?p:"[!todo]";t[n]=`> ${x} ${e.title}`}let r=t.findIndex(u=>/^>\\s*status::/i.test(u));if(r!==-1)t[r]=`> status:: ${e.status}`;else{let u=n!==-1?n+1:1;t.splice(u,0,`> status:: ${e.status}`),r=u}if(e.tags.length>0){let u=t.findIndex(x=>/^>\\s*tags::/i.test(x));u!==-1?t[u]=`> tags:: ${e.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${e.tags.join(", ")}`)}let o=new Date().toISOString(),l=[];return l.push(">"),l.push("> ---"),l.push(`> updated:: ${o}`),(c=e.instruction)!=null&&c.trim()&&l.push(`> instruction:: ${e.instruction.trim()}`),l.push(...It(e.body)),t.splice(a,0,...l),t.join(`
`)+`
`}var et=class extends K.Modal{constructor(t,s){var a;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.value=this.draft,a.addEventListener("input",()=>{this.draft=a.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:"Generate preview"}),d=o.createEl("button",{text:"Confirm & write"}),p=o.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let c=t.createDiv({cls:"ai-tasks-draft-preview"}),u=c.createDiv({cls:"ai-tasks-draft-side"});u.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=u.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let x=c.createDiv({cls:"ai-tasks-draft-side"});x.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=x.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,l.addEventListener("click",async()=>{await this.generate()}),d.addEventListener("click",async()=>{await this.apply()}),p.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,a,n,r,o,l,d,p,c,u,x,h,k,v,g,T,y;try{this.setStatus("Generating preview..."),this.boardFile=await Qt(this.plugin);let w=await this.plugin.app.vault.read(this.boardFile),f=W(w);f.changed&&await M(this.plugin.app.vault,this.boardFile,f.next),this.boardContent=f.next;let B=_(this.boardContent),D=Array.from(B.sections.values()).flatMap($=>$.tasks.map(P=>({uuid:P.uuid,title:P.title,status:P.status,tags:P.tags}))),A={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:D,ai_model:this.plugin.getModelConfig(),tag_presets:this.plugin.getTagPresets()};await E(this.plugin,{type:"board.propose.request",mode:A.mode,draft_len:A.draft.length,instruction_len:((t=A.instruction)!=null?t:"").length,tasks_count:A.tasks.length,tag_presets_count:(a=(s=A.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(n=A.ai_model)==null?void 0:n.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});try{this.proposal=await Zt(this.plugin,A),await E(this.plugin,{type:"board.propose.response",engine:(o=this.proposal.engine)!=null?o:null,provider:(l=this.proposal.provider)!=null?l:null,thread_id:(d=this.proposal.thread_id)!=null?d:null,ai_fallback:(p=this.proposal.ai_fallback)!=null?p:null,action:this.proposal.action,target_uuid:(c=this.proposal.target_uuid)!=null?c:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(u=this.proposal.confidence)!=null?u:null,reasoning:(x=this.proposal.reasoning)!=null?x:null})}catch($){let P=$ instanceof Error?$.message:String($);throw await E(this.plugin,{type:"board.propose.error",error:P}),$}let V=this.proposal.action,L=Gt(this.proposal.status);if(V==="update"&&this.proposal.target_uuid){let $=this.proposal.target_uuid,P=null;for(let[m,b]of B.sections.entries()){for(let I of b.tasks)if(I.uuid===$){P={rawBlock:I.rawBlock,sectionStatus:m};break}if(P)break}if(!P)this.proposal.action="create";else{this.beforeBlock=P.rawBlock,this.afterBlock=ee(this.beforeBlock,{uuid:$,title:this.proposal.title||"(Untitled)",status:L,tags:(h=this.proposal.tags)!=null?h:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let m=ot(this.boardContent,$,this.afterBlock);P.sectionStatus!==L&&(m=Y(m,$,L,null)),this.nextBoardContent=m}}if(this.proposal.action==="create"){let $=Jt();this.beforeBlock="",this.afterBlock=te({uuid:$,title:this.proposal.title||"(Untitled)",status:L,tags:(k=this.proposal.tags)!=null?k:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let P=(y=(T=(g=(v=B.sections.get(L))==null?void 0:v.tasks)==null?void 0:g[0])==null?void 0:T.uuid)!=null?y:null;this.nextBoardContent=Q(this.boardContent,L,P,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let F=[];this.proposal.engine&&F.push(`engine=${this.proposal.engine}`),this.proposal.thread_id&&F.push(`thread=${this.proposal.thread_id}`),this.proposal.ai_fallback&&F.push(`ai_fallback=${this.proposal.ai_fallback}`),this.proposal.reasoning&&F.push(this.proposal.reasoning),this.proposal.confidence!=null&&F.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(F.length?F.join(" | "):"Preview ready.")}catch(w){let f=ft(w);Pt("\u751F\u6210\u9884\u89C8\u5931\u8D25",w,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(`Failed: ${f}`),new K.Notice(`AI Tasks: \u9884\u89C8\u5931\u8D25\uFF1A${f}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}async apply(){var t,s,a,n,r,o;if(!this.boardFile){new K.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new K.Notice("AI Tasks: please generate preview first.");return}try{await M(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await E(this.plugin,{type:"board.write",via:"draft_modal",action:(s=(t=this.proposal)==null?void 0:t.action)!=null?s:null,target_uuid:(n=(a=this.proposal)==null?void 0:a.target_uuid)!=null?n:null}),new K.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(l){let d=ft(l);Pt("\u5199\u5165\u770B\u677F\u5931\u8D25",l,{boardPath:(o=(r=this.boardFile)==null?void 0:r.path)!=null?o:this.plugin.settings.boardPath}),new K.Notice(`AI Tasks: \u5199\u5165\u5931\u8D25\uFF1A${d}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}};var H=require("obsidian");var se=["Unassigned","Todo","Doing","Review","Done"];function $t(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ie(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ae(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function ne(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof H.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await j(i.app.vault,s),await i.app.vault.create(e,ae())}function re(i,e){return i.replace(/\/+$/g,"")+e}async function oe(i,e){let t=re(i.settings.runtimeUrl,"/v1/board/split"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function le(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function Lt(i){let t=(i!=null?i:[]).filter(n=>typeof n=="string").flatMap(n=>n.split(/[,，]/g)).map(n=>n.trim()).filter(n=>n.length>0),s=new Set,a=[];for(let n of t){let r=n.toLowerCase();s.has(r)||(s.add(r),a.push(n))}return a}function de(i){let e=new Date().toISOString(),t=(i.title||"").trim()||"(Untitled)",s=[];return s.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),s.push(`> [!todo] ${t}`),s.push(`> status:: ${i.status}`),i.tags.length>0&&s.push(`> tags:: ${i.tags.join(", ")}`),s.push(`> created:: ${e}`),i.sourcePath&&s.push(`> source:: [[${i.sourcePath}]]`),s.push(">"),i.body.trim().length>0?s.push(...le(i.body)):s.push(">"),s.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),s.join(`
`)+`
`}var J=class extends H.Modal{constructor(t,s){var a,n;super(t.app);this.instruction="";this.boardFile=null;this.tasks=[];this.proposalMeta=null;this.statusEl=null;this.listEl=null;this.plugin=t,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.text=(n=s.selection)!=null?n:""}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-bulk-import-modal"),t.createEl("h2",{text:"AI Tasks: Import tasks"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Text to split into tasks (editable)"});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.placeholder="Paste a task list here...",a.value=this.text,a.addEventListener("input",()=>{this.text=a.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. Use tags from presets; keep titles short; group by category...",r.value=this.instruction,r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:"Generate",cls:"mod-cta"}),d=o.createEl("button",{text:"Import to board"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""}),this.listEl=t.createDiv({cls:"ai-tasks-bulk-list"}),l.addEventListener("click",()=>void this.generate()),d.addEventListener("click",()=>void this.apply())}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}renderList(){var t;if(this.listEl){if(this.listEl.empty(),!this.tasks.length){this.listEl.createDiv({cls:"ai-tasks-board-empty",text:"(no tasks yet)"});return}for(let s of this.tasks){let a=this.listEl.createDiv({cls:"ai-tasks-bulk-row"}),n=(s.title||"").trim()||"(Untitled)",r=$t((t=s.status)!=null?t:"Unassigned"),o=Lt(s.tags);a.createDiv({cls:"ai-tasks-bulk-title",text:n}),a.createDiv({cls:"ai-tasks-bulk-meta",text:`${r}${o.length?" | "+o.join(", "):""}`})}}}async generate(){var t,s,a,n,r,o,l,d,p,c,u,x,h,k,v,g,T,y;try{this.setStatus("Generating..."),this.boardFile=await ne(this.plugin);let w={text:this.text,instruction:this.instruction||null,tag_presets:this.plugin.getTagPresets(),max_tasks:60,ai_model:this.plugin.getModelConfig()};await E(this.plugin,{type:"board.split.request",text_len:w.text.length,instruction_len:((t=w.instruction)!=null?t:"").length,tag_presets_count:(a=(s=w.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(n=w.ai_model)==null?void 0:n.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});let f=await oe(this.plugin,w);this.tasks=Array.isArray(f.tasks)?f.tasks.slice(0,Math.max(1,(o=w.max_tasks)!=null?o:60)):[],this.proposalMeta={engine:(l=f.engine)!=null?l:null,provider:(d=f.provider)!=null?d:null,thread_id:(p=f.thread_id)!=null?p:null,ai_fallback:(c=f.ai_fallback)!=null?c:null,reasoning:(u=f.reasoning)!=null?u:null,confidence:(x=f.confidence)!=null?x:null},await E(this.plugin,{type:"board.split.response",engine:(h=f.engine)!=null?h:null,provider:(k=f.provider)!=null?k:null,thread_id:(v=f.thread_id)!=null?v:null,ai_fallback:(g=f.ai_fallback)!=null?g:null,tasks_count:this.tasks.length,confidence:(T=f.confidence)!=null?T:null,reasoning:(y=f.reasoning)!=null?y:null}),this.renderList();let B=[];f.engine&&B.push(`engine=${f.engine}`),f.thread_id&&B.push(`thread=${f.thread_id}`),f.ai_fallback&&B.push(`ai_fallback=${f.ai_fallback}`),f.confidence!=null&&B.push(`confidence=${f.confidence.toFixed(2)}`),f.reasoning&&B.push(f.reasoning),this.setStatus(B.length?B.join(" | "):`Ready (${this.tasks.length} tasks).`)}catch(w){let f=w instanceof Error?w.message:String(w);this.setStatus(`Failed: ${f}`),new H.Notice(`AI Tasks: ${f}`)}}async apply(){var t,s,a,n,r,o,l,d,p,c,u,x,h;if(!this.boardFile){new H.Notice("AI Tasks: board file not ready.");return}if(!this.tasks.length){new H.Notice("AI Tasks: please generate tasks first.");return}try{let k=await this.plugin.app.vault.read(this.boardFile),v=W(k),g=v.next;v.changed&&(await M(this.plugin.app.vault,this.boardFile,v.next),await E(this.plugin,{type:"board.normalize_escaped_newlines"}));let T=_(g),y=new Map;for(let f of se){let B=(n=(a=(s=(t=T.sections.get(f))==null?void 0:t.tasks)==null?void 0:s[0])==null?void 0:a.uuid)!=null?n:null;y.set(f,B)}let w=[];for(let f of this.tasks){let B=(f.title||"").trim().slice(0,120)||"(Untitled)",D=$t((r=f.status)!=null?r:"Unassigned"),A=Lt(f.tags),V=String((o=f.body)!=null?o:"").trim(),L=ie(),F=de({uuid:L,title:B,status:D,tags:A,body:V,sourcePath:this.sourcePath});g=Q(g,D,(l=y.get(D))!=null?l:null,F),w.push({uuid:L,title:B,status:D,tags:A})}await M(this.plugin.app.vault,this.boardFile,g),await E(this.plugin,{type:"board.bulk_import.write",via:"bulk_import_modal",tasks_count:w.length,engine:(p=(d=this.proposalMeta)==null?void 0:d.engine)!=null?p:null,provider:(u=(c=this.proposalMeta)==null?void 0:c.provider)!=null?u:null,thread_id:(h=(x=this.proposalMeta)==null?void 0:x.thread_id)!=null?h:null}),new H.Notice(`AI Tasks: imported ${w.length} tasks (history snapshot created).`),this.close()}catch(k){let v=k instanceof Error?k.message:String(k);new H.Notice(`AI Tasks: import failed: ${v}`)}}};var Ft=require("obsidian");var Z=require("obsidian");var st=require("obsidian");var ce=["Unassigned","Todo","Doing","Review","Done"];function ue(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function pe(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ge(i){let e=i.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(r=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(r.trim()));if(t===-1)return"";let s=e.findIndex(r=>r.trim()===">");return s===-1||s>=t?"":e.slice(s+1,t).map(r=>{let o=r.match(/^>\s?(.*)$/);return o?o[1]:r}).join(`
`).replace(/\n$/,"")}function he(i,e){var k,v;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(g=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(g.trim()));if(s===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(g=>/^>\s*\[![^\]]+\]/.test(g));if(a!==-1){let g=(k=t[a])==null?void 0:k.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),T=(v=g==null?void 0:g[1])!=null?v:"[!todo]";t[a]=`> ${T} ${e.title||"(Untitled)"}`}let n=t.findIndex(g=>/^>\s*status::/i.test(g));if(n!==-1)t[n]=`> status:: ${e.status}`;else{let g=a!==-1?a+1:1;t.splice(g,0,`> status:: ${e.status}`),n=g}let r=t.findIndex(g=>/^>\s*tags::/i.test(g));if(e.tags.length>0){let g=`> tags:: ${e.tags.join(", ")}`;r!==-1?t[r]=g:t.splice(n+1,0,g)}else r!==-1&&t.splice(r,1);let o=t.findIndex(g=>/^>\s*updated::/i.test(g)),l=`> updated:: ${e.updatedAtIso}`;if(o!==-1)t[o]=l;else{let g=t.findIndex(y=>/^>\s*created::/i.test(y)),T=g!==-1?g+1:n+1;t.splice(T,0,l)}let d=t.findIndex(g=>g.trim()===">");(d===-1||d>=s)&&(d=s,t.splice(d,0,">"));let p=t.findIndex(g=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(g.trim()));if(p===-1)throw new Error("Malformed task block (missing END marker).");let c=[],u=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let g of u)g.trim()===""?c.push(">"):c.push(`> ${g}`);let x=t.slice(0,d+1),h=t.slice(p);return x.concat(c,h).join(`
`)+`
`}function fe(i){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title||"(Untitled)"}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">");for(let s of(i.body||"").replace(/\r\n/g,`
`).split(`
`))s.trim()===""?t.push(">"):t.push(`> ${s}`);return t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}var it=class extends st.Modal{constructor(e,t){var s,a,n,r,o;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(s=t.task)!=null?s:null,this.defaultStatus=(r=t.defaultStatus)!=null?r:(n=(a=this.task)==null?void 0:a.status)!=null?n:"Unassigned",this.sourcePath=(o=t.sourcePath)!=null?o:null,this.onDidWrite=t.onDidWrite}onOpen(){var h,k,v,g,T,y;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?"Edit task":"New task"});let s=e.createDiv({cls:"ai-tasks-form-row"});s.createDiv({cls:"ai-tasks-form-label",text:"Title"});let a=s.createEl("input",{type:"text",cls:"ai-tasks-form-input"});a.value=(k=(h=this.task)==null?void 0:h.title)!=null?k:"";let n=e.createDiv({cls:"ai-tasks-form-row"});n.createDiv({cls:"ai-tasks-form-label",text:"Status"});let r=n.createEl("select",{cls:"ai-tasks-form-select"});for(let w of ce)r.add(new Option(w,w));r.value=(g=(v=this.task)==null?void 0:v.status)!=null?g:this.defaultStatus;let o=e.createDiv({cls:"ai-tasks-form-row"});o.createDiv({cls:"ai-tasks-form-label",text:"Tags (comma separated)"});let l=o.createEl("input",{type:"text",cls:"ai-tasks-form-input"});l.placeholder="e.g. release, bug, v1",l.value=((y=(T=this.task)==null?void 0:T.tags)!=null?y:[]).join(", ");let d=e.createDiv({cls:"ai-tasks-form-row"});d.createDiv({cls:"ai-tasks-form-label",text:"Body"});let p=d.createEl("textarea",{cls:"ai-tasks-form-textarea"});p.value=this.task?ge(this.task.rawBlock):"";let c=e.createDiv({cls:"ai-tasks-form-buttons"}),u=c.createEl("button",{text:"Save",cls:"mod-cta"});c.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),u.addEventListener("click",()=>{this.save({title:a.value,status:pe(r.value),tagsRaw:l.value,body:p.value})})}async save(e){var t,s,a,n,r,o;try{let l=e.tagsRaw.split(/[,，]/).map(k=>k.trim()).filter(k=>k.length>0),d=await this.plugin.app.vault.read(this.boardFile),c=W(d).next,u=_(c),x=new Date().toISOString(),h=c;if(this.task){let k=null,v=null;for(let[T,y]of u.sections.entries()){for(let w of y.tasks)if(w.uuid===this.task.uuid){k=w,v=T;break}if(k)break}if(!k||!v)throw new Error(`Task not found: ${this.task.uuid}`);let g=he(k.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:l,body:(t=e.body)!=null?t:"",updatedAtIso:x});h=ot(h,k.uuid,g),v!==e.status&&(h=Y(h,k.uuid,e.status,null)),await M(this.plugin.app.vault,this.boardFile,h),await E(this.plugin,{type:"task.edit",uuid:k.uuid,from_status:v,status:e.status})}else{let k=ue(),v=fe({uuid:k,title:e.title||"(Untitled)",status:e.status,tags:l,body:(s=e.body)!=null?s:"",sourcePath:this.sourcePath}),g=(o=(r=(n=(a=u.sections.get(e.status))==null?void 0:a.tasks)==null?void 0:n[0])==null?void 0:r.uuid)!=null?o:null;h=Q(h,e.status,g,v),await M(this.plugin.app.vault,this.boardFile,h),await E(this.plugin,{type:"task.create",uuid:k,status:e.status})}new st.Notice("AI Tasks: saved."),this.close(),this.onDidWrite()}catch(l){let d=l instanceof Error?l.message:String(l);new st.Notice(`AI Tasks: save failed: ${d}`)}}};var X=["Unassigned","Todo","Doing","Review","Done"];function me(){let i=new Date,e=String(i.getFullYear()),t=String(i.getMonth()+1).padStart(2,"0"),s=String(i.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}function ke(i,e){let t=(i||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function ve(i){return["---","schema: ai-tasks-archive/v1",`date: ${i}`,"---","",`# Archive ${i}`,"",""].join(`
`)}function xe(i,e){let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(l=>/^>\s*archived::/i.test(l));if(s!==-1)return t[s]=`> archived:: ${e}`,t.join(`
`)+`
`;let a=t.findIndex(l=>/^>\s*created::/i.test(l)),n=t.findIndex(l=>/^>\s*status::/i.test(l)),r=t.findIndex(l=>/^>\s*\[![^\]]+\]/.test(l)),o=a!==-1?a+1:n!==-1?n+1:r!==-1?r+1:1;return t.splice(o,0,`> archived:: ${e}`),t.join(`
`)+`
`}function we(i){return Array.from(new Set(i.flatMap(e=>e.tags))).sort()}function be(i,e){let t=e.trim().toLowerCase();return t?i.title.toLowerCase().includes(t)||i.tags.some(s=>s.toLowerCase().includes(t)):!0}var lt=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.selectedUuid=null;this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=W(e);return t.changed&&(await M(this.plugin.app.vault,this.boardFile,t.next),new Z.Notice("AI Tasks: fixed escaped newlines in Board.md."),await E(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return be(e,this.searchText)}renderHeader(e,t,s){let a=e.createDiv({cls:"ai-tasks-board-header"});a.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let r=a.createDiv({cls:"ai-tasks-board-controls"}),o=r.createEl("select",{cls:"ai-tasks-board-view-select"});if(o.add(new Option("Kanban","kanban")),o.add(new Option("Kan Detail","split")),o.add(new Option("MD","md")),o.value=s,o.addEventListener("change",()=>{(async()=>{let h=o.value;this.plugin.settings.boardLayout=h,await this.plugin.saveSettings(),await this.render(e)})()}),r.createEl("button",{text:"Import",cls:"ai-tasks-board-import"}).addEventListener("click",()=>{new J(this.plugin,{selection:"",sourcePath:this.boardFile.path}).open()}),s==="md")return;let d=r.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:"Search title/tags..."}});d.value=this.searchText,d.addEventListener("input",async()=>{this.searchText=d.value,await this.render(e)});let p=r.createEl("select",{cls:"ai-tasks-board-select"});p.add(new Option("All statuses","All"));for(let h of X)p.add(new Option(h,h));p.value=this.statusFilter,p.addEventListener("change",async()=>{let h=p.value;this.statusFilter=h==="All"?"All":h,await this.render(e)});let c=r.createDiv({cls:"ai-tasks-board-tags"}),u=c.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),x=c.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)x.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let h of t){let k=x.createEl("button",{cls:"ai-tasks-tag-chip",text:h});this.tagFilter.has(h)&&k.classList.add("is-active"),k.addEventListener("click",async v=>{v.preventDefault(),this.tagFilter.has(h)?this.tagFilter.delete(h):this.tagFilter.add(h),await this.render(e)})}u.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}extractBodyFromBlock(e){let t=e.replace(/\r\n/g,`
`).split(`
`),s=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+BEGIN\s*-->\s*$/i,a=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->\s*$/i,n=!1,r=[];for(let o of t){let l=o.trim();if(!s.test(l)){if(a.test(l))break;if(!n){l===">"&&(n=!0);continue}if(o.startsWith(">")){let d=o.slice(1);d.startsWith(" ")&&(d=d.slice(1)),r.push(d)}else r.push(o)}}if(r.length===0){for(let o of t)if(!(s.test(o.trim())||a.test(o.trim()))&&o.startsWith(">")){let l=o.slice(1);l.startsWith(" ")&&(l=l.slice(1)),r.push(l)}}return r.join(`
`).replace(/\n{3,}/g,`

`).trim()}createCard(e,t,s,a,n){let r=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});r.draggable=!0,r.addEventListener("click",c=>{var u,x;(x=(u=c.target)==null?void 0:u.closest)!=null&&x.call(u,"select, button, a, input, textarea")||n(t)});let o=r.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let l=o.createDiv({cls:"ai-task-actions"}),d=l.createEl("select",{cls:"ai-task-status"});for(let c of X)d.add(new Option(c,c));if(d.value=t.status,d.addEventListener("click",c=>c.stopPropagation()),d.addEventListener("change",async c=>{c.stopPropagation(),await s(t.uuid,d.value,null)}),l.createEl("button",{cls:"ai-task-edit",text:"Edit"}).addEventListener("click",c=>{c.stopPropagation(),n(t)}),t.status==="Done"&&l.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async u=>{u.stopPropagation(),await a(t.uuid)}),t.tags.length>0){let c=r.createDiv({cls:"ai-task-tags"});for(let u of t.tags)c.createSpan({cls:"ai-task-tag",text:u})}return r.addEventListener("dragstart",c=>{var u,x;(u=c.dataTransfer)==null||u.setData("application/x-ai-task-uuid",t.uuid),(x=c.dataTransfer)==null||x.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(e,t,s){e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async a=>{var d,p,c;a.preventDefault(),e.classList.remove("is-drop-target");let n=(d=a.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid");if(!n)return;let r=a.target,o=(p=r==null?void 0:r.closest)==null?void 0:p.call(r,".ai-task-card"),l=(c=o==null?void 0:o.getAttribute("data-uuid"))!=null?c:null;await s(n,t,l)})}attachSplitDnD(e,t,s){e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async a=>{var d,p,c;a.preventDefault(),e.classList.remove("is-drop-target");let n=(d=a.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid");if(!n)return;let r=a.target,o=(p=r==null?void 0:r.closest)==null?void 0:p.call(r,".ai-tasks-split-task"),l=(c=o==null?void 0:o.getAttribute("data-uuid"))!=null?c:null;await s(n,t,l)})}async appendToArchive(e,t,s,a){let n=t.split("/").slice(0,-1).join("/");n&&await j(e,n);let r=e.getAbstractFileByPath(t);if(r instanceof Z.TFile){let o=await e.read(r),l=o.endsWith(`
`)?`
`:`

`;await e.modify(r,o+l+s);return}await e.create(t,ve(a)+s)}async render(e){var A,V,L,F,$,P;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t=this.plugin.settings.boardLayout==="kanban"?"kanban":this.plugin.settings.boardLayout==="md"?"md":"split",s;try{s=await this.readBoardNormalized()}catch(m){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:m instanceof Error?m.message:"Failed to read Board.md."});return}if(t==="md"){this.renderHeader(e,[],t);let m=e.createDiv({cls:"ai-tasks-md-root"}),b=m.createDiv({cls:"ai-tasks-md-actions"}),I=b.createEl("button",{text:"Reload"}),C=b.createEl("button",{text:"Save",cls:"mod-cta"}),R=m.createEl("textarea",{cls:"ai-tasks-md-textarea"});R.value=s,I.addEventListener("click",()=>void this.render(e)),C.addEventListener("click",()=>{(async()=>(await M(this.plugin.app.vault,this.boardFile,R.value.replace(/\r\n/g,`
`)),await E(this.plugin,{type:"board.write",via:"md_view"}),new Z.Notice("AI Tasks: saved Board.md (history snapshot created)."),await this.render(e)))()});return}let a;try{a=_(s)}catch(m){this.renderHeader(e,[],t);let b=e.createDiv({cls:"ai-tasks-board-error"});b.createDiv({text:m instanceof Error?m.message:"Failed to parse Board.md (unknown error)."}),b.createDiv({text:"Tip: switch view to MD to edit/fix the file."});return}let n=Array.from(a.sections.values()).flatMap(m=>m.tasks),r=we(n);this.renderHeader(e,r,t);let o=async(m,b,I)=>{let C=await this.readBoardNormalized(),R=Y(C,m,b,I);await M(this.plugin.app.vault,this.boardFile,R),await E(this.plugin,{type:"task.move",uuid:m,status:b,before_uuid:I}),await this.render(e)},l=async m=>{if(!window.confirm("Archive this task?"))return;let b=await this.readBoardNormalized(),{removed:I,next:C}=Bt(b,m),R=me(),z=ke(this.plugin.settings.archiveFolderPath,R),q=xe(I.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,z,q,R),await M(this.plugin.app.vault,this.boardFile,C),new Z.Notice(`Archived task to ${z}`),await E(this.plugin,{type:"task.archive",uuid:m,archive_path:z}),await this.render(e)},d=m=>{new it(this.plugin,{boardFile:this.boardFile,task:m,onDidWrite:()=>{this.render(e)}}).open()},p=m=>{new it(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:m,onDidWrite:()=>{this.render(e)}}).open()};if(t==="kanban"){let m=e.createDiv({cls:"ai-tasks-board-columns"});for(let b of X){let I=m.createDiv({cls:"ai-tasks-column"}),C=I.createDiv({cls:"ai-tasks-column-head"});C.createDiv({cls:"ai-tasks-column-title",text:b}),C.createEl("button",{cls:"ai-tasks-column-add",text:"+ Add"}).addEventListener("click",()=>p(b));let z=I.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(z,b,o);let q=a.sections.get(b),O=((A=q==null?void 0:q.tasks)!=null?A:[]).filter(U=>this.shouldShowTask(U));for(let U of O)this.createCard(z,U,o,l,d)}return}let c=e.createDiv({cls:"ai-tasks-board-split"}),u=c.createDiv({cls:"ai-tasks-board-split-left"}),x=c.createDiv({cls:"ai-tasks-board-split-right"}),h=new Map;for(let m of n)h.set(m.uuid,m);let k=[];for(let m of X){let b=a.sections.get(m);k.push(...((V=b==null?void 0:b.tasks)!=null?V:[]).filter(I=>this.shouldShowTask(I)))}this.selectedUuid&&!h.has(this.selectedUuid)&&(this.selectedUuid=null),this.selectedUuid&&!k.some(m=>m.uuid===this.selectedUuid)&&(this.selectedUuid=null),!this.selectedUuid&&k.length>0&&(this.selectedUuid=(F=(L=k[0])==null?void 0:L.uuid)!=null?F:null);for(let m of X){let b=a.sections.get(m),I=(($=b==null?void 0:b.tasks)!=null?$:[]).filter(O=>this.shouldShowTask(O)),C=u.createDiv({cls:"ai-tasks-split-section"}),R=C.createDiv({cls:"ai-tasks-split-section-head"});R.createDiv({cls:"ai-tasks-split-section-title",text:m}),R.createDiv({cls:"ai-tasks-split-section-count",text:String(I.length)}),R.createEl("button",{cls:"ai-tasks-split-add",text:"+ Add"}).addEventListener("click",()=>p(m));let q=C.createDiv({cls:"ai-tasks-split-tasklist"});this.attachSplitDnD(q,m,o);for(let O of I){let U=q.createDiv({cls:"ai-tasks-split-task",attr:{"data-uuid":O.uuid}});O.uuid===this.selectedUuid&&U.classList.add("is-selected"),U.draggable=!0,U.createDiv({cls:"ai-tasks-split-task-title",text:O.title}),O.tags.length>0&&U.createDiv({cls:"ai-tasks-split-task-tags",text:O.tags.join(", ")}),U.addEventListener("click",async nt=>{var G,tt;(tt=(G=nt.target)==null?void 0:G.closest)!=null&&tt.call(G,"select, button, a, input, textarea")||(this.selectedUuid=O.uuid,await this.render(e))}),U.addEventListener("dragstart",nt=>{var G,tt;(G=nt.dataTransfer)==null||G.setData("application/x-ai-task-uuid",O.uuid),(tt=nt.dataTransfer)==null||tt.setDragImage(U,8,8),U.classList.add("is-dragging")}),U.addEventListener("dragend",()=>{U.classList.remove("is-dragging")})}}let v=this.selectedUuid&&(P=h.get(this.selectedUuid))!=null?P:null;if(!v){x.createDiv({cls:"ai-tasks-detail-empty",text:"Select a task to view details."});return}let g=x.createDiv({cls:"ai-tasks-detail"});g.createDiv({cls:"ai-tasks-detail-title",text:v.title}),g.createDiv({cls:"ai-tasks-detail-uuid",text:v.uuid});let T=g.createDiv({cls:"ai-tasks-detail-meta"}),y=T.createEl("select",{cls:"ai-tasks-detail-status"});for(let m of X)y.add(new Option(m,m));if(y.value=v.status,y.addEventListener("change",async()=>{await o(v.uuid,y.value,null)}),T.createEl("button",{text:"Edit",cls:"ai-tasks-detail-edit"}).addEventListener("click",()=>d(v)),v.status==="Done"&&T.createEl("button",{text:"Archive",cls:"ai-tasks-detail-archive"}).addEventListener("click",async()=>{await l(v.uuid)}),v.tags.length>0){let m=g.createDiv({cls:"ai-tasks-detail-tags"});for(let b of v.tags)m.createSpan({cls:"ai-task-tag",text:b})}let f=g.createDiv({cls:"ai-tasks-detail-body"}),B=this.extractBodyFromBlock(v.rawBlock),D=f.createEl("pre",{cls:"ai-tasks-detail-body-pre"});D.textContent=B||"(no details)"}};var dt=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let s of e){let a=s.view;if(!(a instanceof Ft.MarkdownView))continue;let n=a.file;if(!n){this.unmount(a);continue}let r=!!this.plugin.settings.renderBoardInNote,o=n.path===this.plugin.settings.boardPath;if(!r||!o){this.unmount(a);continue}t.add(a),await this.mount(a,n)}for(let s of Array.from(this.overlays.keys()))t.has(s)||this.unmount(s)}async mount(e,t){let s=this.overlays.get(e);if(s&&s.file.path===t.path)return;s&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let a=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),n=new lt(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:a,panel:n});try{await n.render(a)}catch(r){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};function Ut(i,e){return i.replace(/\/+$/g,"")+e}function Te(i){var a,n;if(!i)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,s;for(;(s=t.exec(i))!==null;){let r=(n=(a=s[1])!=null?a:s[2])!=null?n:s[3];r&&e.push(r)}return e}function ye(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var ut=class extends N.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.boardOverlay=null}getPluginDir(){var a;let t=this.app.vault.adapter,s=(a=t==null?void 0:t.getBasePath)==null?void 0:a.call(t);return s?(0,ct.join)(s,this.app.vault.configDir,"plugins","ai-tasks-board"):null}async onload(){await this.loadSettings(),this.boardOverlay=new dt(this),this.addCommand({id:"open-ai-tasks-board-note",name:"AI Tasks: Open board note",callback:async()=>{let t=this.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);if(s instanceof N.TFile){await this.app.workspace.getLeaf().openFile(s);return}let a=t.split("/").slice(0,-1).join("/");a&&await j(this.app.vault,a);let n=await this.app.vault.create(t,ye());await this.app.workspace.getLeaf().openFile(n)}}),this.addCommand({id:"bulk-import-ai-tasks",name:"AI Tasks: Import tasks (AI)",callback:()=>{var s,a;let t=(a=(s=this.app.workspace.getActiveFile())==null?void 0:s.path)!=null?a:null;new J(this,{selection:"",sourcePath:t}).open()}}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var s;t.path===this.settings.boardPath&&((s=this.boardOverlay)==null||s.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,a)=>{let n=s.getSelection();!n||n.trim().length===0||(t.addItem(r=>{r.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var o;new et(this,{mode:"create",selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var o;new et(this,{mode:"auto",selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Import selection as tasks (AI)").setIcon("list-plus").onClick(()=>{var o;new J(this,{selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}))})),this.addSettingTab(new rt(this.app,this))}onunload(){var t;(t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}async loadSettings(){this.settings=Object.assign({},mt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var s,a,n;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((s=this.settings.modelName)==null?void 0:s.trim())||void 0,base_url:((a=this.settings.modelBaseUrl)==null?void 0:a.trim())||void 0,api_key:((n=this.settings.modelApiKey)==null?void 0:n.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}getTagPresets(){let s=(this.settings.tagPresets||"").replace(/\r\n/g,`
`).split(/\n|[,，]/g).map(r=>r.trim()).filter(r=>r.length>0),a=new Set,n=[];for(let r of s){let o=r.toLowerCase();a.has(o)||(a.add(o),n.push(r))}return n}async startRuntime(){var n,r,o;if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new N.Notice("AI Tasks: runtime already running.");return}let t=this.settings.runtimeCommand.trim();if(!t){new N.Notice("AI Tasks: runtime command is empty.");return}let s=Te(this.settings.runtimeArgs||""),a=this.settings.runtimeCwd.trim()||void 0;try{let l=(0,Mt.spawn)(t,s,{cwd:a,windowsHide:!0,shell:!1});this.runtimeProcess=l,this.runtimePid=(n=l.pid)!=null?n:null;let d=this.getPluginDir();if(d)try{(0,at.mkdirSync)(d,{recursive:!0});let p=(0,ct.join)(d,"runtime.stdout.log"),c=(0,ct.join)(d,"runtime.stderr.log");(r=l.stdout)==null||r.on("data",u=>{(0,at.appendFileSync)(p,u.toString())}),(o=l.stderr)==null||o.on("data",u=>{(0,at.appendFileSync)(c,u.toString())}),console.info(`[ai-tasks-board] runtime logs: ${p} / ${c}`)}catch(p){console.error("[ai-tasks-board] failed to init runtime log files",p)}l.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),l.on("error",p=>{new N.Notice(`AI Tasks: runtime start failed: ${p.message}`)}),new N.Notice(`AI Tasks: runtime starting${l.pid?` (pid ${l.pid})`:""}.`)}catch(l){let d=l instanceof Error?l.message:String(l);new N.Notice(`AI Tasks: runtime start failed: ${d}`)}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new N.Notice("AI Tasks: runtime stop requested."):new N.Notice("AI Tasks: runtime not running.")}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),s=t==null?void 0:t.ok,a=s?"online":"offline";if(s&&(t!=null&&t.pid)&&(a+=` (pid ${t.pid})`),s&&typeof(t==null?void 0:t.uptime_s)=="number"){let n=Math.floor(t.uptime_s/60);a+=` uptime ${n}m`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(a+=` | local pid ${this.runtimePid}`),a}async fetchRuntimeStatus(){let t=Ut(this.settings.runtimeUrl,"/v1/runtime/status");try{let s=await fetch(t,{method:"GET"});return s.ok?await s.json():null}catch(s){return null}}async requestRuntimeShutdown(){let t=Ut(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(s){return!1}}};
