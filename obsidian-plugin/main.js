/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var pt=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames;var Nt=Object.prototype.hasOwnProperty;var Ct=(i,e)=>{for(var t in e)pt(i,t,{get:e[t],enumerable:!0})},Ot=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Rt(e))!Nt.call(i,n)&&n!==t&&pt(i,n,{get:()=>e[n],enumerable:!(s=_t(e,n))||s.enumerable});return i};var jt=i=>Ot(pt({},"__esModule",{value:!0}),i);var Se={};Ct(Se,{default:()=>ut});module.exports=jt(Se);var R=require("obsidian"),Mt=require("child_process"),at=require("fs"),dt=require("path");var S=require("obsidian"),mt={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",tagPresets:`work
\u5B66\u4E60
\u6548\u7387
\u8FD0\u7EF4
openclaw
obsidian
pixel`,boardLayout:"split",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function gt(i,e){let t=Number(i);return Number.isFinite(t)?t:e}var rt=class extends S.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new S.Setting(e).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(a=>{a.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Render board in note").setDesc("Replace Board.md with a draggable visual board in the note area (editor + preview).").addToggle(a=>{a.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async r=>{this.plugin.settings.renderBoardInNote=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Board layout").setDesc("Default layout for the in-note board UI.").addDropdown(a=>{a.addOption("split","Split (list + detail)"),a.addOption("kanban","Kanban (columns)"),a.setValue(this.plugin.settings.boardLayout||"split"),a.onChange(async r=>{this.plugin.settings.boardLayout=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new S.Setting(e).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(a=>{a.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Tag presets").setDesc("One tag per line. AI will prefer these tags when proposing/importing tasks.").addTextArea(a=>{a.setPlaceholder("work\\n\u5B66\u4E60\\n\u6548\u7387\\nopenclaw").setValue(this.plugin.settings.tagPresets||"").onChange(async r=>{this.plugin.settings.tagPresets=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(a=>{a.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Runtime Service"});let s=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:"Status: unchecked"}),n=async()=>{s.textContent=await this.plugin.refreshRuntimeStatus()};new S.Setting(e).setName("Runtime control").setDesc("Start/stop local ai-tasks-runtime and refresh status.").addButton(a=>{a.setButtonText("Check status").onClick(async()=>{await n()})}).addButton(a=>{a.setButtonText("Start").onClick(async()=>{await this.plugin.startRuntime(),await n()})}).addButton(a=>{a.setButtonText("Stop").onClick(async()=>{await this.plugin.stopRuntime(),await n()})}),new S.Setting(e).setName("Runtime start command").setDesc("Executable to start the runtime (e.g. ai-tasks-runtime).").addText(a=>{a.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime args").setDesc("Arguments for runtime start (e.g. serve).").addText(a=>{a.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime working directory").setDesc("Optional working directory for the runtime process.").addText(a=>{a.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Model Settings"}),new S.Setting(e).setName("Model provider").setDesc("codex-cli (local) or OpenAI-compatible API.").addDropdown(a=>{a.addOption("codex-cli","codex-cli (local)"),a.addOption("openai-compatible","OpenAI-compatible API"),a.setValue(this.plugin.settings.modelProvider),a.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new S.Setting(e).setName("Model name").setDesc("Model identifier (for OpenAI-compatible providers).").addText(a=>{a.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("API base URL").setDesc("Base URL for OpenAI-compatible API (e.g. https://api.openai.com).").addText(a=>{a.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("API key").setDesc("API key for OpenAI-compatible providers (stored locally).").addText(a=>{a.inputEl.type="password",a.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Temperature").setDesc("Sampling temperature (e.g. 0.2).").addText(a=>{a.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=gt(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Top P").setDesc("Nucleus sampling (0-1).").addText(a=>{a.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let o=gt(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,o)),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Max tokens").setDesc("Max output tokens (OpenAI-compatible).").addText(a=>{a.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let o=Math.max(0,Math.floor(gt(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=o,await this.plugin.saveSettings()})}),n()}};var O=require("obsidian");var ht="<!-- AI-TASKS:BEGIN -->",kt="<!-- AI-TASKS:END -->",vt=["Unassigned","Todo","Doing","Review","Done"],xt=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function W(i){if(!i.includes("\\n")&&!i.includes("\\r\\n")&&!i.includes(`\r
`))return{next:i,changed:!1};let e=i;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==i}}function wt(i){let e=i.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function Kt(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function Ht(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(n=>n.trim()).filter(n=>n.length>0)}return[]}function Vt(i){var t;let e=i.split(`
`);for(let s of e){let n=s.match(/^>\s*status::\s*(.+)\s*$/i);if(n!=null&&n[1])return(t=wt(n[1]))!=null?t:null}return null}function bt(i){let e=i.indexOf(ht),t=i.indexOf(kt);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${ht} / ${kt}).`);return{autoStart:e+ht.length,autoEnd:t}}function yt(i,e,t){var l;let n=i.slice(e,t).split(`
`),a=e,r=[];for(let c of n){let g=c.trimStart();if(g.startsWith("## ")){let u=g.slice(3).trim(),d=wt(u);if(d){let v=a+c.indexOf("## "),x=a+c.length;r.push({status:d,start:v,end:x})}}a+=c.length+1}let o=new Map;for(let c=0;c<r.length;c++){let g=r[c];if(!g)continue;let u=r[c+1],d=g.end+1,v=u?u.start:t,x=i.slice(d,v),m=[];xt.lastIndex=0;let h;for(;h=xt.exec(x);){let p=h[1];if(!p)continue;let b=h.index,y=d+b,w=`<!-- AI-TASKS:TASK ${p} END -->`,f=x.indexOf(w,b);if(f===-1)continue;let E=d+f+w.length;for(;E<i.length&&i[E]===`
`;){E+=1,E<i.length&&i[E]===`
`&&(E+=1);break}let A=i.slice(y,E),V=(l=Vt(A))!=null?l:g.status,$=Kt(A),F=Ht(A);m.push({uuid:p,title:$,status:V,tags:F,rawBlock:A,start:y,end:E})}o.set(g.status,{status:g.status,headingStart:g.start,headingEnd:g.end,sectionStart:d,sectionEnd:v,tasks:m})}return o}function M(i){let{autoStart:e,autoEnd:t}=bt(i),s=yt(i,e,t);return{content:i,autoStart:e,autoEnd:t,sections:s}}function Tt(i){let{autoStart:e,autoEnd:t}=bt(i),s=yt(i,e,t),n=vt.filter(c=>!s.has(c));if(n.length===0)return i;let a=[];for(let c of vt)n.includes(c)&&a.push(`## ${c}`,"");let r=a.join(`
`);r.endsWith(`
`)||(r+=`
`);let o=i.slice(0,t),l=i.slice(t);return o.length>0&&!o.endsWith(`
`)&&(o+=`
`),o+r+l}function qt(i,e){let t=i.split(`
`),s=!1,n=t.map(a=>a.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${e}`):a);if(!s)for(let a=0;a<n.length;a++){let r=n[a];if(r&&r.match(/^>\s*\[![^\]]+\]/)){n.splice(a+1,0,`> status:: ${e}`);break}}return n.join(`
`)}function St(i,e,t){let s=i.sections.get(e);if(!s)throw new Error(`Missing status section: ${e}`);if(t){for(let a of s.tasks)if(a.uuid===t)return a.start}let n=s.tasks.at(-1);return n?n.end:s.sectionStart}function Y(i,e,t,s){let n=Tt(i),a=M(n),r=null,o=null;for(let[b,y]of a.sections.entries()){for(let w of y.tasks)if(w.uuid===e){r=w,o=b;break}if(r)break}if(!r||!o)throw new Error(`Task not found: ${e}`);let l=s===e?null:s,c=r.rawBlock;o!==t&&(c=qt(c,t));let g=n.slice(0,r.start)+n.slice(r.end),u=M(g),d=St(u,t,l),v=g.slice(0,d),x=g.slice(d),m=v.length>0&&!v.endsWith(`
`),h=!c.endsWith(`
`),p=(m?`
`:"")+c+(h?`
`:"");return g=v+p+x,g}function Q(i,e,t,s){let n=Tt(i),a=M(n),r=St(a,e,t),o=n.slice(0,r),l=n.slice(r),c=o.length>0&&!o.endsWith(`
`),g=!s.endsWith(`
`),u=(c?`
`:"")+s+(g?`
`:"");return o+u+l}function ot(i,e,t){let s=M(i),n=null;for(let o of s.sections.values()){for(let l of o.tasks)if(l.uuid===e){n=l;break}if(n)break}if(!n)throw new Error(`Task not found: ${e}`);let a=!t.endsWith(`
`),r=t+(a?`
`:"");return i.slice(0,n.start)+r+i.slice(n.end)}function Bt(i,e){let t=M(i),s=null;for(let a of t.sections.values()){for(let r of a.tasks)if(r.uuid===e){s=r;break}if(s)break}if(!s)throw new Error(`Task not found: ${e}`);let n=i.slice(0,s.start)+i.slice(s.end);return{removed:s,next:n}}var At=require("obsidian");function Wt(){return new Date().toISOString().replace(/[:.]/g,"-")}function zt(i,e){var r;let s=((r=i.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${e}.md`),n=i.lastIndexOf("/Boards/");return n!==-1?`${i.slice(0,n)}/History/Boards/${s}`:`${i.split("/").slice(0,-1).join("/")}/History/${s}`}function Et(i,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),s=i.lastIndexOf("/Boards/");return s!==-1?`${i.slice(0,s)}/History/Logs/ai-tasks.${t}.jsonl`:`${i.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function C(i,e){let t=e.split("/").filter(n=>n.length>0),s="";for(let n of t)s=s?`${s}/${n}`:n,i.getAbstractFileByPath(s)||await i.createFolder(s)}async function _(i,e,t){let s=await i.read(e),n=Wt(),a=zt(e.path,n),r=a.split("/").slice(0,-1).join("/");await C(i,r),await i.create(a,s),await i.modify(e,t)}async function Pt(i,e,t){let s=e.split("/").slice(0,-1).join("/");s&&await C(i,s);let n=JSON.stringify(t)+`
`,a=i.getAbstractFileByPath(e);if(a instanceof At.TFile){let r=await i.read(a);await i.modify(a,r+n);return}await i.create(e,n)}async function D(i,e){let t=new Date().toISOString(),s=t.slice(0,10),n=Et(i.settings.boardPath,s);await Pt(i.app.vault,n,{ts:t,...e})}function ft(i){return i instanceof Error?i.message:String(i)}function Dt(i,e,t){let s=ft(e),n={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${i}: ${s}`,n)}function Gt(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Jt(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Yt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function Qt(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof O.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await C(i.app.vault,s),await i.app.vault.create(e,Yt())}function Xt(i,e){return i.replace(/\/+$/g,"")+e}async function Zt(i,e){let t=Xt(i.settings.runtimeUrl,"/v1/board/propose"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let n=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${n}`)}return await s.json()}function It(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function te(i){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">"),t.push(...It(i.body)),t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}function ee(i,e){var c,g,u;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),n=t.findIndex(d=>s.test(d.trim()));if(n===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(d=>/^>\\s*\\[![^\\]]+\\]/.test(d));if(a!==-1){let d=(c=t[a])==null?void 0:c.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),v=(g=d==null?void 0:d[1])!=null?g:"[!todo]";t[a]=`> ${v} ${e.title}`}let r=t.findIndex(d=>/^>\\s*status::/i.test(d));if(r!==-1)t[r]=`> status:: ${e.status}`;else{let d=a!==-1?a+1:1;t.splice(d,0,`> status:: ${e.status}`),r=d}if(e.tags.length>0){let d=t.findIndex(v=>/^>\\s*tags::/i.test(v));d!==-1?t[d]=`> tags:: ${e.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${e.tags.join(", ")}`)}let o=new Date().toISOString(),l=[];return l.push(">"),l.push("> ---"),l.push(`> updated:: ${o}`),(u=e.instruction)!=null&&u.trim()&&l.push(`> instruction:: ${e.instruction.trim()}`),l.push(...It(e.body)),t.splice(n,0,...l),t.join(`
`)+`
`}var tt=class extends O.Modal{constructor(t,s){var n;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(n=s.sourcePath)!=null?n:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let n=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});n.value=this.draft,n.addEventListener("input",()=>{this.draft=n.value});let a=t.createDiv({cls:"ai-tasks-instr-box"});a.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=a.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:"Generate preview"}),c=o.createEl("button",{text:"Confirm & write"}),g=o.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let u=t.createDiv({cls:"ai-tasks-draft-preview"}),d=u.createDiv({cls:"ai-tasks-draft-side"});d.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=d.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let v=u.createDiv({cls:"ai-tasks-draft-side"});v.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=v.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,l.addEventListener("click",async()=>{await this.generate()}),c.addEventListener("click",async()=>{await this.apply()}),g.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,n,a,r,o,l,c,g,u,d,v,x,m,h,p,b,y;try{this.setStatus("Generating preview..."),this.boardFile=await Qt(this.plugin);let w=await this.plugin.app.vault.read(this.boardFile),f=W(w);f.changed&&await _(this.plugin.app.vault,this.boardFile,f.next),this.boardContent=f.next;let B=M(this.boardContent),E=Array.from(B.sections.values()).flatMap(I=>I.tasks.map(P=>({uuid:P.uuid,title:P.title,status:P.status,tags:P.tags}))),A={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:E,ai_model:this.plugin.getModelConfig(),tag_presets:this.plugin.getTagPresets()};await D(this.plugin,{type:"board.propose.request",mode:A.mode,draft_len:A.draft.length,instruction_len:((t=A.instruction)!=null?t:"").length,tasks_count:A.tasks.length,tag_presets_count:(n=(s=A.tag_presets)==null?void 0:s.length)!=null?n:0,model_provider:(r=(a=A.ai_model)==null?void 0:a.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});try{this.proposal=await Zt(this.plugin,A),await D(this.plugin,{type:"board.propose.response",engine:(o=this.proposal.engine)!=null?o:null,provider:(l=this.proposal.provider)!=null?l:null,thread_id:(c=this.proposal.thread_id)!=null?c:null,ai_fallback:(g=this.proposal.ai_fallback)!=null?g:null,action:this.proposal.action,target_uuid:(u=this.proposal.target_uuid)!=null?u:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(d=this.proposal.confidence)!=null?d:null,reasoning:(v=this.proposal.reasoning)!=null?v:null})}catch(I){let P=I instanceof Error?I.message:String(I);throw await D(this.plugin,{type:"board.propose.error",error:P}),I}let V=this.proposal.action,$=Gt(this.proposal.status);if(V==="update"&&this.proposal.target_uuid){let I=this.proposal.target_uuid,P=null;for(let[k,T]of B.sections.entries()){for(let L of T.tasks)if(L.uuid===I){P={rawBlock:L.rawBlock,sectionStatus:k};break}if(P)break}if(!P)this.proposal.action="create";else{this.beforeBlock=P.rawBlock,this.afterBlock=ee(this.beforeBlock,{uuid:I,title:this.proposal.title||"(Untitled)",status:$,tags:(x=this.proposal.tags)!=null?x:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let k=ot(this.boardContent,I,this.afterBlock);P.sectionStatus!==$&&(k=Y(k,I,$,null)),this.nextBoardContent=k}}if(this.proposal.action==="create"){let I=Jt();this.beforeBlock="",this.afterBlock=te({uuid:I,title:this.proposal.title||"(Untitled)",status:$,tags:(m=this.proposal.tags)!=null?m:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let P=(y=(b=(p=(h=B.sections.get($))==null?void 0:h.tasks)==null?void 0:p[0])==null?void 0:b.uuid)!=null?y:null;this.nextBoardContent=Q(this.boardContent,$,P,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let F=[];this.proposal.engine&&F.push(`engine=${this.proposal.engine}`),this.proposal.thread_id&&F.push(`thread=${this.proposal.thread_id}`),this.proposal.ai_fallback&&F.push(`ai_fallback=${this.proposal.ai_fallback}`),this.proposal.reasoning&&F.push(this.proposal.reasoning),this.proposal.confidence!=null&&F.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(F.length?F.join(" | "):"Preview ready.")}catch(w){let f=ft(w);Dt("\u751F\u6210\u9884\u89C8\u5931\u8D25",w,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(`Failed: ${f}`),new O.Notice(`AI Tasks: \u9884\u89C8\u5931\u8D25\uFF1A${f}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}async apply(){var t,s,n,a,r,o;if(!this.boardFile){new O.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new O.Notice("AI Tasks: please generate preview first.");return}try{await _(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await D(this.plugin,{type:"board.write",via:"draft_modal",action:(s=(t=this.proposal)==null?void 0:t.action)!=null?s:null,target_uuid:(a=(n=this.proposal)==null?void 0:n.target_uuid)!=null?a:null}),new O.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(l){let c=ft(l);Dt("\u5199\u5165\u770B\u677F\u5931\u8D25",l,{boardPath:(o=(r=this.boardFile)==null?void 0:r.path)!=null?o:this.plugin.settings.boardPath}),new O.Notice(`AI Tasks: \u5199\u5165\u5931\u8D25\uFF1A${c}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}};var j=require("obsidian");var se=["Unassigned","Todo","Doing","Review","Done"];function Lt(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ie(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ae(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function ne(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof j.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await C(i.app.vault,s),await i.app.vault.create(e,ae())}function re(i,e){return i.replace(/\/+$/g,"")+e}async function oe(i,e){let t=re(i.settings.runtimeUrl,"/v1/board/split"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let n=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${n}`)}return await s.json()}function le(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function $t(i){let t=(i!=null?i:[]).filter(a=>typeof a=="string").flatMap(a=>a.split(/[,，]/g)).map(a=>a.trim()).filter(a=>a.length>0),s=new Set,n=[];for(let a of t){let r=a.toLowerCase();s.has(r)||(s.add(r),n.push(a))}return n}function ce(i){let e=new Date().toISOString(),t=(i.title||"").trim()||"(Untitled)",s=[];return s.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),s.push(`> [!todo] ${t}`),s.push(`> status:: ${i.status}`),i.tags.length>0&&s.push(`> tags:: ${i.tags.join(", ")}`),s.push(`> created:: ${e}`),i.sourcePath&&s.push(`> source:: [[${i.sourcePath}]]`),s.push(">"),i.body.trim().length>0?s.push(...le(i.body)):s.push(">"),s.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),s.join(`
`)+`
`}var J=class extends j.Modal{constructor(t,s){var n,a;super(t.app);this.instruction="";this.boardFile=null;this.tasks=[];this.proposalMeta=null;this.statusEl=null;this.listEl=null;this.plugin=t,this.sourcePath=(n=s.sourcePath)!=null?n:null,this.text=(a=s.selection)!=null?a:""}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-bulk-import-modal"),t.createEl("h2",{text:"AI Tasks: Import tasks"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Text to split into tasks (editable)"});let n=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});n.placeholder="Paste a task list here...",n.value=this.text,n.addEventListener("input",()=>{this.text=n.value});let a=t.createDiv({cls:"ai-tasks-instr-box"});a.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=a.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. Use tags from presets; keep titles short; group by category...",r.value=this.instruction,r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=o.createEl("button",{text:"Generate",cls:"mod-cta"}),c=o.createEl("button",{text:"Import to board"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""}),this.listEl=t.createDiv({cls:"ai-tasks-bulk-list"}),l.addEventListener("click",()=>void this.generate()),c.addEventListener("click",()=>void this.apply())}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}renderList(){var t;if(this.listEl){if(this.listEl.empty(),!this.tasks.length){this.listEl.createDiv({cls:"ai-tasks-board-empty",text:"(no tasks yet)"});return}for(let s of this.tasks){let n=this.listEl.createDiv({cls:"ai-tasks-bulk-row"}),a=(s.title||"").trim()||"(Untitled)",r=Lt((t=s.status)!=null?t:"Unassigned"),o=$t(s.tags);n.createDiv({cls:"ai-tasks-bulk-title",text:a}),n.createDiv({cls:"ai-tasks-bulk-meta",text:`${r}${o.length?" | "+o.join(", "):""}`})}}}async generate(){var t,s,n,a,r,o,l,c,g,u,d,v,x,m,h,p,b,y;try{this.setStatus("Generating..."),this.boardFile=await ne(this.plugin);let w={text:this.text,instruction:this.instruction||null,tag_presets:this.plugin.getTagPresets(),max_tasks:60,ai_model:this.plugin.getModelConfig()};await D(this.plugin,{type:"board.split.request",text_len:w.text.length,instruction_len:((t=w.instruction)!=null?t:"").length,tag_presets_count:(n=(s=w.tag_presets)==null?void 0:s.length)!=null?n:0,model_provider:(r=(a=w.ai_model)==null?void 0:a.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});let f=await oe(this.plugin,w);this.tasks=Array.isArray(f.tasks)?f.tasks.slice(0,Math.max(1,(o=w.max_tasks)!=null?o:60)):[],this.proposalMeta={engine:(l=f.engine)!=null?l:null,provider:(c=f.provider)!=null?c:null,thread_id:(g=f.thread_id)!=null?g:null,ai_fallback:(u=f.ai_fallback)!=null?u:null,reasoning:(d=f.reasoning)!=null?d:null,confidence:(v=f.confidence)!=null?v:null},await D(this.plugin,{type:"board.split.response",engine:(x=f.engine)!=null?x:null,provider:(m=f.provider)!=null?m:null,thread_id:(h=f.thread_id)!=null?h:null,ai_fallback:(p=f.ai_fallback)!=null?p:null,tasks_count:this.tasks.length,confidence:(b=f.confidence)!=null?b:null,reasoning:(y=f.reasoning)!=null?y:null}),this.renderList();let B=[];f.engine&&B.push(`engine=${f.engine}`),f.thread_id&&B.push(`thread=${f.thread_id}`),f.ai_fallback&&B.push(`ai_fallback=${f.ai_fallback}`),f.confidence!=null&&B.push(`confidence=${f.confidence.toFixed(2)}`),f.reasoning&&B.push(f.reasoning),this.setStatus(B.length?B.join(" | "):`Ready (${this.tasks.length} tasks).`)}catch(w){let f=w instanceof Error?w.message:String(w);this.setStatus(`Failed: ${f}`),new j.Notice(`AI Tasks: ${f}`)}}async apply(){var t,s,n,a,r,o,l,c,g,u,d,v,x;if(!this.boardFile){new j.Notice("AI Tasks: board file not ready.");return}if(!this.tasks.length){new j.Notice("AI Tasks: please generate tasks first.");return}try{let m=await this.plugin.app.vault.read(this.boardFile),h=W(m),p=h.next;h.changed&&(await _(this.plugin.app.vault,this.boardFile,h.next),await D(this.plugin,{type:"board.normalize_escaped_newlines"}));let b=M(p),y=new Map;for(let f of se){let B=(a=(n=(s=(t=b.sections.get(f))==null?void 0:t.tasks)==null?void 0:s[0])==null?void 0:n.uuid)!=null?a:null;y.set(f,B)}let w=[];for(let f of this.tasks){let B=(f.title||"").trim().slice(0,120)||"(Untitled)",E=Lt((r=f.status)!=null?r:"Unassigned"),A=$t(f.tags),V=String((o=f.body)!=null?o:"").trim(),$=ie(),F=ce({uuid:$,title:B,status:E,tags:A,body:V,sourcePath:this.sourcePath});p=Q(p,E,(l=y.get(E))!=null?l:null,F),w.push({uuid:$,title:B,status:E,tags:A})}await _(this.plugin.app.vault,this.boardFile,p),await D(this.plugin,{type:"board.bulk_import.write",via:"bulk_import_modal",tasks_count:w.length,engine:(g=(c=this.proposalMeta)==null?void 0:c.engine)!=null?g:null,provider:(d=(u=this.proposalMeta)==null?void 0:u.provider)!=null?d:null,thread_id:(x=(v=this.proposalMeta)==null?void 0:v.thread_id)!=null?x:null}),new j.Notice(`AI Tasks: imported ${w.length} tasks (history snapshot created).`),this.close()}catch(m){let h=m instanceof Error?m.message:String(m);new j.Notice(`AI Tasks: import failed: ${h}`)}}};var Ft=require("obsidian");var it=require("obsidian");var et=require("obsidian");var de=["Unassigned","Todo","Doing","Review","Done"];function ue(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function pe(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ge(i){let e=i.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(r=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(r.trim()));if(t===-1)return"";let s=e.findIndex(r=>r.trim()===">");return s===-1||s>=t?"":e.slice(s+1,t).map(r=>{let o=r.match(/^>\s?(.*)$/);return o?o[1]:r}).join(`
`).replace(/\n$/,"")}function he(i,e){var m,h;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(s===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(p=>/^>\s*\[![^\]]+\]/.test(p));if(n!==-1){let p=(m=t[n])==null?void 0:m.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),b=(h=p==null?void 0:p[1])!=null?h:"[!todo]";t[n]=`> ${b} ${e.title||"(Untitled)"}`}let a=t.findIndex(p=>/^>\s*status::/i.test(p));if(a!==-1)t[a]=`> status:: ${e.status}`;else{let p=n!==-1?n+1:1;t.splice(p,0,`> status:: ${e.status}`),a=p}let r=t.findIndex(p=>/^>\s*tags::/i.test(p));if(e.tags.length>0){let p=`> tags:: ${e.tags.join(", ")}`;r!==-1?t[r]=p:t.splice(a+1,0,p)}else r!==-1&&t.splice(r,1);let o=t.findIndex(p=>/^>\s*updated::/i.test(p)),l=`> updated:: ${e.updatedAtIso}`;if(o!==-1)t[o]=l;else{let p=t.findIndex(y=>/^>\s*created::/i.test(y)),b=p!==-1?p+1:a+1;t.splice(b,0,l)}let c=t.findIndex(p=>p.trim()===">");(c===-1||c>=s)&&(c=s,t.splice(c,0,">"));let g=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(g===-1)throw new Error("Malformed task block (missing END marker).");let u=[],d=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let p of d)p.trim()===""?u.push(">"):u.push(`> ${p}`);let v=t.slice(0,c+1),x=t.slice(g);return v.concat(u,x).join(`
`)+`
`}function fe(i){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title||"(Untitled)"}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">");for(let s of(i.body||"").replace(/\r\n/g,`
`).split(`
`))s.trim()===""?t.push(">"):t.push(`> ${s}`);return t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}var st=class extends et.Modal{constructor(e,t){var s,n,a,r,o;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(s=t.task)!=null?s:null,this.defaultStatus=(r=t.defaultStatus)!=null?r:(a=(n=this.task)==null?void 0:n.status)!=null?a:"Unassigned",this.sourcePath=(o=t.sourcePath)!=null?o:null,this.onDidWrite=t.onDidWrite}onOpen(){var x,m,h,p,b,y;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?"Edit task":"New task"});let s=e.createDiv({cls:"ai-tasks-form-row"});s.createDiv({cls:"ai-tasks-form-label",text:"Title"});let n=s.createEl("input",{type:"text",cls:"ai-tasks-form-input"});n.value=(m=(x=this.task)==null?void 0:x.title)!=null?m:"";let a=e.createDiv({cls:"ai-tasks-form-row"});a.createDiv({cls:"ai-tasks-form-label",text:"Status"});let r=a.createEl("select",{cls:"ai-tasks-form-select"});for(let w of de)r.add(new Option(w,w));r.value=(p=(h=this.task)==null?void 0:h.status)!=null?p:this.defaultStatus;let o=e.createDiv({cls:"ai-tasks-form-row"});o.createDiv({cls:"ai-tasks-form-label",text:"Tags (comma separated)"});let l=o.createEl("input",{type:"text",cls:"ai-tasks-form-input"});l.placeholder="e.g. release, bug, v1",l.value=((y=(b=this.task)==null?void 0:b.tags)!=null?y:[]).join(", ");let c=e.createDiv({cls:"ai-tasks-form-row"});c.createDiv({cls:"ai-tasks-form-label",text:"Body"});let g=c.createEl("textarea",{cls:"ai-tasks-form-textarea"});g.value=this.task?ge(this.task.rawBlock):"";let u=e.createDiv({cls:"ai-tasks-form-buttons"}),d=u.createEl("button",{text:"Save",cls:"mod-cta"});u.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),d.addEventListener("click",()=>{this.save({title:n.value,status:pe(r.value),tagsRaw:l.value,body:g.value})})}async save(e){var t,s,n,a,r,o;try{let l=e.tagsRaw.split(/[,，]/).map(m=>m.trim()).filter(m=>m.length>0),c=await this.plugin.app.vault.read(this.boardFile),u=W(c).next,d=M(u),v=new Date().toISOString(),x=u;if(this.task){let m=null,h=null;for(let[b,y]of d.sections.entries()){for(let w of y.tasks)if(w.uuid===this.task.uuid){m=w,h=b;break}if(m)break}if(!m||!h)throw new Error(`Task not found: ${this.task.uuid}`);let p=he(m.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:l,body:(t=e.body)!=null?t:"",updatedAtIso:v});x=ot(x,m.uuid,p),h!==e.status&&(x=Y(x,m.uuid,e.status,null)),await _(this.plugin.app.vault,this.boardFile,x),await D(this.plugin,{type:"task.edit",uuid:m.uuid,from_status:h,status:e.status})}else{let m=ue(),h=fe({uuid:m,title:e.title||"(Untitled)",status:e.status,tags:l,body:(s=e.body)!=null?s:"",sourcePath:this.sourcePath}),p=(o=(r=(a=(n=d.sections.get(e.status))==null?void 0:n.tasks)==null?void 0:a[0])==null?void 0:r.uuid)!=null?o:null;x=Q(x,e.status,p,h),await _(this.plugin.app.vault,this.boardFile,x),await D(this.plugin,{type:"task.create",uuid:m,status:e.status})}new et.Notice("AI Tasks: saved."),this.close(),this.onDidWrite()}catch(l){let c=l instanceof Error?l.message:String(l);new et.Notice(`AI Tasks: save failed: ${c}`)}}};var X=["Unassigned","Todo","Doing","Review","Done"];function me(){let i=new Date,e=String(i.getFullYear()),t=String(i.getMonth()+1).padStart(2,"0"),s=String(i.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}function ke(i,e){let t=(i||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function ve(i){return["---","schema: ai-tasks-archive/v1",`date: ${i}`,"---","",`# Archive ${i}`,"",""].join(`
`)}function xe(i,e){let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(l=>/^>\s*archived::/i.test(l));if(s!==-1)return t[s]=`> archived:: ${e}`,t.join(`
`)+`
`;let n=t.findIndex(l=>/^>\s*created::/i.test(l)),a=t.findIndex(l=>/^>\s*status::/i.test(l)),r=t.findIndex(l=>/^>\s*\[![^\]]+\]/.test(l)),o=n!==-1?n+1:a!==-1?a+1:r!==-1?r+1:1;return t.splice(o,0,`> archived:: ${e}`),t.join(`
`)+`
`}function we(i){return Array.from(new Set(i.flatMap(e=>e.tags))).sort()}function be(i,e){let t=e.trim().toLowerCase();return t?i.title.toLowerCase().includes(t)||i.tags.some(s=>s.toLowerCase().includes(t)):!0}var lt=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.selectedUuid=null;this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=W(e);return t.changed&&(await _(this.plugin.app.vault,this.boardFile,t.next),new it.Notice("AI Tasks: fixed escaped newlines in Board.md."),await D(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return be(e,this.searchText)}renderHeader(e,t){let s=e.createDiv({cls:"ai-tasks-board-header"});s.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let a=s.createDiv({cls:"ai-tasks-board-controls"}),r=a.createDiv({cls:"ai-tasks-board-layout"}),o=r.createEl("button",{text:"Split",cls:"ai-tasks-layout-btn"}),l=r.createEl("button",{text:"Kanban",cls:"ai-tasks-layout-btn"});(this.plugin.settings.boardLayout==="kanban"?"kanban":"split")==="split"?o.classList.add("is-active"):l.classList.add("is-active"),o.addEventListener("click",()=>{(async()=>(this.plugin.settings.boardLayout="split",await this.plugin.saveSettings(),await this.render(e)))()}),l.addEventListener("click",()=>{(async()=>(this.plugin.settings.boardLayout="kanban",await this.plugin.saveSettings(),await this.render(e)))()}),a.createEl("button",{text:"Import",cls:"ai-tasks-board-import"}).addEventListener("click",()=>{new J(this.plugin,{selection:"",sourcePath:this.boardFile.path}).open()});let u=a.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:"Search title/tags..."}});u.value=this.searchText,u.addEventListener("input",async()=>{this.searchText=u.value,await this.render(e)});let d=a.createEl("select",{cls:"ai-tasks-board-select"});d.add(new Option("All statuses","All"));for(let h of X)d.add(new Option(h,h));d.value=this.statusFilter,d.addEventListener("change",async()=>{let h=d.value;this.statusFilter=h==="All"?"All":h,await this.render(e)});let v=a.createDiv({cls:"ai-tasks-board-tags"}),x=v.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),m=v.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)m.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let h of t){let p=m.createEl("button",{cls:"ai-tasks-tag-chip",text:h});this.tagFilter.has(h)&&p.classList.add("is-active"),p.addEventListener("click",async b=>{b.preventDefault(),this.tagFilter.has(h)?this.tagFilter.delete(h):this.tagFilter.add(h),await this.render(e)})}x.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}extractBodyFromBlock(e){let t=e.replace(/\r\n/g,`
`).split(`
`),s=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+BEGIN\s*-->\s*$/i,n=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->\s*$/i,a=!1,r=[];for(let o of t){let l=o.trim();if(!s.test(l)){if(n.test(l))break;if(!a){l===">"&&(a=!0);continue}if(o.startsWith(">")){let c=o.slice(1);c.startsWith(" ")&&(c=c.slice(1)),r.push(c)}else r.push(o)}}if(r.length===0){for(let o of t)if(!(s.test(o.trim())||n.test(o.trim()))&&o.startsWith(">")){let l=o.slice(1);l.startsWith(" ")&&(l=l.slice(1)),r.push(l)}}return r.join(`
`).replace(/\n{3,}/g,`

`).trim()}createCard(e,t,s,n,a){let r=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});r.draggable=!0,r.addEventListener("click",u=>{var d,v;(v=(d=u.target)==null?void 0:d.closest)!=null&&v.call(d,"select, button, a, input, textarea")||a(t)});let o=r.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let l=o.createDiv({cls:"ai-task-actions"}),c=l.createEl("select",{cls:"ai-task-status"});for(let u of X)c.add(new Option(u,u));if(c.value=t.status,c.addEventListener("click",u=>u.stopPropagation()),c.addEventListener("change",async u=>{u.stopPropagation(),await s(t.uuid,c.value,null)}),l.createEl("button",{cls:"ai-task-edit",text:"Edit"}).addEventListener("click",u=>{u.stopPropagation(),a(t)}),t.status==="Done"&&l.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async d=>{d.stopPropagation(),await n(t.uuid)}),t.tags.length>0){let u=r.createDiv({cls:"ai-task-tags"});for(let d of t.tags)u.createSpan({cls:"ai-task-tag",text:d})}return r.addEventListener("dragstart",u=>{var d,v;(d=u.dataTransfer)==null||d.setData("application/x-ai-task-uuid",t.uuid),(v=u.dataTransfer)==null||v.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(e,t,s){e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async n=>{var c,g,u;n.preventDefault(),e.classList.remove("is-drop-target");let a=(c=n.dataTransfer)==null?void 0:c.getData("application/x-ai-task-uuid");if(!a)return;let r=n.target,o=(g=r==null?void 0:r.closest)==null?void 0:g.call(r,".ai-task-card"),l=(u=o==null?void 0:o.getAttribute("data-uuid"))!=null?u:null;await s(a,t,l)})}attachSplitDnD(e,t,s){e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async n=>{var c,g,u;n.preventDefault(),e.classList.remove("is-drop-target");let a=(c=n.dataTransfer)==null?void 0:c.getData("application/x-ai-task-uuid");if(!a)return;let r=n.target,o=(g=r==null?void 0:r.closest)==null?void 0:g.call(r,".ai-tasks-split-task"),l=(u=o==null?void 0:o.getAttribute("data-uuid"))!=null?u:null;await s(a,t,l)})}async appendToArchive(e,t,s,n){let a=t.split("/").slice(0,-1).join("/");a&&await C(e,a);let r=e.getAbstractFileByPath(t);if(r instanceof it.TFile){let o=await e.read(r),l=o.endsWith(`
`)?`
`:`

`;await e.modify(r,o+l+s);return}await e.create(t,ve(n)+s)}async render(e){var A,V,$,F,I,P;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t;try{t=await this.readBoardNormalized()}catch(k){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:k instanceof Error?k.message:"Failed to read Board.md."});return}let s;try{s=M(t)}catch(k){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:k instanceof Error?k.message:"Failed to parse Board.md (unknown error)."});return}let n=Array.from(s.sections.values()).flatMap(k=>k.tasks),a=we(n);this.renderHeader(e,a);let r=async(k,T,L)=>{let K=await this.readBoardNormalized(),H=Y(K,k,T,L);await _(this.plugin.app.vault,this.boardFile,H),await D(this.plugin,{type:"task.move",uuid:k,status:T,before_uuid:L}),await this.render(e)},o=async k=>{if(!window.confirm("Archive this task?"))return;let T=await this.readBoardNormalized(),{removed:L,next:K}=Bt(T,k),H=me(),z=ke(this.plugin.settings.archiveFolderPath,H),q=xe(L.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,z,q,H),await _(this.plugin.app.vault,this.boardFile,K),new it.Notice(`Archived task to ${z}`),await D(this.plugin,{type:"task.archive",uuid:k,archive_path:z}),await this.render(e)},l=k=>{new st(this.plugin,{boardFile:this.boardFile,task:k,onDidWrite:()=>{this.render(e)}}).open()},c=k=>{new st(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:k,onDidWrite:()=>{this.render(e)}}).open()};if((this.plugin.settings.boardLayout==="kanban"?"kanban":"split")==="kanban"){let k=e.createDiv({cls:"ai-tasks-board-columns"});for(let T of X){let L=k.createDiv({cls:"ai-tasks-column"}),K=L.createDiv({cls:"ai-tasks-column-head"});K.createDiv({cls:"ai-tasks-column-title",text:T}),K.createEl("button",{cls:"ai-tasks-column-add",text:"+ Add"}).addEventListener("click",()=>c(T));let z=L.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(z,T,r);let q=s.sections.get(T),N=((A=q==null?void 0:q.tasks)!=null?A:[]).filter(U=>this.shouldShowTask(U));for(let U of N)this.createCard(z,U,r,o,l)}return}let u=e.createDiv({cls:"ai-tasks-board-split"}),d=u.createDiv({cls:"ai-tasks-board-split-left"}),v=u.createDiv({cls:"ai-tasks-board-split-right"}),x=new Map;for(let k of n)x.set(k.uuid,k);let m=[];for(let k of X){let T=s.sections.get(k);m.push(...((V=T==null?void 0:T.tasks)!=null?V:[]).filter(L=>this.shouldShowTask(L)))}this.selectedUuid&&!x.has(this.selectedUuid)&&(this.selectedUuid=null),this.selectedUuid&&!m.some(k=>k.uuid===this.selectedUuid)&&(this.selectedUuid=null),!this.selectedUuid&&m.length>0&&(this.selectedUuid=(F=($=m[0])==null?void 0:$.uuid)!=null?F:null);for(let k of X){let T=s.sections.get(k),L=((I=T==null?void 0:T.tasks)!=null?I:[]).filter(N=>this.shouldShowTask(N)),K=d.createDiv({cls:"ai-tasks-split-section"}),H=K.createDiv({cls:"ai-tasks-split-section-head"});H.createDiv({cls:"ai-tasks-split-section-title",text:k}),H.createDiv({cls:"ai-tasks-split-section-count",text:String(L.length)}),H.createEl("button",{cls:"ai-tasks-split-add",text:"+ Add"}).addEventListener("click",()=>c(k));let q=K.createDiv({cls:"ai-tasks-split-tasklist"});this.attachSplitDnD(q,k,r);for(let N of L){let U=q.createDiv({cls:"ai-tasks-split-task",attr:{"data-uuid":N.uuid}});N.uuid===this.selectedUuid&&U.classList.add("is-selected"),U.draggable=!0,U.createDiv({cls:"ai-tasks-split-task-title",text:N.title}),N.tags.length>0&&U.createDiv({cls:"ai-tasks-split-task-tags",text:N.tags.join(", ")}),U.addEventListener("click",async nt=>{var G,Z;(Z=(G=nt.target)==null?void 0:G.closest)!=null&&Z.call(G,"select, button, a, input, textarea")||(this.selectedUuid=N.uuid,await this.render(e))}),U.addEventListener("dragstart",nt=>{var G,Z;(G=nt.dataTransfer)==null||G.setData("application/x-ai-task-uuid",N.uuid),(Z=nt.dataTransfer)==null||Z.setDragImage(U,8,8),U.classList.add("is-dragging")}),U.addEventListener("dragend",()=>{U.classList.remove("is-dragging")})}}let h=this.selectedUuid&&(P=x.get(this.selectedUuid))!=null?P:null;if(!h){v.createDiv({cls:"ai-tasks-detail-empty",text:"Select a task to view details."});return}let p=v.createDiv({cls:"ai-tasks-detail"});p.createDiv({cls:"ai-tasks-detail-title",text:h.title}),p.createDiv({cls:"ai-tasks-detail-uuid",text:h.uuid});let b=p.createDiv({cls:"ai-tasks-detail-meta"}),y=b.createEl("select",{cls:"ai-tasks-detail-status"});for(let k of X)y.add(new Option(k,k));if(y.value=h.status,y.addEventListener("change",async()=>{await r(h.uuid,y.value,null)}),b.createEl("button",{text:"Edit",cls:"ai-tasks-detail-edit"}).addEventListener("click",()=>l(h)),h.status==="Done"&&b.createEl("button",{text:"Archive",cls:"ai-tasks-detail-archive"}).addEventListener("click",async()=>{await o(h.uuid)}),h.tags.length>0){let k=p.createDiv({cls:"ai-tasks-detail-tags"});for(let T of h.tags)k.createSpan({cls:"ai-task-tag",text:T})}let f=p.createDiv({cls:"ai-tasks-detail-body"}),B=this.extractBodyFromBlock(h.rawBlock),E=f.createEl("pre",{cls:"ai-tasks-detail-body-pre"});E.textContent=B||"(no details)"}};var ct=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let s of e){let n=s.view;if(!(n instanceof Ft.MarkdownView))continue;let a=n.file;if(!a){this.unmount(n);continue}let r=!!this.plugin.settings.renderBoardInNote,o=a.path===this.plugin.settings.boardPath;if(!r||!o){this.unmount(n);continue}t.add(n),await this.mount(n,a)}for(let s of Array.from(this.overlays.keys()))t.has(s)||this.unmount(s)}async mount(e,t){let s=this.overlays.get(e);if(s&&s.file.path===t.path)return;s&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let n=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),a=new lt(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:n,panel:a});try{await a.render(n)}catch(r){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};function Ut(i,e){return i.replace(/\/+$/g,"")+e}function ye(i){var n,a;if(!i)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,s;for(;(s=t.exec(i))!==null;){let r=(a=(n=s[1])!=null?n:s[2])!=null?a:s[3];r&&e.push(r)}return e}function Te(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var ut=class extends R.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.boardOverlay=null}getPluginDir(){var n;let t=this.app.vault.adapter,s=(n=t==null?void 0:t.getBasePath)==null?void 0:n.call(t);return s?(0,dt.join)(s,this.app.vault.configDir,"plugins","ai-tasks-board"):null}async onload(){await this.loadSettings(),this.boardOverlay=new ct(this),this.addCommand({id:"open-ai-tasks-board-note",name:"AI Tasks: Open board note",callback:async()=>{let t=this.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);if(s instanceof R.TFile){await this.app.workspace.getLeaf().openFile(s);return}let n=t.split("/").slice(0,-1).join("/");n&&await C(this.app.vault,n);let a=await this.app.vault.create(t,Te());await this.app.workspace.getLeaf().openFile(a)}}),this.addCommand({id:"bulk-import-ai-tasks",name:"AI Tasks: Import tasks (AI)",callback:()=>{var s,n;let t=(n=(s=this.app.workspace.getActiveFile())==null?void 0:s.path)!=null?n:null;new J(this,{selection:"",sourcePath:t}).open()}}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var s;t.path===this.settings.boardPath&&((s=this.boardOverlay)==null||s.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,n)=>{let a=s.getSelection();!a||a.trim().length===0||(t.addItem(r=>{r.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var o;new tt(this,{mode:"create",selection:a,sourcePath:(o=n.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var o;new tt(this,{mode:"auto",selection:a,sourcePath:(o=n.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Import selection as tasks (AI)").setIcon("list-plus").onClick(()=>{var o;new J(this,{selection:a,sourcePath:(o=n.file)==null?void 0:o.path}).open()})}))})),this.addSettingTab(new rt(this.app,this))}onunload(){var t;(t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}async loadSettings(){this.settings=Object.assign({},mt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var s,n,a;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((s=this.settings.modelName)==null?void 0:s.trim())||void 0,base_url:((n=this.settings.modelBaseUrl)==null?void 0:n.trim())||void 0,api_key:((a=this.settings.modelApiKey)==null?void 0:a.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}getTagPresets(){let s=(this.settings.tagPresets||"").replace(/\r\n/g,`
`).split(/\n|[,，]/g).map(r=>r.trim()).filter(r=>r.length>0),n=new Set,a=[];for(let r of s){let o=r.toLowerCase();n.has(o)||(n.add(o),a.push(r))}return a}async startRuntime(){var a,r,o;if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new R.Notice("AI Tasks: runtime already running.");return}let t=this.settings.runtimeCommand.trim();if(!t){new R.Notice("AI Tasks: runtime command is empty.");return}let s=ye(this.settings.runtimeArgs||""),n=this.settings.runtimeCwd.trim()||void 0;try{let l=(0,Mt.spawn)(t,s,{cwd:n,windowsHide:!0,shell:!1});this.runtimeProcess=l,this.runtimePid=(a=l.pid)!=null?a:null;let c=this.getPluginDir();if(c)try{(0,at.mkdirSync)(c,{recursive:!0});let g=(0,dt.join)(c,"runtime.stdout.log"),u=(0,dt.join)(c,"runtime.stderr.log");(r=l.stdout)==null||r.on("data",d=>{(0,at.appendFileSync)(g,d.toString())}),(o=l.stderr)==null||o.on("data",d=>{(0,at.appendFileSync)(u,d.toString())}),console.info(`[ai-tasks-board] runtime logs: ${g} / ${u}`)}catch(g){console.error("[ai-tasks-board] failed to init runtime log files",g)}l.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),l.on("error",g=>{new R.Notice(`AI Tasks: runtime start failed: ${g.message}`)}),new R.Notice(`AI Tasks: runtime starting${l.pid?` (pid ${l.pid})`:""}.`)}catch(l){let c=l instanceof Error?l.message:String(l);new R.Notice(`AI Tasks: runtime start failed: ${c}`)}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new R.Notice("AI Tasks: runtime stop requested."):new R.Notice("AI Tasks: runtime not running.")}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),s=t==null?void 0:t.ok,n=s?"online":"offline";if(s&&(t!=null&&t.pid)&&(n+=` (pid ${t.pid})`),s&&typeof(t==null?void 0:t.uptime_s)=="number"){let a=Math.floor(t.uptime_s/60);n+=` uptime ${a}m`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(n+=` | local pid ${this.runtimePid}`),n}async fetchRuntimeStatus(){let t=Ut(this.settings.runtimeUrl,"/v1/runtime/status");try{let s=await fetch(t,{method:"GET"});return s.ok?await s.json():null}catch(s){return null}}async requestRuntimeShutdown(){let t=Ut(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(s){return!1}}};
