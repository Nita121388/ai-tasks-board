/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var N=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var pt=Object.getOwnPropertyNames;var gt=Object.prototype.hasOwnProperty;var ht=(s,i)=>{for(var t in i)N(s,t,{get:i[t],enumerable:!0})},mt=(s,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of pt(i))!gt.call(s,n)&&n!==t&&N(s,n,{get:()=>i[n],enumerable:!(e=ut(i,n))||e.enumerable});return s};var ft=s=>mt(N({},"__esModule",{value:!0}),s);var Ut={};ht(Ut,{default:()=>R});module.exports=ft(Ut);var T=require("obsidian"),ot=require("child_process"),D=require("fs"),L=require("path");var v=require("obsidian"),W={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1};function U(s,i){let t=Number(s);return Number.isFinite(t)?t:i}var C=class extends v.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),new v.Setting(i).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(a=>{a.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(a=>{a.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(a=>{a.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Runtime Service"});let e=i.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:"Status: unchecked"}),n=async()=>{e.textContent=await this.plugin.refreshRuntimeStatus()};new v.Setting(i).setName("Runtime control").setDesc("Start/stop local ai-tasks-runtime and refresh status.").addButton(a=>{a.setButtonText("Check status").onClick(async()=>{await n()})}).addButton(a=>{a.setButtonText("Start").onClick(async()=>{await this.plugin.startRuntime(),await n()})}).addButton(a=>{a.setButtonText("Stop").onClick(async()=>{await this.plugin.stopRuntime(),await n()})}),new v.Setting(i).setName("Runtime start command").setDesc("Executable to start the runtime (e.g. ai-tasks-runtime).").addText(a=>{a.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Runtime args").setDesc("Arguments for runtime start (e.g. serve).").addText(a=>{a.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new v.Setting(i).setName("Runtime working directory").setDesc("Optional working directory for the runtime process.").addText(a=>{a.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Model Settings"}),new v.Setting(i).setName("Model provider").setDesc("codex-cli (local) or OpenAI-compatible API.").addDropdown(a=>{a.addOption("codex-cli","codex-cli (local)"),a.addOption("openai-compatible","OpenAI-compatible API"),a.setValue(this.plugin.settings.modelProvider),a.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new v.Setting(i).setName("Model name").setDesc("Model identifier (for OpenAI-compatible providers).").addText(a=>{a.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("API base URL").setDesc("Base URL for OpenAI-compatible API (e.g. https://api.openai.com).").addText(a=>{a.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("API key").setDesc("API key for OpenAI-compatible providers (stored locally).").addText(a=>{a.inputEl.type="password",a.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Temperature").setDesc("Sampling temperature (e.g. 0.2).").addText(a=>{a.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=U(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Top P").setDesc("Nucleus sampling (0-1).").addText(a=>{a.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let c=U(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,c)),await this.plugin.saveSettings()})}),new v.Setting(i).setName("Max tokens").setDesc("Max output tokens (OpenAI-compatible).").addText(a=>{a.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let c=Math.max(0,Math.floor(U(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=c,await this.plugin.saveSettings()})}),n()}};var S=require("obsidian");var O="<!-- AI-TASKS:BEGIN -->",G="<!-- AI-TASKS:END -->",q=["Unassigned","Todo","Doing","Review","Done"],z=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function Y(s){let i=s.trim();return i==="Unassigned"?"Unassigned":i==="Todo"?"Todo":i==="Doing"?"Doing":i==="Review"?"Review":i==="Done"?"Done":null}function vt(s){let i=s.split(`
`);for(let t of i){let e=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(e!=null&&e[1])return e[1].trim()}return"(Untitled)"}function kt(s){let i=s.split(`
`);for(let t of i){let e=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(e!=null&&e[1])return e[1].split(/[,ï¼Œ]/).map(n=>n.trim()).filter(n=>n.length>0)}return[]}function wt(s){var t;let i=s.split(`
`);for(let e of i){let n=e.match(/^>\s*status::\s*(.+)\s*$/i);if(n!=null&&n[1])return(t=Y(n[1]))!=null?t:null}return null}function J(s){let i=s.indexOf(O),t=s.indexOf(G);if(i===-1||t===-1||t<=i)throw new Error(`Board is missing auto area markers (${O} / ${G}).`);return{autoStart:i+O.length,autoEnd:t}}function Q(s,i,t){var l;let n=s.slice(i,t).split(`
`),a=i,r=[];for(let d of n){let u=d.trimStart();if(u.startsWith("## ")){let p=u.slice(3).trim(),o=Y(p);if(o){let g=a+d.indexOf("## "),h=a+d.length;r.push({status:o,start:g,end:h})}}a+=d.length+1}let c=new Map;for(let d=0;d<r.length;d++){let u=r[d];if(!u)continue;let p=r[d+1],o=u.end+1,g=p?p.start:t,h=s.slice(o,g),m=[];z.lastIndex=0;let f;for(;f=z.exec(h);){let k=f[1];if(!k)continue;let w=f.index,B=o+w,y=`<!-- AI-TASKS:TASK ${k} END -->`,I=h.indexOf(y,w);if(I===-1)continue;let A=o+I+y.length;for(;A<s.length&&s[A]===`
`;){A+=1,A<s.length&&s[A]===`
`&&(A+=1);break}let $=s.slice(B,A),lt=(l=wt($))!=null?l:u.status,ct=vt($),dt=kt($);m.push({uuid:k,title:ct,status:lt,tags:dt,rawBlock:$,start:B,end:A})}c.set(u.status,{status:u.status,headingStart:u.start,headingEnd:u.end,sectionStart:o,sectionEnd:g,tasks:m})}return c}function b(s){let{autoStart:i,autoEnd:t}=J(s),e=Q(s,i,t);return{content:s,autoStart:i,autoEnd:t,sections:e}}function X(s){let{autoStart:i,autoEnd:t}=J(s),e=Q(s,i,t),n=q.filter(d=>!e.has(d));if(n.length===0)return s;let a=[];for(let d of q)n.includes(d)&&a.push(`## ${d}`,"");let r=a.join(`
`);r.endsWith(`
`)||(r+=`
`);let c=s.slice(0,t),l=s.slice(t);return c.length>0&&!c.endsWith(`
`)&&(c+=`
`),c+r+l}function xt(s,i){let t=s.split(`
`),e=!1,n=t.map(a=>a.match(/^>\s*status::\s*(.+)\s*$/i)?(e=!0,`> status:: ${i}`):a);if(!e)for(let a=0;a<n.length;a++){let r=n[a];if(r&&r.match(/^>\s*\[![^\]]+\]/)){n.splice(a+1,0,`> status:: ${i}`);break}}return n.join(`
`)}function Z(s,i,t){let e=s.sections.get(i);if(!e)throw new Error(`Missing status section: ${i}`);if(t){for(let a of e.tasks)if(a.uuid===t)return a.start}let n=e.tasks.at(-1);return n?n.end:e.sectionStart}function F(s,i,t,e){let n=X(s),a=b(n),r=null,c=null;for(let[w,B]of a.sections.entries()){for(let y of B.tasks)if(y.uuid===i){r=y,c=w;break}if(r)break}if(!r||!c)throw new Error(`Task not found: ${i}`);let l=e===i?null:e,d=r.rawBlock;c!==t&&(d=xt(d,t));let u=n.slice(0,r.start)+n.slice(r.end),p=b(u),o=Z(p,t,l),g=u.slice(0,o),h=u.slice(o),m=g.length>0&&!g.endsWith(`
`),f=!d.endsWith(`
`),k=(m?`
`:"")+d+(f?`
`:"");return u=g+k+h,u}function tt(s,i,t,e){let n=X(s),a=b(n),r=Z(a,i,t),c=n.slice(0,r),l=n.slice(r),d=c.length>0&&!c.endsWith(`
`),u=!e.endsWith(`
`),p=(d?`
`:"")+e+(u?`
`:"");return c+p+l}function et(s,i,t){let e=b(s),n=null;for(let c of e.sections.values()){for(let l of c.tasks)if(l.uuid===i){n=l;break}if(n)break}if(!n)throw new Error(`Task not found: ${i}`);let a=!t.endsWith(`
`),r=t+(a?`
`:"");return s.slice(0,n.start)+r+s.slice(n.end)}function st(s,i){let t=b(s),e=null;for(let a of t.sections.values()){for(let r of a.tasks)if(r.uuid===i){e=r;break}if(e)break}if(!e)throw new Error(`Task not found: ${i}`);let n=s.slice(0,e.start)+s.slice(e.end);return{removed:e,next:n}}var P="ai-tasks-board-view",_=["Unassigned","Todo","Doing","Review","Done"];function K(s){return s instanceof Error?s.message:String(s)}function j(s,i,t){let e=K(i),n={error:i,...t!=null?t:{}};console.error(`[ai-tasks-board] ${s}: ${e}`,n)}function Tt(){return new Date().toISOString().replace(/[:.]/g,"-")}function bt(s,i){var r;let e=((r=s.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${i}.md`),n=s.lastIndexOf("/Boards/");return n!==-1?`${s.slice(0,n)}/History/Boards/${e}`:`${s.split("/").slice(0,-1).join("/")}/History/${e}`}function St(){let s=new Date,i=String(s.getFullYear()),t=String(s.getMonth()+1).padStart(2,"0"),e=String(s.getDate()).padStart(2,"0");return`${i}-${t}-${e}`}function Bt(s,i){let t=(s||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${i}.md`:`${i}.md`}function yt(s){return["---","schema: ai-tasks-archive/v1",`date: ${s}`,"---","",`# Archive ${s}`,"",""].join(`
`)}function At(s,i){let t=s.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),e=t.findIndex(l=>/^>\s*archived::/i.test(l));if(e!==-1)return t[e]=`> archived:: ${i}`,t.join(`
`)+`
`;let n=t.findIndex(l=>/^>\s*created::/i.test(l)),a=t.findIndex(l=>/^>\s*status::/i.test(l)),r=t.findIndex(l=>/^>\s*\[![^\]]+\]/.test(l)),c=n!==-1?n+1:a!==-1?a+1:r!==-1?r+1:1;return t.splice(c,0,`> archived:: ${i}`),t.join(`
`)+`
`}async function V(s,i){let t=i.split("/").filter(n=>n.length>0),e="";for(let n of t)e=e?`${e}/${n}`:n,s.getAbstractFileByPath(e)||await s.createFolder(e)}var M=class extends S.ItemView{constructor(t,e){super(t);this.statusFilter="All";this.tagFilter=new Set;this.plugin=e}getViewType(){return P}getDisplayText(){return"AI Tasks Board"}getIcon(){return"layout-list"}async onOpen(){await this.render()}async onClose(){this.contentEl.empty()}async getBoardFile(){let t=this.plugin.settings.boardPath,e=this.app.vault.getAbstractFileByPath(t);return e instanceof S.TFile?e:null}async createDefaultBoard(){let t=this.plugin.settings.boardPath,e=t.split("/").slice(0,-1).join("/");e&&await V(this.app.vault,e);let n=["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`);await this.app.vault.create(t,n)}async snapshotBoard(t,e){let n=Tt(),a=bt(t.path,n),r=a.split("/").slice(0,-1).join("/");await V(this.app.vault,r),await this.app.vault.create(a,e)}async writeBoard(t,e){let n=await this.app.vault.read(t);await this.snapshotBoard(t,n),await this.app.vault.modify(t,e)}renderHeader(t,e){let n=t.createDiv({cls:"ai-tasks-board-header"});n.createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let a=n.createDiv({cls:"ai-tasks-board-controls"}),r=a.createEl("select",{cls:"ai-tasks-board-select"});r.add(new Option("All statuses","All"));for(let u of _)r.add(new Option(u,u));r.value=this.statusFilter,r.addEventListener("change",async()=>{let u=r.value;this.statusFilter=u==="All"?"All":u,await this.render()});let c=a.createDiv({cls:"ai-tasks-board-tags"}),l=c.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),d=c.createDiv({cls:"ai-tasks-board-tags-list"});if(e.length===0)d.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let u of e){let p=d.createEl("label",{cls:"ai-tasks-tag"}),o=p.createEl("input",{type:"checkbox"});o.checked=this.tagFilter.has(u),o.addEventListener("change",async()=>{o.checked?this.tagFilter.add(u):this.tagFilter.delete(u),await this.render()}),p.createSpan({text:u})}l.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render()})}shouldShowTask(t){if(this.statusFilter!=="All"&&t.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let e of this.tagFilter)if(t.tags.includes(e))return!0;return!1}return!0}createCard(t,e,n,a){let r=t.createDiv({cls:"ai-task-card",attr:{"data-uuid":e.uuid}});r.draggable=!0;let c=r.createDiv({cls:"ai-task-card-top"});c.createDiv({cls:"ai-task-title",text:e.title});let l=c.createEl("select",{cls:"ai-task-status"});for(let d of _)l.add(new Option(d,d));if(l.value=e.status,l.addEventListener("change",async()=>{await n(e.uuid,l.value,null)}),e.status==="Done"&&c.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async()=>{await a(e.uuid)}),e.tags.length>0){let d=r.createDiv({cls:"ai-task-tags"});for(let u of e.tags)d.createSpan({cls:"ai-task-tag",text:u})}return r.addEventListener("dragstart",d=>{var u,p,o;(u=d.dataTransfer)==null||u.setData("text/plain",e.uuid),(p=d.dataTransfer)==null||p.setData("application/x-ai-task-uuid",e.uuid),(o=d.dataTransfer)==null||o.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(t,e,n){t.addEventListener("dragover",a=>{a.preventDefault(),t.classList.add("is-drop-target")}),t.addEventListener("dragleave",()=>{t.classList.remove("is-drop-target")}),t.addEventListener("drop",async a=>{var u,p,o,g;a.preventDefault(),t.classList.remove("is-drop-target");let r=((u=a.dataTransfer)==null?void 0:u.getData("application/x-ai-task-uuid"))||((p=a.dataTransfer)==null?void 0:p.getData("text/plain"));if(!r)return;let c=a.target,l=(o=c==null?void 0:c.closest)==null?void 0:o.call(c,".ai-task-card"),d=(g=l==null?void 0:l.getAttribute("data-uuid"))!=null?g:null;await n(r,e,d)})}async render(){var u;let t=this.contentEl;t.empty(),t.addClass("ai-tasks-board-root");let e=await this.getBoardFile();if(!e){let p=t.createDiv({cls:"ai-tasks-board-empty"});p.createDiv({text:`Board file not found: ${this.plugin.settings.boardPath}`}),p.createEl("button",{text:"Create board"}).addEventListener("click",async()=>{await this.createDefaultBoard(),await this.render()});return}let n=await this.app.vault.read(e),a;try{a=b(n)}catch(p){j("\u89E3\u6790\u770B\u677F\u5931\u8D25",p,{boardPath:e.path}),t.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:p instanceof Error?p.message:"Failed to parse Board.md (unknown error)."});return}let r=Array.from(new Set(Array.from(a.sections.values()).flatMap(p=>p.tasks.flatMap(o=>o.tags)))).sort();this.renderHeader(t,r);let c=t.createDiv({cls:"ai-tasks-board-columns"}),l=async(p,o,g)=>{try{let h=await this.app.vault.read(e),m=F(h,p,o,g);await this.writeBoard(e,m),await this.render()}catch(h){j("\u79FB\u52A8\u4EFB\u52A1\u5931\u8D25",h,{boardPath:e.path,uuid:p,toStatus:o,beforeUuid:g}),new S.Notice(`AI Tasks: \u79FB\u52A8\u4EFB\u52A1\u5931\u8D25\uFF1A${K(h)}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}},d=async p=>{if(window.confirm("Archive this task?"))try{let o=await this.app.vault.read(e),{removed:g,next:h}=st(o,p),m=St(),f=Bt(this.plugin.settings.archiveFolderPath,m),k=At(g.rawBlock,new Date().toISOString()),w=f.split("/").slice(0,-1).join("/");w&&await V(this.app.vault,w);let B=this.app.vault.getAbstractFileByPath(f);if(B instanceof S.TFile){let y=await this.app.vault.read(B),I=y.endsWith(`
`)?`
`:`

`;await this.app.vault.modify(B,y+I+k)}else await this.app.vault.create(f,yt(m)+k);await this.writeBoard(e,h),new S.Notice(`Archived task to ${f}`),await this.render()}catch(o){j("\u5F52\u6863\u4EFB\u52A1\u5931\u8D25",o,{boardPath:e.path,uuid:p}),new S.Notice(`AI Tasks: \u5F52\u6863\u5931\u8D25\uFF1A${K(o)}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}};for(let p of _){let o=c.createDiv({cls:"ai-tasks-column"});o.createDiv({cls:"ai-tasks-column-title",text:p});let g=o.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(g,p,l);let h=a.sections.get(p),m=((u=h==null?void 0:h.tasks)!=null?u:[]).filter(f=>this.shouldShowTask(f));for(let f of m)this.createCard(g,f,l,d)}}};var x=require("obsidian");function H(s){return s instanceof Error?s.message:String(s)}function it(s,i,t){let e=H(i),n={error:i,...t!=null?t:{}};console.error(`[ai-tasks-board] ${s}: ${e}`,n)}function Pt(s){let i=(s!=null?s:"").trim();return i==="Todo"?"Todo":i==="Doing"?"Doing":i==="Review"?"Review":i==="Done"?"Done":"Unassigned"}function Et(){let s=globalThis.crypto;return s!=null&&s.randomUUID?s.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{let t=Math.floor(Math.random()*16);return(i==="x"?t:t&3|8).toString(16)})}function Dt(){return new Date().toISOString().replace(/[:.]/g,"-")}function It(s,i){var r;let e=((r=s.split("/").pop())!=null?r:"Board.md").replace(/\\.md$/i,`.${i}.md`),n=s.lastIndexOf("/Boards/");return n!==-1?`${s.slice(0,n)}/History/Boards/${e}`:`${s.split("/").slice(0,-1).join("/")}/History/${e}`}async function nt(s,i){let t=i.split("/").filter(n=>n.length>0),e="";for(let n of t)e=e?`${e}/${n}`:n,s.getAbstractFileByPath(e)||await s.createFolder(e)}function $t(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join("\\n")}async function Ct(s){let i=s.settings.boardPath,t=s.app.vault.getAbstractFileByPath(i);if(t instanceof x.TFile)return t;let e=i.split("/").slice(0,-1).join("/");return e&&await nt(s.app.vault,e),await s.app.vault.create(i,$t())}function Ft(s,i){return s.replace(/\/+$/g,"")+i}async function Mt(s,i){let t=Ft(s.settings.runtimeUrl,"/v1/board/propose"),e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!e.ok){let n=await e.text().catch(()=>"");throw new Error(`Runtime error (${e.status}): ${n}`)}return await e.json()}function at(s){return s.replace(/\\r\\n/g,"\\n").split("\\n").map(t=>t.length?`> ${t}`:">")}function Lt(s){let i=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${s.uuid} BEGIN -->`),t.push(`> [!todo] ${s.title}`),t.push(`> status:: ${s.status}`),s.tags.length>0&&t.push(`> tags:: ${s.tags.join(", ")}`),t.push(`> created:: ${i}`),s.sourcePath&&t.push(`> source:: [[${s.sourcePath}]]`),t.push(">"),t.push(...at(s.body)),t.push(`<!-- AI-TASKS:TASK ${s.uuid} END -->`),t.join("\\n")+"\\n"}function Rt(s,i){var d,u,p;let t=s.replace(/\\r\\n/g,"\\n").replace(/\\n$/,"").split("\\n"),e=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${i.uuid}\\s+END\\s*-->\\s*$`,"i"),n=t.findIndex(o=>e.test(o.trim()));if(n===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(o=>/^>\\s*\\[![^\\]]+\\]/.test(o));if(a!==-1){let o=(d=t[a])==null?void 0:d.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),g=(u=o==null?void 0:o[1])!=null?u:"[!todo]";t[a]=`> ${g} ${i.title}`}let r=t.findIndex(o=>/^>\\s*status::/i.test(o));if(r!==-1)t[r]=`> status:: ${i.status}`;else{let o=a!==-1?a+1:1;t.splice(o,0,`> status:: ${i.status}`),r=o}if(i.tags.length>0){let o=t.findIndex(g=>/^>\\s*tags::/i.test(g));o!==-1?t[o]=`> tags:: ${i.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${i.tags.join(", ")}`)}let c=new Date().toISOString(),l=[];return l.push(">"),l.push("> ---"),l.push(`> updated:: ${c}`),(p=i.instruction)!=null&&p.trim()&&l.push(`> instruction:: ${i.instruction.trim()}`),l.push(...at(i.body)),t.splice(n,0,...l),t.join("\\n")+"\\n"}var E=class extends x.Modal{constructor(t,e){var n;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=e.mode,this.sourcePath=(n=e.sourcePath)!=null?n:null,this.draft=e.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let e=t.createDiv({cls:"ai-tasks-draft-box"});e.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let n=e.createEl("textarea",{cls:"ai-tasks-draft-textarea"});n.value=this.draft,n.addEventListener("input",()=>{this.draft=n.value});let a=t.createDiv({cls:"ai-tasks-instr-box"});a.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=a.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let c=t.createDiv({cls:"ai-tasks-draft-buttons"}),l=c.createEl("button",{text:"Generate preview"}),d=c.createEl("button",{text:"Confirm & write"}),u=c.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let p=t.createDiv({cls:"ai-tasks-draft-preview"}),o=p.createDiv({cls:"ai-tasks-draft-side"});o.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=o.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let g=p.createDiv({cls:"ai-tasks-draft-side"});g.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=g.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,l.addEventListener("click",async()=>{await this.generate()}),d.addEventListener("click",async()=>{await this.apply()}),u.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,e,n,a,r,c;try{this.setStatus("Generating preview..."),this.boardFile=await Ct(this.plugin),this.boardContent=await this.plugin.app.vault.read(this.boardFile);let l=b(this.boardContent),d=Array.from(l.sections.values()).flatMap(h=>h.tasks.map(m=>({uuid:m.uuid,title:m.title,status:m.status,tags:m.tags}))),u={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:d,ai_model:this.plugin.getModelConfig()};this.proposal=await Mt(this.plugin,u);let p=this.proposal.action,o=Pt(this.proposal.status);if(p==="update"&&this.proposal.target_uuid){let h=this.proposal.target_uuid,m=null;for(let[f,k]of l.sections.entries()){for(let w of k.tasks)if(w.uuid===h){m={rawBlock:w.rawBlock,sectionStatus:f};break}if(m)break}if(!m)this.proposal.action="create";else{this.beforeBlock=m.rawBlock,this.afterBlock=Rt(this.beforeBlock,{uuid:h,title:this.proposal.title||"(Untitled)",status:o,tags:(t=this.proposal.tags)!=null?t:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let f=et(this.boardContent,h,this.afterBlock);m.sectionStatus!==o&&(f=F(f,h,o,null)),this.nextBoardContent=f}}if(this.proposal.action==="create"){let h=Et();this.beforeBlock="",this.afterBlock=Lt({uuid:h,title:this.proposal.title||"(Untitled)",status:o,tags:(e=this.proposal.tags)!=null?e:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let m=(c=(r=(a=(n=l.sections.get(o))==null?void 0:n.tasks)==null?void 0:a[0])==null?void 0:r.uuid)!=null?c:null;this.nextBoardContent=tt(this.boardContent,o,m,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let g=[];this.proposal.reasoning&&g.push(this.proposal.reasoning),this.proposal.confidence!=null&&g.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(g.length?g.join(" | "):"Preview ready.")}catch(l){let d=H(l);it("\u751F\u6210\u9884\u89C8\u5931\u8D25",l,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(`Failed: ${d}`),new x.Notice(`AI Tasks: \u9884\u89C8\u5931\u8D25\uFF1A${d}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}async apply(){var t,e;if(!this.boardFile){new x.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new x.Notice("AI Tasks: please generate preview first.");return}try{let n=await this.plugin.app.vault.read(this.boardFile),a=Dt(),r=It(this.boardFile.path,a),c=r.split("/").slice(0,-1).join("/");await nt(this.plugin.app.vault,c),await this.plugin.app.vault.create(r,n),await this.plugin.app.vault.modify(this.boardFile,this.nextBoardContent),new x.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(n){let a=H(n);it("\u5199\u5165\u770B\u677F\u5931\u8D25",n,{boardPath:(e=(t=this.boardFile)==null?void 0:t.path)!=null?e:this.plugin.settings.boardPath}),new x.Notice(`AI Tasks: \u5199\u5165\u5931\u8D25\uFF1A${a}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}};function rt(s,i){return s.replace(/\/+$/g,"")+i}function Nt(s){var n,a;if(!s)return[];let i=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,e;for(;(e=t.exec(s))!==null;){let r=(a=(n=e[1])!=null?n:e[2])!=null?a:e[3];r&&i.push(r)}return i}var R=class extends T.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null}getPluginDir(){var n;let t=this.app.vault.adapter,e=(n=t==null?void 0:t.getBasePath)==null?void 0:n.call(t);return e?(0,L.join)(e,this.app.vault.configDir,"plugins","ai-tasks-board"):null}async onload(){await this.loadSettings(),this.registerView(P,t=>new M(t,this)),this.addCommand({id:"open-ai-tasks-board",name:"Open AI Tasks board",callback:async()=>{await this.activateView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,n)=>{let a=e.getSelection();!a||a.trim().length===0||(t.addItem(r=>{r.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var c;new E(this,{mode:"create",selection:a,sourcePath:(c=n.file)==null?void 0:c.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var c;new E(this,{mode:"auto",selection:a,sourcePath:(c=n.file)==null?void 0:c.path}).open()})}))})),this.addSettingTab(new C(this.app,this))}onunload(){this.app.workspace.detachLeavesOfType(P)}async activateView(){var a;let e=this.app.workspace.getLeavesOfType(P)[0];if(e){this.app.workspace.revealLeaf(e);return}let n=(a=this.app.workspace.getRightLeaf(!1))!=null?a:this.app.workspace.getLeaf();await n.setViewState({type:P,active:!0}),this.app.workspace.revealLeaf(n)}async loadSettings(){this.settings=Object.assign({},W,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var e,n,a;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((e=this.settings.modelName)==null?void 0:e.trim())||void 0,base_url:((n=this.settings.modelBaseUrl)==null?void 0:n.trim())||void 0,api_key:((a=this.settings.modelApiKey)==null?void 0:a.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}async startRuntime(){var a,r,c;if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new T.Notice("AI Tasks: runtime already running.");return}let t=this.settings.runtimeCommand.trim();if(!t){new T.Notice("AI Tasks: runtime command is empty.");return}let e=Nt(this.settings.runtimeArgs||""),n=this.settings.runtimeCwd.trim()||void 0;try{let l=(0,ot.spawn)(t,e,{cwd:n,windowsHide:!0,shell:!1});this.runtimeProcess=l,this.runtimePid=(a=l.pid)!=null?a:null;let d=this.getPluginDir();if(d)try{(0,D.mkdirSync)(d,{recursive:!0});let u=(0,L.join)(d,"runtime.stdout.log"),p=(0,L.join)(d,"runtime.stderr.log");(r=l.stdout)==null||r.on("data",o=>{(0,D.appendFileSync)(u,o.toString())}),(c=l.stderr)==null||c.on("data",o=>{(0,D.appendFileSync)(p,o.toString())}),console.info(`[ai-tasks-board] runtime logs: ${u} / ${p}`)}catch(u){console.error("[ai-tasks-board] failed to init runtime log files",u)}l.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),l.on("error",u=>{new T.Notice(`AI Tasks: runtime start failed: ${u.message}`)}),new T.Notice(`AI Tasks: runtime starting${l.pid?` (pid ${l.pid})`:""}.`)}catch(l){let d=l instanceof Error?l.message:String(l);new T.Notice(`AI Tasks: runtime start failed: ${d}`)}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new T.Notice("AI Tasks: runtime stop requested."):new T.Notice("AI Tasks: runtime not running.")}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),e=t==null?void 0:t.ok,n=e?"online":"offline";if(e&&(t!=null&&t.pid)&&(n+=` (pid ${t.pid})`),e&&typeof(t==null?void 0:t.uptime_s)=="number"){let a=Math.floor(t.uptime_s/60);n+=` uptime ${a}m`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(n+=` | local pid ${this.runtimePid}`),n}async fetchRuntimeStatus(){let t=rt(this.settings.runtimeUrl,"/v1/runtime/status");try{let e=await fetch(t,{method:"GET"});return e.ok?await e.json():null}catch(e){return null}}async requestRuntimeShutdown(){let t=rt(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(e){return!1}}};
