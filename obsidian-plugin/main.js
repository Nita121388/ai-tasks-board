/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var At=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var le=(r,e)=>{for(var t in e)At(r,t,{get:e[t],enumerable:!0})},ue=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of re(e))!oe.call(r,i)&&i!==t&&At(r,i,{get:()=>e[i],enumerable:!(s=ae(e,i))||s.enumerable});return r};var de=r=>ue(At({},"__esModule",{value:!0}),r);var ts={};le(ts,{default:()=>Tt});module.exports=de(ts);var q=require("obsidian"),St=require("child_process"),z=require("fs"),ne=require("os"),N=require("path");var Lt=require("obsidian");function ce(){return new Date().toISOString().replace(/[:.]/g,"-")}function ge(r,e){var a;let s=((a=r.split("/").pop())!=null?a:"Board.md").replace(/\.md$/i,`.${e}.md`),i=r.lastIndexOf("/Boards/");return i!==-1?`${r.slice(0,i)}/History/Boards/${s}`:`${r.split("/").slice(0,-1).join("/")}/History/${s}`}function Ct(r,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),s=r.lastIndexOf("/Boards/");return s!==-1?`${r.slice(0,s)}/History/Logs/ai-tasks.${t}.jsonl`:`${r.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function Y(r,e){let t=e.split("/").filter(i=>i.length>0),s="";for(let i of t)s=s?`${s}/${i}`:i,r.getAbstractFileByPath(s)||await r.createFolder(s)}async function U(r,e,t){let s=await r.read(e),i=ce(),n=ge(e.path,i),a=n.split("/").slice(0,-1).join("/");await Y(r,a),await r.create(n,s),await r.modify(e,t)}async function $t(r,e,t){let s=e.split("/").slice(0,-1).join("/");s&&await Y(r,s);let i=JSON.stringify(t)+`
`,n=r.getAbstractFileByPath(e);if(n instanceof Lt.TFile){let a=await r.read(n);await r.modify(n,a+i);return}await r.create(e,i)}async function _(r,e){let t=new Date().toISOString(),s=t.slice(0,10),i=Ct(r.settings.boardPath,s);await $t(r.app.vault,i,{ts:t,...e})}var L=require("obsidian"),Pt={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",autoStartRuntime:!0,tagPresets:`work
\u5B66\u4E60
\u6548\u7387
\u8FD0\u7EF4
openclaw
obsidian
pixel`,boardLayout:"split",uiLanguage:"auto",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",codexCliPath:"",agentDir:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function Dt(r,e){let t=Number(r);return Number.isFinite(t)?t:e}var ht=class extends L.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new L.Setting(e).setName(this.plugin.t("settings.ui_language.name")).setDesc(this.plugin.t("settings.ui_language.desc")).addDropdown(o=>{o.addOption("auto",this.plugin.t("settings.ui_language.opt.auto")),o.addOption("zh-CN",this.plugin.t("settings.ui_language.opt.zh")),o.addOption("en",this.plugin.t("settings.ui_language.opt.en")),o.setValue(this.plugin.settings.uiLanguage||"auto"),o.onChange(async u=>{this.plugin.settings.uiLanguage=u,await this.plugin.saveSettings(),this.plugin.requestOverlayRefresh(),this.display()})}),new L.Setting(e).setName(this.plugin.t("settings.board_path.name")).setDesc(this.plugin.t("settings.board_path.desc")).addText(o=>{o.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async u=>{this.plugin.settings.boardPath=u.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new L.Setting(e).setName(this.plugin.t("settings.render_board_in_note.name")).setDesc(this.plugin.t("settings.render_board_in_note.desc")).addToggle(o=>{o.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async u=>{this.plugin.settings.renderBoardInNote=u,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new L.Setting(e).setName(this.plugin.t("settings.board_layout.name")).setDesc(this.plugin.t("settings.board_layout.desc")).addDropdown(o=>{o.addOption("split",this.plugin.t("settings.board_layout.opt.split")),o.addOption("kanban",this.plugin.t("settings.board_layout.opt.kanban")),o.addOption("md",this.plugin.t("settings.board_layout.opt.md")),o.setValue(this.plugin.settings.boardLayout||"split"),o.onChange(async u=>{this.plugin.settings.boardLayout=u,await this.plugin.saveSettings(),this.plugin.requestOverlayRefresh()})}),new L.Setting(e).setName(this.plugin.t("settings.archive_folder.name")).setDesc(this.plugin.t("settings.archive_folder.desc")).addText(o=>{o.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async u=>{this.plugin.settings.archiveFolderPath=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.tag_presets.name")).setDesc(this.plugin.t("settings.tag_presets.desc")).addTextArea(o=>{o.setPlaceholder("work\\n\u5B66\u4E60\\n\u6548\u7387\\nopenclaw").setValue(this.plugin.settings.tagPresets||"").onChange(async u=>{this.plugin.settings.tagPresets=u,await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.runtime_url.name")).setDesc(this.plugin.t("settings.runtime_url.desc")).addText(o=>{o.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async u=>{this.plugin.settings.runtimeUrl=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.runtime_auto_start.name")).setDesc(this.plugin.t("settings.runtime_auto_start.desc")).addToggle(o=>{o.setValue(!!this.plugin.settings.autoStartRuntime).onChange(async u=>{this.plugin.settings.autoStartRuntime=u,await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.runtime_service.heading")});let s=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:this.plugin.t("settings.runtime.status.unchecked")}),n=e.createDiv({cls:"ai-tasks-runtime-version"}).createSpan({text:""}),a=o=>{let u=this.plugin.t("settings.runtime.version.unknown"),d=this.plugin.getPluginVersion()||u,g=o&&o.trim()?o:u;n.textContent=this.plugin.t("settings.runtime.version.line",{plugin:d,runtime:g})},l=async()=>{let o=await this.plugin.refreshRuntimeStatus();s.textContent=o.text,a(o.runtimeVersion)};a(null),new L.Setting(e).setName(this.plugin.t("settings.runtime_control.name")).setDesc(this.plugin.t("settings.runtime_control.desc")).addButton(o=>{o.setButtonText(this.plugin.t("settings.runtime_control.btn.check")).onClick(async()=>{await l()})}).addButton(o=>{o.setButtonText(this.plugin.t("settings.runtime_control.btn.start")).onClick(async()=>{await this.plugin.startRuntime(),await l()})}).addButton(o=>{o.setButtonText(this.plugin.t("settings.runtime_control.btn.stop")).onClick(async()=>{await this.plugin.stopRuntime(),await l()})}),new L.Setting(e).setName(this.plugin.t("settings.runtime_command.name")).setDesc(this.plugin.t("settings.runtime_command.desc")).addText(o=>{o.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async u=>{this.plugin.settings.runtimeCommand=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.runtime_args.name")).setDesc(this.plugin.t("settings.runtime_args.desc")).addText(o=>{o.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async u=>{this.plugin.settings.runtimeArgs=u,await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.runtime_cwd.name")).setDesc(this.plugin.t("settings.runtime_cwd.desc")).addText(o=>{o.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async u=>{this.plugin.settings.runtimeCwd=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.agent_dir.name")).setDesc(this.plugin.t("settings.agent_dir.desc")).addText(o=>{o.setPlaceholder("E:\\\\File\\\\NitaFile\\\\Obsidian\\\\Obsidian\\\\AI Tasks Agent").setValue(this.plugin.settings.agentDir||"").onChange(async u=>{this.plugin.settings.agentDir=u.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.model.heading")}),new L.Setting(e).setName(this.plugin.t("settings.model_provider.name")).setDesc(this.plugin.t("settings.model_provider.desc")).addDropdown(o=>{o.addOption("codex-cli",this.plugin.t("settings.model_provider.opt.codex")),o.addOption("openai-compatible",this.plugin.t("settings.model_provider.opt.openai")),o.setValue(this.plugin.settings.modelProvider),o.onChange(async u=>{this.plugin.settings.modelProvider=u,await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.codex_cli_path.name")).setDesc(this.plugin.t("settings.codex_cli_path.desc")).addText(o=>{o.setPlaceholder("C:\\\\path\\\\to\\\\codex.exe").setValue(this.plugin.settings.codexCliPath||"").onChange(async u=>{this.plugin.settings.codexCliPath=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_name.name")).setDesc(this.plugin.t("settings.model_name.desc")).addText(o=>{o.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async u=>{this.plugin.settings.modelName=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_base_url.name")).setDesc(this.plugin.t("settings.model_base_url.desc")).addText(o=>{o.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async u=>{this.plugin.settings.modelBaseUrl=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_api_key.name")).setDesc(this.plugin.t("settings.model_api_key.desc")).addText(o=>{o.inputEl.type="password",o.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async u=>{this.plugin.settings.modelApiKey=u.trim(),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_temperature.name")).setDesc(this.plugin.t("settings.model_temperature.desc")).addText(o=>{o.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async u=>{this.plugin.settings.modelTemperature=Dt(u,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_top_p.name")).setDesc(this.plugin.t("settings.model_top_p.desc")).addText(o=>{o.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async u=>{let d=Dt(u,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,d)),await this.plugin.saveSettings()})}),new L.Setting(e).setName(this.plugin.t("settings.model_max_tokens.name")).setDesc(this.plugin.t("settings.model_max_tokens.desc")).addText(o=>{o.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async u=>{let d=Math.max(0,Math.floor(Dt(u,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=d,await this.plugin.saveSettings()})}),e.createEl("h3",{text:this.plugin.t("settings.diagnostics.heading")}),new L.Setting(e).setName(this.plugin.t("settings.diagnostics.test_ai.name")).setDesc(this.plugin.t("settings.diagnostics.test_ai.desc")).addButton(o=>{o.setButtonText(this.plugin.t("settings.diagnostics.test_ai.btn")).onClick(async()=>{await this.plugin.runTestAi()})}),new L.Setting(e).setName(this.plugin.t("settings.diagnostics.test_agent.name")).setDesc(this.plugin.t("settings.diagnostics.test_agent.desc")).addButton(o=>{o.setButtonText(this.plugin.t("settings.diagnostics.test_agent.btn")).onClick(async()=>{await this.plugin.runTestAgent()})}),l()}};var X=require("obsidian");var Bt="<!-- AI-TASKS:BEGIN -->",Nt="<!-- AI-TASKS:END -->",Ot=["Unassigned","Todo","Doing","Review","Done"],Mt=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function Q(r){if(!r.includes("\\n")&&!r.includes("\\r\\n")&&!r.includes(`\r
`))return{next:r,changed:!1};let e=r;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==r}}function Ft(r){let e=r.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function pe(r){let e=r.split(`
`);for(let t of e){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function he(r){let e=r.split(`
`);for(let t of e){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(i=>i.trim()).filter(i=>i.length>0)}return[]}function me(r){let e=r.split(`
`);for(let t of e){let s=t.match(/^>\s*sessions::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(i=>i.trim()).filter(i=>i.length>0)}return[]}function fe(r){var t;let e=r.split(`
`);for(let s of e){let i=s.match(/^>\s*status::\s*(.+)\s*$/i);if(i!=null&&i[1])return(t=Ft(i[1]))!=null?t:null}return null}function Ut(r){let e=r.indexOf(Bt),t=r.indexOf(Nt);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${Bt} / ${Nt}).`);return{autoStart:e+Bt.length,autoEnd:t}}function qt(r,e,t){var o;let i=r.slice(e,t).split(`
`),n=e,a=[];for(let u of i){let d=u.trimStart();if(d.startsWith("## ")){let g=d.slice(3).trim(),p=Ft(g);if(p){let h=n+u.indexOf("## "),c=n+u.length;a.push({status:p,start:h,end:c})}}n+=u.length+1}let l=new Map;for(let u=0;u<a.length;u++){let d=a[u];if(!d)continue;let g=a[u+1],p=d.end+1,h=g?g.start:t,c=r.slice(p,h),f=[];Mt.lastIndex=0;let v;for(;v=Mt.exec(c);){let b=v[1];if(!b)continue;let A=v.index,B=p+A,k=`<!-- AI-TASKS:TASK ${b} END -->`,S=c.indexOf(k,A);if(S===-1)continue;let y=p+S+k.length;for(;y<r.length&&r[y]===`
`;){y+=1,y<r.length&&r[y]===`
`&&(y+=1);break}let T=r.slice(B,y),D=(o=fe(T))!=null?o:d.status,m=pe(T),x=he(T),P=me(T);f.push({uuid:b,title:m,status:D,tags:x,sessions:P,rawBlock:T,start:B,end:y})}l.set(d.status,{status:d.status,headingStart:d.start,headingEnd:d.end,sectionStart:p,sectionEnd:h,tasks:f})}return l}function W(r){let{autoStart:e,autoEnd:t}=Ut(r),s=qt(r,e,t);return{content:r,autoStart:e,autoEnd:t,sections:s}}function jt(r){let{autoStart:e,autoEnd:t}=Ut(r),s=qt(r,e,t),i=Ot.filter(u=>!s.has(u));if(i.length===0)return r;let n=[];for(let u of Ot)i.includes(u)&&n.push(`## ${u}`,"");let a=n.join(`
`);a.endsWith(`
`)||(a+=`
`);let l=r.slice(0,t),o=r.slice(t);return l.length>0&&!l.endsWith(`
`)&&(l+=`
`),l+a+o}function be(r,e){let t=r.split(`
`),s=!1,i=t.map(n=>n.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${e}`):n);if(!s)for(let n=0;n<i.length;n++){let a=i[n];if(a&&a.match(/^>\s*\[![^\]]+\]/)){i.splice(n+1,0,`> status:: ${e}`);break}}return i.join(`
`)}function Kt(r,e,t){let s=r.sections.get(e);if(!s)throw new Error(`Missing status section: ${e}`);if(t){for(let n of s.tasks)if(n.uuid===t)return n.start}let i=s.tasks.at(-1);return i?i.end:s.sectionStart}function at(r,e,t,s){let i=jt(r),n=W(i),a=null,l=null;for(let[A,B]of n.sections.entries()){for(let k of B.tasks)if(k.uuid===e){a=k,l=A;break}if(a)break}if(!a||!l)throw new Error(`Task not found: ${e}`);let o=s===e?null:s,u=a.rawBlock;l!==t&&(u=be(u,t));let d=i.slice(0,a.start)+i.slice(a.end),g=W(d),p=Kt(g,t,o),h=d.slice(0,p),c=d.slice(p),f=h.length>0&&!h.endsWith(`
`),v=!u.endsWith(`
`),b=(f?`
`:"")+u+(v?`
`:"");return d=h+b+c,d}function rt(r,e,t,s){let i=jt(r),n=W(i),a=Kt(n,e,t),l=i.slice(0,a),o=i.slice(a),u=l.length>0&&!l.endsWith(`
`),d=!s.endsWith(`
`),g=(u?`
`:"")+s+(d?`
`:"");return l+g+o}function mt(r,e,t){let s=W(r),i=null;for(let l of s.sections.values()){for(let o of l.tasks)if(o.uuid===e){i=o;break}if(i)break}if(!i)throw new Error(`Task not found: ${e}`);let n=!t.endsWith(`
`),a=t+(n?`
`:"");return r.slice(0,i.start)+a+r.slice(i.end)}function It(r,e){let t=W(r),s=null;for(let n of t.sections.values()){for(let a of n.tasks)if(a.uuid===e){s=a;break}if(s)break}if(!s)throw new Error(`Task not found: ${e}`);let i=r.slice(0,s.start)+r.slice(s.end);return{removed:s,next:i}}var M=class extends Error{constructor(e,t){super(e),this.name="RuntimeHttpError",this.meta=t}};function Vt(r,e){let t=(r||"").trim();return t.length<=e?t:t.slice(0,e)+"...[truncated]"}function G(){let r=globalThis.crypto;return r!=null&&r.randomUUID?r.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ke(r,e){return r.replace(/\/+$/g,"")+e}async function J(r,e){var u,d;let t=ke(r.settings.runtimeUrl,e.path),s=(u=e.method)!=null?u:e.body===void 0?"GET":"POST",i=(e.request_id||"").trim()||G(),n=Date.now(),a=new AbortController,l=Math.max(1,(d=e.timeout_ms)!=null?d:18e4),o=setTimeout(()=>a.abort(),l);try{let g={"X-Request-ID":i};e.body!==void 0&&(g["Content-Type"]="application/json");let p=await fetch(t,{method:s,headers:g,body:e.body===void 0?void 0:JSON.stringify(e.body),signal:a.signal}),h=await p.text().catch(()=>""),c={request_id:i,url:t,method:s,latency_ms:Math.max(0,Date.now()-n),http_status:p.status,ok:!1,response_text_len:h.length,response_snip:Vt(h,800)};if(!p.ok)throw new M(`Runtime error (${p.status}): ${Vt(h,400)}`,c);try{let f=JSON.parse(h);return c.ok=!0,{json:f,text:h,meta:c}}catch(f){throw new M("Runtime returned invalid JSON.",c)}}catch(g){if(g instanceof M)throw g;let p=g instanceof Error?g.message:String(g),h={request_id:i,url:t,method:s,latency_ms:Math.max(0,Date.now()-n),http_status:null,ok:!1,response_text_len:0,response_snip:""};throw new M(p,h)}finally{clearTimeout(o)}}function Et(r){return r instanceof Error?r.message:String(r)}function Wt(r,e,t){let s=Et(e),i={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${r}: ${s}`,i)}function ve(r){let e=(r!=null?r:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function _e(){let r=globalThis.crypto;return r!=null&&r.randomUUID?r.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ye(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function we(r){let e=r.settings.boardPath,t=r.app.vault.getAbstractFileByPath(e);if(t instanceof X.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await Y(r.app.vault,s),await r.app.vault.create(e,ye())}function Ht(r){return r.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function xe(r){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${r.uuid} BEGIN -->`),t.push(`> [!todo] ${r.title}`),t.push(`> status:: ${r.status}`),r.tags.length>0&&t.push(`> tags:: ${r.tags.join(", ")}`),t.push(`> created:: ${e}`),r.sourcePath&&t.push(`> source:: [[${r.sourcePath}]]`),t.push(">"),t.push(...Ht(r.body)),t.push(`<!-- AI-TASKS:TASK ${r.uuid} END -->`),t.join(`
`)+`
`}function Se(r,e){var u,d,g;let t=r.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),i=t.findIndex(p=>s.test(p.trim()));if(i===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(p=>/^>\\s*\\[![^\\]]+\\]/.test(p));if(n!==-1){let p=(u=t[n])==null?void 0:u.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),h=(d=p==null?void 0:p[1])!=null?d:"[!todo]";t[n]=`> ${h} ${e.title}`}let a=t.findIndex(p=>/^>\\s*status::/i.test(p));if(a!==-1)t[a]=`> status:: ${e.status}`;else{let p=n!==-1?n+1:1;t.splice(p,0,`> status:: ${e.status}`),a=p}if(e.tags.length>0){let p=t.findIndex(h=>/^>\\s*tags::/i.test(h));p!==-1?t[p]=`> tags:: ${e.tags.join(", ")}`:t.splice(a+1,0,`> tags:: ${e.tags.join(", ")}`)}let l=new Date().toISOString(),o=[];return o.push(">"),o.push("> ---"),o.push(`> updated:: ${l}`),(g=e.instruction)!=null&&g.trim()&&o.push(`> instruction:: ${e.instruction.trim()}`),o.push(...Ht(e.body)),t.splice(i,0,...o),t.join(`
`)+`
`}var ut=class extends X.Modal{constructor(t,s){var i;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(i=s.sourcePath)!=null?i:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?this.plugin.t("draft_modal.title.add"):this.plugin.t("draft_modal.title.update")});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.draft")});let i=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});i.value=this.draft,i.addEventListener("input",()=>{this.draft=i.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.instruction")});let a=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.placeholder=this.plugin.t("draft_modal.placeholder.instruction"),a.addEventListener("input",()=>{this.instruction=a.value});let l=t.createDiv({cls:"ai-tasks-draft-buttons"}),o=l.createEl("button",{text:this.plugin.t("draft_modal.btn.generate_preview")}),u=l.createEl("button",{text:this.plugin.t("draft_modal.btn.confirm_write")}),d=l.createEl("button",{text:this.plugin.t("btn.cancel")});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let g=t.createDiv({cls:"ai-tasks-draft-preview"}),p=g.createDiv({cls:"ai-tasks-draft-side"});p.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.before")}),this.beforeEl=p.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let h=g.createDiv({cls:"ai-tasks-draft-side"});h.createDiv({cls:"ai-tasks-draft-label",text:this.plugin.t("draft_modal.label.after")}),this.afterEl=h.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,o.addEventListener("click",async()=>{await this.generate()}),u.addEventListener("click",async()=>{await this.apply()}),d.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,i,n,a,l,o,u,d,g,p,h,c,f,v,b,A,B,k,S,w,y;try{this.setStatus(this.plugin.t("draft_modal.status.generating")),this.boardFile=await we(this.plugin);let T=await this.plugin.app.vault.read(this.boardFile),D=Q(T);D.changed&&await U(this.plugin.app.vault,this.boardFile,D.next),this.boardContent=D.next;let m=W(this.boardContent),x=Array.from(m.sections.values()).flatMap(E=>E.tasks.map(R=>({uuid:R.uuid,title:R.title,status:R.status,tags:R.tags}))),P={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:x,ai_model:this.plugin.getModelConfig(),tag_presets:this.plugin.getTagPresets()},K=G();await _(this.plugin,{type:"board.propose.request",request_id:K,mode:P.mode,draft_len:P.draft.length,instruction_len:((t=P.instruction)!=null?t:"").length,tasks_count:P.tasks.length,tag_presets_count:(i=(s=P.tag_presets)==null?void 0:s.length)!=null?i:0,model_provider:(a=(n=P.ai_model)==null?void 0:n.provider)!=null?a:null,runtime_url:this.plugin.settings.runtimeUrl});try{let E=await J(this.plugin,{path:"/v1/board/propose",method:"POST",body:P,request_id:K});this.proposal=E.json,await _(this.plugin,{type:"board.propose.response",request_id:E.meta.request_id,latency_ms:E.meta.latency_ms,http_status:E.meta.http_status,response_text_len:E.meta.response_text_len,engine:(l=this.proposal.engine)!=null?l:null,provider:(o=this.proposal.provider)!=null?o:null,thread_id:(u=this.proposal.thread_id)!=null?u:null,ai_fallback:(d=this.proposal.ai_fallback)!=null?d:null,action:this.proposal.action,target_uuid:(g=this.proposal.target_uuid)!=null?g:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(p=this.proposal.confidence)!=null?p:null,reasoning:(h=this.proposal.reasoning)!=null?h:null})}catch(E){let R=E instanceof Error?E.message:String(E),I=E instanceof M?E.meta:null;throw await _(this.plugin,{type:"board.propose.error",request_id:(c=I==null?void 0:I.request_id)!=null?c:K,latency_ms:(f=I==null?void 0:I.latency_ms)!=null?f:null,http_status:(v=I==null?void 0:I.http_status)!=null?v:null,response_snip:(b=I==null?void 0:I.response_snip)!=null?b:null,error:R}),E}let H=this.proposal.action,j=ve(this.proposal.status);if(H==="update"&&this.proposal.target_uuid){let E=this.proposal.target_uuid,R=null;for(let[I,O]of m.sections.entries()){for(let $ of O.tasks)if($.uuid===E){R={rawBlock:$.rawBlock,sectionStatus:I};break}if(R)break}if(!R)this.proposal.action="create";else{this.beforeBlock=R.rawBlock,this.afterBlock=Se(this.beforeBlock,{uuid:E,title:this.proposal.title||"(Untitled)",status:j,tags:(A=this.proposal.tags)!=null?A:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let I=mt(this.boardContent,E,this.afterBlock);R.sectionStatus!==j&&(I=at(I,E,j,null)),this.nextBoardContent=I}}if(this.proposal.action==="create"){let E=_e();this.beforeBlock="",this.afterBlock=xe({uuid:E,title:this.proposal.title||"(Untitled)",status:j,tags:(B=this.proposal.tags)!=null?B:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let R=(y=(w=(S=(k=m.sections.get(j))==null?void 0:k.tasks)==null?void 0:S[0])==null?void 0:w.uuid)!=null?y:null;this.nextBoardContent=rt(this.boardContent,j,R,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let F=[];this.proposal.engine&&F.push(`engine=${this.proposal.engine}`),this.proposal.thread_id&&F.push(`thread=${this.proposal.thread_id}`),this.proposal.ai_fallback&&F.push(`ai_fallback=${this.proposal.ai_fallback}`),this.proposal.reasoning&&F.push(this.proposal.reasoning),this.proposal.confidence!=null&&F.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(F.length?F.join(" | "):this.plugin.t("draft_modal.status.preview_ready"))}catch(T){let D=Et(T);Wt("\u751F\u6210\u9884\u89C8\u5931\u8D25",T,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(this.plugin.t("draft_modal.status.failed",{error:D})),new X.Notice(this.plugin.t("draft_modal.notice.preview_failed",{error:D}))}}async apply(){var t,s,i,n,a,l;if(!this.boardFile){new X.Notice(this.plugin.t("draft_modal.notice.board_not_ready"));return}if(!this.nextBoardContent){new X.Notice(this.plugin.t("draft_modal.notice.generate_first"));return}try{await U(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await _(this.plugin,{type:"board.write",via:"draft_modal",action:(s=(t=this.proposal)==null?void 0:t.action)!=null?s:null,target_uuid:(n=(i=this.proposal)==null?void 0:i.target_uuid)!=null?n:null}),new X.Notice(this.plugin.t("draft_modal.notice.wrote_update")),this.close()}catch(o){let u=Et(o);Wt("\u5199\u5165\u770B\u677F\u5931\u8D25",o,{boardPath:(l=(a=this.boardFile)==null?void 0:a.path)!=null?l:this.plugin.settings.boardPath}),new X.Notice(this.plugin.t("draft_modal.notice.write_failed",{error:u}))}}};var Z=require("obsidian"),bt=require("fs"),Yt=require("os"),et=require("path");var Te=["Unassigned","Todo","Doing","Review","Done"],Ae=/^rollout-.*\.jsonl$/i,De=/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i;function ft(r){try{return(0,bt.readdirSync)(r,{withFileTypes:!0})}catch(e){return[]}}function Pe(r){var t,s;let e=r.match(De);return(s=(t=e==null?void 0:e[1])==null?void 0:t.toLowerCase())!=null?s:null}function Be(r){let e=r.match(/^rollout-(\d{4})-(\d{2})-(\d{2})T(\d{2})-(\d{2})-(\d{2})-/);return e?`${e[1]}-${e[2]}-${e[3]} ${e[4]}:${e[5]}:${e[6]}`:null}function Ie(r=new Date){let e=(0,et.join)((0,Yt.homedir)(),".codex","sessions");if(!(0,bt.existsSync)(e))return{rootPath:e,available:!1,totalCount:0,todayCount:0,latestSessionId:null,latestTime:null};let t=String(r.getFullYear()),s=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0"),n=`${t}/${s}/${i}/`,a=0,l=0,o="",u=ft(e).filter(g=>g.isDirectory()&&/^\d{4}$/.test(g.name));for(let g of u){let p=(0,et.join)(e,g.name),h=ft(p).filter(c=>c.isDirectory()&&/^\d{2}$/.test(c.name));for(let c of h){let f=(0,et.join)(p,c.name),v=ft(f).filter(b=>b.isDirectory()&&/^\d{2}$/.test(b.name));for(let b of v){let A=`${g.name}/${c.name}/${b.name}/`,B=(0,et.join)(f,b.name);for(let k of ft(B)){if(!k.isFile()||!Ae.test(k.name))continue;a+=1,A===n&&(l+=1);let S=`${A}${k.name}`;(!o||S>o)&&(o=S)}}}}let d=o?(0,et.basename)(o):"";return{rootPath:e,available:!0,totalCount:a,todayCount:l,latestSessionId:d?Pe(d):null,latestTime:d?Be(d):null}}function Gt(r){let e=(r!=null?r:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Ee(){let r=globalThis.crypto;return r!=null&&r.randomUUID?r.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Re(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function ze(r){let e=r.settings.boardPath,t=r.app.vault.getAbstractFileByPath(e);if(t instanceof Z.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await Y(r.app.vault,s),await r.app.vault.create(e,Re())}function Le(r){return r.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function Jt(r){let t=(r!=null?r:[]).filter(n=>typeof n=="string").flatMap(n=>n.split(/[,，]/g)).map(n=>n.trim()).filter(n=>n.length>0),s=new Set,i=[];for(let n of t){let a=n.toLowerCase();s.has(a)||(s.add(a),i.push(n))}return i}function Ce(r){let e=new Date().toISOString(),t=(r.title||"").trim()||"(Untitled)",s=[];return s.push(`<!-- AI-TASKS:TASK ${r.uuid} BEGIN -->`),s.push(`> [!todo] ${t}`),s.push(`> status:: ${r.status}`),r.tags.length>0&&s.push(`> tags:: ${r.tags.join(", ")}`),s.push(`> created:: ${e}`),r.sourcePath&&s.push(`> source:: [[${r.sourcePath}]]`),s.push(">"),r.body.trim().length>0?s.push(...Le(r.body)):s.push(">"),s.push(`<!-- AI-TASKS:TASK ${r.uuid} END -->`),s.join(`
`)+`
`}var st=class extends Z.Modal{constructor(t,s){var i,n;super(t.app);this.instruction="";this.boardFile=null;this.tasks=[];this.proposalMeta=null;this.autoRefreshOn=!1;this.autoRefreshTimer=null;this.sessionInfoEl=null;this.sessionMetaEl=null;this.sessionAutoBtn=null;this.statusEl=null;this.listEl=null;this.plugin=t,this.sourcePath=(i=s.sourcePath)!=null?i:null,this.text=(n=s.selection)!=null?n:""}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-bulk-import-modal"),t.createEl("h2",{cls:"ai-tasks-bulk-heading",text:this.plugin.t("bulk_modal.title")}),t.createDiv({cls:"ai-tasks-bulk-subtitle",text:this.plugin.t("bulk_modal.subtitle")});let s=t.createDiv({cls:"ai-tasks-bulk-session-card"}),i=s.createDiv({cls:"ai-tasks-bulk-session-head"});i.createDiv({cls:"ai-tasks-bulk-session-title",text:this.plugin.t("bulk_modal.session.title")});let n=i.createDiv({cls:"ai-tasks-bulk-session-actions"}),a=n.createEl("button",{cls:"ai-tasks-bulk-session-refresh",text:this.plugin.t("bulk_modal.session.btn_refresh")});this.sessionAutoBtn=n.createEl("button",{cls:"ai-tasks-bulk-session-refresh",text:this.getAutoRefreshBtnText()}),this.sessionMetaEl=s.createDiv({cls:"ai-tasks-bulk-session-meta"}),this.sessionInfoEl=s.createDiv({cls:"ai-tasks-bulk-session-grid"}),this.renderSessionInfo(),a.addEventListener("click",()=>{this.renderSessionInfo(),this.setStatus(this.plugin.t("bulk_modal.session.status_refreshed"))}),this.sessionAutoBtn.addEventListener("click",()=>this.toggleAutoRefresh());let l=t.createDiv({cls:"ai-tasks-bulk-form-grid"}),o=l.createDiv({cls:"ai-tasks-bulk-panel ai-tasks-bulk-panel-main"});o.createDiv({cls:"ai-tasks-bulk-label",text:this.plugin.t("bulk_modal.label.text")});let u=o.createEl("textarea",{cls:"ai-tasks-bulk-textarea ai-tasks-bulk-textarea-main"});u.placeholder=this.plugin.t("bulk_modal.placeholder.text"),u.value=this.text,u.addEventListener("input",()=>{this.text=u.value});let d=l.createDiv({cls:"ai-tasks-bulk-panel"});d.createDiv({cls:"ai-tasks-bulk-label",text:this.plugin.t("bulk_modal.label.instruction")});let g=d.createEl("textarea",{cls:"ai-tasks-bulk-textarea"});g.placeholder=this.plugin.t("bulk_modal.placeholder.instruction"),g.value=this.instruction,g.addEventListener("input",()=>{this.instruction=g.value});let p=t.createDiv({cls:"ai-tasks-bulk-actions"}),h=p.createEl("button",{text:this.plugin.t("btn.generate"),cls:"mod-cta"}),c=p.createEl("button",{text:this.plugin.t("bulk_modal.btn.import_to_board")});this.statusEl=t.createDiv({cls:"ai-tasks-bulk-status",text:""}),this.listEl=t.createDiv({cls:"ai-tasks-bulk-list"}),h.addEventListener("click",()=>void this.generate()),c.addEventListener("click",()=>void this.apply())}onClose(){this.stopAutoRefresh(),this.contentEl.empty()}getAutoRefreshBtnText(){return this.plugin.t(this.autoRefreshOn?"bulk_modal.session.btn_auto_on":"bulk_modal.session.btn_auto_off")}startAutoRefresh(){this.stopAutoRefresh(),this.autoRefreshTimer=window.setInterval(()=>{this.renderSessionInfo()},3e4)}stopAutoRefresh(){this.autoRefreshTimer!=null&&(window.clearInterval(this.autoRefreshTimer),this.autoRefreshTimer=null)}toggleAutoRefresh(){if(this.autoRefreshOn=!this.autoRefreshOn,this.sessionAutoBtn&&(this.sessionAutoBtn.textContent=this.getAutoRefreshBtnText()),this.autoRefreshOn){this.renderSessionInfo(),this.startAutoRefresh(),this.setStatus(this.plugin.t("bulk_modal.session.status_auto_on"));return}this.stopAutoRefresh(),this.setStatus(this.plugin.t("bulk_modal.session.status_auto_off"))}renderSessionMeta(t){if(!this.sessionMetaEl)return;let s=t.toLocaleString();this.sessionMetaEl.textContent=this.plugin.t("bulk_modal.session.last_updated",{ts:s})}renderSessionInfo(){var i,n;if(!this.sessionInfoEl)return;this.sessionInfoEl.empty(),this.renderSessionMeta(new Date);let t=Ie(),s=(a,l,o=!1)=>{var d;let u=(d=this.sessionInfoEl)==null?void 0:d.createDiv({cls:"ai-tasks-bulk-session-item"});u&&(u.createDiv({cls:"ai-tasks-bulk-session-label",text:a}),u.createDiv({cls:`ai-tasks-bulk-session-value${o?" is-mono":""}`,text:l}))};if(s(this.plugin.t("bulk_modal.session.root"),t.rootPath,!0),!t.available){this.sessionInfoEl.createDiv({cls:"ai-tasks-bulk-session-note",text:this.plugin.t("bulk_modal.session.unavailable")});return}s(this.plugin.t("bulk_modal.session.total"),String(t.totalCount)),s(this.plugin.t("bulk_modal.session.today"),String(t.todayCount)),s(this.plugin.t("bulk_modal.session.latest_id"),(i=t.latestSessionId)!=null?i:this.plugin.t("bulk_modal.session.none"),!0),s(this.plugin.t("bulk_modal.session.latest_time"),(n=t.latestTime)!=null?n:this.plugin.t("bulk_modal.session.none"))}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}renderList(){var t;if(this.listEl){if(this.listEl.empty(),!this.tasks.length){this.listEl.createDiv({cls:"ai-tasks-board-empty",text:this.plugin.t("bulk_modal.empty")});return}for(let s of this.tasks){let i=this.listEl.createDiv({cls:"ai-tasks-bulk-row"}),n=(s.title||"").trim()||"(Untitled)",a=Gt((t=s.status)!=null?t:"Unassigned"),l=Jt(s.tags),o=i.createDiv({cls:"ai-tasks-bulk-row-head"});o.createDiv({cls:"ai-tasks-bulk-title",text:n}),o.createDiv({cls:"ai-tasks-bulk-chip",text:a}),i.createDiv({cls:"ai-tasks-bulk-meta",text:l.length?l.join(", "):this.plugin.t("bulk_modal.meta.no_tags")})}}}async generate(){var t,s,i,n,a,l,o,u,d,g,p,h,c,f,v,b,A,B,k,S,w,y;try{this.setStatus(this.plugin.t("bulk_modal.status.generating")),this.boardFile=await ze(this.plugin);let T={text:this.text,instruction:this.instruction||null,tag_presets:this.plugin.getTagPresets(),max_tasks:60,ai_model:this.plugin.getModelConfig()},D=G();await _(this.plugin,{type:"board.split.request",request_id:D,text_len:T.text.length,instruction_len:((t=T.instruction)!=null?t:"").length,tag_presets_count:(i=(s=T.tag_presets)==null?void 0:s.length)!=null?i:0,model_provider:(a=(n=T.ai_model)==null?void 0:n.provider)!=null?a:null,runtime_url:this.plugin.settings.runtimeUrl});let m=await J(this.plugin,{path:"/v1/board/split",method:"POST",body:T,request_id:D}),x=m.json;this.tasks=Array.isArray(x.tasks)?x.tasks.slice(0,Math.max(1,(l=T.max_tasks)!=null?l:60)):[],this.proposalMeta={engine:(o=x.engine)!=null?o:null,provider:(u=x.provider)!=null?u:null,thread_id:(d=x.thread_id)!=null?d:null,ai_fallback:(g=x.ai_fallback)!=null?g:null,reasoning:(p=x.reasoning)!=null?p:null,confidence:(h=x.confidence)!=null?h:null},await _(this.plugin,{type:"board.split.response",request_id:m.meta.request_id,latency_ms:m.meta.latency_ms,http_status:m.meta.http_status,response_text_len:m.meta.response_text_len,engine:(c=x.engine)!=null?c:null,provider:(f=x.provider)!=null?f:null,thread_id:(v=x.thread_id)!=null?v:null,ai_fallback:(b=x.ai_fallback)!=null?b:null,tasks_count:this.tasks.length,confidence:(A=x.confidence)!=null?A:null,reasoning:(B=x.reasoning)!=null?B:null}),this.renderList();let P=[];x.engine&&P.push(`engine=${x.engine}`),x.thread_id&&P.push(`thread=${x.thread_id}`),x.ai_fallback&&P.push(`ai_fallback=${x.ai_fallback}`),x.confidence!=null&&P.push(`confidence=${x.confidence.toFixed(2)}`),x.reasoning&&P.push(x.reasoning),this.setStatus(P.length?P.join(" | "):this.plugin.t("bulk_modal.status.ready",{count:this.tasks.length}))}catch(T){let D=T instanceof Error?T.message:String(T),m=T instanceof M?T.meta:null;await _(this.plugin,{type:"board.split.error",request_id:(k=m==null?void 0:m.request_id)!=null?k:null,latency_ms:(S=m==null?void 0:m.latency_ms)!=null?S:null,http_status:(w=m==null?void 0:m.http_status)!=null?w:null,response_snip:(y=m==null?void 0:m.response_snip)!=null?y:null,error:D}),this.setStatus(this.plugin.t("bulk_modal.status.failed",{error:D})),new Z.Notice(this.plugin.t("bulk_modal.notice.generate_failed",{error:D}))}}async apply(){var t,s,i,n,a,l,o,u,d,g,p,h,c;if(!this.boardFile){new Z.Notice(this.plugin.t("bulk_modal.notice.board_not_ready"));return}if(!this.tasks.length){new Z.Notice(this.plugin.t("bulk_modal.notice.generate_first"));return}try{let f=await this.plugin.app.vault.read(this.boardFile),v=Q(f),b=v.next;v.changed&&(await U(this.plugin.app.vault,this.boardFile,v.next),await _(this.plugin,{type:"board.normalize_escaped_newlines"}));let A=W(b),B=new Map;for(let S of Te){let w=(n=(i=(s=(t=A.sections.get(S))==null?void 0:t.tasks)==null?void 0:s[0])==null?void 0:i.uuid)!=null?n:null;B.set(S,w)}let k=[];for(let S of this.tasks){let w=(S.title||"").trim().slice(0,120)||"(Untitled)",y=Gt((a=S.status)!=null?a:"Unassigned"),T=Jt(S.tags),D=String((l=S.body)!=null?l:"").trim(),m=Ee(),x=Ce({uuid:m,title:w,status:y,tags:T,body:D,sourcePath:this.sourcePath});b=rt(b,y,(o=B.get(y))!=null?o:null,x),k.push({uuid:m,title:w,status:y,tags:T})}await U(this.plugin.app.vault,this.boardFile,b),await _(this.plugin,{type:"board.bulk_import.write",via:"bulk_import_modal",tasks_count:k.length,engine:(d=(u=this.proposalMeta)==null?void 0:u.engine)!=null?d:null,provider:(p=(g=this.proposalMeta)==null?void 0:g.provider)!=null?p:null,thread_id:(c=(h=this.proposalMeta)==null?void 0:h.thread_id)!=null?c:null}),new Z.Notice(this.plugin.t("bulk_modal.notice.imported",{count:k.length})),this.close()}catch(f){let v=f instanceof Error?f.message:String(f);new Z.Notice(this.plugin.t("bulk_modal.notice.import_failed",{error:v}))}}};var Xt=require("obsidian");var tt=require("obsidian");var dt=require("obsidian");var $e=["Unassigned","Todo","Doing","Review","Done"];function Ne(){let r=globalThis.crypto;return r!=null&&r.randomUUID?r.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Oe(r){let e=(r!=null?r:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Me(r){let e=r.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(a=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(a.trim()));if(t===-1)return"";let s=e.findIndex(a=>a.trim()===">");return s===-1||s>=t?"":e.slice(s+1,t).map(a=>{let l=a.match(/^>\s?(.*)$/);return l?l[1]:a}).join(`
`).replace(/\n$/,"")}function Fe(r,e){var f,v;let t=r.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(b=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(b.trim()));if(s===-1)throw new Error("Malformed task block (missing END marker).");let i=t.findIndex(b=>/^>\s*\[![^\]]+\]/.test(b));if(i!==-1){let b=(f=t[i])==null?void 0:f.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),A=(v=b==null?void 0:b[1])!=null?v:"[!todo]";t[i]=`> ${A} ${e.title||"(Untitled)"}`}let n=t.findIndex(b=>/^>\s*status::/i.test(b));if(n!==-1)t[n]=`> status:: ${e.status}`;else{let b=i!==-1?i+1:1;t.splice(b,0,`> status:: ${e.status}`),n=b}let a=t.findIndex(b=>/^>\s*tags::/i.test(b));if(e.tags.length>0){let b=`> tags:: ${e.tags.join(", ")}`;a!==-1?t[a]=b:t.splice(n+1,0,b)}else a!==-1&&t.splice(a,1);let l=t.findIndex(b=>/^>\s*updated::/i.test(b)),o=`> updated:: ${e.updatedAtIso}`;if(l!==-1)t[l]=o;else{let b=t.findIndex(B=>/^>\s*created::/i.test(B)),A=b!==-1?b+1:n+1;t.splice(A,0,o)}let u=t.findIndex(b=>b.trim()===">");(u===-1||u>=s)&&(u=s,t.splice(u,0,">"));let d=t.findIndex(b=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(b.trim()));if(d===-1)throw new Error("Malformed task block (missing END marker).");let g=[],p=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let b of p)b.trim()===""?g.push(">"):g.push(`> ${b}`);let h=t.slice(0,u+1),c=t.slice(d);return h.concat(g,c).join(`
`)+`
`}function Ue(r){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${r.uuid} BEGIN -->`),t.push(`> [!todo] ${r.title||"(Untitled)"}`),t.push(`> status:: ${r.status}`),r.tags.length>0&&t.push(`> tags:: ${r.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),r.sourcePath&&t.push(`> source:: [[${r.sourcePath}]]`),t.push(">");for(let s of(r.body||"").replace(/\r\n/g,`
`).split(`
`))s.trim()===""?t.push(">"):t.push(`> ${s}`);return t.push(`<!-- AI-TASKS:TASK ${r.uuid} END -->`),t.join(`
`)+`
`}var ct=class extends dt.Modal{constructor(e,t){var s,i,n,a,l;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(s=t.task)!=null?s:null,this.defaultStatus=(a=t.defaultStatus)!=null?a:(n=(i=this.task)==null?void 0:i.status)!=null?n:"Unassigned",this.sourcePath=(l=t.sourcePath)!=null?l:null,this.onDidWrite=t.onDidWrite}onOpen(){var c,f,v,b,A,B;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?this.plugin.t("task_modal.title.edit"):this.plugin.t("task_modal.title.new")});let s=e.createDiv({cls:"ai-tasks-form-row"});s.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.title")});let i=s.createEl("input",{type:"text",cls:"ai-tasks-form-input"});i.value=(f=(c=this.task)==null?void 0:c.title)!=null?f:"";let n=e.createDiv({cls:"ai-tasks-form-row"});n.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.status")});let a=n.createEl("select",{cls:"ai-tasks-form-select"});for(let k of $e)a.add(new Option(k,k));a.value=(b=(v=this.task)==null?void 0:v.status)!=null?b:this.defaultStatus;let l=e.createDiv({cls:"ai-tasks-form-row"});l.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.tags")});let o=l.createEl("input",{type:"text",cls:"ai-tasks-form-input"});o.placeholder=this.plugin.t("task_modal.placeholder.tags"),o.value=((B=(A=this.task)==null?void 0:A.tags)!=null?B:[]).join(", ");let u=e.createDiv({cls:"ai-tasks-form-row"});u.createDiv({cls:"ai-tasks-form-label",text:this.plugin.t("task_modal.label.body")});let d=u.createEl("textarea",{cls:"ai-tasks-form-textarea"});d.value=this.task?Me(this.task.rawBlock):"";let g=e.createDiv({cls:"ai-tasks-form-buttons"}),p=g.createEl("button",{text:this.plugin.t("btn.save"),cls:"mod-cta"});g.createEl("button",{text:this.plugin.t("btn.cancel")}).addEventListener("click",()=>this.close()),p.addEventListener("click",()=>{this.save({title:i.value,status:Oe(a.value),tagsRaw:o.value,body:d.value})})}async save(e){var t,s,i,n,a,l;try{let o=e.tagsRaw.split(/[,，]/).map(f=>f.trim()).filter(f=>f.length>0),u=await this.plugin.app.vault.read(this.boardFile),g=Q(u).next,p=W(g),h=new Date().toISOString(),c=g;if(this.task){let f=null,v=null;for(let[A,B]of p.sections.entries()){for(let k of B.tasks)if(k.uuid===this.task.uuid){f=k,v=A;break}if(f)break}if(!f||!v)throw new Error(`Task not found: ${this.task.uuid}`);let b=Fe(f.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:o,body:(t=e.body)!=null?t:"",updatedAtIso:h});c=mt(c,f.uuid,b),v!==e.status&&(c=at(c,f.uuid,e.status,null)),await U(this.plugin.app.vault,this.boardFile,c),await _(this.plugin,{type:"task.edit",uuid:f.uuid,from_status:v,status:e.status})}else{let f=Ne(),v=Ue({uuid:f,title:e.title||"(Untitled)",status:e.status,tags:o,body:(s=e.body)!=null?s:"",sourcePath:this.sourcePath}),b=(l=(a=(n=(i=p.sections.get(e.status))==null?void 0:i.tasks)==null?void 0:n[0])==null?void 0:a.uuid)!=null?l:null;c=rt(c,e.status,b,v),await U(this.plugin.app.vault,this.boardFile,c),await _(this.plugin,{type:"task.create",uuid:f,status:e.status})}new dt.Notice(this.plugin.t("task_modal.notice.saved")),this.close(),this.onDidWrite()}catch(o){let u=o instanceof Error?o.message:String(o);new dt.Notice(this.plugin.t("task_modal.notice.save_failed",{error:u}))}}};var ot=["Unassigned","Todo","Doing","Review","Done"];function qe(){let r=new Date,e=String(r.getFullYear()),t=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}function je(r,e){let t=(r||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function Ke(r){return["---","schema: ai-tasks-archive/v1",`date: ${r}`,"---","",`# Archive ${r}`,"",""].join(`
`)}function Ve(r,e){let t=r.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(o=>/^>\s*archived::/i.test(o));if(s!==-1)return t[s]=`> archived:: ${e}`,t.join(`
`)+`
`;let i=t.findIndex(o=>/^>\s*created::/i.test(o)),n=t.findIndex(o=>/^>\s*status::/i.test(o)),a=t.findIndex(o=>/^>\s*\[![^\]]+\]/.test(o)),l=i!==-1?i+1:n!==-1?n+1:a!==-1?a+1:1;return t.splice(l,0,`> archived:: ${e}`),t.join(`
`)+`
`}function We(r){return Array.from(new Set(r.flatMap(e=>e.tags))).sort()}function He(r,e){let t=e.trim().toLowerCase();return t?r.title.toLowerCase().includes(t)||r.tags.some(s=>s.toLowerCase().includes(t)):!0}var kt=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.selectedUuid=null;this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=Q(e);return t.changed&&(await U(this.plugin.app.vault,this.boardFile,t.next),new tt.Notice(this.plugin.t("board.notice.fixed_escaped_newlines")),await _(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return He(e,this.searchText)}parseSessionRef(e){let t=(e||"").trim();if(!t)return null;let s=t.indexOf(":");if(s===-1)return null;let i=t.slice(0,s).trim(),n=t.slice(s+1).trim();return!i||!n?null:{source:i,id:n}}async loadSessionInfos(e){let t=[],s=this.plugin.app.vault,i=this.plugin.getSessionSearchRoots();for(let n of e){let a=this.parseSessionRef(n);if(!a){t.push({ref:n,summary:null,snippets:[],missing:!0});continue}let l=null;for(let o of i){let u=`${o.replace(/\/+$/g,"")}/${a.source}/${a.id}.json`,d=s.getAbstractFileByPath(u);if(d instanceof tt.TFile){l=d;break}}if(!l){t.push({ref:n,summary:null,snippets:[],missing:!0});continue}try{let o=await s.read(l),u=JSON.parse(o),d=typeof u.summary=="string"?u.summary.trim():"",g=Array.isArray(u.snippets)?u.snippets:[],p=[];for(let h of g.slice(0,3)){if(!h||typeof h!="object")continue;let c=typeof h.role=="string"?String(h.role):"",v=(typeof h.text=="string"?String(h.text):"").replace(/\s+/g," ").trim();v&&p.push(c?`${c}: ${v}`:v)}t.push({ref:n,summary:d||null,snippets:p,missing:!1})}catch(o){t.push({ref:n,summary:null,snippets:[],missing:!0})}}return t}async loadCapturedSessions(e=12){let t=this.plugin.getSessionSearchRoots().map(n=>`${n.replace(/\/+$/g,"")}/`),s=this.plugin.app.vault.getFiles().filter(n=>n.path.toLowerCase().endsWith(".json")?t.some(a=>n.path.startsWith(a)):!1).sort((n,a)=>a.stat.mtime-n.stat.mtime).slice(0,Math.max(1,e)),i=[];for(let n of s){let a=`unknown:${n.basename}`;for(let l of t){if(!n.path.startsWith(l))continue;a=`${n.path.slice(l.length).split("/")[0]||"unknown"}:${n.basename}`;break}try{let l=await this.plugin.app.vault.read(n),o=JSON.parse(l),u=typeof o.summary=="string"?o.summary.trim():"",d=Array.isArray(o.snippets)?o.snippets:[],g=[];for(let h of d.slice(0,4)){if(!h||typeof h!="object")continue;let c=typeof h.role=="string"?String(h.role):"",v=(typeof h.text=="string"?String(h.text):"").replace(/\s+/g," ").trim();v&&g.push(c?`${c}: ${v}`:v)}let p=typeof o.ended_at=="string"?o.ended_at:typeof o.started_at=="string"?o.started_at:null;i.push({ref:a,summary:u||null,snippets:g,endedAt:p,mtime:n.stat.mtime})}catch(l){i.push({ref:a,summary:null,snippets:[],endedAt:null,mtime:n.stat.mtime})}}return i.sort((n,a)=>{let l=n.endedAt?Date.parse(n.endedAt):n.mtime,o=a.endedAt?Date.parse(a.endedAt):a.mtime,u=Number.isNaN(l)?n.mtime:l;return(Number.isNaN(o)?a.mtime:o)-u})}formatSessionTime(e,t){let s=e?Date.parse(e):NaN;return Number.isNaN(s)?new Date(t).toLocaleString():new Date(s).toLocaleString()}renderCapturedSessions(e,t){let s=e.createDiv({cls:"ai-tasks-captured-sessions"}),i=s.createDiv({cls:"ai-tasks-captured-sessions-head"});i.createDiv({cls:"ai-tasks-captured-sessions-title",text:this.plugin.t("board.captured_sessions.title")}),i.createDiv({cls:"ai-tasks-captured-sessions-count",text:String(t.length)});let n=s.createDiv({cls:"ai-tasks-captured-sessions-list"});if(!t.length){n.createDiv({cls:"ai-tasks-captured-session-empty",text:this.plugin.t("board.captured_sessions.empty")});return}for(let a of t){let l=n.createDiv({cls:"ai-tasks-captured-session"});if(l.createDiv({cls:"ai-tasks-captured-session-ref",text:a.ref}),l.createDiv({cls:"ai-tasks-captured-session-time",text:this.plugin.t("board.captured_sessions.time",{ts:this.formatSessionTime(a.endedAt,a.mtime)})}),a.summary&&l.createDiv({cls:"ai-tasks-captured-session-summary",text:a.summary}),a.snippets.length>0){let o=l.createEl("pre",{cls:"ai-tasks-captured-session-snippets"});o.textContent=a.snippets.join(`
`)}!a.summary&&a.snippets.length===0&&l.createDiv({cls:"ai-tasks-captured-session-empty",text:this.plugin.t("board.task.sessions.empty")})}}renderHeader(e,t,s){let i=e.createDiv({cls:"ai-tasks-board-header"});i.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:this.plugin.t("board.title")});let a=i.createDiv({cls:"ai-tasks-board-controls"}),l=a.createEl("select",{cls:"ai-tasks-board-view-select"});if(l.add(new Option(this.plugin.t("board.view.kanban"),"kanban")),l.add(new Option(this.plugin.t("board.view.split"),"split")),l.add(new Option(this.plugin.t("board.view.md"),"md")),l.value=s,l.addEventListener("change",()=>{(async()=>{let c=l.value;this.plugin.settings.boardLayout=c,await this.plugin.saveSettings(),await this.render(e)})()}),a.createEl("button",{text:this.plugin.t("btn.import"),cls:"ai-tasks-board-import"}).addEventListener("click",()=>{new st(this.plugin,{selection:"",sourcePath:this.boardFile.path}).open()}),s==="md")return;let u=a.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:this.plugin.t("board.search.placeholder")}});u.value=this.searchText,u.addEventListener("input",async()=>{this.searchText=u.value,await this.render(e)});let d=a.createEl("select",{cls:"ai-tasks-board-select"});d.add(new Option(this.plugin.t("board.status_filter.all"),"All"));for(let c of ot)d.add(new Option(c,c));d.value=this.statusFilter,d.addEventListener("change",async()=>{let c=d.value;this.statusFilter=c==="All"?"All":c,await this.render(e)});let g=a.createDiv({cls:"ai-tasks-board-tags"}),p=g.createDiv({cls:"ai-tasks-board-tags-title",text:this.plugin.t("board.tags.title")}),h=g.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)h.createDiv({cls:"ai-tasks-board-tags-empty",text:this.plugin.t("board.tags.empty")});else for(let c of t){let f=h.createEl("button",{cls:"ai-tasks-tag-chip",text:c});this.tagFilter.has(c)&&f.classList.add("is-active"),f.addEventListener("click",async v=>{v.preventDefault(),this.tagFilter.has(c)?this.tagFilter.delete(c):this.tagFilter.add(c),await this.render(e)})}p.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}extractBodyFromBlock(e){let t=e.replace(/\r\n/g,`
`).split(`
`),s=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+BEGIN\s*-->\s*$/i,i=/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->\s*$/i,n=!1,a=[];for(let l of t){let o=l.trim();if(!s.test(o)){if(i.test(o))break;if(!n){o===">"&&(n=!0);continue}if(l.startsWith(">")){let u=l.slice(1);u.startsWith(" ")&&(u=u.slice(1)),a.push(u)}else a.push(l)}}if(a.length===0){for(let l of t)if(!(s.test(l.trim())||i.test(l.trim()))&&l.startsWith(">")){let o=l.slice(1);o.startsWith(" ")&&(o=o.slice(1)),a.push(o)}}return a.join(`
`).replace(/\n{3,}/g,`

`).trim()}createCard(e,t,s,i,n,a){let l=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});l.draggable=!0,l.addEventListener("click",h=>{var c,f;(f=(c=h.target)==null?void 0:c.closest)!=null&&f.call(c,"select, button, a, input, textarea")||a(t)});let o=l.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let u=o.createDiv({cls:"ai-task-actions"}),d=u.createEl("select",{cls:"ai-task-status"});for(let h of ot)d.add(new Option(h,h));if(d.value=t.status,d.addEventListener("click",h=>h.stopPropagation()),d.addEventListener("change",async h=>{h.stopPropagation(),await s(t.uuid,d.value,null)}),u.createEl("button",{cls:"ai-task-edit",text:this.plugin.t("btn.edit")}).addEventListener("click",h=>{h.stopPropagation(),a(t)}),u.createEl("button",{cls:"ai-task-delete",text:this.plugin.t("btn.delete")}).addEventListener("click",async h=>{h.stopPropagation(),await n(t.uuid)}),t.status==="Done"&&u.createEl("button",{text:this.plugin.t("btn.archive"),cls:"ai-task-archive"}).addEventListener("click",async c=>{c.stopPropagation(),await i(t.uuid)}),t.tags.length>0){let h=l.createDiv({cls:"ai-task-tags"});for(let c of t.tags)h.createSpan({cls:"ai-task-tag",text:c})}return l.addEventListener("dragstart",h=>{var c,f;(c=h.dataTransfer)==null||c.setData("application/x-ai-task-uuid",t.uuid),(f=h.dataTransfer)==null||f.setDragImage(l,8,8),l.classList.add("is-dragging")}),l.addEventListener("dragend",()=>{l.classList.remove("is-dragging")}),l}attachColumnDnD(e,t,s){e.addEventListener("dragover",i=>{i.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async i=>{var u,d,g;i.preventDefault(),e.classList.remove("is-drop-target");let n=(u=i.dataTransfer)==null?void 0:u.getData("application/x-ai-task-uuid");if(!n)return;let a=i.target,l=(d=a==null?void 0:a.closest)==null?void 0:d.call(a,".ai-task-card"),o=(g=l==null?void 0:l.getAttribute("data-uuid"))!=null?g:null;await s(n,t,o)})}attachSplitDnD(e,t,s){e.addEventListener("dragover",i=>{i.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async i=>{var u,d,g;i.preventDefault(),e.classList.remove("is-drop-target");let n=(u=i.dataTransfer)==null?void 0:u.getData("application/x-ai-task-uuid");if(!n)return;let a=i.target,l=(d=a==null?void 0:a.closest)==null?void 0:d.call(a,".ai-tasks-split-task"),o=(g=l==null?void 0:l.getAttribute("data-uuid"))!=null?g:null;await s(n,t,o)})}async appendToArchive(e,t,s,i){let n=t.split("/").slice(0,-1).join("/");n&&await Y(e,n);let a=e.getAbstractFileByPath(t);if(a instanceof tt.TFile){let l=await e.read(a),o=l.endsWith(`
`)?`
`:`

`;await e.modify(a,l+o+s);return}await e.create(t,Ke(i)+s)}async render(e){var h,c,f,v,b,A,B;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t=this.plugin.settings.boardLayout==="kanban"?"kanban":this.plugin.settings.boardLayout==="md"?"md":"split",s;try{s=await this.readBoardNormalized()}catch(k){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:k instanceof Error?k.message:this.plugin.t("board.md.read_failed")});return}if(t==="md"){this.renderHeader(e,[],t);let k=e.createDiv({cls:"ai-tasks-md-root"}),S=k.createDiv({cls:"ai-tasks-md-actions"}),w=S.createEl("button",{text:this.plugin.t("btn.reload")}),y=S.createEl("button",{text:this.plugin.t("btn.save"),cls:"mod-cta"}),T=k.createEl("textarea",{cls:"ai-tasks-md-textarea"});T.value=s,w.addEventListener("click",()=>void this.render(e)),y.addEventListener("click",()=>{(async()=>(await U(this.plugin.app.vault,this.boardFile,T.value.replace(/\r\n/g,`
`)),await _(this.plugin,{type:"board.write",via:"md_view"}),new tt.Notice(this.plugin.t("board.md.saved_notice")),await this.render(e)))()});return}let i;try{i=W(s)}catch(k){this.renderHeader(e,[],t);let S=e.createDiv({cls:"ai-tasks-board-error"});S.createDiv({text:k instanceof Error?k.message:this.plugin.t("board.md.parse_failed")}),S.createDiv({text:this.plugin.t("board.md.tip_switch_md")});return}let n=Array.from(i.sections.values()).flatMap(k=>k.tasks),a=We(n);this.renderHeader(e,a,t);let l=async(k,S,w)=>{let y=await this.readBoardNormalized(),T=at(y,k,S,w);await U(this.plugin.app.vault,this.boardFile,T),await _(this.plugin,{type:"task.move",uuid:k,status:S,before_uuid:w}),await this.render(e)},o=async k=>{if(!window.confirm(this.plugin.t("board.confirm.archive")))return;let S=await this.readBoardNormalized(),{removed:w,next:y}=It(S,k),T=qe(),D=je(this.plugin.settings.archiveFolderPath,T),m=Ve(w.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,D,m,T),await U(this.plugin.app.vault,this.boardFile,y),new tt.Notice(this.plugin.t("board.notice.archived_to",{path:D})),await _(this.plugin,{type:"task.archive",uuid:k,archive_path:D}),await this.render(e)},u=async k=>{if(!window.confirm(this.plugin.t("board.confirm.delete")))return;let S=await this.readBoardNormalized(),{next:w}=It(S,k);await U(this.plugin.app.vault,this.boardFile,w),new tt.Notice(this.plugin.t("board.notice.deleted")),await _(this.plugin,{type:"task.delete",uuid:k}),await this.render(e)},d=k=>{new ct(this.plugin,{boardFile:this.boardFile,task:k,onDidWrite:()=>{this.render(e)}}).open()},g=k=>{new ct(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:k,onDidWrite:()=>{this.render(e)}}).open()};if(t==="kanban"){let k=e.createDiv({cls:"ai-tasks-board-columns"});for(let S of ot){let w=k.createDiv({cls:"ai-tasks-column"}),y=w.createDiv({cls:"ai-tasks-column-head"});y.createDiv({cls:"ai-tasks-column-title",text:S}),y.createEl("button",{cls:"ai-tasks-column-add",text:this.plugin.t("board.btn.add")}).addEventListener("click",()=>g(S));let D=w.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(D,S,l);let m=i.sections.get(S),x=((h=m==null?void 0:m.tasks)!=null?h:[]).filter(P=>this.shouldShowTask(P));for(let P of x)this.createCard(D,P,l,o,u,d)}}else{let k=e.createDiv({cls:"ai-tasks-board-split"}),S=k.createDiv({cls:"ai-tasks-board-split-left"}),w=k.createDiv({cls:"ai-tasks-board-split-right"}),y=new Map;for(let m of n)y.set(m.uuid,m);let T=[];for(let m of ot){let x=i.sections.get(m);T.push(...((c=x==null?void 0:x.tasks)!=null?c:[]).filter(P=>this.shouldShowTask(P)))}this.selectedUuid&&!y.has(this.selectedUuid)&&(this.selectedUuid=null),this.selectedUuid&&!T.some(m=>m.uuid===this.selectedUuid)&&(this.selectedUuid=null),!this.selectedUuid&&T.length>0&&(this.selectedUuid=(v=(f=T[0])==null?void 0:f.uuid)!=null?v:null);for(let m of ot){let x=i.sections.get(m),P=((b=x==null?void 0:x.tasks)!=null?b:[]).filter(E=>this.shouldShowTask(E)),K=S.createDiv({cls:"ai-tasks-split-section"}),H=K.createDiv({cls:"ai-tasks-split-section-head"});H.createDiv({cls:"ai-tasks-split-section-title",text:m}),H.createDiv({cls:"ai-tasks-split-section-count",text:String(P.length)}),H.createEl("button",{cls:"ai-tasks-split-add",text:this.plugin.t("board.btn.add")}).addEventListener("click",()=>g(m));let F=K.createDiv({cls:"ai-tasks-split-tasklist"});this.attachSplitDnD(F,m,l);for(let E of P){let R=F.createDiv({cls:"ai-tasks-split-task",attr:{"data-uuid":E.uuid}});E.uuid===this.selectedUuid&&R.classList.add("is-selected"),R.draggable=!0,R.createDiv({cls:"ai-tasks-split-task-title",text:E.title}),E.tags.length>0&&R.createDiv({cls:"ai-tasks-split-task-tags",text:E.tags.join(", ")}),R.addEventListener("click",async I=>{var O,$;($=(O=I.target)==null?void 0:O.closest)!=null&&$.call(O,"select, button, a, input, textarea")||(this.selectedUuid=E.uuid,await this.render(e))}),R.addEventListener("dragstart",I=>{var O,$;(O=I.dataTransfer)==null||O.setData("application/x-ai-task-uuid",E.uuid),($=I.dataTransfer)==null||$.setDragImage(R,8,8),R.classList.add("is-dragging")}),R.addEventListener("dragend",()=>{R.classList.remove("is-dragging")})}}let D=this.selectedUuid&&(A=y.get(this.selectedUuid))!=null?A:null;if(!D)w.createDiv({cls:"ai-tasks-detail-empty",text:this.plugin.t("board.task.select_to_view")});else{let m=w.createDiv({cls:"ai-tasks-detail"});m.createDiv({cls:"ai-tasks-detail-title",text:D.title}),m.createDiv({cls:"ai-tasks-detail-uuid",text:D.uuid});let x=m.createDiv({cls:"ai-tasks-detail-meta"}),P=x.createEl("select",{cls:"ai-tasks-detail-status"});for(let I of ot)P.add(new Option(I,I));if(P.value=D.status,P.addEventListener("change",async()=>{await l(D.uuid,P.value,null)}),x.createEl("button",{text:this.plugin.t("btn.edit"),cls:"ai-tasks-detail-edit"}).addEventListener("click",()=>d(D)),x.createEl("button",{text:this.plugin.t("btn.delete"),cls:"ai-tasks-detail-delete"}).addEventListener("click",async()=>{await u(D.uuid)}),D.status==="Done"&&x.createEl("button",{text:this.plugin.t("btn.archive"),cls:"ai-tasks-detail-archive"}).addEventListener("click",async()=>{await o(D.uuid)}),D.tags.length>0){let I=m.createDiv({cls:"ai-tasks-detail-tags"});for(let O of D.tags)I.createSpan({cls:"ai-task-tag",text:O})}let j=m.createDiv({cls:"ai-tasks-detail-body"}),F=this.extractBodyFromBlock(D.rawBlock),E=j.createEl("pre",{cls:"ai-tasks-detail-body-pre"});E.textContent=F||this.plugin.t("board.task.no_details");let R=(B=D.sessions)!=null?B:[];if(R.length>0){let I=m.createDiv({cls:"ai-tasks-detail-sessions"});I.createDiv({cls:"ai-tasks-detail-section-title",text:this.plugin.t("board.task.sessions.title")});let O=await this.loadSessionInfos(R);if(!O.length)I.createDiv({cls:"ai-tasks-detail-session-empty",text:this.plugin.t("board.task.sessions.empty")});else for(let $ of O){let C=I.createDiv({cls:"ai-tasks-detail-session"});if(C.createDiv({cls:"ai-tasks-detail-session-ref",text:$.ref}),$.missing){C.createDiv({cls:"ai-tasks-detail-session-missing",text:this.plugin.t("board.task.sessions.missing")});continue}if($.summary&&C.createDiv({cls:"ai-tasks-detail-session-summary",text:$.summary}),$.snippets.length>0){let V=C.createEl("pre",{cls:"ai-tasks-detail-session-snippets"});V.textContent=$.snippets.join(`
`)}!$.summary&&$.snippets.length===0&&C.createDiv({cls:"ai-tasks-detail-session-empty",text:this.plugin.t("board.task.sessions.empty")})}}}}let p=await this.loadCapturedSessions(12);this.renderCapturedSessions(e,p)}};var vt=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let s of e){let i=s.view;if(!(i instanceof Xt.MarkdownView))continue;let n=i.file;if(!n){this.unmount(i);continue}let a=!!this.plugin.settings.renderBoardInNote,l=n.path===this.plugin.settings.boardPath;if(!a||!l){this.unmount(i);continue}t.add(i),await this.mount(i,n)}for(let s of Array.from(this.overlays.keys()))t.has(s)||this.unmount(s)}async mount(e,t){let s=this.overlays.get(e);if(s&&s.file.path===t.path)return;s&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let i=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),n=new kt(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:i,panel:n});try{await n.render(i)}catch(a){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};var gt=require("obsidian");async function Ge(r){var s,i;let e=(i=(s=globalThis.navigator)==null?void 0:s.clipboard)==null?void 0:i.writeText;if(e){await e(r);return}let t=document.createElement("textarea");t.value=r,t.setAttribute("readonly","true"),t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}var pt=class extends gt.Modal{constructor(e,t){super(e.app),this.plugin=e,this.result=t}onOpen(){let{contentEl:e}=this;e.empty();let t=this.result.kind==="agent"?"diagnostics.modal.title.agent":"diagnostics.modal.title.ai";e.createEl("h2",{text:this.plugin.t(t)});let s=e.createDiv({cls:"ai-tasks-diagnostics-summary"});s.createSpan({text:this.result.ok?this.plugin.t("diagnostics.modal.summary.ok"):this.plugin.t("diagnostics.modal.summary.fail")}),s.createSpan({text:" | "+this.plugin.t("diagnostics.modal.latency",{ms:this.result.latency_ms})}),typeof this.result.http_status=="number"&&s.createSpan({text:` | HTTP ${this.result.http_status}`}),s.createDiv({text:this.result.url,cls:"ai-tasks-diagnostics-url"}),this.result.error&&e.createDiv({cls:"ai-tasks-diagnostics-error"}).createDiv({text:String(this.result.error)});let i=e.createEl("pre",{cls:"ai-tasks-diagnostics-json"});i.textContent=JSON.stringify(this.result,null,2);let n=e.createDiv({cls:"ai-tasks-diagnostics-buttons"}),a=n.createEl("button",{text:this.plugin.t("btn.copy_json")}),l=n.createEl("button",{text:this.plugin.t("btn.close")});a.addEventListener("click",()=>{(async()=>{try{await Ge(i.textContent||""),new gt.Notice(this.plugin.t("notice.clipboard.copied"))}catch(o){let u=o instanceof Error?o.message:String(o);new gt.Notice(this.plugin.t("notice.clipboard.copy_failed",{error:u}))}})()}),l.addEventListener("click",()=>this.close())}};function Zt(r,e){return r==="en"?"en":r==="zh-CN"||(e||"").toLowerCase().startsWith("zh")?"zh-CN":"en"}function Je(r,e){return e?r.replace(/\{\{([a-zA-Z0-9_]+)\}\}/g,(t,s)=>{let i=e[s];return i==null?"":String(i)}):r}var Ye={"cmd.open_board_note":{en:"AI Tasks: Open board note",zh:"AI Tasks\uFF1A\u6253\u5F00\u770B\u677F\u7B14\u8BB0"},"cmd.bulk_import":{en:"AI Tasks: Import tasks (AI)",zh:"AI Tasks\uFF1A\u5BFC\u5165\u4EFB\u52A1\uFF08AI\uFF09"},"cmd.open_debug_sidebar":{en:"AI Tasks: Open debug sidebar",zh:"AI Tasks\uFF1A\u6253\u5F00\u8C03\u8BD5\u4FA7\u680F"},"menu.add_to_board":{en:"AI Tasks: Add to board",zh:"AI Tasks\uFF1A\u6DFB\u52A0\u5230\u770B\u677F"},"menu.update_board_ai":{en:"AI Tasks: Update board (AI)",zh:"AI Tasks\uFF1A\u66F4\u65B0\u770B\u677F\uFF08AI\uFF09"},"menu.import_selection_ai":{en:"AI Tasks: Import selection as tasks (AI)",zh:"AI Tasks\uFF1A\u5C06\u9009\u4E2D\u6587\u672C\u5BFC\u5165\u4E3A\u4EFB\u52A1\uFF08AI\uFF09"},"btn.cancel":{en:"Cancel",zh:"\u53D6\u6D88"},"btn.close":{en:"Close",zh:"\u5173\u95ED"},"btn.save":{en:"Save",zh:"\u4FDD\u5B58"},"btn.reload":{en:"Reload",zh:"\u91CD\u65B0\u52A0\u8F7D"},"btn.copy_json":{en:"Copy JSON",zh:"\u590D\u5236 JSON"},"btn.edit":{en:"Edit",zh:"\u7F16\u8F91"},"btn.archive":{en:"Archive",zh:"\u5F52\u6863"},"btn.delete":{en:"Delete",zh:"\u5220\u9664"},"btn.import":{en:"Import",zh:"\u5BFC\u5165"},"btn.generate":{en:"Generate",zh:"\u751F\u6210"},"notice.runtime.already_running":{en:"AI Tasks: runtime already running.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u5DF2\u5728\u8FD0\u884C\u3002"},"notice.runtime.already_online":{en:"AI Tasks: runtime already online.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u5DF2\u5728\u7EBF\u3002"},"notice.runtime.command_empty":{en:"AI Tasks: runtime command is empty.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u542F\u52A8\u547D\u4EE4\u4E3A\u7A7A\u3002"},"notice.runtime.start_failed":{en:"AI Tasks: runtime start failed: {{error}}",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u542F\u52A8\u5931\u8D25\uFF1A{{error}}"},"notice.runtime.starting":{en:"AI Tasks: runtime starting.",zh:"AI Tasks\uFF1A\u6B63\u5728\u542F\u52A8\u8FD0\u884C\u65F6\u3002"},"notice.runtime.starting_pid":{en:"AI Tasks: runtime starting (pid {{pid}}).",zh:"AI Tasks\uFF1A\u6B63\u5728\u542F\u52A8\u8FD0\u884C\u65F6\uFF08pid {{pid}}\uFF09\u3002"},"notice.runtime.stop_requested":{en:"AI Tasks: runtime stop requested.",zh:"AI Tasks\uFF1A\u5DF2\u8BF7\u6C42\u505C\u6B62\u8FD0\u884C\u65F6\u3002"},"notice.runtime.not_running":{en:"AI Tasks: runtime not running.",zh:"AI Tasks\uFF1A\u8FD0\u884C\u65F6\u672A\u5728\u8FD0\u884C\u3002"},"notice.clipboard.copied":{en:"Copied to clipboard.",zh:"\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F\u3002"},"notice.clipboard.copy_failed":{en:"Copy failed: {{error}}",zh:"\u590D\u5236\u5931\u8D25\uFF1A{{error}}"},"settings.board_path.name":{en:"Board file path",zh:"\u770B\u677F\u6587\u4EF6\u8DEF\u5F84"},"settings.board_path.desc":{en:"Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).",zh:"Vault \u5185 Board.md \u7684\u8DEF\u5F84\uFF08\u4F8B\u5982 Tasks/Boards/Board.md\uFF09\u3002"},"settings.render_board_in_note.name":{en:"Render board in note",zh:"\u5728\u7B14\u8BB0\u533A\u57DF\u6E32\u67D3\u770B\u677F"},"settings.render_board_in_note.desc":{en:"Replace Board.md with a draggable visual board in the note area (editor + preview).",zh:"\u5728\u7B14\u8BB0\u533A\u57DF\uFF08\u7F16\u8F91 + \u9884\u89C8\uFF09\u7528\u53EF\u62D6\u62FD\u53EF\u89C6\u5316\u770B\u677F\u66FF\u6362 Board.md\u3002"},"settings.board_layout.name":{en:"Board layout",zh:"\u770B\u677F\u5E03\u5C40"},"settings.board_layout.desc":{en:"Default view for the in-note board UI.",zh:"\u7B14\u8BB0\u5185\u770B\u677F UI \u7684\u9ED8\u8BA4\u89C6\u56FE\u3002"},"settings.board_layout.opt.split":{en:"Split (list + detail)",zh:"\u62C6\u5206\uFF08\u5217\u8868 + \u8BE6\u60C5\uFF09"},"settings.board_layout.opt.kanban":{en:"Kanban (columns)",zh:"\u770B\u677F\uFF08\u5217\uFF09"},"settings.board_layout.opt.md":{en:"MD (raw editor)",zh:"MD\uFF08\u539F\u59CB\u7F16\u8F91\uFF09"},"settings.archive_folder.name":{en:"Archive folder path",zh:"\u5F52\u6863\u6587\u4EF6\u5939\u8DEF\u5F84"},"settings.archive_folder.desc":{en:"Folder for archived tasks (daily files), e.g. Archive.",zh:"\u5F52\u6863\u4EFB\u52A1\u7684\u6587\u4EF6\u5939\uFF08\u6309\u5929\u5199\u6587\u4EF6\uFF09\uFF0C\u4F8B\u5982 Archive\u3002"},"settings.tag_presets.name":{en:"Tag presets",zh:"\u6807\u7B7E\u9884\u8BBE"},"settings.tag_presets.desc":{en:"One tag per line. AI will prefer these tags when proposing/importing tasks.",zh:"\u6BCF\u884C\u4E00\u4E2A\u6807\u7B7E\u3002AI \u751F\u6210/\u5BFC\u5165\u4EFB\u52A1\u65F6\u4F1A\u4F18\u5148\u4F7F\u7528\u8FD9\u4E9B\u6807\u7B7E\u3002"},"settings.runtime_url.name":{en:"Runtime URL",zh:"\u8FD0\u884C\u65F6 URL"},"settings.runtime_url.desc":{en:"Local runtime base URL (Agno + FastAPI).",zh:"\u672C\u5730\u8FD0\u884C\u65F6\u57FA\u5730\u5740\uFF08Agno + FastAPI\uFF09\u3002"},"settings.runtime_auto_start.name":{en:"Auto-start runtime",zh:"\u81EA\u52A8\u542F\u52A8\u8FD0\u884C\u65F6"},"settings.runtime_auto_start.desc":{en:"Start the local runtime automatically when Obsidian starts.",zh:"\u6253\u5F00 Obsidian \u65F6\u81EA\u52A8\u542F\u52A8\u672C\u5730\u8FD0\u884C\u65F6\u3002"},"settings.ui_language.name":{en:"UI language",zh:"\u754C\u9762\u8BED\u8A00"},"settings.ui_language.desc":{en:"Auto follows Obsidian language. You can also override it.",zh:"\u81EA\u52A8\u8DDF\u968F Obsidian \u8BED\u8A00\uFF1B\u4E5F\u53EF\u4EE5\u624B\u52A8\u8986\u76D6\u3002"},"settings.ui_language.opt.auto":{en:"Auto",zh:"\u81EA\u52A8"},"settings.ui_language.opt.zh":{en:"Chinese (Simplified)",zh:"\u4E2D\u6587"},"settings.ui_language.opt.en":{en:"English",zh:"English"},"settings.runtime_service.heading":{en:"Runtime Service",zh:"\u8FD0\u884C\u65F6\u670D\u52A1"},"settings.runtime.status.unchecked":{en:"Status: unchecked",zh:"\u72B6\u6001\uFF1A\u672A\u68C0\u67E5"},"runtime.status.online":{en:"online",zh:"\u5728\u7EBF"},"runtime.status.offline":{en:"offline",zh:"\u79BB\u7EBF"},"runtime.status.uptime":{en:"uptime {{mins}}m",zh:"\u8FD0\u884C {{mins}}m"},"runtime.status.local_pid":{en:"local pid {{pid}}",zh:"\u672C\u5730 pid {{pid}}"},"settings.runtime_control.name":{en:"Runtime control",zh:"\u8FD0\u884C\u65F6\u63A7\u5236"},"settings.runtime_control.desc":{en:"Start/stop local ai-tasks-runtime and refresh status.",zh:"\u542F\u52A8/\u505C\u6B62\u672C\u5730 ai-tasks-runtime \u5E76\u5237\u65B0\u72B6\u6001\u3002"},"settings.runtime_control.btn.check":{en:"Check status",zh:"\u68C0\u67E5\u72B6\u6001"},"settings.runtime_control.btn.start":{en:"Start",zh:"\u542F\u52A8"},"settings.runtime_control.btn.stop":{en:"Stop",zh:"\u505C\u6B62"},"settings.runtime_command.name":{en:"Runtime start command",zh:"\u8FD0\u884C\u65F6\u542F\u52A8\u547D\u4EE4"},"settings.runtime_command.desc":{en:"Executable to start the runtime (e.g. ai-tasks-runtime).",zh:"\u542F\u52A8\u8FD0\u884C\u65F6\u7684\u53EF\u6267\u884C\u6587\u4EF6\uFF08\u4F8B\u5982 ai-tasks-runtime\uFF09\u3002"},"settings.runtime_args.name":{en:"Runtime args",zh:"\u8FD0\u884C\u65F6\u53C2\u6570"},"settings.runtime_args.desc":{en:"Arguments for runtime start (e.g. serve).",zh:"\u8FD0\u884C\u65F6\u542F\u52A8\u53C2\u6570\uFF08\u4F8B\u5982 serve\uFF09\u3002"},"settings.runtime_cwd.name":{en:"Runtime working directory",zh:"\u8FD0\u884C\u65F6\u5DE5\u4F5C\u76EE\u5F55"},"settings.runtime_cwd.desc":{en:"Optional working directory for the runtime process.",zh:"\u8FD0\u884C\u65F6\u8FDB\u7A0B\u7684\u53EF\u9009\u5DE5\u4F5C\u76EE\u5F55\u3002"},"settings.agent_dir.name":{en:"Agent workspace directory",zh:"Agent \u5DE5\u4F5C\u76EE\u5F55"},"settings.agent_dir.desc":{en:"Optional. Store prompts/memory here; set to a vault path to edit prompts in Obsidian.",zh:"\u53EF\u9009\u3002\u7528\u4E8E\u5B58\u653E\u63D0\u793A\u8BCD/\u8BB0\u5FC6\uFF1B\u8BBE\u7F6E\u4E3A Vault \u5185\u8DEF\u5F84\u5373\u53EF\u5728 Obsidian \u4E2D\u7F16\u8F91\u63D0\u793A\u8BCD\u3002"},"settings.runtime.version.line":{en:"Plugin v{{plugin}} | Runtime v{{runtime}}",zh:"\u63D2\u4EF6 v{{plugin}} | \u8FD0\u884C\u65F6 v{{runtime}}"},"settings.runtime.version.unknown":{en:"unknown",zh:"\u672A\u77E5"},"settings.model.heading":{en:"Model Settings",zh:"\u6A21\u578B\u8BBE\u7F6E"},"settings.model_provider.name":{en:"Model provider",zh:"\u6A21\u578B\u63D0\u4F9B\u8005"},"settings.model_provider.desc":{en:"codex-cli (local) or OpenAI-compatible API.",zh:"codex-cli\uFF08\u672C\u5730\uFF09\u6216 OpenAI-compatible API\u3002"},"settings.model_provider.opt.codex":{en:"codex-cli (local)",zh:"codex-cli\uFF08\u672C\u5730\uFF09"},"settings.model_provider.opt.openai":{en:"OpenAI-compatible API",zh:"OpenAI-compatible API"},"settings.codex_cli_path.name":{en:"Codex CLI path",zh:"Codex CLI \u8DEF\u5F84"},"settings.codex_cli_path.desc":{en:"Optional path to local codex executable (used by codex-cli).",zh:"\u672C\u5730 codex \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84\uFF08\u4EC5\u7528\u4E8E codex-cli\uFF09\u3002"},"settings.model_name.name":{en:"Model name",zh:"\u6A21\u578B\u540D\u79F0"},"settings.model_name.desc":{en:"Model identifier (for OpenAI-compatible providers).",zh:"\u6A21\u578B\u6807\u8BC6\uFF08\u7528\u4E8E OpenAI-compatible provider\uFF09\u3002"},"settings.model_base_url.name":{en:"API base URL",zh:"API base URL"},"settings.model_base_url.desc":{en:"Base URL for OpenAI-compatible API (e.g. https://api.openai.com).",zh:"OpenAI-compatible \u7684 base URL\uFF08\u4F8B\u5982 https://api.openai.com\uFF09\u3002"},"settings.model_api_key.name":{en:"API key",zh:"API key"},"settings.model_api_key.desc":{en:"API key for OpenAI-compatible providers (stored locally).",zh:"OpenAI-compatible \u7684 API key\uFF08\u4EC5\u4FDD\u5B58\u5728\u672C\u5730\uFF09\u3002"},"settings.model_temperature.name":{en:"Temperature",zh:"\u6E29\u5EA6"},"settings.model_temperature.desc":{en:"Sampling temperature (e.g. 0.2).",zh:"\u91C7\u6837\u6E29\u5EA6\uFF08\u4F8B\u5982 0.2\uFF09\u3002"},"settings.model_top_p.name":{en:"Top P",zh:"Top P"},"settings.model_top_p.desc":{en:"Nucleus sampling (0-1).",zh:"\u6838\u91C7\u6837\uFF080-1\uFF09\u3002"},"settings.model_max_tokens.name":{en:"Max tokens",zh:"\u6700\u5927 tokens"},"settings.model_max_tokens.desc":{en:"Max output tokens (OpenAI-compatible).",zh:"\u6700\u5927\u8F93\u51FA tokens\uFF08OpenAI-compatible\uFF09\u3002"},"settings.diagnostics.heading":{en:"Diagnostics",zh:"\u8BCA\u65AD"},"settings.diagnostics.test_ai.name":{en:"Test AI",zh:"\u6D4B\u8BD5 AI"},"settings.diagnostics.test_ai.desc":{en:"Send a safe dry-run request to verify AI configuration (no writes).",zh:"\u53D1\u8D77\u4E00\u6B21\u5B89\u5168\u7684\u6D4B\u8BD5\u8BF7\u6C42\uFF0C\u7528\u4E8E\u9A8C\u8BC1 AI \u914D\u7F6E\u4E0E\u8FDE\u901A\u6027\uFF08\u4E0D\u4F1A\u5199\u5165/\u4FEE\u6539\u4EFB\u4F55\u6587\u4EF6\uFF09\u3002"},"settings.diagnostics.test_ai.btn":{en:"Run",zh:"\u8FD0\u884C"},"settings.diagnostics.test_agent.name":{en:"Test Agent",zh:"\u6D4B\u8BD5 Agent"},"settings.diagnostics.test_agent.desc":{en:"Call the Agent pipeline to verify agent/tooling is working (no writes).",zh:"\u8C03\u7528 Agent \u7BA1\u7EBF\uFF0C\u7528\u4E8E\u9A8C\u8BC1 agent/tooling \u662F\u5426\u53EF\u7528\uFF08\u4E0D\u4F1A\u5199\u5165/\u4FEE\u6539\u4EFB\u4F55\u6587\u4EF6\uFF09\u3002"},"settings.diagnostics.test_agent.btn":{en:"Run",zh:"\u8FD0\u884C"},"diagnostics.modal.title.ai":{en:"AI Tasks: Test AI result",zh:"AI Tasks\uFF1A\u6D4B\u8BD5 AI \u7ED3\u679C"},"diagnostics.modal.title.agent":{en:"AI Tasks: Test Agent result",zh:"AI Tasks\uFF1A\u6D4B\u8BD5 Agent \u7ED3\u679C"},"diagnostics.modal.summary.ok":{en:"OK",zh:"\u6210\u529F"},"diagnostics.modal.summary.fail":{en:"FAILED",zh:"\u5931\u8D25"},"diagnostics.modal.latency":{en:"Latency: {{ms}} ms",zh:"\u8017\u65F6\uFF1A{{ms}} ms"},"board.title":{en:"AI Tasks Board",zh:"AI Tasks Board"},"board.view.kanban":{en:"Kanban",zh:"\u770B\u677F"},"board.view.split":{en:"Kan Detail",zh:"\u8BE6\u60C5"},"board.view.md":{en:"MD",zh:"MD"},"board.search.placeholder":{en:"Search title/tags...",zh:"\u641C\u7D22\u6807\u9898/\u6807\u7B7E..."},"board.status_filter.all":{en:"All statuses",zh:"\u5168\u90E8\u72B6\u6001"},"board.tags.title":{en:"Tags",zh:"\u6807\u7B7E"},"board.tags.empty":{en:"(none)",zh:"\uFF08\u65E0\uFF09"},"board.md.saved_notice":{en:"AI Tasks: saved Board.md (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u4FDD\u5B58 Board.md\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"board.md.read_failed":{en:"Failed to read Board.md.",zh:"\u8BFB\u53D6 Board.md \u5931\u8D25\u3002"},"board.md.parse_failed":{en:"Failed to parse Board.md (unknown error).",zh:"\u89E3\u6790 Board.md \u5931\u8D25\uFF08\u672A\u77E5\u9519\u8BEF\uFF09\u3002"},"board.md.tip_switch_md":{en:"Tip: switch view to MD to edit/fix the file.",zh:"\u63D0\u793A\uFF1A\u5207\u6362\u5230 MD \u89C6\u56FE\u7F16\u8F91/\u4FEE\u590D\u6587\u4EF6\u3002"},"board.task.select_to_view":{en:"Select a task to view details.",zh:"\u9009\u62E9\u4E00\u4E2A\u4EFB\u52A1\u67E5\u770B\u8BE6\u60C5\u3002"},"board.task.no_details":{en:"(no details)",zh:"\uFF08\u65E0\u8BE6\u60C5\uFF09"},"board.confirm.archive":{en:"Archive this task?",zh:"\u5F52\u6863\u8FD9\u4E2A\u4EFB\u52A1\uFF1F"},"board.confirm.delete":{en:"Delete this task?",zh:"\u5220\u9664\u8FD9\u4E2A\u4EFB\u52A1\uFF1F"},"board.notice.archived_to":{en:"Archived task to {{path}}",zh:"\u5DF2\u5F52\u6863\u5230 {{path}}"},"board.notice.deleted":{en:"Deleted task.",zh:"\u5DF2\u5220\u9664\u4EFB\u52A1\u3002"},"board.notice.fixed_escaped_newlines":{en:"AI Tasks: fixed escaped newlines in Board.md.",zh:"AI Tasks\uFF1A\u5DF2\u4FEE\u590D Board.md \u4E2D\u7684\u8F6C\u4E49\u6362\u884C\u3002"},"board.btn.add":{en:"+ Add",zh:"+ \u65B0\u5EFA"},"board.task.sessions.title":{en:"AI Sessions",zh:"AI \u4F1A\u8BDD"},"board.task.sessions.empty":{en:"No session info.",zh:"\u65E0\u4F1A\u8BDD\u4FE1\u606F\u3002"},"board.task.sessions.missing":{en:"Session file not found.",zh:"\u672A\u627E\u5230\u4F1A\u8BDD\u6587\u4EF6\u3002"},"board.captured_sessions.title":{en:"Captured Sessions",zh:"\u6355\u6349\u5230\u7684\u4F1A\u8BDD"},"board.captured_sessions.empty":{en:"No captured sessions yet.",zh:"\u6682\u672A\u6355\u6349\u5230\u4F1A\u8BDD\u5185\u5BB9\u3002"},"board.captured_sessions.time":{en:"Time: {{ts}}",zh:"\u65F6\u95F4\uFF1A{{ts}}"},"debug.view.title":{en:"AI Tasks Debug",zh:"AI Tasks \u8C03\u8BD5"},"debug.btn.refresh":{en:"Refresh",zh:"\u5237\u65B0"},"debug.btn.sync_once":{en:"Sync now",zh:"\u7ACB\u5373\u540C\u6B65"},"debug.btn.syncing":{en:"Syncing...",zh:"\u540C\u6B65\u4E2D..."},"debug.btn.auto_on":{en:"Auto: ON",zh:"\u81EA\u52A8\u5237\u65B0\uFF1A\u5F00"},"debug.btn.auto_off":{en:"Auto: OFF",zh:"\u81EA\u52A8\u5237\u65B0\uFF1A\u5173"},"debug.notice.sync_ok":{en:"Sync completed, wrote {{count}} session file(s).",zh:"\u540C\u6B65\u5B8C\u6210\uFF0C\u5199\u5165 {{count}} \u4E2A\u4F1A\u8BDD\u6587\u4EF6\u3002"},"debug.notice.sync_failed":{en:"Sync failed: {{error}}",zh:"\u540C\u6B65\u5931\u8D25\uFF1A{{error}}"},"debug.section.stage":{en:"Capture stages",zh:"\u6293\u53D6\u9636\u6BB5"},"debug.section.events":{en:"Recent plugin events",zh:"\u6700\u8FD1\u63D2\u4EF6\u4E8B\u4EF6"},"debug.section.watch_logs":{en:"Watcher logs",zh:"\u76D1\u542C\u65E5\u5FD7"},"debug.logs.stdout":{en:"sessions.stdout.log",zh:"sessions.stdout.log"},"debug.logs.stderr":{en:"sessions.stderr.log",zh:"sessions.stderr.log"},"debug.card.runtime":{en:"Runtime",zh:"\u8FD0\u884C\u65F6"},"debug.card.watcher":{en:"Watcher",zh:"\u76D1\u542C\u5668"},"debug.card.session_dir":{en:"Session dir",zh:"\u4F1A\u8BDD\u76EE\u5F55"},"debug.card.total":{en:"Total sessions",zh:"\u7D2F\u8BA1\u4F1A\u8BDD\u6570"},"debug.card.today":{en:"Today sessions",zh:"\u4ECA\u65E5\u4F1A\u8BDD\u6570"},"debug.card.latest":{en:"Latest session",zh:"\u6700\u65B0\u4F1A\u8BDD"},"debug.stage.runtime":{en:"Runtime ready",zh:"\u8FD0\u884C\u65F6\u5C31\u7EEA"},"debug.stage.watcher":{en:"Watcher running",zh:"\u76D1\u542C\u5668\u8FD0\u884C"},"debug.stage.poll":{en:"Poll cycle",zh:"\u8F6E\u8BE2\u5468\u671F"},"debug.stage.write":{en:"Session write",zh:"\u4F1A\u8BDD\u5199\u5165"},"debug.stage.link":{en:"Board link",zh:"\u770B\u677F\u5173\u8054"},"debug.stage.no_tick":{en:"No polling result yet.",zh:"\u5C1A\u65E0\u8F6E\u8BE2\u7ED3\u679C\u3002"},"debug.stage.waiting_data":{en:"Waiting for data.",zh:"\u7B49\u5F85\u6570\u636E\u4E2D\u3002"},"debug.stage.none_new":{en:"No new session in this cycle.",zh:"\u672C\u8F6E\u65E0\u65B0\u4F1A\u8BDD\u3002"},"debug.stage.failed":{en:"Failed. See stderr/events.",zh:"\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B stderr/\u4E8B\u4EF6\u3002"},"debug.stage.wait_stable":{en:"New session exists but still stabilizing.",zh:"\u6709\u65B0\u4F1A\u8BDD\u4F46\u4ECD\u5728\u7A33\u5B9A\u671F\u3002"},"debug.stage.skipped_old":{en:"Historical sessions skipped by ignore_before.",zh:"\u5386\u53F2\u4F1A\u8BDD\u88AB ignore_before \u8DF3\u8FC7\u3002"},"debug.stage.written":{en:"Wrote {{count}} new session file(s).",zh:"\u5DF2\u5199\u5165 {{count}} \u4E2A\u65B0\u4F1A\u8BDD\u6587\u4EF6\u3002"},"debug.stage.linked":{en:"Linked {{count}} session(s) to tasks.",zh:"\u5DF2\u5173\u8054 {{count}} \u4E2A\u4F1A\u8BDD\u5230\u4EFB\u52A1\u3002"},"debug.stage.created_unassigned":{en:"Created {{count}} unassigned task(s).",zh:"\u5DF2\u521B\u5EFA {{count}} \u4E2A\u672A\u5206\u914D\u4EFB\u52A1\u3002"},"debug.stage.no_link_change":{en:"No board link changes this cycle.",zh:"\u672C\u8F6E\u770B\u677F\u65E0\u5173\u8054\u53D8\u66F4\u3002"},"debug.stage.none":{en:"(none)",zh:"\uFF08\u65E0\uFF09"},"debug.stage.no_events":{en:"No events yet.",zh:"\u6682\u65E0\u4E8B\u4EF6\u3002"},"debug.status.online":{en:"online",zh:"\u5728\u7EBF"},"debug.status.offline":{en:"offline",zh:"\u79BB\u7EBF"},"debug.status.running":{en:"running",zh:"\u8FD0\u884C\u4E2D"},"debug.status.stopped":{en:"stopped",zh:"\u672A\u8FD0\u884C"},"debug.status.exists":{en:"exists",zh:"\u5B58\u5728"},"debug.status.missing":{en:"missing",zh:"\u4E0D\u5B58\u5728"},"draft_modal.title.add":{en:"AI Tasks: Add to board",zh:"AI Tasks\uFF1A\u6DFB\u52A0\u5230\u770B\u677F"},"draft_modal.title.update":{en:"AI Tasks: Update board",zh:"AI Tasks\uFF1A\u66F4\u65B0\u770B\u677F"},"draft_modal.label.draft":{en:"Draft (editable)",zh:"Draft\uFF08\u53EF\u7F16\u8F91\uFF09"},"draft_modal.label.instruction":{en:"Extra instruction (optional)",zh:"\u989D\u5916\u6307\u4EE4\uFF08\u53EF\u9009\uFF09"},"draft_modal.placeholder.instruction":{en:"e.g. set status=Todo, add tag=release, update existing task if it matches...",zh:"\u4F8B\u5982\uFF1A\u8BBE\u7F6E status=Todo\uFF0C\u6DFB\u52A0 tag=release\uFF1B\u5982\u679C\u5339\u914D\u5219\u66F4\u65B0\u5DF2\u6709\u4EFB\u52A1\u2026\u2026"},"draft_modal.btn.generate_preview":{en:"Generate preview",zh:"\u751F\u6210\u9884\u89C8"},"draft_modal.btn.confirm_write":{en:"Confirm & write",zh:"\u786E\u8BA4\u5E76\u5199\u5165"},"draft_modal.label.before":{en:"Before",zh:"\u5199\u5165\u524D"},"draft_modal.label.after":{en:"After",zh:"\u5199\u5165\u540E"},"draft_modal.status.generating":{en:"Generating preview...",zh:"\u6B63\u5728\u751F\u6210\u9884\u89C8..."},"draft_modal.status.preview_ready":{en:"Preview ready.",zh:"\u9884\u89C8\u5DF2\u5C31\u7EEA\u3002"},"draft_modal.status.failed":{en:"Failed: {{error}}",zh:"\u5931\u8D25\uFF1A{{error}}"},"draft_modal.notice.preview_failed":{en:"AI Tasks: preview failed: {{error}} (see console)",zh:"AI Tasks\uFF1A\u9884\u89C8\u5931\u8D25\uFF1A{{error}}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09"},"draft_modal.notice.board_not_ready":{en:"AI Tasks: board file not ready.",zh:"AI Tasks\uFF1A\u770B\u677F\u6587\u4EF6\u672A\u5C31\u7EEA\u3002"},"draft_modal.notice.generate_first":{en:"AI Tasks: please generate preview first.",zh:"AI Tasks\uFF1A\u8BF7\u5148\u751F\u6210\u9884\u89C8\u3002"},"draft_modal.notice.wrote_update":{en:"AI Tasks: wrote board update (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u5199\u5165\u770B\u677F\u66F4\u65B0\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"draft_modal.notice.write_failed":{en:"AI Tasks: write failed: {{error}} (see console)",zh:"AI Tasks\uFF1A\u5199\u5165\u5931\u8D25\uFF1A{{error}}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09"},"bulk_modal.title":{en:"AI Tasks: Import tasks",zh:"AI Tasks\uFF1A\u5BFC\u5165\u4EFB\u52A1"},"bulk_modal.subtitle":{en:"Split a messy list into clear tasks, then import in one click.",zh:"\u628A\u6742\u4E71\u6E05\u5355\u62C6\u6210\u6E05\u6670\u4EFB\u52A1\uFF0C\u518D\u4E00\u952E\u5BFC\u5165\u770B\u677F\u3002"},"bulk_modal.session.title":{en:"Current computer session capture (Codex)",zh:"\u5F53\u524D\u7535\u8111\u4F1A\u8BDD\u6293\u53D6\uFF08Codex\uFF09"},"bulk_modal.session.btn_refresh":{en:"Refresh",zh:"\u5237\u65B0"},"bulk_modal.session.status_refreshed":{en:"Session info refreshed.",zh:"\u4F1A\u8BDD\u4FE1\u606F\u5DF2\u5237\u65B0\u3002"},"bulk_modal.session.btn_auto_on":{en:"Auto: ON",zh:"\u81EA\u52A8\u5237\u65B0\uFF1A\u5F00"},"bulk_modal.session.btn_auto_off":{en:"Auto: OFF",zh:"\u81EA\u52A8\u5237\u65B0\uFF1A\u5173"},"bulk_modal.session.status_auto_on":{en:"Auto refresh enabled (every 30s).",zh:"\u5DF2\u5F00\u542F\u81EA\u52A8\u5237\u65B0\uFF08\u6BCF 30 \u79D2\uFF09\u3002"},"bulk_modal.session.status_auto_off":{en:"Auto refresh disabled.",zh:"\u5DF2\u5173\u95ED\u81EA\u52A8\u5237\u65B0\u3002"},"bulk_modal.session.last_updated":{en:"Last updated: {{ts}}",zh:"\u6700\u540E\u5237\u65B0\uFF1A{{ts}}"},"bulk_modal.session.root":{en:"Session directory",zh:"\u4F1A\u8BDD\u76EE\u5F55"},"bulk_modal.session.total":{en:"Total rollouts",zh:"\u7D2F\u8BA1\u6293\u53D6\u6570"},"bulk_modal.session.today":{en:"Today rollouts",zh:"\u4ECA\u65E5\u6293\u53D6\u6570"},"bulk_modal.session.latest_id":{en:"Latest session",zh:"\u6700\u65B0\u4F1A\u8BDD ID"},"bulk_modal.session.latest_time":{en:"Latest time",zh:"\u6700\u65B0\u65F6\u95F4"},"bulk_modal.session.none":{en:"(none)",zh:"\uFF08\u65E0\uFF09"},"bulk_modal.session.unavailable":{en:"Session directory not found. Start Codex at least once to generate local sessions.",zh:"\u672A\u627E\u5230\u4F1A\u8BDD\u76EE\u5F55\u3002\u8BF7\u81F3\u5C11\u542F\u52A8\u4E00\u6B21 Codex\uFF0C\u4EE5\u751F\u6210\u672C\u5730\u4F1A\u8BDD\u8BB0\u5F55\u3002"},"bulk_modal.label.text":{en:"Text to split into tasks (editable)",zh:"\u5F85\u62C6\u5206\u4E3A\u4EFB\u52A1\u7684\u6587\u672C\uFF08\u53EF\u7F16\u8F91\uFF09"},"bulk_modal.placeholder.text":{en:"Paste a task list here...",zh:"\u5728\u8FD9\u91CC\u7C98\u8D34\u4EFB\u52A1\u5217\u8868..."},"bulk_modal.label.instruction":{en:"Extra instruction (optional)",zh:"\u989D\u5916\u6307\u4EE4\uFF08\u53EF\u9009\uFF09"},"bulk_modal.placeholder.instruction":{en:"e.g. Use tags from presets; keep titles short; group by category...",zh:"\u4F8B\u5982\uFF1A\u4F18\u5148\u4F7F\u7528\u6807\u7B7E\u9884\u8BBE\uFF1B\u6807\u9898\u5C3D\u91CF\u77ED\uFF1B\u6309\u7C7B\u522B\u5206\u7EC4\u2026\u2026"},"bulk_modal.btn.import_to_board":{en:"Import to board",zh:"\u5BFC\u5165\u5230\u770B\u677F"},"bulk_modal.meta.no_tags":{en:"no-tags",zh:"\u65E0\u6807\u7B7E"},"bulk_modal.empty":{en:"(no tasks yet)",zh:"\uFF08\u8FD8\u6CA1\u6709\u4EFB\u52A1\uFF09"},"bulk_modal.status.generating":{en:"Generating...",zh:"\u6B63\u5728\u751F\u6210..."},"bulk_modal.status.ready":{en:"Ready ({{count}} tasks).",zh:"\u5C31\u7EEA\uFF08{{count}} \u4E2A\u4EFB\u52A1\uFF09\u3002"},"bulk_modal.status.failed":{en:"Failed: {{error}}",zh:"\u5931\u8D25\uFF1A{{error}}"},"bulk_modal.notice.generate_failed":{en:"AI Tasks: generate failed: {{error}}",zh:"AI Tasks\uFF1A\u751F\u6210\u5931\u8D25\uFF1A{{error}}"},"bulk_modal.notice.board_not_ready":{en:"AI Tasks: board file not ready.",zh:"AI Tasks\uFF1A\u770B\u677F\u6587\u4EF6\u672A\u5C31\u7EEA\u3002"},"bulk_modal.notice.generate_first":{en:"AI Tasks: please generate tasks first.",zh:"AI Tasks\uFF1A\u8BF7\u5148\u751F\u6210\u4EFB\u52A1\u3002"},"bulk_modal.notice.imported":{en:"AI Tasks: imported {{count}} tasks (history snapshot created).",zh:"AI Tasks\uFF1A\u5DF2\u5BFC\u5165 {{count}} \u4E2A\u4EFB\u52A1\uFF08\u5DF2\u521B\u5EFA\u5386\u53F2\u5FEB\u7167\uFF09\u3002"},"bulk_modal.notice.import_failed":{en:"AI Tasks: import failed: {{error}}",zh:"AI Tasks\uFF1A\u5BFC\u5165\u5931\u8D25\uFF1A{{error}}"},"task_modal.title.edit":{en:"Edit task",zh:"\u7F16\u8F91\u4EFB\u52A1"},"task_modal.title.new":{en:"New task",zh:"\u65B0\u5EFA\u4EFB\u52A1"},"task_modal.label.title":{en:"Title",zh:"\u6807\u9898"},"task_modal.label.status":{en:"Status",zh:"\u72B6\u6001"},"task_modal.label.tags":{en:"Tags (comma separated)",zh:"\u6807\u7B7E\uFF08\u9017\u53F7\u5206\u9694\uFF09"},"task_modal.placeholder.tags":{en:"e.g. release, bug, v1",zh:"\u4F8B\u5982\uFF1Arelease, bug, v1"},"task_modal.label.body":{en:"Body",zh:"\u5185\u5BB9"},"task_modal.notice.saved":{en:"AI Tasks: saved.",zh:"AI Tasks\uFF1A\u5DF2\u4FDD\u5B58\u3002"},"task_modal.notice.save_failed":{en:"AI Tasks: save failed: {{error}}",zh:"AI Tasks\uFF1A\u4FDD\u5B58\u5931\u8D25\uFF1A{{error}}"}};function Qt(r,e,t){let s=Ye[r],i=e==="zh-CN"?s.zh:s.en;return Je(i,t)}var it=require("obsidian"),yt=require("fs"),Rt=require("path");var nt="ai-tasks-debug-view";function te(r){let e=new Date(r),t=String(e.getFullYear()),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${i}`}function ee(r,e){let t=r.replace(/\r\n/g,`
`).split(`
`).map(s=>s.trimEnd()).filter(s=>s.trim().length>0);return t.length<=e?t:t.slice(t.length-e)}function se(r){let e=(r||"").trim();if(!e.startsWith("{")||!e.endsWith("}"))return null;try{let t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch(t){return null}}function lt(r){return Number.isFinite(r)?String(Math.max(0,Math.floor(r))):"0"}var _t=class extends it.ItemView{constructor(t,s){super(t);this.refreshTimer=null;this.autoRefresh=!0;this.rendering=!1;this.syncingOnce=!1;this.plugin=s}getViewType(){return nt}getDisplayText(){return this.plugin.t("debug.view.title")}getIcon(){return"activity"}async onOpen(){this.contentEl.addClass("ai-tasks-debug-root"),await this.renderSafe(),this.startAutoRefresh()}async onClose(){this.stopAutoRefresh(),this.contentEl.empty()}startAutoRefresh(){this.autoRefresh&&this.refreshTimer===null&&(this.refreshTimer=window.setInterval(()=>{this.renderSafe()},5e3))}stopAutoRefresh(){this.refreshTimer!==null&&(window.clearInterval(this.refreshTimer),this.refreshTimer=null)}setAutoRefresh(t){this.autoRefresh=t,t?this.startAutoRefresh():this.stopAutoRefresh()}async fetchRuntimeState(){try{let t=await J(this.plugin,{path:"/v1/runtime/status",method:"GET",request_id:G(),timeout_ms:3e3});return{online:!!t.json.ok,pid:typeof t.json.pid=="number"?t.json.pid:null,uptimeSec:typeof t.json.uptime_s=="number"?t.json.uptime_s:null,version:typeof t.json.version=="string"?t.json.version:null,error:null}}catch(t){let s=t instanceof M?t:null;return{online:!1,pid:null,uptimeSec:null,version:null,error:s?s.message:t instanceof Error?t.message:String(t)}}}readLogLines(t,s){if(!t)return[];if(!(0,yt.existsSync)(t))return[];try{let i=(0,yt.readFileSync)(t,"utf-8");return ee(i,s)}catch(i){return[]}}parseLatestWatchTick(t){var s;for(let i=t.length-1;i>=0;i--){let n=se((s=t[i])!=null?s:"");if(n&&typeof n.written=="number"&&typeof n.skipped_old=="number")return{ts:typeof n.ts=="number"?n.ts:null,written:n.written,skipped_old:n.skipped_old,skipped_recent:typeof n.skipped_recent=="number"?n.skipped_recent:0,skipped_existing:typeof n.skipped_existing=="number"?n.skipped_existing:0,skipped_already_linked:typeof n.skipped_already_linked=="number"?n.skipped_already_linked:0,linked_updates:typeof n.linked_updates=="number"?n.linked_updates:0,created_unassigned:typeof n.created_unassigned=="number"?n.created_unassigned:0,errors:typeof n.errors=="number"?n.errors:0}}return null}parseSessionRefFromPath(t){for(let s of this.plugin.getSessionSearchRoots()){let i=`${s.replace(/\/+$/g,"")}/`;if(!t.startsWith(i))continue;let a=t.slice(i.length).split("/");if(a.length<2)return null;let l=a[0]||"unknown",o=(a[1]||"").replace(/\.json$/i,"");return o?`${l}:${o}`:null}return null}listSessionFiles(){let t=this.plugin.getSessionSearchRoots().map(s=>`${s.replace(/\/+$/g,"")}/`);return this.app.vault.getFiles().filter(s=>s.path.toLowerCase().endsWith(".json")&&t.some(i=>s.path.startsWith(i))).sort((s,i)=>i.stat.mtime-s.stat.mtime)}async readRecentPluginEvents(t=24){let s=this.app.vault.getFiles().filter(n=>/(^|\/)ai-tasks\.\d{4}-\d{2}-\d{2}\.jsonl$/i.test(n.path)).sort((n,a)=>a.stat.mtime-n.stat.mtime).slice(0,2),i=[];for(let n of s)try{let a=await this.app.vault.read(n),l=ee(a,180);for(let o of l){let u=se(o);if(!u)continue;let d=typeof u.type=="string"?u.type:"",g=typeof u.ts=="string"?u.ts:"";if(!d||!g)continue;let p="";typeof u.error=="string"&&u.error?p=u.error:typeof u.http_status=="number"?p=`http=${u.http_status}`:typeof u.latency_ms=="number"?p=`latency=${u.latency_ms}ms`:typeof u.tasks_count=="number"?p=`tasks=${u.tasks_count}`:typeof u.pid=="number"?p=`pid=${u.pid}`:typeof u.ok=="boolean"&&(p=`ok=${u.ok}`),i.push({ts:g,type:d,summary:p})}}catch(a){}return i.sort((n,a)=>Date.parse(a.ts)-Date.parse(n.ts)),i.slice(0,Math.max(1,t))}buildStages(t,s,i){let n=[],a=[];if(t.online?(a.push(this.plugin.t("debug.status.online")),t.pid!==null&&a.push(`pid ${t.pid}`),t.version&&a.push(`v${t.version}`),t.uptimeSec!==null&&a.push(`${Math.floor(t.uptimeSec/60)}m`)):(a.push(this.plugin.t("debug.status.offline")),t.error&&a.push(t.error)),n.push({name:this.plugin.t("debug.stage.runtime"),status:t.online?"ok":"error",detail:a.join(" | ")}),n.push({name:this.plugin.t("debug.stage.watcher"),status:s?"ok":"warn",detail:s?this.plugin.t("debug.status.running"):this.plugin.t("debug.status.stopped")}),!i)return n.push({name:this.plugin.t("debug.stage.poll"),status:"idle",detail:this.plugin.t("debug.stage.no_tick")}),n.push({name:this.plugin.t("debug.stage.write"),status:"idle",detail:this.plugin.t("debug.stage.waiting_data")}),n.push({name:this.plugin.t("debug.stage.link"),status:"idle",detail:this.plugin.t("debug.stage.waiting_data")}),n;let l=[`written=${lt(i.written)}`,`old=${lt(i.skipped_old)}`,`recent=${lt(i.skipped_recent)}`,`existing=${lt(i.skipped_existing)}`].join(" | ");n.push({name:this.plugin.t("debug.stage.poll"),status:i.errors>0?"error":"ok",detail:l});let o="idle",u=this.plugin.t("debug.stage.none_new");i.errors>0?(o="error",u=this.plugin.t("debug.stage.failed")):i.written>0?(o="ok",u=this.plugin.t("debug.stage.written",{count:i.written})):i.skipped_recent>0?(o="warn",u=this.plugin.t("debug.stage.wait_stable")):i.skipped_old>0&&i.skipped_existing===0&&(o="warn",u=this.plugin.t("debug.stage.skipped_old")),n.push({name:this.plugin.t("debug.stage.write"),status:o,detail:u});let d="idle",g=this.plugin.t("debug.stage.no_link_change");return i.errors>0?(d="error",g=this.plugin.t("debug.stage.failed")):i.linked_updates>0?(d="ok",g=this.plugin.t("debug.stage.linked",{count:i.linked_updates})):i.created_unassigned>0&&(d="ok",g=this.plugin.t("debug.stage.created_unassigned",{count:i.created_unassigned})),n.push({name:this.plugin.t("debug.stage.link"),status:d,detail:g}),n}createSummaryCard(t,s,i,n){let a=t.createDiv({cls:"ai-tasks-debug-card"});a.createDiv({cls:"ai-tasks-debug-card-label",text:s}),a.createDiv({cls:"ai-tasks-debug-card-value",text:i}),n&&n.trim()&&a.createDiv({cls:"ai-tasks-debug-card-hint",text:n})}extractNumber(t,s){if(!t)return null;let i=t[s];return typeof i=="number"?i:null}getSyncResultHint(t){return t.error?t.error:t.code!==null?`code=${t.code}`:this.plugin.t("debug.stage.none")}async renderSafe(){if(!this.rendering){this.rendering=!0;try{await this.renderNow()}finally{this.rendering=!1}}}async renderNow(){var R,I,O,$;let t=this.contentEl;t.empty();let s=t.createDiv({cls:"ai-tasks-debug-head"});s.createDiv({cls:"ai-tasks-debug-title",text:this.plugin.t("debug.view.title")});let i=s.createDiv({cls:"ai-tasks-debug-actions"});i.createEl("button",{text:this.plugin.t("debug.btn.refresh"),cls:"ai-tasks-debug-btn"}).addEventListener("click",()=>{this.renderSafe()}),i.createEl("button",{text:this.syncingOnce?this.plugin.t("debug.btn.syncing"):this.plugin.t("debug.btn.sync_once"),cls:"ai-tasks-debug-btn mod-cta"}).addEventListener("click",()=>{(async()=>{if(this.syncingOnce||this.plugin.isSessionsSyncRunning())return;this.syncingOnce=!0,await this.renderSafe();let C=await this.plugin.runSessionsSyncOnce(),V=this.extractNumber(C.parsed,"written");C.ok?new it.Notice(this.plugin.t("debug.notice.sync_ok",{count:V!=null?V:0})):new it.Notice(this.plugin.t("debug.notice.sync_failed",{error:this.getSyncResultHint(C)})),this.syncingOnce=!1,await this.renderSafe()})()}),i.createEl("button",{text:this.autoRefresh?this.plugin.t("debug.btn.auto_on"):this.plugin.t("debug.btn.auto_off"),cls:"ai-tasks-debug-btn"}).addEventListener("click",()=>{this.setAutoRefresh(!this.autoRefresh),this.renderSafe()});let[o,u]=await Promise.all([this.fetchRuntimeState(),this.readRecentPluginEvents(24)]),d=this.listSessionFiles(),g=(R=d[0])!=null?R:null,p=te(Date.now()),h=d.filter(C=>te(C.stat.mtime)===p).length,c=this.plugin.getPrimarySessionsRoot(),f=this.app.vault.getAbstractFileByPath(c)instanceof it.TFolder,v=this.plugin.isSessionsWatcherRunning(),b=this.plugin.getPluginDirForDebug(),A=b?(0,Rt.join)(b,"sessions.stdout.log"):null,B=b?(0,Rt.join)(b,"sessions.stderr.log"):null,k=this.readLogLines(A,40),S=this.readLogLines(B,24),w=this.parseLatestWatchTick(k),y=t.createDiv({cls:"ai-tasks-debug-summary"});this.createSummaryCard(y,this.plugin.t("debug.card.runtime"),o.online?this.plugin.t("debug.status.online"):this.plugin.t("debug.status.offline"),o.online?`pid=${(I=o.pid)!=null?I:"-"} | v=${(O=o.version)!=null?O:"-"}`:o.error||this.plugin.t("debug.stage.none")),this.createSummaryCard(y,this.plugin.t("debug.card.watcher"),v?this.plugin.t("debug.status.running"):this.plugin.t("debug.status.stopped"),v?`pid=${($=this.plugin.getSessionsWatcherPid())!=null?$:"-"}`:this.plugin.t("debug.stage.none")),this.createSummaryCard(y,this.plugin.t("debug.card.session_dir"),f?this.plugin.t("debug.status.exists"):this.plugin.t("debug.status.missing"),c),this.createSummaryCard(y,this.plugin.t("debug.card.total"),lt(d.length),""),this.createSummaryCard(y,this.plugin.t("debug.card.today"),lt(h),p),this.createSummaryCard(y,this.plugin.t("debug.card.latest"),g?this.parseSessionRefFromPath(g.path)||g.basename:this.plugin.t("debug.stage.none"),g?new Date(g.stat.mtime).toLocaleString():"");let T=t.createDiv({cls:"ai-tasks-debug-section"});T.createDiv({cls:"ai-tasks-debug-section-title",text:this.plugin.t("debug.section.stage")});let D=T.createDiv({cls:"ai-tasks-debug-stage-list"});for(let C of this.buildStages(o,v,w)){let V=D.createDiv({cls:"ai-tasks-debug-stage-row"});V.createDiv({cls:"ai-tasks-debug-stage-name",text:C.name}),V.createDiv({cls:`ai-tasks-debug-stage-badge is-${C.status}`,text:C.status.toUpperCase()}),V.createDiv({cls:"ai-tasks-debug-stage-detail",text:C.detail})}let m=t.createDiv({cls:"ai-tasks-debug-section"});m.createDiv({cls:"ai-tasks-debug-section-title",text:this.plugin.t("debug.section.events")});let x=m.createDiv({cls:"ai-tasks-debug-events"});if(!u.length)x.createDiv({cls:"ai-tasks-debug-empty",text:this.plugin.t("debug.stage.no_events")});else for(let C of u){let V=x.createDiv({cls:"ai-tasks-debug-event-row"});V.createDiv({cls:"ai-tasks-debug-event-ts",text:C.ts}),V.createDiv({cls:"ai-tasks-debug-event-type",text:C.type}),C.summary&&V.createDiv({cls:"ai-tasks-debug-event-summary",text:C.summary})}let P=t.createDiv({cls:"ai-tasks-debug-section"});P.createDiv({cls:"ai-tasks-debug-section-title",text:this.plugin.t("debug.section.watch_logs")});let K=P.createDiv({cls:"ai-tasks-debug-watch-grid"}),H=K.createDiv({cls:"ai-tasks-debug-watch-col"});H.createDiv({cls:"ai-tasks-debug-watch-title",text:this.plugin.t("debug.logs.stdout")});let j=H.createEl("pre",{cls:"ai-tasks-debug-pre"});j.textContent=k.length?k.slice(-12).join(`
`):this.plugin.t("debug.stage.none");let F=K.createDiv({cls:"ai-tasks-debug-watch-col"});F.createDiv({cls:"ai-tasks-debug-watch-title",text:this.plugin.t("debug.logs.stderr")});let E=F.createEl("pre",{cls:"ai-tasks-debug-pre"});E.textContent=S.length?S.slice(-12).join(`
`):this.plugin.t("debug.stage.none")}};var wt="Tasks/Sessions",zt="Sessions";function xt(r,e){return r.replace(/\/+$/g,"")+e}function Xe(r){var i,n;if(!r)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,s;for(;(s=t.exec(r))!==null;){let a=(n=(i=s[1])!=null?i:s[2])!=null?n:s[3];a&&e.push(a)}return e}function Ze(r){let e=(r||"").trim();if(!e)return null;try{let t=new URL(e),s=t.hostname||"127.0.0.1",i=t.port?Number(t.port):17890;return!Number.isFinite(i)||i<=0?null:{host:s,port:i}}catch(t){return null}}function ie(r,e){let t=e.toLowerCase();for(let s=0;s<r.length;s++){let i=(r[s]||"").toLowerCase();if(i===t||i.startsWith(t+"="))return!0}return!1}function Qe(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var Tt=class extends q.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.sessionsProcess=null;this.sessionsPid=null;this.sessionsSyncPromise=null;this.boardOverlay=null;this.autoStartPromise=null;this.sessionsMigrationTimer=null;this.debugStatusEl=null}getObsidianLanguageCode(){var t;try{return((t=q.getLanguage)==null?void 0:t())||"en"}catch(s){return"en"}}getResolvedLanguage(){var t;return Zt((t=this.settings)==null?void 0:t.uiLanguage,this.getObsidianLanguageCode())}t(t,s){return Qt(t,this.getResolvedLanguage(),s)}getPluginVersion(){var i;let t=((i=this.manifest)==null?void 0:i.version)||"",s=this.getPluginDir();if(!s)return t;try{let n=(0,z.readFileSync)((0,N.join)(s,"manifest.json"),"utf8"),a=JSON.parse(n);if(typeof a.version=="string"&&a.version.trim())return a.version.trim()}catch(n){}return t}getPluginDir(){var i;let t=this.app.vault.adapter,s=(i=t==null?void 0:t.getBasePath)==null?void 0:i.call(t);return s?(0,N.join)(s,this.app.vault.configDir,"plugins","ai-tasks-board"):null}getVaultBasePath(){var s;let t=this.app.vault.adapter;return((s=t==null?void 0:t.getBasePath)==null?void 0:s.call(t))||null}getPluginDirForDebug(){return this.getPluginDir()}getPrimarySessionsRoot(){return wt}getSessionSearchRoots(){return[wt,zt]}isRuntimeManagedRunning(){return!!(this.runtimeProcess&&this.runtimeProcess.exitCode===null)}getRuntimeManagedPid(){return this.runtimePid}isSessionsWatcherRunning(){return!!(this.sessionsProcess&&this.sessionsProcess.exitCode===null)}getSessionsWatcherPid(){return this.sessionsPid}isSessionsSyncRunning(){return this.sessionsSyncPromise!==null}getDefaultAgentDir(){try{return(0,N.join)((0,ne.homedir)(),".ai-tasks-board","agent")}catch(t){return null}}getBundledRuntimeCommand(){let t=this.getPluginDir();if(!t)return null;let s=process.platform==="win32"?"ai-tasks-runtime.exe":"ai-tasks-runtime",i=[(0,N.join)(t,"bin",`${process.platform}-${process.arch}`,s),(0,N.join)(t,"bin",process.platform,process.arch,s),(0,N.join)(t,"bin",process.platform,s),(0,N.join)(t,"bin",s)];for(let n of i)if((0,z.existsSync)(n))return n;return null}resolveRuntimeSpawnBase(){var f,v,b,A,B,k;let t=this.getBundledRuntimeCommand(),s=this.settings.runtimeCommand.trim()===Pt.runtimeCommand,i=this.settings.runtimeCommand.trim();if((!i||s)&&t&&(i=t,process.platform!=="win32"))try{(0,z.chmodSync)(i,493)}catch(S){}if(!i)return null;let n=this.getPluginDir(),a=this.settings.runtimeCwd.trim()||i===t&&n||void 0,l={...process.env},o=Ze(this.settings.runtimeUrl);o&&(l.AI_TASKS_HOST=o.host,l.AI_TASKS_PORT=String(o.port));let u=((f=this.settings.agentDir)==null?void 0:f.trim())||this.getDefaultAgentDir();u&&(l.AI_TASKS_AGENT_DIR=u);let d=(v=this.settings.codexCliPath)==null?void 0:v.trim();d&&(l.AI_TASKS_CODEX_BIN=d);let g=(b=this.settings.modelProvider)==null?void 0:b.trim();g&&(l.AI_TASKS_MODEL_PROVIDER=g);let p=(A=this.settings.modelName)==null?void 0:A.trim();p&&(l.AI_TASKS_MODEL_NAME=p);let h=(B=this.settings.modelBaseUrl)==null?void 0:B.trim();h&&(l.AI_TASKS_MODEL_BASE_URL=h);let c=(k=this.settings.modelApiKey)==null?void 0:k.trim();return c&&(l.AI_TASKS_MODEL_API_KEY=c),Number.isFinite(this.settings.modelTemperature)&&(l.AI_TASKS_MODEL_TEMPERATURE=String(this.settings.modelTemperature)),Number.isFinite(this.settings.modelMaxTokens)&&(l.AI_TASKS_MODEL_MAX_TOKENS=String(this.settings.modelMaxTokens)),Number.isFinite(this.settings.modelTopP)&&(l.AI_TASKS_MODEL_TOP_P=String(this.settings.modelTopP)),{cmd:i,cwd:a,env:l,bundledCmd:t,urlInfo:o}}async activateDebugView(){var s;let t=this.app.workspace.getLeavesOfType(nt)[0];t||(t=(s=this.app.workspace.getLeftLeaf(!1))!=null?s:this.app.workspace.getLeaf(!0),await t.setViewState({type:nt,active:!0})),await this.app.workspace.revealLeaf(t)}setupDebugStatusEntry(){if(this.debugStatusEl)return;let t=this.addStatusBarItem();t.setText(this.t("debug.view.title")),t.title=this.t("cmd.open_debug_sidebar"),t.style.cursor="pointer",t.addEventListener("click",()=>{this.activateDebugView()}),this.debugStatusEl=t}async ensureDebugViewVisible(){this.app.workspace.getLeavesOfType(nt).length>0||await this.activateDebugView()}scheduleLegacySessionsMigration(t=1200){this.sessionsMigrationTimer===null&&(this.sessionsMigrationTimer=window.setTimeout(()=>{this.sessionsMigrationTimer=null,this.migrateLegacySessionsToPrimaryRoot()},Math.max(100,t)))}moveJsonFilesRecursive(t,s){let i=0,n=0,a=0;if(!(0,z.existsSync)(t))return{moved:i,skipped:n,errors:a};(0,z.mkdirSync)(s,{recursive:!0});let l=(0,z.readdirSync)(t,{withFileTypes:!0});for(let o of l){let u=(0,N.join)(t,o.name),d=(0,N.join)(s,o.name);if(o.isDirectory()){let g=this.moveJsonFilesRecursive(u,d);i+=g.moved,n+=g.skipped,a+=g.errors;continue}if(o.isFile()&&o.name.toLowerCase().endsWith(".json")){if((0,z.existsSync)(d)){n+=1;continue}try{(0,z.renameSync)(u,d),i+=1}catch(g){try{(0,z.copyFileSync)(u,d),(0,z.unlinkSync)(u),i+=1}catch(p){a+=1}}}}return{moved:i,skipped:n,errors:a}}migrateLegacySessionsToPrimaryRoot(){let t=this.getVaultBasePath();if(!t)return;let s=(0,N.join)(t,zt),i=(0,N.join)(t,wt);if(!(0,z.existsSync)(s))return;let n=this.moveJsonFilesRecursive(s,i);(n.moved>0||n.errors>0)&&_(this,{type:"sessions.migrate.legacy",from:zt,to:wt,moved:n.moved,skipped:n.skipped,errors:n.errors})}async autoStartRuntimeIfNeeded(){this.settings.autoStartRuntime&&(this.autoStartPromise||(this.autoStartPromise=(async()=>{await this.startRuntime()})().finally(()=>{this.autoStartPromise=null}),await this.autoStartPromise))}async onload(){await this.loadSettings(),this.registerView(nt,t=>new _t(t,this)),this.setupDebugStatusEntry(),this.boardOverlay=new vt(this),this.scheduleLegacySessionsMigration(300),this.addCommand({id:"open-ai-tasks-board-note",name:this.t("cmd.open_board_note"),callback:async()=>{let t=this.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);if(s instanceof q.TFile){await this.app.workspace.getLeaf().openFile(s);return}let i=t.split("/").slice(0,-1).join("/");i&&await Y(this.app.vault,i);let n=await this.app.vault.create(t,Qe());await this.app.workspace.getLeaf().openFile(n)}}),this.addCommand({id:"bulk-import-ai-tasks",name:this.t("cmd.bulk_import"),callback:()=>{var s,i;let t=(i=(s=this.app.workspace.getActiveFile())==null?void 0:s.path)!=null?i:null;new st(this,{selection:"",sourcePath:t}).open()}}),this.addCommand({id:"open-ai-tasks-debug-sidebar",name:this.t("cmd.open_debug_sidebar"),callback:()=>{this.activateDebugView()}}),this.addRibbonIcon("activity",this.t("cmd.open_debug_sidebar"),()=>{this.activateDebugView()}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var s;t.path===this.settings.boardPath&&((s=this.boardOverlay)==null||s.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,i)=>{let n=s.getSelection();!n||n.trim().length===0||(t.addItem(a=>{a.setTitle(this.t("menu.add_to_board")).setIcon("plus").onClick(()=>{var l;new ut(this,{mode:"create",selection:n,sourcePath:(l=i.file)==null?void 0:l.path}).open()})}),t.addItem(a=>{a.setTitle(this.t("menu.update_board_ai")).setIcon("wand-2").onClick(()=>{var l;new ut(this,{mode:"auto",selection:n,sourcePath:(l=i.file)==null?void 0:l.path}).open()})}),t.addItem(a=>{a.setTitle(this.t("menu.import_selection_ai")).setIcon("list-plus").onClick(()=>{var l;new st(this,{selection:n,sourcePath:(l=i.file)==null?void 0:l.path}).open()})}))})),this.addSettingTab(new ht(this.app,this)),this.autoStartRuntimeIfNeeded(),this.app.workspace.onLayoutReady(()=>{this.autoStartRuntimeIfNeeded(),this.ensureDebugViewVisible()})}onunload(){var t;if(this.sessionsMigrationTimer!==null&&(window.clearTimeout(this.sessionsMigrationTimer),this.sessionsMigrationTimer=null),(t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null,this.runtimeProcess&&this.runtimeProcess.exitCode===null)try{this.runtimeProcess.kill()}catch(s){}if(this.runtimeProcess=null,this.runtimePid=null,this.sessionsProcess&&this.sessionsProcess.exitCode===null)try{this.sessionsProcess.kill()}catch(s){}this.sessionsProcess=null,this.sessionsPid=null,this.debugStatusEl=null,this.app.workspace.getLeavesOfType(nt).forEach(s=>s.detach())}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}requestOverlayRefresh(){var t;(t=this.boardOverlay)==null||t.requestRefresh()}async loadSettings(){this.settings=Object.assign({},Pt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var s,i,n;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((s=this.settings.modelName)==null?void 0:s.trim())||void 0,base_url:((i=this.settings.modelBaseUrl)==null?void 0:i.trim())||void 0,api_key:((n=this.settings.modelApiKey)==null?void 0:n.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}getTagPresets(){let s=(this.settings.tagPresets||"").replace(/\r\n/g,`
`).split(/\n|[,，]/g).map(a=>a.trim()).filter(a=>a.length>0),i=new Set,n=[];for(let a of s){let l=a.toLowerCase();i.has(l)||(i.add(l),n.push(a))}return n}parseLastJsonLine(t){var i;let s=(t||"").replace(/\r\n/g,`
`).split(`
`).map(n=>n.trim()).filter(n=>n.length>0);for(let n=s.length-1;n>=0;n--){let a=(i=s[n])!=null?i:"";if(!(!a.startsWith("{")||!a.endsWith("}")))try{let l=JSON.parse(a);if(l&&typeof l=="object")return l}catch(l){}}return null}async runSessionsSyncOnce(){return this.sessionsSyncPromise?this.sessionsSyncPromise:(this.sessionsSyncPromise=(async()=>{var b;let t=Date.now(),s=this.resolveRuntimeSpawnBase(),i=this.getVaultBasePath();if(!s||!i){let A=s?"Vault path unavailable.":this.t("notice.runtime.command_empty"),B={ok:!1,code:null,signal:null,latency_ms:Math.max(0,Date.now()-t),stdout:"",stderr:"",parsed:null,error:A};return _(this,{type:"sessions.sync.once.error",error:A}),B}let n=["sessions","sync",i,"--board-path",this.settings.boardPath,"--match-mode","ai"];_(this,{type:"sessions.sync.once.request",cmd:s.cmd,args:n,cwd:(b=s.cwd)!=null?b:null,vault:i,board_path:this.settings.boardPath});let a="",l="",o=null,u=null,d,g=this.getPluginDir(),p=g?(0,N.join)(g,"sessions.stdout.log"):null,h=g?(0,N.join)(g,"sessions.stderr.log"):null;try{let A=(0,St.spawn)(s.cmd,n,{cwd:s.cwd,windowsHide:!0,shell:!1,env:s.env});await new Promise(B=>{var k,S;(k=A.stdout)==null||k.on("data",w=>{let y=w.toString();a+=y,p&&(0,z.appendFileSync)(p,y)}),(S=A.stderr)==null||S.on("data",w=>{let y=w.toString();l+=y,h&&(0,z.appendFileSync)(h,y)}),A.on("error",w=>{d=w instanceof Error?w.message:String(w)}),A.on("close",(w,y)=>{o=w!=null?w:null,u=y!=null?y:null,B()})})}catch(A){d=A instanceof Error?A.message:String(A)}let c=this.parseLastJsonLine(a),f=o===0&&!d,v={ok:f,code:o,signal:u,latency_ms:Math.max(0,Date.now()-t),stdout:a,stderr:l,parsed:c,error:d};return _(this,{type:f?"sessions.sync.once.done":"sessions.sync.once.error",ok:f,code:o,signal:u,latency_ms:v.latency_ms,written:typeof(c==null?void 0:c.written)=="number"?c.written:null,linked_updates:typeof(c==null?void 0:c.linked_updates)=="number"?c.linked_updates:null,created_unassigned:typeof(c==null?void 0:c.created_unassigned)=="number"?c.created_unassigned:null,skipped_old:typeof(c==null?void 0:c.skipped_old)=="number"?c.skipped_old:null,errors:typeof(c==null?void 0:c.errors)=="number"?c.errors:null,error:d!=null?d:null}),this.scheduleLegacySessionsMigration(200),v})().finally(()=>{this.sessionsSyncPromise=null}),this.sessionsSyncPromise)}async startSessionsWatcherIfNeeded(t){var u,d,g,p,h;if(this.sessionsProcess&&this.sessionsProcess.exitCode===null)return;let s=this.getVaultBasePath();if(!s){_(this,{type:"sessions.watch.skip.no_vault_path"});return}let i=["sessions","watch",s,"--board-path",this.settings.boardPath,"--match-mode","ai"];_(this,{type:"sessions.watch.start.request",cmd:t.cmd,args:i,cwd:(u=t.cwd)!=null?u:null,vault:s,board_path:this.settings.boardPath});let n=(0,St.spawn)(t.cmd,i,{cwd:t.cwd,windowsHide:!0,shell:!1,env:t.env});this.sessionsProcess=n,this.sessionsPid=(d=n.pid)!=null?d:null;let a=this.getPluginDir(),l=null,o=null;if(a)try{(0,z.mkdirSync)(a,{recursive:!0}),l=(0,N.join)(a,"sessions.stdout.log"),o=(0,N.join)(a,"sessions.stderr.log"),(g=n.stdout)==null||g.on("data",c=>{l&&(0,z.appendFileSync)(l,c.toString()),this.scheduleLegacySessionsMigration()}),(p=n.stderr)==null||p.on("data",c=>{o&&(0,z.appendFileSync)(o,c.toString())})}catch(c){_(this,{type:"sessions.watch.logfiles_error",error:c instanceof Error?c.message:String(c)})}_(this,{type:"sessions.watch.start.spawned",pid:(h=n.pid)!=null?h:null,stdout_log:l,stderr_log:o}),n.on("exit",(c,f)=>{var v;_(this,{type:"sessions.watch.process.exit",pid:(v=n.pid)!=null?v:null,code:c!=null?c:null,signal:f!=null?f:null}),this.sessionsProcess=null,this.sessionsPid=null}),n.on("error",c=>{var f,v;_(this,{type:"sessions.watch.process.error",pid:(f=n.pid)!=null?f:null,error:c instanceof Error?c.message:String(c),code:(v=c.code)!=null?v:null})})}stopSessionsWatcher(){var t;return!this.sessionsProcess||this.sessionsProcess.exitCode!==null?!1:(this.sessionsProcess.kill(),_(this,{type:"sessions.watch.stop.killed",pid:(t=this.sessionsPid)!=null?t:null}),!0)}async startRuntime(){var o,u,d,g,p,h,c,f,v,b,A,B,k,S;let t=await this.fetchRuntimeStatus(),s=this.resolveRuntimeSpawnBase();if(t!=null&&t.ok){_(this,{type:"runtime.start.skip.online",runtime_url:this.settings.runtimeUrl,pid:(o=t.pid)!=null?o:null,version:(u=t.version)!=null?u:null}),s?await this.startSessionsWatcherIfNeeded(s):_(this,{type:"sessions.watch.skip.no_runtime_cmd"}),new q.Notice(this.t("notice.runtime.already_online"));return}if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){_(this,{type:"runtime.start.skip.running",runtime_url:this.settings.runtimeUrl,pid:(d=this.runtimePid)!=null?d:null}),s?await this.startSessionsWatcherIfNeeded(s):_(this,{type:"sessions.watch.skip.no_runtime_cmd"}),new q.Notice(this.t("notice.runtime.already_running"));return}if(!s){new q.Notice(this.t("notice.runtime.command_empty"));return}let i=Xe(this.settings.runtimeArgs||""),n=s.urlInfo;i.length>0&&i[0]==="serve"&&n&&(ie(i,"--host")||i.push("--host",n.host),ie(i,"--port")||i.push("--port",String(n.port)));let a=(g=s.env.AI_TASKS_AGENT_DIR)!=null?g:null,l=(p=s.env.AI_TASKS_CODEX_BIN)!=null?p:null;_(this,{type:"runtime.start.request",runtime_url:this.settings.runtimeUrl,cmd:s.cmd,args:i,cwd:(h=s.cwd)!=null?h:null,bundled_cmd:(c=s.bundledCmd)!=null?c:null,used_bundled_cmd:s.bundledCmd?s.cmd===s.bundledCmd:null,host:(f=n==null?void 0:n.host)!=null?f:null,port:(v=n==null?void 0:n.port)!=null?v:null,agent_dir:a!=null?a:null,codex_bin:l!=null?l:null});try{let w=(0,St.spawn)(s.cmd,i,{cwd:s.cwd,windowsHide:!0,shell:!1,env:s.env});this.runtimeProcess=w,this.runtimePid=(b=w.pid)!=null?b:null;let y=this.getPluginDir(),T=null,D=null;if(y)try{(0,z.mkdirSync)(y,{recursive:!0}),T=(0,N.join)(y,"runtime.stdout.log"),D=(0,N.join)(y,"runtime.stderr.log"),(A=w.stdout)==null||A.on("data",m=>{T&&(0,z.appendFileSync)(T,m.toString())}),(B=w.stderr)==null||B.on("data",m=>{D&&(0,z.appendFileSync)(D,m.toString())}),console.info(`[ai-tasks-board] runtime logs: ${T} / ${D}`)}catch(m){console.error("[ai-tasks-board] failed to init runtime log files",m),_(this,{type:"runtime.start.logfiles_error",error:m instanceof Error?m.message:String(m)})}_(this,{type:"runtime.start.spawned",pid:(k=w.pid)!=null?k:null,stdout_log:T,stderr_log:D}),w.on("exit",(m,x)=>{var P;_(this,{type:"runtime.process.exit",pid:(P=w.pid)!=null?P:null,code:m!=null?m:null,signal:x!=null?x:null}),this.runtimeProcess=null,this.runtimePid=null}),w.on("error",m=>{var x,P,K,H,j;_(this,{type:"runtime.process.error",pid:(x=w.pid)!=null?x:null,error:m instanceof Error?m.message:String(m),code:(P=m.code)!=null?P:null,errno:(K=m.errno)!=null?K:null,syscall:(H=m.syscall)!=null?H:null,path:(j=m.path)!=null?j:null}),new q.Notice(this.t("notice.runtime.start_failed",{error:m.message}))}),new q.Notice(w.pid?this.t("notice.runtime.starting_pid",{pid:w.pid}):this.t("notice.runtime.starting")),await this.startSessionsWatcherIfNeeded(s)}catch(w){let y=w instanceof Error?w.message:String(w);_(this,{type:"runtime.start.exception",runtime_url:this.settings.runtimeUrl,cmd:s.cmd,args:i,cwd:(S=s.cwd)!=null?S:null,error:y}),new q.Notice(this.t("notice.runtime.start_failed",{error:y}))}}async stopRuntime(){var s,i;let t=!1;_(this,{type:"runtime.stop.request",runtime_url:this.settings.runtimeUrl,pid:(s=this.runtimePid)!=null?s:null}),await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),_(this,{type:"runtime.stop.killed",pid:(i=this.runtimePid)!=null?i:null}),t=!0),this.stopSessionsWatcher()&&(t=!0),t?(_(this,{type:"runtime.stop.done",ok:!0}),new q.Notice(this.t("notice.runtime.stop_requested"))):(_(this,{type:"runtime.stop.done",ok:!1}),new q.Notice(this.t("notice.runtime.not_running")))}async runTestAi(){let t=xt(this.settings.runtimeUrl,"/v1/board/propose"),s={mode:"create",draft:this.getResolvedLanguage()==="zh-CN"?"\u8FD9\u662F\u4E00\u4E2A\u8BCA\u65AD\u6D4B\u8BD5\u8BF7\u6C42\uFF1A\u8BF7\u751F\u6210\u4E00\u4E2A\u6807\u9898\u4E3A\u201CTest AI OK\u201D\u7684\u4EFB\u52A1\uFF08\u4E0D\u4F1A\u5199\u5165\u6587\u4EF6\uFF09\u3002":"This is a diagnostic request: please propose a task titled 'Test AI OK' (no writes).",instruction:null,tasks:[],ai_model:this.getModelConfig(),tag_presets:this.getTagPresets()},i=G(),n={kind:"ai",url:t,latency_ms:0,request:s,ok:!1};try{_(this,{type:"diagnostics.test_ai.request",request_id:i,runtime_url:this.settings.runtimeUrl});let a=await J(this,{path:"/v1/board/propose",method:"POST",body:s,request_id:i});n.latency_ms=a.meta.latency_ms,typeof a.meta.http_status=="number"&&(n.http_status=a.meta.http_status),n.ok=!0,n.response=a.json,_(this,{type:"diagnostics.test_ai.response",request_id:a.meta.request_id,latency_ms:a.meta.latency_ms,http_status:a.meta.http_status})}catch(a){let l=a instanceof M?a:null;l?(n.latency_ms=l.meta.latency_ms,typeof l.meta.http_status=="number"&&(n.http_status=l.meta.http_status),n.error=`${l.message}${l.meta.response_snip?" | "+l.meta.response_snip:""}`,_(this,{type:"diagnostics.test_ai.error",request_id:l.meta.request_id,latency_ms:l.meta.latency_ms,http_status:l.meta.http_status,response_snip:l.meta.response_snip,error:l.message})):(n.error=a instanceof Error?a.message:String(a),_(this,{type:"diagnostics.test_ai.error",request_id:i,error:n.error}))}new pt(this,n).open()}async runTestAgent(){let t=xt(this.settings.runtimeUrl,"/v1/agent/ask"),s={prompt:this.getResolvedLanguage()==="zh-CN"?"\u8FD9\u662F\u4E00\u4E2A\u8BCA\u65AD\u6D4B\u8BD5\u8BF7\u6C42\uFF1A\u8BF7\u53EA\u56DE\u590D OK\u3002":"This is a diagnostic request: reply with OK only.",include_memory:!1,record_memory:!1,timeout_s:60},i=G(),n={kind:"agent",url:t,latency_ms:0,request:s,ok:!1};try{_(this,{type:"diagnostics.test_agent.request",request_id:i,runtime_url:this.settings.runtimeUrl});let a=await J(this,{path:"/v1/agent/ask",method:"POST",body:s,request_id:i,timeout_ms:9e4});n.latency_ms=a.meta.latency_ms,typeof a.meta.http_status=="number"&&(n.http_status=a.meta.http_status),n.ok=!0,n.response=a.json,_(this,{type:"diagnostics.test_agent.response",request_id:a.meta.request_id,latency_ms:a.meta.latency_ms,http_status:a.meta.http_status})}catch(a){let l=a instanceof M?a:null;l?(n.latency_ms=l.meta.latency_ms,typeof l.meta.http_status=="number"&&(n.http_status=l.meta.http_status),n.error=`${l.message}${l.meta.response_snip?" | "+l.meta.response_snip:""}`,_(this,{type:"diagnostics.test_agent.error",request_id:l.meta.request_id,latency_ms:l.meta.latency_ms,http_status:l.meta.http_status,response_snip:l.meta.response_snip,error:l.message})):(n.error=a instanceof Error?a.message:String(a),_(this,{type:"diagnostics.test_agent.error",request_id:i,error:n.error}))}new pt(this,n).open()}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),s=t==null?void 0:t.ok,i=s?this.t("runtime.status.online"):this.t("runtime.status.offline");if(s&&(t!=null&&t.pid)&&(i+=` (pid ${t.pid})`),s&&typeof(t==null?void 0:t.uptime_s)=="number"){let a=Math.floor(t.uptime_s/60);i+=` ${this.t("runtime.status.uptime",{mins:a})}`}this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(i+=` | ${this.t("runtime.status.local_pid",{pid:this.runtimePid})}`);let n=typeof(t==null?void 0:t.version)=="string"?t.version:null;return{text:i,runtimeVersion:n}}async fetchRuntimeStatus(){var i,n,a,l,o,u,d;let t=xt(this.settings.runtimeUrl,"/v1/runtime/status"),s=G();try{let g=await J(this,{path:"/v1/runtime/status",method:"GET",request_id:s,timeout_ms:5e3});return _(this,{type:"runtime.status.ok",request_id:g.meta.request_id,latency_ms:g.meta.latency_ms,http_status:g.meta.http_status,pid:(i=g.json.pid)!=null?i:null,version:(n=g.json.version)!=null?n:null,uptime_s:(a=g.json.uptime_s)!=null?a:null}),g.json}catch(g){let p=g instanceof M?g:null;return _(this,{type:"runtime.status.error",request_id:(l=p==null?void 0:p.meta.request_id)!=null?l:s,latency_ms:(o=p==null?void 0:p.meta.latency_ms)!=null?o:null,http_status:(u=p==null?void 0:p.meta.http_status)!=null?u:null,response_snip:(d=p==null?void 0:p.meta.response_snip)!=null?d:null,error:p?p.message:g instanceof Error?g.message:String(g),url:t}),null}}async requestRuntimeShutdown(){var i,n,a,l,o;let t=xt(this.settings.runtimeUrl,"/v1/runtime/shutdown"),s=G();try{let u=await J(this,{path:"/v1/runtime/shutdown",method:"POST",body:{force:!1},request_id:s,timeout_ms:5e3});return _(this,{type:"runtime.shutdown.ok",request_id:u.meta.request_id,latency_ms:u.meta.latency_ms,http_status:u.meta.http_status,pid:(i=u.json.pid)!=null?i:null}),!0}catch(u){let d=u instanceof M?u:null;return _(this,{type:"runtime.shutdown.error",request_id:(n=d==null?void 0:d.meta.request_id)!=null?n:s,latency_ms:(a=d==null?void 0:d.meta.latency_ms)!=null?a:null,http_status:(l=d==null?void 0:d.meta.http_status)!=null?l:null,response_snip:(o=d==null?void 0:d.meta.response_snip)!=null?o:null,error:d?d.message:u instanceof Error?u.message:String(u),url:t}),!1}}};
