/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var z=Object.defineProperty;var vt=Object.getOwnPropertyDescriptor;var xt=Object.getOwnPropertyNames;var wt=Object.prototype.hasOwnProperty;var Tt=(s,e)=>{for(var t in e)z(s,t,{get:e[t],enumerable:!0})},yt=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of xt(e))!wt.call(s,n)&&n!==t&&z(s,n,{get:()=>e[n],enumerable:!(i=vt(e,n))||i.enumerable});return s};var bt=s=>yt(z({},"__esModule",{value:!0}),s);var Xt={};Tt(Xt,{default:()=>W});module.exports=bt(Xt);var A=require("obsidian"),mt=require("child_process"),U=require("fs"),q=require("path");var w=require("obsidian"),X={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function G(s,e){let t=Number(s);return Number.isFinite(t)?t:e}var _=class extends w.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new w.Setting(e).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(a=>{a.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new w.Setting(e).setName("Render board in note").setDesc("Replace Board.md with a draggable visual board in the note area (editor + preview).").addToggle(a=>{a.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async r=>{this.plugin.settings.renderBoardInNote=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new w.Setting(e).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(a=>{a.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new w.Setting(e).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(a=>{a.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Runtime Service"});let i=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:"Status: unchecked"}),n=async()=>{i.textContent=await this.plugin.refreshRuntimeStatus()};new w.Setting(e).setName("Runtime control").setDesc("Start/stop local ai-tasks-runtime and refresh status.").addButton(a=>{a.setButtonText("Check status").onClick(async()=>{await n()})}).addButton(a=>{a.setButtonText("Start").onClick(async()=>{await this.plugin.startRuntime(),await n()})}).addButton(a=>{a.setButtonText("Stop").onClick(async()=>{await this.plugin.stopRuntime(),await n()})}),new w.Setting(e).setName("Runtime start command").setDesc("Executable to start the runtime (e.g. ai-tasks-runtime).").addText(a=>{a.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new w.Setting(e).setName("Runtime args").setDesc("Arguments for runtime start (e.g. serve).").addText(a=>{a.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new w.Setting(e).setName("Runtime working directory").setDesc("Optional working directory for the runtime process.").addText(a=>{a.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Model Settings"}),new w.Setting(e).setName("Model provider").setDesc("codex-cli (local) or OpenAI-compatible API.").addDropdown(a=>{a.addOption("codex-cli","codex-cli (local)"),a.addOption("openai-compatible","OpenAI-compatible API"),a.setValue(this.plugin.settings.modelProvider),a.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new w.Setting(e).setName("Model name").setDesc("Model identifier (for OpenAI-compatible providers).").addText(a=>{a.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new w.Setting(e).setName("API base URL").setDesc("Base URL for OpenAI-compatible API (e.g. https://api.openai.com).").addText(a=>{a.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new w.Setting(e).setName("API key").setDesc("API key for OpenAI-compatible providers (stored locally).").addText(a=>{a.inputEl.type="password",a.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new w.Setting(e).setName("Temperature").setDesc("Sampling temperature (e.g. 0.2).").addText(a=>{a.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=G(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new w.Setting(e).setName("Top P").setDesc("Nucleus sampling (0-1).").addText(a=>{a.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let o=G(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,o)),await this.plugin.saveSettings()})}),new w.Setting(e).setName("Max tokens").setDesc("Max output tokens (OpenAI-compatible).").addText(a=>{a.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let o=Math.max(0,Math.floor(G(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=o,await this.plugin.saveSettings()})}),n()}};var D=require("obsidian");var J="<!-- AI-TASKS:BEGIN -->",Z="<!-- AI-TASKS:END -->",tt=["Unassigned","Todo","Doing","Review","Done"],et=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function F(s){if(!s.includes("\\n")&&!s.includes("\\r\\n")&&!s.includes(`\r
`))return{next:s,changed:!1};let e=s;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==s}}function st(s){let e=s.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function Bt(s){let e=s.split(`
`);for(let t of e){let i=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(i!=null&&i[1])return i[1].trim()}return"(Untitled)"}function St(s){let e=s.split(`
`);for(let t of e){let i=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(i!=null&&i[1])return i[1].split(/[,，]/).map(n=>n.trim()).filter(n=>n.length>0)}return[]}function At(s){var t;let e=s.split(`
`);for(let i of e){let n=i.match(/^>\s*status::\s*(.+)\s*$/i);if(n!=null&&n[1])return(t=st(n[1]))!=null?t:null}return null}function it(s){let e=s.indexOf(J),t=s.indexOf(Z);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${J} / ${Z}).`);return{autoStart:e+J.length,autoEnd:t}}function nt(s,e,t){var d;let n=s.slice(e,t).split(`
`),a=e,r=[];for(let u of n){let g=u.trimStart();if(g.startsWith("## ")){let c=g.slice(3).trim(),l=st(c);if(l){let h=a+u.indexOf("## "),m=a+u.length;r.push({status:l,start:h,end:m})}}a+=u.length+1}let o=new Map;for(let u=0;u<r.length;u++){let g=r[u];if(!g)continue;let c=r[u+1],l=g.end+1,h=c?c.start:t,m=s.slice(l,h),f=[];et.lastIndex=0;let k;for(;k=et.exec(m);){let p=k[1];if(!p)continue;let x=k.index,v=l+x,T=`<!-- AI-TASKS:TASK ${p} END -->`,y=m.indexOf(T,x);if(y===-1)continue;let B=l+y+T.length;for(;B<s.length&&s[B]===`
`;){B+=1,B<s.length&&s[B]===`
`&&(B+=1);break}let $=s.slice(v,B),O=(d=At($))!=null?d:g.status,ft=Bt($),kt=St($);f.push({uuid:p,title:ft,status:O,tags:kt,rawBlock:$,start:v,end:B})}o.set(g.status,{status:g.status,headingStart:g.start,headingEnd:g.end,sectionStart:l,sectionEnd:h,tasks:f})}return o}function P(s){let{autoStart:e,autoEnd:t}=it(s),i=nt(s,e,t);return{content:s,autoStart:e,autoEnd:t,sections:i}}function at(s){let{autoStart:e,autoEnd:t}=it(s),i=nt(s,e,t),n=tt.filter(u=>!i.has(u));if(n.length===0)return s;let a=[];for(let u of tt)n.includes(u)&&a.push(`## ${u}`,"");let r=a.join(`
`);r.endsWith(`
`)||(r+=`
`);let o=s.slice(0,t),d=s.slice(t);return o.length>0&&!o.endsWith(`
`)&&(o+=`
`),o+r+d}function Pt(s,e){let t=s.split(`
`),i=!1,n=t.map(a=>a.match(/^>\s*status::\s*(.+)\s*$/i)?(i=!0,`> status:: ${e}`):a);if(!i)for(let a=0;a<n.length;a++){let r=n[a];if(r&&r.match(/^>\s*\[![^\]]+\]/)){n.splice(a+1,0,`> status:: ${e}`);break}}return n.join(`
`)}function rt(s,e,t){let i=s.sections.get(e);if(!i)throw new Error(`Missing status section: ${e}`);if(t){for(let a of i.tasks)if(a.uuid===t)return a.start}let n=i.tasks.at(-1);return n?n.end:i.sectionStart}function L(s,e,t,i){let n=at(s),a=P(n),r=null,o=null;for(let[x,v]of a.sections.entries()){for(let T of v.tasks)if(T.uuid===e){r=T,o=x;break}if(r)break}if(!r||!o)throw new Error(`Task not found: ${e}`);let d=i===e?null:i,u=r.rawBlock;o!==t&&(u=Pt(u,t));let g=n.slice(0,r.start)+n.slice(r.end),c=P(g),l=rt(c,t,d),h=g.slice(0,l),m=g.slice(l),f=h.length>0&&!h.endsWith(`
`),k=!u.endsWith(`
`),p=(f?`
`:"")+u+(k?`
`:"");return g=h+p+m,g}function j(s,e,t,i){let n=at(s),a=P(n),r=rt(a,e,t),o=n.slice(0,r),d=n.slice(r),u=o.length>0&&!o.endsWith(`
`),g=!i.endsWith(`
`),c=(u?`
`:"")+i+(g?`
`:"");return o+c+d}function K(s,e,t){let i=P(s),n=null;for(let o of i.sections.values()){for(let d of o.tasks)if(d.uuid===e){n=d;break}if(n)break}if(!n)throw new Error(`Task not found: ${e}`);let a=!t.endsWith(`
`),r=t+(a?`
`:"");return s.slice(0,n.start)+r+s.slice(n.end)}function ot(s,e){let t=P(s),i=null;for(let a of t.sections.values()){for(let r of a.tasks)if(r.uuid===e){i=r;break}if(i)break}if(!i)throw new Error(`Task not found: ${e}`);let n=s.slice(0,i.start)+s.slice(i.end);return{removed:i,next:n}}var lt=require("obsidian");function Et(){return new Date().toISOString().replace(/[:.]/g,"-")}function Dt(s,e){var r;let i=((r=s.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${e}.md`),n=s.lastIndexOf("/Boards/");return n!==-1?`${s.slice(0,n)}/History/Boards/${i}`:`${s.split("/").slice(0,-1).join("/")}/History/${i}`}function dt(s,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),i=s.lastIndexOf("/Boards/");return i!==-1?`${s.slice(0,i)}/History/Logs/ai-tasks.${t}.jsonl`:`${s.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function I(s,e){let t=e.split("/").filter(n=>n.length>0),i="";for(let n of t)i=i?`${i}/${n}`:n,s.getAbstractFileByPath(i)||await s.createFolder(i)}async function E(s,e,t){let i=await s.read(e),n=Et(),a=Dt(e.path,n),r=a.split("/").slice(0,-1).join("/");await I(s,r),await s.create(a,i),await s.modify(e,t)}async function ct(s,e,t){let i=e.split("/").slice(0,-1).join("/");i&&await I(s,i);let n=JSON.stringify(t)+`
`,a=s.getAbstractFileByPath(e);if(a instanceof lt.TFile){let r=await s.read(a);await s.modify(a,r+n);return}await s.create(e,n)}async function S(s,e){let t=new Date().toISOString(),i=t.slice(0,10),n=dt(s.settings.boardPath,i);await ct(s.app.vault,n,{ts:t,...e})}function Y(s){return s instanceof Error?s.message:String(s)}function ut(s,e,t){let i=Y(e),n={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${s}: ${i}`,n)}function It(s){let e=(s!=null?s:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function $t(){let s=globalThis.crypto;return s!=null&&s.randomUUID?s.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Ft(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function Lt(s){let e=s.settings.boardPath,t=s.app.vault.getAbstractFileByPath(e);if(t instanceof D.TFile)return t;let i=e.split("/").slice(0,-1).join("/");return i&&await I(s.app.vault,i),await s.app.vault.create(e,Ft())}function Nt(s,e){return s.replace(/\/+$/g,"")+e}async function Mt(s,e){let t=Nt(s.settings.runtimeUrl,"/v1/board/propose"),i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok){let n=await i.text().catch(()=>"");throw new Error(`Runtime error (${i.status}): ${n}`)}return await i.json()}function pt(s){return s.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function Ct(s){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${s.uuid} BEGIN -->`),t.push(`> [!todo] ${s.title}`),t.push(`> status:: ${s.status}`),s.tags.length>0&&t.push(`> tags:: ${s.tags.join(", ")}`),t.push(`> created:: ${e}`),s.sourcePath&&t.push(`> source:: [[${s.sourcePath}]]`),t.push(">"),t.push(...pt(s.body)),t.push(`<!-- AI-TASKS:TASK ${s.uuid} END -->`),t.join(`
`)+`
`}function Rt(s,e){var u,g,c;let t=s.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),i=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),n=t.findIndex(l=>i.test(l.trim()));if(n===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(l=>/^>\\s*\\[![^\\]]+\\]/.test(l));if(a!==-1){let l=(u=t[a])==null?void 0:u.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),h=(g=l==null?void 0:l[1])!=null?g:"[!todo]";t[a]=`> ${h} ${e.title}`}let r=t.findIndex(l=>/^>\\s*status::/i.test(l));if(r!==-1)t[r]=`> status:: ${e.status}`;else{let l=a!==-1?a+1:1;t.splice(l,0,`> status:: ${e.status}`),r=l}if(e.tags.length>0){let l=t.findIndex(h=>/^>\\s*tags::/i.test(h));l!==-1?t[l]=`> tags:: ${e.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${e.tags.join(", ")}`)}let o=new Date().toISOString(),d=[];return d.push(">"),d.push("> ---"),d.push(`> updated:: ${o}`),(c=e.instruction)!=null&&c.trim()&&d.push(`> instruction:: ${e.instruction.trim()}`),d.push(...pt(e.body)),t.splice(n,0,...d),t.join(`
`)+`
`}var N=class extends D.Modal{constructor(t,i){var n;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=i.mode,this.sourcePath=(n=i.sourcePath)!=null?n:null,this.draft=i.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let i=t.createDiv({cls:"ai-tasks-draft-box"});i.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let n=i.createEl("textarea",{cls:"ai-tasks-draft-textarea"});n.value=this.draft,n.addEventListener("input",()=>{this.draft=n.value});let a=t.createDiv({cls:"ai-tasks-instr-box"});a.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=a.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),d=o.createEl("button",{text:"Generate preview"}),u=o.createEl("button",{text:"Confirm & write"}),g=o.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let c=t.createDiv({cls:"ai-tasks-draft-preview"}),l=c.createDiv({cls:"ai-tasks-draft-side"});l.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=l.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let h=c.createDiv({cls:"ai-tasks-draft-side"});h.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=h.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,d.addEventListener("click",async()=>{await this.generate()}),u.addEventListener("click",async()=>{await this.apply()}),g.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,i,n,a,r,o,d,u,g,c,l;try{this.setStatus("Generating preview..."),this.boardFile=await Lt(this.plugin);let h=await this.plugin.app.vault.read(this.boardFile),m=F(h);m.changed&&await E(this.plugin.app.vault,this.boardFile,m.next),this.boardContent=m.next;let f=P(this.boardContent),k=Array.from(f.sections.values()).flatMap(y=>y.tasks.map(b=>({uuid:b.uuid,title:b.title,status:b.status,tags:b.tags}))),p={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:k,ai_model:this.plugin.getModelConfig()};await S(this.plugin,{type:"board.propose.request",mode:p.mode,draft_len:p.draft.length,instruction_len:((t=p.instruction)!=null?t:"").length,tasks_count:p.tasks.length,runtime_url:this.plugin.settings.runtimeUrl});try{this.proposal=await Mt(this.plugin,p),await S(this.plugin,{type:"board.propose.response",engine:(i=this.proposal.engine)!=null?i:null,action:this.proposal.action,target_uuid:(n=this.proposal.target_uuid)!=null?n:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(a=this.proposal.confidence)!=null?a:null,reasoning:(r=this.proposal.reasoning)!=null?r:null})}catch(y){let b=y instanceof Error?y.message:String(y);throw await S(this.plugin,{type:"board.propose.error",error:b}),y}let x=this.proposal.action,v=It(this.proposal.status);if(x==="update"&&this.proposal.target_uuid){let y=this.proposal.target_uuid,b=null;for(let[B,$]of f.sections.entries()){for(let O of $.tasks)if(O.uuid===y){b={rawBlock:O.rawBlock,sectionStatus:B};break}if(b)break}if(!b)this.proposal.action="create";else{this.beforeBlock=b.rawBlock,this.afterBlock=Rt(this.beforeBlock,{uuid:y,title:this.proposal.title||"(Untitled)",status:v,tags:(o=this.proposal.tags)!=null?o:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let B=K(this.boardContent,y,this.afterBlock);b.sectionStatus!==v&&(B=L(B,y,v,null)),this.nextBoardContent=B}}if(this.proposal.action==="create"){let y=$t();this.beforeBlock="",this.afterBlock=Ct({uuid:y,title:this.proposal.title||"(Untitled)",status:v,tags:(d=this.proposal.tags)!=null?d:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let b=(l=(c=(g=(u=f.sections.get(v))==null?void 0:u.tasks)==null?void 0:g[0])==null?void 0:c.uuid)!=null?l:null;this.nextBoardContent=j(this.boardContent,v,b,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let T=[];this.proposal.engine&&T.push(`engine=${this.proposal.engine}`),this.proposal.reasoning&&T.push(this.proposal.reasoning),this.proposal.confidence!=null&&T.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(T.length?T.join(" | "):"Preview ready.")}catch(h){let m=Y(h);ut("\u751F\u6210\u9884\u89C8\u5931\u8D25",h,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(`Failed: ${m}`),new D.Notice(`AI Tasks: \u9884\u89C8\u5931\u8D25\uFF1A${m}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}async apply(){var t,i,n,a,r,o;if(!this.boardFile){new D.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new D.Notice("AI Tasks: please generate preview first.");return}try{await E(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await S(this.plugin,{type:"board.write",via:"draft_modal",action:(i=(t=this.proposal)==null?void 0:t.action)!=null?i:null,target_uuid:(a=(n=this.proposal)==null?void 0:n.target_uuid)!=null?a:null}),new D.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(d){let u=Y(d);ut("\u5199\u5165\u770B\u677F\u5931\u8D25",d,{boardPath:(o=(r=this.boardFile)==null?void 0:r.path)!=null?o:this.plugin.settings.boardPath}),new D.Notice(`AI Tasks: \u5199\u5165\u5931\u8D25\uFF1A${u}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}};var gt=require("obsidian");var R=require("obsidian");var M=require("obsidian");var Ut=["Unassigned","Todo","Doing","Review","Done"];function Ot(){let s=globalThis.crypto;return s!=null&&s.randomUUID?s.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function _t(s){let e=(s!=null?s:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function jt(s){let e=s.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(r=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(r.trim()));if(t===-1)return"";let i=e.findIndex(r=>r.trim()===">");return i===-1||i>=t?"":e.slice(i+1,t).map(r=>{let o=r.match(/^>\s?(.*)$/);return o?o[1]:r}).join(`
`).replace(/\n$/,"")}function Kt(s,e){var f,k;let t=s.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),i=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(i===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(p=>/^>\s*\[![^\]]+\]/.test(p));if(n!==-1){let p=(f=t[n])==null?void 0:f.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),x=(k=p==null?void 0:p[1])!=null?k:"[!todo]";t[n]=`> ${x} ${e.title||"(Untitled)"}`}let a=t.findIndex(p=>/^>\s*status::/i.test(p));if(a!==-1)t[a]=`> status:: ${e.status}`;else{let p=n!==-1?n+1:1;t.splice(p,0,`> status:: ${e.status}`),a=p}let r=t.findIndex(p=>/^>\s*tags::/i.test(p));if(e.tags.length>0){let p=`> tags:: ${e.tags.join(", ")}`;r!==-1?t[r]=p:t.splice(a+1,0,p)}else r!==-1&&t.splice(r,1);let o=t.findIndex(p=>/^>\s*updated::/i.test(p)),d=`> updated:: ${e.updatedAtIso}`;if(o!==-1)t[o]=d;else{let p=t.findIndex(v=>/^>\s*created::/i.test(v)),x=p!==-1?p+1:a+1;t.splice(x,0,d)}let u=t.findIndex(p=>p.trim()===">");(u===-1||u>=i)&&(u=i,t.splice(u,0,">"));let g=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(g===-1)throw new Error("Malformed task block (missing END marker).");let c=[],l=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let p of l)p.trim()===""?c.push(">"):c.push(`> ${p}`);let h=t.slice(0,u+1),m=t.slice(g);return h.concat(c,m).join(`
`)+`
`}function Vt(s){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${s.uuid} BEGIN -->`),t.push(`> [!todo] ${s.title||"(Untitled)"}`),t.push(`> status:: ${s.status}`),s.tags.length>0&&t.push(`> tags:: ${s.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),s.sourcePath&&t.push(`> source:: [[${s.sourcePath}]]`),t.push(">");for(let i of(s.body||"").replace(/\r\n/g,`
`).split(`
`))i.trim()===""?t.push(">"):t.push(`> ${i}`);return t.push(`<!-- AI-TASKS:TASK ${s.uuid} END -->`),t.join(`
`)+`
`}var C=class extends M.Modal{constructor(e,t){var i,n,a,r,o;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(i=t.task)!=null?i:null,this.defaultStatus=(r=t.defaultStatus)!=null?r:(a=(n=this.task)==null?void 0:n.status)!=null?a:"Unassigned",this.sourcePath=(o=t.sourcePath)!=null?o:null,this.onDidWrite=t.onDidWrite}onOpen(){var m,f,k,p,x,v;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?"Edit task":"New task"});let i=e.createDiv({cls:"ai-tasks-form-row"});i.createDiv({cls:"ai-tasks-form-label",text:"Title"});let n=i.createEl("input",{type:"text",cls:"ai-tasks-form-input"});n.value=(f=(m=this.task)==null?void 0:m.title)!=null?f:"";let a=e.createDiv({cls:"ai-tasks-form-row"});a.createDiv({cls:"ai-tasks-form-label",text:"Status"});let r=a.createEl("select",{cls:"ai-tasks-form-select"});for(let T of Ut)r.add(new Option(T,T));r.value=(p=(k=this.task)==null?void 0:k.status)!=null?p:this.defaultStatus;let o=e.createDiv({cls:"ai-tasks-form-row"});o.createDiv({cls:"ai-tasks-form-label",text:"Tags (comma separated)"});let d=o.createEl("input",{type:"text",cls:"ai-tasks-form-input"});d.placeholder="e.g. release, bug, v1",d.value=((v=(x=this.task)==null?void 0:x.tags)!=null?v:[]).join(", ");let u=e.createDiv({cls:"ai-tasks-form-row"});u.createDiv({cls:"ai-tasks-form-label",text:"Body"});let g=u.createEl("textarea",{cls:"ai-tasks-form-textarea"});g.value=this.task?jt(this.task.rawBlock):"";let c=e.createDiv({cls:"ai-tasks-form-buttons"}),l=c.createEl("button",{text:"Save",cls:"mod-cta"});c.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),l.addEventListener("click",()=>{this.save({title:n.value,status:_t(r.value),tagsRaw:d.value,body:g.value})})}async save(e){var t,i,n,a,r,o;try{let d=e.tagsRaw.split(/[,，]/).map(f=>f.trim()).filter(f=>f.length>0),u=await this.plugin.app.vault.read(this.boardFile),c=F(u).next,l=P(c),h=new Date().toISOString(),m=c;if(this.task){let f=null,k=null;for(let[x,v]of l.sections.entries()){for(let T of v.tasks)if(T.uuid===this.task.uuid){f=T,k=x;break}if(f)break}if(!f||!k)throw new Error(`Task not found: ${this.task.uuid}`);let p=Kt(f.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:d,body:(t=e.body)!=null?t:"",updatedAtIso:h});m=K(m,f.uuid,p),k!==e.status&&(m=L(m,f.uuid,e.status,null)),await E(this.plugin.app.vault,this.boardFile,m),await S(this.plugin,{type:"task.edit",uuid:f.uuid,from_status:k,status:e.status})}else{let f=Ot(),k=Vt({uuid:f,title:e.title||"(Untitled)",status:e.status,tags:d,body:(i=e.body)!=null?i:"",sourcePath:this.sourcePath}),p=(o=(r=(a=(n=l.sections.get(e.status))==null?void 0:n.tasks)==null?void 0:a[0])==null?void 0:r.uuid)!=null?o:null;m=j(m,e.status,p,k),await E(this.plugin.app.vault,this.boardFile,m),await S(this.plugin,{type:"task.create",uuid:f,status:e.status})}new M.Notice("AI Tasks: saved."),this.close(),this.onDidWrite()}catch(d){let u=d instanceof Error?d.message:String(d);new M.Notice(`AI Tasks: save failed: ${u}`)}}};var Q=["Unassigned","Todo","Doing","Review","Done"];function Ht(){let s=new Date,e=String(s.getFullYear()),t=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${i}`}function qt(s,e){let t=(s||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function Wt(s){return["---","schema: ai-tasks-archive/v1",`date: ${s}`,"---","",`# Archive ${s}`,"",""].join(`
`)}function zt(s,e){let t=s.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),i=t.findIndex(d=>/^>\s*archived::/i.test(d));if(i!==-1)return t[i]=`> archived:: ${e}`,t.join(`
`)+`
`;let n=t.findIndex(d=>/^>\s*created::/i.test(d)),a=t.findIndex(d=>/^>\s*status::/i.test(d)),r=t.findIndex(d=>/^>\s*\[![^\]]+\]/.test(d)),o=n!==-1?n+1:a!==-1?a+1:r!==-1?r+1:1;return t.splice(o,0,`> archived:: ${e}`),t.join(`
`)+`
`}function Gt(s){return Array.from(new Set(s.flatMap(e=>e.tags))).sort()}function Jt(s,e){let t=e.trim().toLowerCase();return t?s.title.toLowerCase().includes(t)||s.tags.some(i=>i.toLowerCase().includes(t)):!0}var V=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=F(e);return t.changed&&(await E(this.plugin.app.vault,this.boardFile,t.next),new R.Notice("AI Tasks: fixed escaped newlines in Board.md."),await S(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return Jt(e,this.searchText)}renderHeader(e,t){let i=e.createDiv({cls:"ai-tasks-board-header"});i.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let a=i.createDiv({cls:"ai-tasks-board-controls"}),r=a.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:"Search title/tags..."}});r.value=this.searchText,r.addEventListener("input",async()=>{this.searchText=r.value,await this.render(e)});let o=a.createEl("select",{cls:"ai-tasks-board-select"});o.add(new Option("All statuses","All"));for(let c of Q)o.add(new Option(c,c));o.value=this.statusFilter,o.addEventListener("change",async()=>{let c=o.value;this.statusFilter=c==="All"?"All":c,await this.render(e)});let d=a.createDiv({cls:"ai-tasks-board-tags"}),u=d.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),g=d.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)g.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let c of t){let l=g.createEl("button",{cls:"ai-tasks-tag-chip",text:c});this.tagFilter.has(c)&&l.classList.add("is-active"),l.addEventListener("click",async h=>{h.preventDefault(),this.tagFilter.has(c)?this.tagFilter.delete(c):this.tagFilter.add(c),await this.render(e)})}u.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}createCard(e,t,i,n,a){let r=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});r.draggable=!0,r.addEventListener("click",c=>{var l,h;(h=(l=c.target)==null?void 0:l.closest)!=null&&h.call(l,"select, button, a, input, textarea")||a(t)});let o=r.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let d=o.createDiv({cls:"ai-task-actions"}),u=d.createEl("select",{cls:"ai-task-status"});for(let c of Q)u.add(new Option(c,c));if(u.value=t.status,u.addEventListener("click",c=>c.stopPropagation()),u.addEventListener("change",async c=>{c.stopPropagation(),await i(t.uuid,u.value,null)}),d.createEl("button",{cls:"ai-task-edit",text:"Edit"}).addEventListener("click",c=>{c.stopPropagation(),a(t)}),t.status==="Done"&&d.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async l=>{l.stopPropagation(),await n(t.uuid)}),t.tags.length>0){let c=r.createDiv({cls:"ai-task-tags"});for(let l of t.tags)c.createSpan({cls:"ai-task-tag",text:l})}return r.addEventListener("dragstart",c=>{var l,h;(l=c.dataTransfer)==null||l.setData("application/x-ai-task-uuid",t.uuid),(h=c.dataTransfer)==null||h.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(e,t,i){e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async n=>{var u,g,c;n.preventDefault(),e.classList.remove("is-drop-target");let a=(u=n.dataTransfer)==null?void 0:u.getData("application/x-ai-task-uuid");if(!a)return;let r=n.target,o=(g=r==null?void 0:r.closest)==null?void 0:g.call(r,".ai-task-card"),d=(c=o==null?void 0:o.getAttribute("data-uuid"))!=null?c:null;await i(a,t,d)})}async appendToArchive(e,t,i,n){let a=t.split("/").slice(0,-1).join("/");a&&await I(e,a);let r=e.getAbstractFileByPath(t);if(r instanceof R.TFile){let o=await e.read(r),d=o.endsWith(`
`)?`
`:`

`;await e.modify(r,o+d+i);return}await e.create(t,Wt(n)+i)}async render(e){var c;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t;try{t=await this.readBoardNormalized()}catch(l){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:l instanceof Error?l.message:"Failed to read Board.md."});return}let i;try{i=P(t)}catch(l){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:l instanceof Error?l.message:"Failed to parse Board.md (unknown error)."});return}let n=Array.from(i.sections.values()).flatMap(l=>l.tasks),a=Gt(n);this.renderHeader(e,a);let r=e.createDiv({cls:"ai-tasks-board-columns"}),o=async(l,h,m)=>{let f=await this.readBoardNormalized(),k=L(f,l,h,m);await E(this.plugin.app.vault,this.boardFile,k),await S(this.plugin,{type:"task.move",uuid:l,status:h,before_uuid:m}),await this.render(e)},d=async l=>{if(!window.confirm("Archive this task?"))return;let h=await this.readBoardNormalized(),{removed:m,next:f}=ot(h,l),k=Ht(),p=qt(this.plugin.settings.archiveFolderPath,k),x=zt(m.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,p,x,k),await E(this.plugin.app.vault,this.boardFile,f),new R.Notice(`Archived task to ${p}`),await S(this.plugin,{type:"task.archive",uuid:l,archive_path:p}),await this.render(e)},u=l=>{new C(this.plugin,{boardFile:this.boardFile,task:l,onDidWrite:()=>{this.render(e)}}).open()},g=l=>{new C(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:l,onDidWrite:()=>{this.render(e)}}).open()};for(let l of Q){let h=r.createDiv({cls:"ai-tasks-column"}),m=h.createDiv({cls:"ai-tasks-column-head"});m.createDiv({cls:"ai-tasks-column-title",text:l}),m.createEl("button",{cls:"ai-tasks-column-add",text:"+ Add"}).addEventListener("click",()=>g(l));let k=h.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(k,l,o);let p=i.sections.get(l),x=((c=p==null?void 0:p.tasks)!=null?c:[]).filter(v=>this.shouldShowTask(v));for(let v of x)this.createCard(k,v,o,d,u)}}};var H=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let i of e){let n=i.view;if(!(n instanceof gt.MarkdownView))continue;let a=n.file;if(!a){this.unmount(n);continue}let r=!!this.plugin.settings.renderBoardInNote,o=a.path===this.plugin.settings.boardPath;if(!r||!o){this.unmount(n);continue}t.add(n),await this.mount(n,a)}for(let i of Array.from(this.overlays.keys()))t.has(i)||this.unmount(i)}async mount(e,t){let i=this.overlays.get(e);if(i&&i.file.path===t.path)return;i&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let n=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),a=new V(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:n,panel:a});try{await a.render(n)}catch(r){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};function ht(s,e){return s.replace(/\/+$/g,"")+e}function Yt(s){var n,a;if(!s)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,i;for(;(i=t.exec(s))!==null;){let r=(a=(n=i[1])!=null?n:i[2])!=null?a:i[3];r&&e.push(r)}return e}function Qt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var W=class extends A.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.boardOverlay=null}getPluginDir(){var n;let t=this.app.vault.adapter,i=(n=t==null?void 0:t.getBasePath)==null?void 0:n.call(t);return i?(0,q.join)(i,this.app.vault.configDir,"plugins","ai-tasks-board"):null}async onload(){await this.loadSettings(),this.boardOverlay=new H(this),this.addCommand({id:"open-ai-tasks-board-note",name:"AI Tasks: Open board note",callback:async()=>{let t=this.settings.boardPath,i=this.app.vault.getAbstractFileByPath(t);if(i instanceof A.TFile){await this.app.workspace.getLeaf().openFile(i);return}let n=t.split("/").slice(0,-1).join("/");n&&await I(this.app.vault,n);let a=await this.app.vault.create(t,Qt());await this.app.workspace.getLeaf().openFile(a)}}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var i;t.path===this.settings.boardPath&&((i=this.boardOverlay)==null||i.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,i,n)=>{let a=i.getSelection();!a||a.trim().length===0||(t.addItem(r=>{r.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var o;new N(this,{mode:"create",selection:a,sourcePath:(o=n.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var o;new N(this,{mode:"auto",selection:a,sourcePath:(o=n.file)==null?void 0:o.path}).open()})}))})),this.addSettingTab(new _(this.app,this))}onunload(){var t;(t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}async loadSettings(){this.settings=Object.assign({},X,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var i,n,a;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((i=this.settings.modelName)==null?void 0:i.trim())||void 0,base_url:((n=this.settings.modelBaseUrl)==null?void 0:n.trim())||void 0,api_key:((a=this.settings.modelApiKey)==null?void 0:a.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}async startRuntime(){var a,r,o;if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new A.Notice("AI Tasks: runtime already running.");return}let t=this.settings.runtimeCommand.trim();if(!t){new A.Notice("AI Tasks: runtime command is empty.");return}let i=Yt(this.settings.runtimeArgs||""),n=this.settings.runtimeCwd.trim()||void 0;try{let d=(0,mt.spawn)(t,i,{cwd:n,windowsHide:!0,shell:!1});this.runtimeProcess=d,this.runtimePid=(a=d.pid)!=null?a:null;let u=this.getPluginDir();if(u)try{(0,U.mkdirSync)(u,{recursive:!0});let g=(0,q.join)(u,"runtime.stdout.log"),c=(0,q.join)(u,"runtime.stderr.log");(r=d.stdout)==null||r.on("data",l=>{(0,U.appendFileSync)(g,l.toString())}),(o=d.stderr)==null||o.on("data",l=>{(0,U.appendFileSync)(c,l.toString())}),console.info(`[ai-tasks-board] runtime logs: ${g} / ${c}`)}catch(g){console.error("[ai-tasks-board] failed to init runtime log files",g)}d.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),d.on("error",g=>{new A.Notice(`AI Tasks: runtime start failed: ${g.message}`)}),new A.Notice(`AI Tasks: runtime starting${d.pid?` (pid ${d.pid})`:""}.`)}catch(d){let u=d instanceof Error?d.message:String(d);new A.Notice(`AI Tasks: runtime start failed: ${u}`)}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new A.Notice("AI Tasks: runtime stop requested."):new A.Notice("AI Tasks: runtime not running.")}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),i=t==null?void 0:t.ok,n=i?"online":"offline";if(i&&(t!=null&&t.pid)&&(n+=` (pid ${t.pid})`),i&&typeof(t==null?void 0:t.uptime_s)=="number"){let a=Math.floor(t.uptime_s/60);n+=` uptime ${a}m`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(n+=` | local pid ${this.runtimePid}`),n}async fetchRuntimeStatus(){let t=ht(this.settings.runtimeUrl,"/v1/runtime/status");try{let i=await fetch(t,{method:"GET"});return i.ok?await i.json():null}catch(i){return null}}async requestRuntimeShutdown(){let t=ht(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(i){return!1}}};
