/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var tt=Object.defineProperty;var Pt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var Dt=Object.prototype.hasOwnProperty;var It=(i,e)=>{for(var t in e)tt(i,t,{get:e[t],enumerable:!0})},$t=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Et(e))!Dt.call(i,a)&&a!==t&&tt(i,a,{get:()=>e[a],enumerable:!(s=Pt(e,a))||s.enumerable});return i};var Ft=i=>$t(tt({},"__esModule",{value:!0}),i);var fe={};It(fe,{default:()=>Z});module.exports=Ft(fe);var $=require("obsidian"),Bt=require("child_process"),z=require("fs"),X=require("path");var T=require("obsidian"),rt={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890",tagPresets:`work
\u5B66\u4E60
\u6548\u7387
\u8FD0\u7EF4
openclaw
obsidian
pixel`,runtimeCommand:"ai-tasks-runtime",runtimeArgs:"serve",runtimeCwd:"",modelProvider:"codex-cli",modelName:"gpt-4o-mini",modelBaseUrl:"",modelApiKey:"",modelTemperature:.2,modelMaxTokens:1024,modelTopP:1,renderBoardInNote:!0};function et(i,e){let t=Number(i);return Number.isFinite(t)?t:e}var G=class extends T.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new T.Setting(e).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(n=>{n.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async r=>{this.plugin.settings.boardPath=r.trim(),await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new T.Setting(e).setName("Render board in note").setDesc("Replace Board.md with a draggable visual board in the note area (editor + preview).").addToggle(n=>{n.setValue(!!this.plugin.settings.renderBoardInNote).onChange(async r=>{this.plugin.settings.renderBoardInNote=r,await this.plugin.saveSettings(),this.plugin.requestOverlayUpdate()})}),new T.Setting(e).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(n=>{n.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async r=>{this.plugin.settings.archiveFolderPath=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName("Tag presets").setDesc("One tag per line. AI will prefer these tags when proposing/importing tasks.").addTextArea(n=>{n.setPlaceholder("work\\n\u5B66\u4E60\\n\u6548\u7387\\nopenclaw").setValue(this.plugin.settings.tagPresets||"").onChange(async r=>{this.plugin.settings.tagPresets=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(n=>{n.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async r=>{this.plugin.settings.runtimeUrl=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Runtime Service"});let s=e.createDiv({cls:"ai-tasks-runtime-status"}).createSpan({text:"Status: unchecked"}),a=async()=>{s.textContent=await this.plugin.refreshRuntimeStatus()};new T.Setting(e).setName("Runtime control").setDesc("Start/stop local ai-tasks-runtime and refresh status.").addButton(n=>{n.setButtonText("Check status").onClick(async()=>{await a()})}).addButton(n=>{n.setButtonText("Start").onClick(async()=>{await this.plugin.startRuntime(),await a()})}).addButton(n=>{n.setButtonText("Stop").onClick(async()=>{await this.plugin.stopRuntime(),await a()})}),new T.Setting(e).setName("Runtime start command").setDesc("Executable to start the runtime (e.g. ai-tasks-runtime).").addText(n=>{n.setPlaceholder("ai-tasks-runtime").setValue(this.plugin.settings.runtimeCommand).onChange(async r=>{this.plugin.settings.runtimeCommand=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName("Runtime args").setDesc("Arguments for runtime start (e.g. serve).").addText(n=>{n.setPlaceholder("serve").setValue(this.plugin.settings.runtimeArgs).onChange(async r=>{this.plugin.settings.runtimeArgs=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Runtime working directory").setDesc("Optional working directory for the runtime process.").addText(n=>{n.setPlaceholder("E:\\path\\to\\ai-tasks-board\\runtime").setValue(this.plugin.settings.runtimeCwd).onChange(async r=>{this.plugin.settings.runtimeCwd=r.trim(),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Model Settings"}),new T.Setting(e).setName("Model provider").setDesc("codex-cli (local) or OpenAI-compatible API.").addDropdown(n=>{n.addOption("codex-cli","codex-cli (local)"),n.addOption("openai-compatible","OpenAI-compatible API"),n.setValue(this.plugin.settings.modelProvider),n.onChange(async r=>{this.plugin.settings.modelProvider=r,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Model name").setDesc("Model identifier (for OpenAI-compatible providers).").addText(n=>{n.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.modelName).onChange(async r=>{this.plugin.settings.modelName=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName("API base URL").setDesc("Base URL for OpenAI-compatible API (e.g. https://api.openai.com).").addText(n=>{n.setPlaceholder("https://api.openai.com").setValue(this.plugin.settings.modelBaseUrl).onChange(async r=>{this.plugin.settings.modelBaseUrl=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName("API key").setDesc("API key for OpenAI-compatible providers (stored locally).").addText(n=>{n.inputEl.type="password",n.setPlaceholder("sk-...").setValue(this.plugin.settings.modelApiKey).onChange(async r=>{this.plugin.settings.modelApiKey=r.trim(),await this.plugin.saveSettings()})}),new T.Setting(e).setName("Temperature").setDesc("Sampling temperature (e.g. 0.2).").addText(n=>{n.setPlaceholder("0.2").setValue(String(this.plugin.settings.modelTemperature)).onChange(async r=>{this.plugin.settings.modelTemperature=et(r,this.plugin.settings.modelTemperature),await this.plugin.saveSettings()})}),new T.Setting(e).setName("Top P").setDesc("Nucleus sampling (0-1).").addText(n=>{n.setPlaceholder("1").setValue(String(this.plugin.settings.modelTopP)).onChange(async r=>{let o=et(r,this.plugin.settings.modelTopP);this.plugin.settings.modelTopP=Math.min(1,Math.max(0,o)),await this.plugin.saveSettings()})}),new T.Setting(e).setName("Max tokens").setDesc("Max output tokens (OpenAI-compatible).").addText(n=>{n.setPlaceholder("1024").setValue(String(this.plugin.settings.modelMaxTokens)).onChange(async r=>{let o=Math.max(0,Math.floor(et(r,this.plugin.settings.modelMaxTokens)));this.plugin.settings.modelMaxTokens=o,await this.plugin.saveSettings()})}),a()}};var U=require("obsidian");var st="<!-- AI-TASKS:BEGIN -->",ot="<!-- AI-TASKS:END -->",lt=["Unassigned","Todo","Doing","Review","Done"],ct=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function R(i){if(!i.includes("\\n")&&!i.includes("\\r\\n")&&!i.includes(`\r
`))return{next:i,changed:!1};let e=i;return e=e.replace(/\\r\\n/g,`
`),e=e.replace(/\\n/g,`
`),e=e.replace(/\r\n/g,`
`),{next:e,changed:e!==i}}function dt(i){let e=i.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function _t(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function Mt(i){let e=i.split(`
`);for(let t of e){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,，]/).map(a=>a.trim()).filter(a=>a.length>0)}return[]}function Ut(i){var t;let e=i.split(`
`);for(let s of e){let a=s.match(/^>\s*status::\s*(.+)\s*$/i);if(a!=null&&a[1])return(t=dt(a[1]))!=null?t:null}return null}function ut(i){let e=i.indexOf(st),t=i.indexOf(ot);if(e===-1||t===-1||t<=e)throw new Error(`Board is missing auto area markers (${st} / ${ot}).`);return{autoStart:e+st.length,autoEnd:t}}function pt(i,e,t){var c;let a=i.slice(e,t).split(`
`),n=e,r=[];for(let d of a){let g=d.trimStart();if(g.startsWith("## ")){let u=g.slice(3).trim(),l=dt(u);if(l){let h=n+d.indexOf("## "),k=n+d.length;r.push({status:l,start:h,end:k})}}n+=d.length+1}let o=new Map;for(let d=0;d<r.length;d++){let g=r[d];if(!g)continue;let u=r[d+1],l=g.end+1,h=u?u.start:t,k=i.slice(l,h),m=[];ct.lastIndex=0;let v;for(;v=ct.exec(k);){let p=v[1];if(!p)continue;let w=v.index,b=l+w,x=`<!-- AI-TASKS:TASK ${p} END -->`,f=k.indexOf(x,w);if(f===-1)continue;let B=l+f+x.length;for(;B<i.length&&i[B]===`
`;){B+=1,B<i.length&&i[B]===`
`&&(B+=1);break}let A=i.slice(b,B),j=(c=Ut(A))!=null?c:g.status,F=_t(A),_=Mt(A);m.push({uuid:p,title:F,status:j,tags:_,rawBlock:A,start:b,end:B})}o.set(g.status,{status:g.status,headingStart:g.start,headingEnd:g.end,sectionStart:l,sectionEnd:h,tasks:m})}return o}function D(i){let{autoStart:e,autoEnd:t}=ut(i),s=pt(i,e,t);return{content:i,autoStart:e,autoEnd:t,sections:s}}function gt(i){let{autoStart:e,autoEnd:t}=ut(i),s=pt(i,e,t),a=lt.filter(d=>!s.has(d));if(a.length===0)return i;let n=[];for(let d of lt)a.includes(d)&&n.push(`## ${d}`,"");let r=n.join(`
`);r.endsWith(`
`)||(r+=`
`);let o=i.slice(0,t),c=i.slice(t);return o.length>0&&!o.endsWith(`
`)&&(o+=`
`),o+r+c}function Lt(i,e){let t=i.split(`
`),s=!1,a=t.map(n=>n.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${e}`):n);if(!s)for(let n=0;n<a.length;n++){let r=a[n];if(r&&r.match(/^>\s*\[![^\]]+\]/)){a.splice(n+1,0,`> status:: ${e}`);break}}return a.join(`
`)}function ht(i,e,t){let s=i.sections.get(e);if(!s)throw new Error(`Missing status section: ${e}`);if(t){for(let n of s.tasks)if(n.uuid===t)return n.start}let a=s.tasks.at(-1);return a?a.end:s.sectionStart}function N(i,e,t,s){let a=gt(i),n=D(a),r=null,o=null;for(let[w,b]of n.sections.entries()){for(let x of b.tasks)if(x.uuid===e){r=x,o=w;break}if(r)break}if(!r||!o)throw new Error(`Task not found: ${e}`);let c=s===e?null:s,d=r.rawBlock;o!==t&&(d=Lt(d,t));let g=a.slice(0,r.start)+a.slice(r.end),u=D(g),l=ht(u,t,c),h=g.slice(0,l),k=g.slice(l),m=h.length>0&&!h.endsWith(`
`),v=!d.endsWith(`
`),p=(m?`
`:"")+d+(v?`
`:"");return g=h+p+k,g}function O(i,e,t,s){let a=gt(i),n=D(a),r=ht(n,e,t),o=a.slice(0,r),c=a.slice(r),d=o.length>0&&!o.endsWith(`
`),g=!s.endsWith(`
`),u=(d?`
`:"")+s+(g?`
`:"");return o+u+c}function J(i,e,t){let s=D(i),a=null;for(let o of s.sections.values()){for(let c of o.tasks)if(c.uuid===e){a=c;break}if(a)break}if(!a)throw new Error(`Task not found: ${e}`);let n=!t.endsWith(`
`),r=t+(n?`
`:"");return i.slice(0,a.start)+r+i.slice(a.end)}function ft(i,e){let t=D(i),s=null;for(let n of t.sections.values()){for(let r of n.tasks)if(r.uuid===e){s=r;break}if(s)break}if(!s)throw new Error(`Task not found: ${e}`);let a=i.slice(0,s.start)+i.slice(s.end);return{removed:s,next:a}}var mt=require("obsidian");function Rt(){return new Date().toISOString().replace(/[:.]/g,"-")}function Ct(i,e){var r;let s=((r=i.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${e}.md`),a=i.lastIndexOf("/Boards/");return a!==-1?`${i.slice(0,a)}/History/Boards/${s}`:`${i.split("/").slice(0,-1).join("/")}/History/${s}`}function kt(i,e){let t=(e||"").trim()||new Date().toISOString().slice(0,10),s=i.lastIndexOf("/Boards/");return s!==-1?`${i.slice(0,s)}/History/Logs/ai-tasks.${t}.jsonl`:`${i.split("/").slice(0,-1).join("/")}/History/ai-tasks.${t}.jsonl`}async function M(i,e){let t=e.split("/").filter(a=>a.length>0),s="";for(let a of t)s=s?`${s}/${a}`:a,i.getAbstractFileByPath(s)||await i.createFolder(s)}async function I(i,e,t){let s=await i.read(e),a=Rt(),n=Ct(e.path,a),r=n.split("/").slice(0,-1).join("/");await M(i,r),await i.create(n,s),await i.modify(e,t)}async function vt(i,e,t){let s=e.split("/").slice(0,-1).join("/");s&&await M(i,s);let a=JSON.stringify(t)+`
`,n=i.getAbstractFileByPath(e);if(n instanceof mt.TFile){let r=await i.read(n);await i.modify(n,r+a);return}await i.create(e,a)}async function S(i,e){let t=new Date().toISOString(),s=t.slice(0,10),a=kt(i.settings.boardPath,s);await vt(i.app.vault,a,{ts:t,...e})}function it(i){return i instanceof Error?i.message:String(i)}function xt(i,e,t){let s=it(e),a={error:e,...t!=null?t:{}};console.error(`[ai-tasks-board] ${i}: ${s}`,a)}function Nt(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Ot(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function jt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function Kt(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof U.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await M(i.app.vault,s),await i.app.vault.create(e,jt())}function Vt(i,e){return i.replace(/\/+$/g,"")+e}async function Ht(i,e){let t=Vt(i.settings.runtimeUrl,"/v1/board/propose"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function wt(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function qt(i){let e=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">"),t.push(...wt(i.body)),t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}function Wt(i,e){var d,g,u;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${e.uuid}\\s+END\\s*-->\\s*$`,"i"),a=t.findIndex(l=>s.test(l.trim()));if(a===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(l=>/^>\\s*\\[![^\\]]+\\]/.test(l));if(n!==-1){let l=(d=t[n])==null?void 0:d.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),h=(g=l==null?void 0:l[1])!=null?g:"[!todo]";t[n]=`> ${h} ${e.title}`}let r=t.findIndex(l=>/^>\\s*status::/i.test(l));if(r!==-1)t[r]=`> status:: ${e.status}`;else{let l=n!==-1?n+1:1;t.splice(l,0,`> status:: ${e.status}`),r=l}if(e.tags.length>0){let l=t.findIndex(h=>/^>\\s*tags::/i.test(h));l!==-1?t[l]=`> tags:: ${e.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${e.tags.join(", ")}`)}let o=new Date().toISOString(),c=[];return c.push(">"),c.push("> ---"),c.push(`> updated:: ${o}`),(u=e.instruction)!=null&&u.trim()&&c.push(`> instruction:: ${e.instruction.trim()}`),c.push(...wt(e.body)),t.splice(a,0,...c),t.join(`
`)+`
`}var V=class extends U.Modal{constructor(t,s){var a;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.value=this.draft,a.addEventListener("input",()=>{this.draft=a.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),c=o.createEl("button",{text:"Generate preview"}),d=o.createEl("button",{text:"Confirm & write"}),g=o.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let u=t.createDiv({cls:"ai-tasks-draft-preview"}),l=u.createDiv({cls:"ai-tasks-draft-side"});l.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=l.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let h=u.createDiv({cls:"ai-tasks-draft-side"});h.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=h.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,c.addEventListener("click",async()=>{await this.generate()}),d.addEventListener("click",async()=>{await this.apply()}),g.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,a,n,r,o,c,d,g,u,l,h,k,m,v,p,w,b;try{this.setStatus("Generating preview..."),this.boardFile=await Kt(this.plugin);let x=await this.plugin.app.vault.read(this.boardFile),f=R(x);f.changed&&await I(this.plugin.app.vault,this.boardFile,f.next),this.boardContent=f.next;let y=D(this.boardContent),B=Array.from(y.sections.values()).flatMap(E=>E.tasks.map(P=>({uuid:P.uuid,title:P.title,status:P.status,tags:P.tags}))),A={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:B,ai_model:this.plugin.getModelConfig(),tag_presets:this.plugin.getTagPresets()};await S(this.plugin,{type:"board.propose.request",mode:A.mode,draft_len:A.draft.length,instruction_len:((t=A.instruction)!=null?t:"").length,tasks_count:A.tasks.length,tag_presets_count:(a=(s=A.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(n=A.ai_model)==null?void 0:n.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});try{this.proposal=await Ht(this.plugin,A),await S(this.plugin,{type:"board.propose.response",engine:(o=this.proposal.engine)!=null?o:null,provider:(c=this.proposal.provider)!=null?c:null,thread_id:(d=this.proposal.thread_id)!=null?d:null,ai_fallback:(g=this.proposal.ai_fallback)!=null?g:null,action:this.proposal.action,target_uuid:(u=this.proposal.target_uuid)!=null?u:null,status:this.proposal.status,tags:this.proposal.tags,confidence:(l=this.proposal.confidence)!=null?l:null,reasoning:(h=this.proposal.reasoning)!=null?h:null})}catch(E){let P=E instanceof Error?E.message:String(E);throw await S(this.plugin,{type:"board.propose.error",error:P}),E}let j=this.proposal.action,F=Nt(this.proposal.status);if(j==="update"&&this.proposal.target_uuid){let E=this.proposal.target_uuid,P=null;for(let[K,At]of y.sections.entries()){for(let at of At.tasks)if(at.uuid===E){P={rawBlock:at.rawBlock,sectionStatus:K};break}if(P)break}if(!P)this.proposal.action="create";else{this.beforeBlock=P.rawBlock,this.afterBlock=Wt(this.beforeBlock,{uuid:E,title:this.proposal.title||"(Untitled)",status:F,tags:(k=this.proposal.tags)!=null?k:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let K=J(this.boardContent,E,this.afterBlock);P.sectionStatus!==F&&(K=N(K,E,F,null)),this.nextBoardContent=K}}if(this.proposal.action==="create"){let E=Ot();this.beforeBlock="",this.afterBlock=qt({uuid:E,title:this.proposal.title||"(Untitled)",status:F,tags:(m=this.proposal.tags)!=null?m:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let P=(b=(w=(p=(v=y.sections.get(F))==null?void 0:v.tasks)==null?void 0:p[0])==null?void 0:w.uuid)!=null?b:null;this.nextBoardContent=O(this.boardContent,F,P,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let _=[];this.proposal.engine&&_.push(`engine=${this.proposal.engine}`),this.proposal.thread_id&&_.push(`thread=${this.proposal.thread_id}`),this.proposal.ai_fallback&&_.push(`ai_fallback=${this.proposal.ai_fallback}`),this.proposal.reasoning&&_.push(this.proposal.reasoning),this.proposal.confidence!=null&&_.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(_.length?_.join(" | "):"Preview ready.")}catch(x){let f=it(x);xt("\u751F\u6210\u9884\u89C8\u5931\u8D25",x,{boardPath:this.plugin.settings.boardPath,mode:this.mode}),this.setStatus(`Failed: ${f}`),new U.Notice(`AI Tasks: \u9884\u89C8\u5931\u8D25\uFF1A${f}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}async apply(){var t,s,a,n,r,o;if(!this.boardFile){new U.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new U.Notice("AI Tasks: please generate preview first.");return}try{await I(this.plugin.app.vault,this.boardFile,this.nextBoardContent),await S(this.plugin,{type:"board.write",via:"draft_modal",action:(s=(t=this.proposal)==null?void 0:t.action)!=null?s:null,target_uuid:(n=(a=this.proposal)==null?void 0:a.target_uuid)!=null?n:null}),new U.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(c){let d=it(c);xt("\u5199\u5165\u770B\u677F\u5931\u8D25",c,{boardPath:(o=(r=this.boardFile)==null?void 0:r.path)!=null?o:this.plugin.settings.boardPath}),new U.Notice(`AI Tasks: \u5199\u5165\u5931\u8D25\uFF1A${d}\uFF08\u8BE6\u89C1\u63A7\u5236\u53F0\uFF09`)}}};var L=require("obsidian");var zt=["Unassigned","Todo","Doing","Review","Done"];function bt(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function Gt(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function Jt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}async function Yt(i){let e=i.settings.boardPath,t=i.app.vault.getAbstractFileByPath(e);if(t instanceof L.TFile)return t;let s=e.split("/").slice(0,-1).join("/");return s&&await M(i.app.vault,s),await i.app.vault.create(e,Jt())}function Qt(i,e){return i.replace(/\/+$/g,"")+e}async function Xt(i,e){let t=Qt(i.settings.runtimeUrl,"/v1/board/split"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let a=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${a}`)}return await s.json()}function Zt(i){return i.replace(/\r\n/g,`
`).split(`
`).map(t=>t.length?`> ${t}`:">")}function Tt(i){let t=(i!=null?i:[]).filter(n=>typeof n=="string").flatMap(n=>n.split(/[,，]/g)).map(n=>n.trim()).filter(n=>n.length>0),s=new Set,a=[];for(let n of t){let r=n.toLowerCase();s.has(r)||(s.add(r),a.push(n))}return a}function te(i){let e=new Date().toISOString(),t=(i.title||"").trim()||"(Untitled)",s=[];return s.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),s.push(`> [!todo] ${t}`),s.push(`> status:: ${i.status}`),i.tags.length>0&&s.push(`> tags:: ${i.tags.join(", ")}`),s.push(`> created:: ${e}`),i.sourcePath&&s.push(`> source:: [[${i.sourcePath}]]`),s.push(">"),i.body.trim().length>0?s.push(...Zt(i.body)):s.push(">"),s.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),s.join(`
`)+`
`}var C=class extends L.Modal{constructor(t,s){var a,n;super(t.app);this.instruction="";this.boardFile=null;this.tasks=[];this.proposalMeta=null;this.statusEl=null;this.listEl=null;this.plugin=t,this.sourcePath=(a=s.sourcePath)!=null?a:null,this.text=(n=s.selection)!=null?n:""}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-bulk-import-modal"),t.createEl("h2",{text:"AI Tasks: Import tasks"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Text to split into tasks (editable)"});let a=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});a.placeholder="Paste a task list here...",a.value=this.text,a.addEventListener("input",()=>{this.text=a.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. Use tags from presets; keep titles short; group by category...",r.value=this.instruction,r.addEventListener("input",()=>{this.instruction=r.value});let o=t.createDiv({cls:"ai-tasks-draft-buttons"}),c=o.createEl("button",{text:"Generate",cls:"mod-cta"}),d=o.createEl("button",{text:"Import to board"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""}),this.listEl=t.createDiv({cls:"ai-tasks-bulk-list"}),c.addEventListener("click",()=>void this.generate()),d.addEventListener("click",()=>void this.apply())}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}renderList(){var t;if(this.listEl){if(this.listEl.empty(),!this.tasks.length){this.listEl.createDiv({cls:"ai-tasks-board-empty",text:"(no tasks yet)"});return}for(let s of this.tasks){let a=this.listEl.createDiv({cls:"ai-tasks-bulk-row"}),n=(s.title||"").trim()||"(Untitled)",r=bt((t=s.status)!=null?t:"Unassigned"),o=Tt(s.tags);a.createDiv({cls:"ai-tasks-bulk-title",text:n}),a.createDiv({cls:"ai-tasks-bulk-meta",text:`${r}${o.length?" | "+o.join(", "):""}`})}}}async generate(){var t,s,a,n,r,o,c,d,g,u,l,h,k,m,v,p,w,b;try{this.setStatus("Generating..."),this.boardFile=await Yt(this.plugin);let x={text:this.text,instruction:this.instruction||null,tag_presets:this.plugin.getTagPresets(),max_tasks:60,ai_model:this.plugin.getModelConfig()};await S(this.plugin,{type:"board.split.request",text_len:x.text.length,instruction_len:((t=x.instruction)!=null?t:"").length,tag_presets_count:(a=(s=x.tag_presets)==null?void 0:s.length)!=null?a:0,model_provider:(r=(n=x.ai_model)==null?void 0:n.provider)!=null?r:null,runtime_url:this.plugin.settings.runtimeUrl});let f=await Xt(this.plugin,x);this.tasks=Array.isArray(f.tasks)?f.tasks.slice(0,Math.max(1,(o=x.max_tasks)!=null?o:60)):[],this.proposalMeta={engine:(c=f.engine)!=null?c:null,provider:(d=f.provider)!=null?d:null,thread_id:(g=f.thread_id)!=null?g:null,ai_fallback:(u=f.ai_fallback)!=null?u:null,reasoning:(l=f.reasoning)!=null?l:null,confidence:(h=f.confidence)!=null?h:null},await S(this.plugin,{type:"board.split.response",engine:(k=f.engine)!=null?k:null,provider:(m=f.provider)!=null?m:null,thread_id:(v=f.thread_id)!=null?v:null,ai_fallback:(p=f.ai_fallback)!=null?p:null,tasks_count:this.tasks.length,confidence:(w=f.confidence)!=null?w:null,reasoning:(b=f.reasoning)!=null?b:null}),this.renderList();let y=[];f.engine&&y.push(`engine=${f.engine}`),f.thread_id&&y.push(`thread=${f.thread_id}`),f.ai_fallback&&y.push(`ai_fallback=${f.ai_fallback}`),f.confidence!=null&&y.push(`confidence=${f.confidence.toFixed(2)}`),f.reasoning&&y.push(f.reasoning),this.setStatus(y.length?y.join(" | "):`Ready (${this.tasks.length} tasks).`)}catch(x){let f=x instanceof Error?x.message:String(x);this.setStatus(`Failed: ${f}`),new L.Notice(`AI Tasks: ${f}`)}}async apply(){var t,s,a,n,r,o,c,d,g,u,l,h,k;if(!this.boardFile){new L.Notice("AI Tasks: board file not ready.");return}if(!this.tasks.length){new L.Notice("AI Tasks: please generate tasks first.");return}try{let m=await this.plugin.app.vault.read(this.boardFile),v=R(m),p=v.next;v.changed&&(await I(this.plugin.app.vault,this.boardFile,v.next),await S(this.plugin,{type:"board.normalize_escaped_newlines"}));let w=D(p),b=new Map;for(let f of zt){let y=(n=(a=(s=(t=w.sections.get(f))==null?void 0:t.tasks)==null?void 0:s[0])==null?void 0:a.uuid)!=null?n:null;b.set(f,y)}let x=[];for(let f of this.tasks){let y=(f.title||"").trim().slice(0,120)||"(Untitled)",B=bt((r=f.status)!=null?r:"Unassigned"),A=Tt(f.tags),j=String((o=f.body)!=null?o:"").trim(),F=Gt(),_=te({uuid:F,title:y,status:B,tags:A,body:j,sourcePath:this.sourcePath});p=O(p,B,(c=b.get(B))!=null?c:null,_),x.push({uuid:F,title:y,status:B,tags:A})}await I(this.plugin.app.vault,this.boardFile,p),await S(this.plugin,{type:"board.bulk_import.write",via:"bulk_import_modal",tasks_count:x.length,engine:(g=(d=this.proposalMeta)==null?void 0:d.engine)!=null?g:null,provider:(l=(u=this.proposalMeta)==null?void 0:u.provider)!=null?l:null,thread_id:(k=(h=this.proposalMeta)==null?void 0:h.thread_id)!=null?k:null}),new L.Notice(`AI Tasks: imported ${x.length} tasks (history snapshot created).`),this.close()}catch(m){let v=m instanceof Error?m.message:String(m);new L.Notice(`AI Tasks: import failed: ${v}`)}}};var yt=require("obsidian");var W=require("obsidian");var H=require("obsidian");var ee=["Unassigned","Todo","Doing","Review","Done"];function se(){let i=globalThis.crypto;return i!=null&&i.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.floor(Math.random()*16);return(e==="x"?t:t&3|8).toString(16)})}function ie(i){let e=(i!=null?i:"").trim();return e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":"Unassigned"}function ne(i){let e=i.replace(/\r\n/g,`
`).split(`
`),t=e.findIndex(r=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(r.trim()));if(t===-1)return"";let s=e.findIndex(r=>r.trim()===">");return s===-1||s>=t?"":e.slice(s+1,t).map(r=>{let o=r.match(/^>\s?(.*)$/);return o?o[1]:r}).join(`
`).replace(/\n$/,"")}function ae(i,e){var m,v;let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(s===-1)throw new Error("Malformed task block (missing END marker).");let a=t.findIndex(p=>/^>\s*\[![^\]]+\]/.test(p));if(a!==-1){let p=(m=t[a])==null?void 0:m.match(/^>\s*(\[\![^\]]+\])\s*(.*)$/),w=(v=p==null?void 0:p[1])!=null?v:"[!todo]";t[a]=`> ${w} ${e.title||"(Untitled)"}`}let n=t.findIndex(p=>/^>\s*status::/i.test(p));if(n!==-1)t[n]=`> status:: ${e.status}`;else{let p=a!==-1?a+1:1;t.splice(p,0,`> status:: ${e.status}`),n=p}let r=t.findIndex(p=>/^>\s*tags::/i.test(p));if(e.tags.length>0){let p=`> tags:: ${e.tags.join(", ")}`;r!==-1?t[r]=p:t.splice(n+1,0,p)}else r!==-1&&t.splice(r,1);let o=t.findIndex(p=>/^>\s*updated::/i.test(p)),c=`> updated:: ${e.updatedAtIso}`;if(o!==-1)t[o]=c;else{let p=t.findIndex(b=>/^>\s*created::/i.test(b)),w=p!==-1?p+1:n+1;t.splice(w,0,c)}let d=t.findIndex(p=>p.trim()===">");(d===-1||d>=s)&&(d=s,t.splice(d,0,">"));let g=t.findIndex(p=>/^<!--\s*AI-TASKS:TASK\s+[0-9a-fA-F-]{8,}\s+END\s*-->/.test(p.trim()));if(g===-1)throw new Error("Malformed task block (missing END marker).");let u=[],l=(e.body||"").replace(/\r\n/g,`
`).split(`
`);for(let p of l)p.trim()===""?u.push(">"):u.push(`> ${p}`);let h=t.slice(0,d+1),k=t.slice(g);return h.concat(u,k).join(`
`)+`
`}function re(i){let e=new Date().toISOString(),t=[];t.push(`<!-- AI-TASKS:TASK ${i.uuid} BEGIN -->`),t.push(`> [!todo] ${i.title||"(Untitled)"}`),t.push(`> status:: ${i.status}`),i.tags.length>0&&t.push(`> tags:: ${i.tags.join(", ")}`),t.push(`> created:: ${e}`),t.push(`> updated:: ${e}`),i.sourcePath&&t.push(`> source:: [[${i.sourcePath}]]`),t.push(">");for(let s of(i.body||"").replace(/\r\n/g,`
`).split(`
`))s.trim()===""?t.push(">"):t.push(`> ${s}`);return t.push(`<!-- AI-TASKS:TASK ${i.uuid} END -->`),t.join(`
`)+`
`}var q=class extends H.Modal{constructor(e,t){var s,a,n,r,o;super(e.app),this.plugin=e,this.boardFile=t.boardFile,this.task=(s=t.task)!=null?s:null,this.defaultStatus=(r=t.defaultStatus)!=null?r:(n=(a=this.task)==null?void 0:a.status)!=null?n:"Unassigned",this.sourcePath=(o=t.sourcePath)!=null?o:null,this.onDidWrite=t.onDidWrite}onOpen(){var k,m,v,p,w,b;let{contentEl:e}=this;e.empty(),e.addClass("ai-tasks-edit-modal");let t=!!this.task;e.createEl("h2",{text:t?"Edit task":"New task"});let s=e.createDiv({cls:"ai-tasks-form-row"});s.createDiv({cls:"ai-tasks-form-label",text:"Title"});let a=s.createEl("input",{type:"text",cls:"ai-tasks-form-input"});a.value=(m=(k=this.task)==null?void 0:k.title)!=null?m:"";let n=e.createDiv({cls:"ai-tasks-form-row"});n.createDiv({cls:"ai-tasks-form-label",text:"Status"});let r=n.createEl("select",{cls:"ai-tasks-form-select"});for(let x of ee)r.add(new Option(x,x));r.value=(p=(v=this.task)==null?void 0:v.status)!=null?p:this.defaultStatus;let o=e.createDiv({cls:"ai-tasks-form-row"});o.createDiv({cls:"ai-tasks-form-label",text:"Tags (comma separated)"});let c=o.createEl("input",{type:"text",cls:"ai-tasks-form-input"});c.placeholder="e.g. release, bug, v1",c.value=((b=(w=this.task)==null?void 0:w.tags)!=null?b:[]).join(", ");let d=e.createDiv({cls:"ai-tasks-form-row"});d.createDiv({cls:"ai-tasks-form-label",text:"Body"});let g=d.createEl("textarea",{cls:"ai-tasks-form-textarea"});g.value=this.task?ne(this.task.rawBlock):"";let u=e.createDiv({cls:"ai-tasks-form-buttons"}),l=u.createEl("button",{text:"Save",cls:"mod-cta"});u.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),l.addEventListener("click",()=>{this.save({title:a.value,status:ie(r.value),tagsRaw:c.value,body:g.value})})}async save(e){var t,s,a,n,r,o;try{let c=e.tagsRaw.split(/[,，]/).map(m=>m.trim()).filter(m=>m.length>0),d=await this.plugin.app.vault.read(this.boardFile),u=R(d).next,l=D(u),h=new Date().toISOString(),k=u;if(this.task){let m=null,v=null;for(let[w,b]of l.sections.entries()){for(let x of b.tasks)if(x.uuid===this.task.uuid){m=x,v=w;break}if(m)break}if(!m||!v)throw new Error(`Task not found: ${this.task.uuid}`);let p=ae(m.rawBlock,{title:e.title||"(Untitled)",status:e.status,tags:c,body:(t=e.body)!=null?t:"",updatedAtIso:h});k=J(k,m.uuid,p),v!==e.status&&(k=N(k,m.uuid,e.status,null)),await I(this.plugin.app.vault,this.boardFile,k),await S(this.plugin,{type:"task.edit",uuid:m.uuid,from_status:v,status:e.status})}else{let m=se(),v=re({uuid:m,title:e.title||"(Untitled)",status:e.status,tags:c,body:(s=e.body)!=null?s:"",sourcePath:this.sourcePath}),p=(o=(r=(n=(a=l.sections.get(e.status))==null?void 0:a.tasks)==null?void 0:n[0])==null?void 0:r.uuid)!=null?o:null;k=O(k,e.status,p,v),await I(this.plugin.app.vault,this.boardFile,k),await S(this.plugin,{type:"task.create",uuid:m,status:e.status})}new H.Notice("AI Tasks: saved."),this.close(),this.onDidWrite()}catch(c){let d=c instanceof Error?c.message:String(c);new H.Notice(`AI Tasks: save failed: ${d}`)}}};var nt=["Unassigned","Todo","Doing","Review","Done"];function oe(){let i=new Date,e=String(i.getFullYear()),t=String(i.getMonth()+1).padStart(2,"0"),s=String(i.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}function le(i,e){let t=(i||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${e}.md`:`${e}.md`}function ce(i){return["---","schema: ai-tasks-archive/v1",`date: ${i}`,"---","",`# Archive ${i}`,"",""].join(`
`)}function de(i,e){let t=i.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(c=>/^>\s*archived::/i.test(c));if(s!==-1)return t[s]=`> archived:: ${e}`,t.join(`
`)+`
`;let a=t.findIndex(c=>/^>\s*created::/i.test(c)),n=t.findIndex(c=>/^>\s*status::/i.test(c)),r=t.findIndex(c=>/^>\s*\[![^\]]+\]/.test(c)),o=a!==-1?a+1:n!==-1?n+1:r!==-1?r+1:1;return t.splice(o,0,`> archived:: ${e}`),t.join(`
`)+`
`}function ue(i){return Array.from(new Set(i.flatMap(e=>e.tags))).sort()}function pe(i,e){let t=e.trim().toLowerCase();return t?i.title.toLowerCase().includes(t)||i.tags.some(s=>s.toLowerCase().includes(t)):!0}var Y=class{constructor(e,t){this.statusFilter="All";this.tagFilter=new Set;this.searchText="";this.plugin=e,this.boardFile=t}async readBoardNormalized(){let e=await this.plugin.app.vault.read(this.boardFile),t=R(e);return t.changed&&(await I(this.plugin.app.vault,this.boardFile,t.next),new W.Notice("AI Tasks: fixed escaped newlines in Board.md."),await S(this.plugin,{type:"board.normalize_escaped_newlines"})),t.next}shouldShowTask(e){if(this.statusFilter!=="All"&&e.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(e.tags.includes(t))return!0;return!1}return pe(e,this.searchText)}renderHeader(e,t){let s=e.createDiv({cls:"ai-tasks-board-header"});s.createDiv({cls:"ai-tasks-board-header-left"}).createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let n=s.createDiv({cls:"ai-tasks-board-controls"});n.createEl("button",{text:"Import",cls:"ai-tasks-board-import"}).addEventListener("click",()=>{new C(this.plugin,{selection:"",sourcePath:this.boardFile.path}).open()});let o=n.createEl("input",{type:"search",cls:"ai-tasks-board-search",attr:{placeholder:"Search title/tags..."}});o.value=this.searchText,o.addEventListener("input",async()=>{this.searchText=o.value,await this.render(e)});let c=n.createEl("select",{cls:"ai-tasks-board-select"});c.add(new Option("All statuses","All"));for(let l of nt)c.add(new Option(l,l));c.value=this.statusFilter,c.addEventListener("change",async()=>{let l=c.value;this.statusFilter=l==="All"?"All":l,await this.render(e)});let d=n.createDiv({cls:"ai-tasks-board-tags"}),g=d.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),u=d.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)u.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let l of t){let h=u.createEl("button",{cls:"ai-tasks-tag-chip",text:l});this.tagFilter.has(l)&&h.classList.add("is-active"),h.addEventListener("click",async k=>{k.preventDefault(),this.tagFilter.has(l)?this.tagFilter.delete(l):this.tagFilter.add(l),await this.render(e)})}g.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render(e)})}createCard(e,t,s,a,n){let r=e.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});r.draggable=!0,r.addEventListener("click",u=>{var l,h;(h=(l=u.target)==null?void 0:l.closest)!=null&&h.call(l,"select, button, a, input, textarea")||n(t)});let o=r.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let c=o.createDiv({cls:"ai-task-actions"}),d=c.createEl("select",{cls:"ai-task-status"});for(let u of nt)d.add(new Option(u,u));if(d.value=t.status,d.addEventListener("click",u=>u.stopPropagation()),d.addEventListener("change",async u=>{u.stopPropagation(),await s(t.uuid,d.value,null)}),c.createEl("button",{cls:"ai-task-edit",text:"Edit"}).addEventListener("click",u=>{u.stopPropagation(),n(t)}),t.status==="Done"&&c.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async l=>{l.stopPropagation(),await a(t.uuid)}),t.tags.length>0){let u=r.createDiv({cls:"ai-task-tags"});for(let l of t.tags)u.createSpan({cls:"ai-task-tag",text:l})}return r.addEventListener("dragstart",u=>{var l,h;(l=u.dataTransfer)==null||l.setData("application/x-ai-task-uuid",t.uuid),(h=u.dataTransfer)==null||h.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(e,t,s){e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("is-drop-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("is-drop-target")}),e.addEventListener("drop",async a=>{var d,g,u;a.preventDefault(),e.classList.remove("is-drop-target");let n=(d=a.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid");if(!n)return;let r=a.target,o=(g=r==null?void 0:r.closest)==null?void 0:g.call(r,".ai-task-card"),c=(u=o==null?void 0:o.getAttribute("data-uuid"))!=null?u:null;await s(n,t,c)})}async appendToArchive(e,t,s,a){let n=t.split("/").slice(0,-1).join("/");n&&await M(e,n);let r=e.getAbstractFileByPath(t);if(r instanceof W.TFile){let o=await e.read(r),c=o.endsWith(`
`)?`
`:`

`;await e.modify(r,o+c+s);return}await e.create(t,ce(a)+s)}async render(e){var u;e.empty(),e.addClass("ai-tasks-board-root"),e.addClass("ai-tasks-board-inline");let t;try{t=await this.readBoardNormalized()}catch(l){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:l instanceof Error?l.message:"Failed to read Board.md."});return}let s;try{s=D(t)}catch(l){e.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:l instanceof Error?l.message:"Failed to parse Board.md (unknown error)."});return}let a=Array.from(s.sections.values()).flatMap(l=>l.tasks),n=ue(a);this.renderHeader(e,n);let r=e.createDiv({cls:"ai-tasks-board-columns"}),o=async(l,h,k)=>{let m=await this.readBoardNormalized(),v=N(m,l,h,k);await I(this.plugin.app.vault,this.boardFile,v),await S(this.plugin,{type:"task.move",uuid:l,status:h,before_uuid:k}),await this.render(e)},c=async l=>{if(!window.confirm("Archive this task?"))return;let h=await this.readBoardNormalized(),{removed:k,next:m}=ft(h,l),v=oe(),p=le(this.plugin.settings.archiveFolderPath,v),w=de(k.rawBlock,new Date().toISOString());await this.appendToArchive(this.plugin.app.vault,p,w,v),await I(this.plugin.app.vault,this.boardFile,m),new W.Notice(`Archived task to ${p}`),await S(this.plugin,{type:"task.archive",uuid:l,archive_path:p}),await this.render(e)},d=l=>{new q(this.plugin,{boardFile:this.boardFile,task:l,onDidWrite:()=>{this.render(e)}}).open()},g=l=>{new q(this.plugin,{boardFile:this.boardFile,task:null,defaultStatus:l,onDidWrite:()=>{this.render(e)}}).open()};for(let l of nt){let h=r.createDiv({cls:"ai-tasks-column"}),k=h.createDiv({cls:"ai-tasks-column-head"});k.createDiv({cls:"ai-tasks-column-title",text:l}),k.createEl("button",{cls:"ai-tasks-column-add",text:"+ Add"}).addEventListener("click",()=>g(l));let v=h.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(v,l,o);let p=s.sections.get(l),w=((u=p==null?void 0:p.tasks)!=null?u:[]).filter(b=>this.shouldShowTask(b));for(let b of w)this.createCard(v,b,o,c,d)}}};var Q=class{constructor(e){this.overlays=new Map;this.refreshTimer=null;this.isRefreshing=!1;this.plugin=e}dispose(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=null;for(let e of Array.from(this.overlays.keys()))this.unmount(e);this.overlays.clear()}requestRefresh(){this.refreshTimer!=null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshAll()},200)}async updateAll(){let e=this.plugin.app.workspace.getLeavesOfType("markdown"),t=new Set;for(let s of e){let a=s.view;if(!(a instanceof yt.MarkdownView))continue;let n=a.file;if(!n){this.unmount(a);continue}let r=!!this.plugin.settings.renderBoardInNote,o=n.path===this.plugin.settings.boardPath;if(!r||!o){this.unmount(a);continue}t.add(a),await this.mount(a,n)}for(let s of Array.from(this.overlays.keys()))t.has(s)||this.unmount(s)}async mount(e,t){let s=this.overlays.get(e);if(s&&s.file.path===t.path)return;s&&this.unmount(e),e.contentEl.classList.add("ai-tasks-board-note-overlay-active");let a=e.contentEl.createDiv({cls:"ai-tasks-board-note-overlay-host"}),n=new Y(this.plugin,t);this.overlays.set(e,{view:e,file:t,host:a,panel:n});try{await n.render(a)}catch(r){}}unmount(e){let t=this.overlays.get(e);t&&(t.host.remove(),e.contentEl.classList.remove("ai-tasks-board-note-overlay-active"),this.overlays.delete(e))}async refreshAll(){if(!this.isRefreshing){this.isRefreshing=!0;try{for(let e of this.overlays.values())await e.panel.render(e.host)}finally{this.isRefreshing=!1}}}};function St(i,e){return i.replace(/\/+$/g,"")+e}function ge(i){var a,n;if(!i)return[];let e=[],t=/"([^"]*)"|'([^']*)'|(\S+)/g,s;for(;(s=t.exec(i))!==null;){let r=(n=(a=s[1])!=null?a:s[2])!=null?n:s[3];r&&e.push(r)}return e}function he(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`)}var Z=class extends $.Plugin{constructor(){super(...arguments);this.runtimeProcess=null;this.runtimePid=null;this.boardOverlay=null}getPluginDir(){var a;let t=this.app.vault.adapter,s=(a=t==null?void 0:t.getBasePath)==null?void 0:a.call(t);return s?(0,X.join)(s,this.app.vault.configDir,"plugins","ai-tasks-board"):null}async onload(){await this.loadSettings(),this.boardOverlay=new Q(this),this.addCommand({id:"open-ai-tasks-board-note",name:"AI Tasks: Open board note",callback:async()=>{let t=this.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);if(s instanceof $.TFile){await this.app.workspace.getLeaf().openFile(s);return}let a=t.split("/").slice(0,-1).join("/");a&&await M(this.app.vault,a);let n=await this.app.vault.create(t,he());await this.app.workspace.getLeaf().openFile(n)}}),this.addCommand({id:"bulk-import-ai-tasks",name:"AI Tasks: Import tasks (AI)",callback:()=>{var s,a;let t=(a=(s=this.app.workspace.getActiveFile())==null?void 0:s.path)!=null?a:null;new C(this,{selection:"",sourcePath:t}).open()}}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("layout-change",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.workspace.on("file-open",()=>this.requestOverlayUpdate())),this.registerEvent(this.app.vault.on("modify",t=>{var s;t.path===this.settings.boardPath&&((s=this.boardOverlay)==null||s.requestRefresh())})),this.requestOverlayUpdate(),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,a)=>{let n=s.getSelection();!n||n.trim().length===0||(t.addItem(r=>{r.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var o;new V(this,{mode:"create",selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var o;new V(this,{mode:"auto",selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}),t.addItem(r=>{r.setTitle("AI Tasks: Import selection as tasks (AI)").setIcon("list-plus").onClick(()=>{var o;new C(this,{selection:n,sourcePath:(o=a.file)==null?void 0:o.path}).open()})}))})),this.addSettingTab(new G(this.app,this))}onunload(){var t;(t=this.boardOverlay)==null||t.dispose(),this.boardOverlay=null}requestOverlayUpdate(){var t;(t=this.boardOverlay)==null||t.updateAll()}async loadSettings(){this.settings=Object.assign({},rt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getModelConfig(){var s,a,n;return this.settings.modelProvider!=="openai-compatible"?{provider:"codex-cli"}:{provider:"openai-compatible",model:((s=this.settings.modelName)==null?void 0:s.trim())||void 0,base_url:((a=this.settings.modelBaseUrl)==null?void 0:a.trim())||void 0,api_key:((n=this.settings.modelApiKey)==null?void 0:n.trim())||void 0,temperature:this.settings.modelTemperature,max_tokens:this.settings.modelMaxTokens,top_p:this.settings.modelTopP}}getTagPresets(){let s=(this.settings.tagPresets||"").replace(/\r\n/g,`
`).split(/\n|[,，]/g).map(r=>r.trim()).filter(r=>r.length>0),a=new Set,n=[];for(let r of s){let o=r.toLowerCase();a.has(o)||(a.add(o),n.push(r))}return n}async startRuntime(){var n,r,o;if(this.runtimeProcess&&this.runtimeProcess.exitCode===null){new $.Notice("AI Tasks: runtime already running.");return}let t=this.settings.runtimeCommand.trim();if(!t){new $.Notice("AI Tasks: runtime command is empty.");return}let s=ge(this.settings.runtimeArgs||""),a=this.settings.runtimeCwd.trim()||void 0;try{let c=(0,Bt.spawn)(t,s,{cwd:a,windowsHide:!0,shell:!1});this.runtimeProcess=c,this.runtimePid=(n=c.pid)!=null?n:null;let d=this.getPluginDir();if(d)try{(0,z.mkdirSync)(d,{recursive:!0});let g=(0,X.join)(d,"runtime.stdout.log"),u=(0,X.join)(d,"runtime.stderr.log");(r=c.stdout)==null||r.on("data",l=>{(0,z.appendFileSync)(g,l.toString())}),(o=c.stderr)==null||o.on("data",l=>{(0,z.appendFileSync)(u,l.toString())}),console.info(`[ai-tasks-board] runtime logs: ${g} / ${u}`)}catch(g){console.error("[ai-tasks-board] failed to init runtime log files",g)}c.on("exit",()=>{this.runtimeProcess=null,this.runtimePid=null}),c.on("error",g=>{new $.Notice(`AI Tasks: runtime start failed: ${g.message}`)}),new $.Notice(`AI Tasks: runtime starting${c.pid?` (pid ${c.pid})`:""}.`)}catch(c){let d=c instanceof Error?c.message:String(c);new $.Notice(`AI Tasks: runtime start failed: ${d}`)}}async stopRuntime(){let t=!1;await this.requestRuntimeShutdown()&&(t=!0),this.runtimeProcess&&this.runtimeProcess.exitCode===null&&(this.runtimeProcess.kill(),t=!0),t?new $.Notice("AI Tasks: runtime stop requested."):new $.Notice("AI Tasks: runtime not running.")}async refreshRuntimeStatus(){let t=await this.fetchRuntimeStatus(),s=t==null?void 0:t.ok,a=s?"online":"offline";if(s&&(t!=null&&t.pid)&&(a+=` (pid ${t.pid})`),s&&typeof(t==null?void 0:t.uptime_s)=="number"){let n=Math.floor(t.uptime_s/60);a+=` uptime ${n}m`}return this.runtimeProcess&&this.runtimeProcess.exitCode===null&&this.runtimePid&&(a+=` | local pid ${this.runtimePid}`),a}async fetchRuntimeStatus(){let t=St(this.settings.runtimeUrl,"/v1/runtime/status");try{let s=await fetch(t,{method:"GET"});return s.ok?await s.json():null}catch(s){return null}}async requestRuntimeShutdown(){let t=St(this.settings.runtimeUrl,"/v1/runtime/shutdown");try{return(await fetch(t,{method:"POST"})).ok}catch(s){return!1}}};
