/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var U=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var tt=Object.prototype.hasOwnProperty;var st=(e,a)=>{for(var t in a)U(e,t,{get:a[t],enumerable:!0})},et=(e,a,t,s)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of Z(a))!tt.call(e,i)&&i!==t&&U(e,i,{get:()=>a[i],enumerable:!(s=X(a,i))||s.enumerable});return e};var at=e=>et(U({},"__esModule",{value:!0}),e);var At={};st(At,{default:()=>L});module.exports=at(At);var z=require("obsidian");var b=require("obsidian"),C={boardPath:"Tasks/Boards/Board.md",archiveFolderPath:"Archive",runtimeUrl:"http://127.0.0.1:17890"},I=class extends b.PluginSettingTab{constructor(a,t){super(a,t),this.plugin=t}display(){let{containerEl:a}=this;a.empty(),new b.Setting(a).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(t=>{t.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async s=>{this.plugin.settings.boardPath=s.trim(),await this.plugin.saveSettings()})}),new b.Setting(a).setName("Archive folder path").setDesc("Folder for archived tasks (daily files), e.g. Archive.").addText(t=>{t.setPlaceholder("Archive").setValue(this.plugin.settings.archiveFolderPath).onChange(async s=>{this.plugin.settings.archiveFolderPath=s.trim(),await this.plugin.saveSettings()})}),new b.Setting(a).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(t=>{t.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async s=>{this.plugin.settings.runtimeUrl=s.trim(),await this.plugin.saveSettings()})})}};var S=require("obsidian");var N="<!-- AI-TASKS:BEGIN -->",O="<!-- AI-TASKS:END -->",j=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function K(e){let a=e.trim();return a==="Unassigned"?"Unassigned":a==="Todo"?"Todo":a==="Doing"?"Doing":a==="Review"?"Review":a==="Done"?"Done":null}function it(e){let a=e.split(`
`);for(let t of a){let s=t.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(s!=null&&s[1])return s[1].trim()}return"(Untitled)"}function nt(e){let a=e.split(`
`);for(let t of a){let s=t.match(/^>\s*tags::\s*(.+)\s*$/i);if(s!=null&&s[1])return s[1].split(/[,ï¼Œ]/).map(i=>i.trim()).filter(i=>i.length>0)}return[]}function rt(e){var t;let a=e.split(`
`);for(let s of a){let i=s.match(/^>\s*status::\s*(.+)\s*$/i);if(i!=null&&i[1])return(t=K(i[1]))!=null?t:null}return null}function ot(e){let a=e.indexOf(N),t=e.indexOf(O);if(a===-1||t===-1||t<=a)throw new Error(`Board is missing auto area markers (${N} / ${O}).`);return{autoStart:a+N.length,autoEnd:t}}function ct(e,a,t){var c;let i=e.slice(a,t).split(`
`),n=a,r=[];for(let l of i){let d=l.trimStart();if(d.startsWith("## ")){let u=d.slice(3).trim(),o=K(u);if(o){let g=n+l.indexOf("## "),f=n+l.length;r.push({status:o,start:g,end:f})}}n+=l.length+1}let p=new Map;for(let l=0;l<r.length;l++){let d=r[l];if(!d)continue;let u=r[l+1],o=d.end+1,g=u?u.start:t,f=e.slice(o,g),h=[];j.lastIndex=0;let v;for(;v=j.exec(f);){let m=v[1];if(!m)continue;let k=v.index,B=o+k,A=`<!-- AI-TASKS:TASK ${m} END -->`,D=f.indexOf(A,k);if(D===-1)continue;let T=o+D+A.length;for(;T<e.length&&e[T]===`
`;){T+=1,T<e.length&&e[T]===`
`&&(T+=1);break}let P=e.slice(B,T),Y=(c=rt(P))!=null?c:d.status,J=it(P),Q=nt(P);h.push({uuid:m,title:J,status:Y,tags:Q,rawBlock:P,start:B,end:T})}p.set(d.status,{status:d.status,headingStart:d.start,headingEnd:d.end,sectionStart:o,sectionEnd:g,tasks:h})}return p}function w(e){let{autoStart:a,autoEnd:t}=ot(e),s=ct(e,a,t);return{content:e,autoStart:a,autoEnd:t,sections:s}}function lt(e,a){let t=e.split(`
`),s=!1,i=t.map(n=>n.match(/^>\s*status::\s*(.+)\s*$/i)?(s=!0,`> status:: ${a}`):n);if(!s)for(let n=0;n<i.length;n++){let r=i[n];if(r&&r.match(/^>\s*\[![^\]]+\]/)){i.splice(n+1,0,`> status:: ${a}`);break}}return i.join(`
`)}function H(e,a,t){let s=e.sections.get(a);if(!s)throw new Error(`Missing status section: ${a}`);if(t){for(let n of s.tasks)if(n.uuid===t)return n.start}let i=s.tasks.at(-1);return i?i.end:s.sectionStart}function $(e,a,t,s){let i=w(e),n=null,r=null;for(let[m,k]of i.sections.entries()){for(let B of k.tasks)if(B.uuid===a){n=B,r=m;break}if(n)break}if(!n||!r)throw new Error(`Task not found: ${a}`);let p=s===a?null:s,c=n.rawBlock;r!==t&&(c=lt(c,t));let l=e.slice(0,n.start)+e.slice(n.end),d=w(l),u=H(d,t,p),o=l.slice(0,u),g=l.slice(u),f=o.length>0&&!o.endsWith(`
`),h=!c.endsWith(`
`),v=(f?`
`:"")+c+(h?`
`:"");return l=o+v+g,l}function V(e,a,t,s){let i=w(e),n=H(i,a,t),r=e.slice(0,n),p=e.slice(n),c=r.length>0&&!r.endsWith(`
`),l=!s.endsWith(`
`),d=(c?`
`:"")+s+(l?`
`:"");return r+d+p}function _(e,a,t){let s=w(e),i=null;for(let p of s.sections.values()){for(let c of p.tasks)if(c.uuid===a){i=c;break}if(i)break}if(!i)throw new Error(`Task not found: ${a}`);let n=!t.endsWith(`
`),r=t+(n?`
`:"");return e.slice(0,i.start)+r+e.slice(i.end)}function W(e,a){let t=w(e),s=null;for(let n of t.sections.values()){for(let r of n.tasks)if(r.uuid===a){s=r;break}if(s)break}if(!s)throw new Error(`Task not found: ${a}`);let i=e.slice(0,s.start)+e.slice(s.end);return{removed:s,next:i}}var y="ai-tasks-board-view",M=["Unassigned","Todo","Doing","Review","Done"];function dt(){return new Date().toISOString().replace(/[:.]/g,"-")}function ut(e,a){var r;let s=((r=e.split("/").pop())!=null?r:"Board.md").replace(/\.md$/i,`.${a}.md`),i=e.lastIndexOf("/Boards/");return i!==-1?`${e.slice(0,i)}/History/Boards/${s}`:`${e.split("/").slice(0,-1).join("/")}/History/${s}`}function pt(){let e=new Date,a=String(e.getFullYear()),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${s}`}function gt(e,a){let t=(e||"Archive").replace(/^\/+|\/+$/g,"");return t?`${t}/${a}.md`:`${a}.md`}function ht(e){return["---","schema: ai-tasks-archive/v1",`date: ${e}`,"---","",`# Archive ${e}`,"",""].join(`
`)}function ft(e,a){let t=e.replace(/\r\n/g,`
`).replace(/\n$/,"").split(`
`),s=t.findIndex(c=>/^>\s*archived::/i.test(c));if(s!==-1)return t[s]=`> archived:: ${a}`,t.join(`
`)+`
`;let i=t.findIndex(c=>/^>\s*created::/i.test(c)),n=t.findIndex(c=>/^>\s*status::/i.test(c)),r=t.findIndex(c=>/^>\s*\[![^\]]+\]/.test(c)),p=i!==-1?i+1:n!==-1?n+1:r!==-1?r+1:1;return t.splice(p,0,`> archived:: ${a}`),t.join(`
`)+`
`}async function R(e,a){let t=a.split("/").filter(i=>i.length>0),s="";for(let i of t)s=s?`${s}/${i}`:i,e.getAbstractFileByPath(s)||await e.createFolder(s)}var F=class extends S.ItemView{constructor(t,s){super(t);this.statusFilter="All";this.tagFilter=new Set;this.plugin=s}getViewType(){return y}getDisplayText(){return"AI Tasks Board"}getIcon(){return"layout-list"}async onOpen(){await this.render()}async onClose(){this.contentEl.empty()}async getBoardFile(){let t=this.plugin.settings.boardPath,s=this.app.vault.getAbstractFileByPath(t);return s instanceof S.TFile?s:null}async createDefaultBoard(){let t=this.plugin.settings.boardPath,s=t.split("/").slice(0,-1).join("/");s&&await R(this.app.vault,s);let i=["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`);await this.app.vault.create(t,i)}async snapshotBoard(t,s){let i=dt(),n=ut(t.path,i),r=n.split("/").slice(0,-1).join("/");await R(this.app.vault,r),await this.app.vault.create(n,s)}async writeBoard(t,s){let i=await this.app.vault.read(t);await this.snapshotBoard(t,i),await this.app.vault.modify(t,s)}renderHeader(t,s){let i=t.createDiv({cls:"ai-tasks-board-header"});i.createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let n=i.createDiv({cls:"ai-tasks-board-controls"}),r=n.createEl("select",{cls:"ai-tasks-board-select"});r.add(new Option("All statuses","All"));for(let d of M)r.add(new Option(d,d));r.value=this.statusFilter,r.addEventListener("change",async()=>{let d=r.value;this.statusFilter=d==="All"?"All":d,await this.render()});let p=n.createDiv({cls:"ai-tasks-board-tags"}),c=p.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),l=p.createDiv({cls:"ai-tasks-board-tags-list"});if(s.length===0)l.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let d of s){let u=l.createEl("label",{cls:"ai-tasks-tag"}),o=u.createEl("input",{type:"checkbox"});o.checked=this.tagFilter.has(d),o.addEventListener("change",async()=>{o.checked?this.tagFilter.add(d):this.tagFilter.delete(d),await this.render()}),u.createSpan({text:d})}c.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render()})}shouldShowTask(t){if(this.statusFilter!=="All"&&t.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let s of this.tagFilter)if(t.tags.includes(s))return!0;return!1}return!0}createCard(t,s,i,n){let r=t.createDiv({cls:"ai-task-card",attr:{"data-uuid":s.uuid}});r.draggable=!0;let p=r.createDiv({cls:"ai-task-card-top"});p.createDiv({cls:"ai-task-title",text:s.title});let c=p.createEl("select",{cls:"ai-task-status"});for(let l of M)c.add(new Option(l,l));if(c.value=s.status,c.addEventListener("change",async()=>{await i(s.uuid,c.value,null)}),s.status==="Done"&&p.createEl("button",{text:"Archive",cls:"ai-task-archive"}).addEventListener("click",async()=>{await n(s.uuid)}),s.tags.length>0){let l=r.createDiv({cls:"ai-task-tags"});for(let d of s.tags)l.createSpan({cls:"ai-task-tag",text:d})}return r.addEventListener("dragstart",l=>{var d,u,o;(d=l.dataTransfer)==null||d.setData("text/plain",s.uuid),(u=l.dataTransfer)==null||u.setData("application/x-ai-task-uuid",s.uuid),(o=l.dataTransfer)==null||o.setDragImage(r,8,8),r.classList.add("is-dragging")}),r.addEventListener("dragend",()=>{r.classList.remove("is-dragging")}),r}attachColumnDnD(t,s,i){t.addEventListener("dragover",n=>{n.preventDefault(),t.classList.add("is-drop-target")}),t.addEventListener("dragleave",()=>{t.classList.remove("is-drop-target")}),t.addEventListener("drop",async n=>{var d,u,o,g;n.preventDefault(),t.classList.remove("is-drop-target");let r=((d=n.dataTransfer)==null?void 0:d.getData("application/x-ai-task-uuid"))||((u=n.dataTransfer)==null?void 0:u.getData("text/plain"));if(!r)return;let p=n.target,c=(o=p==null?void 0:p.closest)==null?void 0:o.call(p,".ai-task-card"),l=(g=c==null?void 0:c.getAttribute("data-uuid"))!=null?g:null;await i(r,s,l)})}async render(){var d;let t=this.contentEl;t.empty(),t.addClass("ai-tasks-board-root");let s=await this.getBoardFile();if(!s){let u=t.createDiv({cls:"ai-tasks-board-empty"});u.createDiv({text:`Board file not found: ${this.plugin.settings.boardPath}`}),u.createEl("button",{text:"Create board"}).addEventListener("click",async()=>{await this.createDefaultBoard(),await this.render()});return}let i=await this.app.vault.read(s),n;try{n=w(i)}catch(u){t.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:u instanceof Error?u.message:"Failed to parse Board.md (unknown error)."});return}let r=Array.from(new Set(Array.from(n.sections.values()).flatMap(u=>u.tasks.flatMap(o=>o.tags)))).sort();this.renderHeader(t,r);let p=t.createDiv({cls:"ai-tasks-board-columns"}),c=async(u,o,g)=>{let f=await this.app.vault.read(s),h=$(f,u,o,g);await this.writeBoard(s,h),await this.render()},l=async u=>{if(!window.confirm("Archive this task?"))return;let o=await this.app.vault.read(s),{removed:g,next:f}=W(o,u),h=pt(),v=gt(this.plugin.settings.archiveFolderPath,h),m=ft(g.rawBlock,new Date().toISOString()),k=v.split("/").slice(0,-1).join("/");k&&await R(this.app.vault,k);let B=this.app.vault.getAbstractFileByPath(v);if(B instanceof S.TFile){let A=await this.app.vault.read(B),D=A.endsWith(`
`)?`
`:`

`;await this.app.vault.modify(B,A+D+m)}else await this.app.vault.create(v,ht(h)+m);await this.writeBoard(s,f),new S.Notice(`Archived task to ${v}`),await this.render()};for(let u of M){let o=p.createDiv({cls:"ai-tasks-column"});o.createDiv({cls:"ai-tasks-column-title",text:u});let g=o.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(g,u,c);let f=n.sections.get(u),h=((d=f==null?void 0:f.tasks)!=null?d:[]).filter(v=>this.shouldShowTask(v));for(let v of h)this.createCard(g,v,c,l)}}};var x=require("obsidian");function vt(e){let a=(e!=null?e:"").trim();return a==="Todo"?"Todo":a==="Doing"?"Doing":a==="Review"?"Review":a==="Done"?"Done":"Unassigned"}function mt(){let e=globalThis.crypto;return e!=null&&e.randomUUID?e.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let t=Math.floor(Math.random()*16);return(a==="x"?t:t&3|8).toString(16)})}function kt(){return new Date().toISOString().replace(/[:.]/g,"-")}function xt(e,a){var r;let s=((r=e.split("/").pop())!=null?r:"Board.md").replace(/\\.md$/i,`.${a}.md`),i=e.lastIndexOf("/Boards/");return i!==-1?`${e.slice(0,i)}/History/Boards/${s}`:`${e.split("/").slice(0,-1).join("/")}/History/${s}`}async function G(e,a){let t=a.split("/").filter(i=>i.length>0),s="";for(let i of t)s=s?`${s}/${i}`:i,e.getAbstractFileByPath(s)||await e.createFolder(s)}function Bt(){return["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join("\\n")}async function wt(e){let a=e.settings.boardPath,t=e.app.vault.getAbstractFileByPath(a);if(t instanceof x.TFile)return t;let s=a.split("/").slice(0,-1).join("/");return s&&await G(e.app.vault,s),await e.app.vault.create(a,Bt())}function Tt(e,a){return e.replace(/\/+$/g,"")+a}async function St(e,a){let t=Tt(e.settings.runtimeUrl,"/v1/board/propose"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){let i=await s.text().catch(()=>"");throw new Error(`Runtime error (${s.status}): ${i}`)}return await s.json()}function q(e){return e.replace(/\\r\\n/g,"\\n").split("\\n").map(t=>t.length?`> ${t}`:">")}function bt(e){let a=new Date().toISOString(),t=[];return t.push(`<!-- AI-TASKS:TASK ${e.uuid} BEGIN -->`),t.push(`> [!todo] ${e.title}`),t.push(`> status:: ${e.status}`),e.tags.length>0&&t.push(`> tags:: ${e.tags.join(", ")}`),t.push(`> created:: ${a}`),e.sourcePath&&t.push(`> source:: [[${e.sourcePath}]]`),t.push(">"),t.push(...q(e.body)),t.push(`<!-- AI-TASKS:TASK ${e.uuid} END -->`),t.join("\\n")+"\\n"}function yt(e,a){var l,d,u;let t=e.replace(/\\r\\n/g,"\\n").replace(/\\n$/,"").split("\\n"),s=new RegExp(`^<!--\\s*AI-TASKS:TASK\\s+${a.uuid}\\s+END\\s*-->\\s*$`,"i"),i=t.findIndex(o=>s.test(o.trim()));if(i===-1)throw new Error("Malformed task block (missing END marker).");let n=t.findIndex(o=>/^>\\s*\\[![^\\]]+\\]/.test(o));if(n!==-1){let o=(l=t[n])==null?void 0:l.match(/^>\\s*(\\[![^\\]]+\\])\\s*(.*)$/),g=(d=o==null?void 0:o[1])!=null?d:"[!todo]";t[n]=`> ${g} ${a.title}`}let r=t.findIndex(o=>/^>\\s*status::/i.test(o));if(r!==-1)t[r]=`> status:: ${a.status}`;else{let o=n!==-1?n+1:1;t.splice(o,0,`> status:: ${a.status}`),r=o}if(a.tags.length>0){let o=t.findIndex(g=>/^>\\s*tags::/i.test(g));o!==-1?t[o]=`> tags:: ${a.tags.join(", ")}`:t.splice(r+1,0,`> tags:: ${a.tags.join(", ")}`)}let p=new Date().toISOString(),c=[];return c.push(">"),c.push("> ---"),c.push(`> updated:: ${p}`),(u=a.instruction)!=null&&u.trim()&&c.push(`> instruction:: ${a.instruction.trim()}`),c.push(...q(a.body)),t.splice(i,0,...c),t.join("\\n")+"\\n"}var E=class extends x.Modal{constructor(t,s){var i;super(t.app);this.instruction="";this.boardFile=null;this.boardContent="";this.proposal=null;this.beforeBlock="";this.afterBlock="";this.nextBoardContent="";this.statusEl=null;this.beforeEl=null;this.afterEl=null;this.plugin=t,this.mode=s.mode,this.sourcePath=(i=s.sourcePath)!=null?i:null,this.draft=s.selection}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("ai-tasks-draft-modal"),t.createEl("h2",{text:this.mode==="create"?"AI Tasks: Add to board":"AI Tasks: Update board"});let s=t.createDiv({cls:"ai-tasks-draft-box"});s.createDiv({cls:"ai-tasks-draft-label",text:"Draft (editable)"});let i=s.createEl("textarea",{cls:"ai-tasks-draft-textarea"});i.value=this.draft,i.addEventListener("input",()=>{this.draft=i.value});let n=t.createDiv({cls:"ai-tasks-instr-box"});n.createDiv({cls:"ai-tasks-draft-label",text:"Extra instruction (optional)"});let r=n.createEl("textarea",{cls:"ai-tasks-draft-textarea"});r.placeholder="e.g. set status=Todo, add tag=release, update existing task if it matches...",r.addEventListener("input",()=>{this.instruction=r.value});let p=t.createDiv({cls:"ai-tasks-draft-buttons"}),c=p.createEl("button",{text:"Generate preview"}),l=p.createEl("button",{text:"Confirm & write"}),d=p.createEl("button",{text:"Cancel"});this.statusEl=t.createDiv({cls:"ai-tasks-draft-status",text:""});let u=t.createDiv({cls:"ai-tasks-draft-preview"}),o=u.createDiv({cls:"ai-tasks-draft-side"});o.createDiv({cls:"ai-tasks-draft-label",text:"Before"}),this.beforeEl=o.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.beforeEl.readOnly=!0;let g=u.createDiv({cls:"ai-tasks-draft-side"});g.createDiv({cls:"ai-tasks-draft-label",text:"After"}),this.afterEl=g.createEl("textarea",{cls:"ai-tasks-draft-preview-textarea"}),this.afterEl.readOnly=!0,c.addEventListener("click",async()=>{await this.generate()}),l.addEventListener("click",async()=>{await this.apply()}),d.addEventListener("click",()=>{this.close()}),this.generate()}setStatus(t){this.statusEl&&(this.statusEl.textContent=t)}async generate(){var t,s,i,n,r,p;try{this.setStatus("Generating preview..."),this.boardFile=await wt(this.plugin),this.boardContent=await this.plugin.app.vault.read(this.boardFile);let c=w(this.boardContent),l=Array.from(c.sections.values()).flatMap(f=>f.tasks.map(h=>({uuid:h.uuid,title:h.title,status:h.status,tags:h.tags}))),d={mode:this.mode,draft:this.draft,instruction:this.instruction||null,tasks:l};this.proposal=await St(this.plugin,d);let u=this.proposal.action,o=vt(this.proposal.status);if(u==="update"&&this.proposal.target_uuid){let f=this.proposal.target_uuid,h=null;for(let[v,m]of c.sections.entries()){for(let k of m.tasks)if(k.uuid===f){h={rawBlock:k.rawBlock,sectionStatus:v};break}if(h)break}if(!h)this.proposal.action="create";else{this.beforeBlock=h.rawBlock,this.afterBlock=yt(this.beforeBlock,{uuid:f,title:this.proposal.title||"(Untitled)",status:o,tags:(t=this.proposal.tags)!=null?t:[],body:this.proposal.body||this.draft,instruction:this.instruction||null});let v=_(this.boardContent,f,this.afterBlock);h.sectionStatus!==o&&(v=$(v,f,o,null)),this.nextBoardContent=v}}if(this.proposal.action==="create"){let f=mt();this.beforeBlock="",this.afterBlock=bt({uuid:f,title:this.proposal.title||"(Untitled)",status:o,tags:(s=this.proposal.tags)!=null?s:[],body:this.proposal.body||this.draft,sourcePath:this.sourcePath});let h=(p=(r=(n=(i=c.sections.get(o))==null?void 0:i.tasks)==null?void 0:n[0])==null?void 0:r.uuid)!=null?p:null;this.nextBoardContent=V(this.boardContent,o,h,this.afterBlock)}this.beforeEl&&(this.beforeEl.value=this.beforeBlock),this.afterEl&&(this.afterEl.value=this.afterBlock);let g=[];this.proposal.reasoning&&g.push(this.proposal.reasoning),this.proposal.confidence!=null&&g.push(`confidence=${this.proposal.confidence.toFixed(2)}`),this.setStatus(g.length?g.join(" | "):"Preview ready.")}catch(c){let l=c instanceof Error?c.message:String(c);this.setStatus(`Failed: ${l}`),new x.Notice(`AI Tasks: ${l}`)}}async apply(){if(!this.boardFile){new x.Notice("AI Tasks: board file not ready.");return}if(!this.nextBoardContent){new x.Notice("AI Tasks: please generate preview first.");return}try{let t=await this.plugin.app.vault.read(this.boardFile),s=kt(),i=xt(this.boardFile.path,s),n=i.split("/").slice(0,-1).join("/");await G(this.plugin.app.vault,n),await this.plugin.app.vault.create(i,t),await this.plugin.app.vault.modify(this.boardFile,this.nextBoardContent),new x.Notice("AI Tasks: wrote board update (history snapshot created)."),this.close()}catch(t){let s=t instanceof Error?t.message:String(t);new x.Notice(`AI Tasks: write failed: ${s}`)}}};var L=class extends z.Plugin{async onload(){await this.loadSettings(),this.registerView(y,a=>new F(a,this)),this.addCommand({id:"open-ai-tasks-board",name:"Open AI Tasks board",callback:async()=>{await this.activateView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(a,t,s)=>{let i=t.getSelection();!i||i.trim().length===0||(a.addItem(n=>{n.setTitle("AI Tasks: Add to board").setIcon("plus").onClick(()=>{var r;new E(this,{mode:"create",selection:i,sourcePath:(r=s.file)==null?void 0:r.path}).open()})}),a.addItem(n=>{n.setTitle("AI Tasks: Update board (AI)").setIcon("wand-2").onClick(()=>{var r;new E(this,{mode:"auto",selection:i,sourcePath:(r=s.file)==null?void 0:r.path}).open()})}))})),this.addSettingTab(new I(this.app,this))}onunload(){this.app.workspace.detachLeavesOfType(y)}async activateView(){var i;let t=this.app.workspace.getLeavesOfType(y)[0];if(t){this.app.workspace.revealLeaf(t);return}let s=(i=this.app.workspace.getRightLeaf(!1))!=null?i:this.app.workspace.getLeaf();await s.setViewState({type:y,active:!0}),this.app.workspace.revealLeaf(s)}async loadSettings(){this.settings=Object.assign({},C,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
