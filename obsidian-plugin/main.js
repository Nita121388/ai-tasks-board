/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var P=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var z=(n,e)=>{for(var s in e)P(n,s,{get:e[s],enumerable:!0})},Y=(n,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of G(e))!j.call(n,a)&&a!==s&&P(n,a,{get:()=>e[a],enumerable:!(t=W(e,a))||t.enumerable});return n};var q=n=>Y(P({},"__esModule",{value:!0}),n);var nt={};z(nt,{default:()=>E});module.exports=q(nt);var V=require("obsidian");var S=require("obsidian"),U={boardPath:"Tasks/Boards/Board.md",runtimeUrl:"http://127.0.0.1:17890"},b=class extends S.PluginSettingTab{constructor(e,s){super(e,s),this.plugin=s}display(){let{containerEl:e}=this;e.empty(),new S.Setting(e).setName("Board file path").setDesc("Path to Board.md inside your vault (e.g. Tasks/Boards/Board.md).").addText(s=>{s.setPlaceholder("Tasks/Boards/Board.md").setValue(this.plugin.settings.boardPath).onChange(async t=>{this.plugin.settings.boardPath=t.trim(),await this.plugin.saveSettings()})}),new S.Setting(e).setName("Runtime URL").setDesc("Local runtime base URL (Agno + FastAPI).").addText(s=>{s.setPlaceholder("http://127.0.0.1:17890").setValue(this.plugin.settings.runtimeUrl).onChange(async t=>{this.plugin.settings.runtimeUrl=t.trim(),await this.plugin.saveSettings()})})}};var D=require("obsidian");var L="<!-- AI-TASKS:BEGIN -->",N="<!-- AI-TASKS:END -->",O=/<!--\s*AI-TASKS:TASK\s+([0-9a-fA-F-]{8,})\s+BEGIN\s*-->/g;function R(n){let e=n.trim();return e==="Unassigned"?"Unassigned":e==="Todo"?"Todo":e==="Doing"?"Doing":e==="Review"?"Review":e==="Done"?"Done":null}function J(n){let e=n.split(`
`);for(let s of e){let t=s.match(/^>\s*\[![^\]]+\]\s*(.+)\s*$/);if(t!=null&&t[1])return t[1].trim()}return"(Untitled)"}function Q(n){let e=n.split(`
`);for(let s of e){let t=s.match(/^>\s*tags::\s*(.+)\s*$/i);if(t!=null&&t[1])return t[1].split(/[,ï¼Œ]/).map(a=>a.trim()).filter(a=>a.length>0)}return[]}function X(n){var s;let e=n.split(`
`);for(let t of e){let a=t.match(/^>\s*status::\s*(.+)\s*$/i);if(a!=null&&a[1])return(s=R(a[1]))!=null?s:null}return null}function Z(n){let e=n.indexOf(L),s=n.indexOf(N);if(e===-1||s===-1||s<=e)throw new Error(`Board is missing auto area markers (${L} / ${N}).`);return{autoStart:e+L.length,autoEnd:s}}function tt(n,e,s){var l;let a=n.slice(e,s).split(`
`),i=e,o=[];for(let c of a){let r=c.trimStart();if(r.startsWith("## ")){let d=r.slice(3).trim(),u=R(d);if(u){let p=i+c.indexOf("## "),f=i+c.length;o.push({status:u,start:p,end:f})}}i+=c.length+1}let g=new Map;for(let c=0;c<o.length;c++){let r=o[c];if(!r)continue;let d=o[c+1],u=r.end+1,p=d?d.start:s,f=n.slice(u,p),h=[];O.lastIndex=0;let k;for(;k=O.exec(f);){let T=k[1];if(!T)continue;let w=k.index,B=u+w,I=`<!-- AI-TASKS:TASK ${T} END -->`,$=f.indexOf(I,w);if($===-1)continue;let m=u+$+I.length;for(;m<n.length&&n[m]===`
`;){m+=1,m<n.length&&n[m]===`
`&&(m+=1);break}let A=n.slice(B,m),H=(l=X(A))!=null?l:r.status,K=J(A),C=Q(A);h.push({uuid:T,title:K,status:H,tags:C,rawBlock:A,start:B,end:m})}g.set(r.status,{status:r.status,headingStart:r.start,headingEnd:r.end,sectionStart:u,sectionEnd:p,tasks:h})}return g}function x(n){let{autoStart:e,autoEnd:s}=Z(n),t=tt(n,e,s);return{content:n,autoStart:e,autoEnd:s,sections:t}}function st(n,e){let s=n.split(`
`),t=!1,a=s.map(i=>i.match(/^>\s*status::\s*(.+)\s*$/i)?(t=!0,`> status:: ${e}`):i);if(!t)for(let i=0;i<a.length;i++){let o=a[i];if(o&&o.match(/^>\s*\[![^\]]+\]/)){a.splice(i+1,0,`> status:: ${e}`);break}}return a.join(`
`)}function et(n,e,s){let t=n.sections.get(e);if(!t)throw new Error(`Missing status section: ${e}`);if(s){for(let i of t.tasks)if(i.uuid===s)return i.start}let a=t.tasks.at(-1);return a?a.end:t.sectionStart}function M(n,e,s,t){let a=x(n),i=null,o=null;for(let[T,w]of a.sections.entries()){for(let B of w.tasks)if(B.uuid===e){i=B,o=T;break}if(i)break}if(!i||!o)throw new Error(`Task not found: ${e}`);let g=t===e?null:t,l=i.rawBlock;o!==s&&(l=st(l,s));let c=n.slice(0,i.start)+n.slice(i.end),r=x(c),d=et(r,s,g),u=c.slice(0,d),p=c.slice(d),f=u.length>0&&!u.endsWith(`
`),h=!l.endsWith(`
`),k=(f?`
`:"")+l+(h?`
`:"");return c=u+k+p,c}var v="ai-tasks-board-view",F=["Unassigned","Todo","Doing","Review","Done"];function at(){return new Date().toISOString().replace(/[:.]/g,"-")}function it(n,e){var o;let t=((o=n.split("/").pop())!=null?o:"Board.md").replace(/\.md$/i,`.${e}.md`),a=n.lastIndexOf("/Boards/");return a!==-1?`${n.slice(0,a)}/History/Boards/${t}`:`${n.split("/").slice(0,-1).join("/")}/History/${t}`}async function _(n,e){let s=e.split("/").filter(a=>a.length>0),t="";for(let a of s)t=t?`${t}/${a}`:a,n.getAbstractFileByPath(t)||await n.createFolder(t)}var y=class extends D.ItemView{constructor(s,t){super(s);this.statusFilter="All";this.tagFilter=new Set;this.plugin=t}getViewType(){return v}getDisplayText(){return"AI Tasks Board"}getIcon(){return"layout-list"}async onOpen(){await this.render()}async onClose(){this.contentEl.empty()}async getBoardFile(){let s=this.plugin.settings.boardPath,t=this.app.vault.getAbstractFileByPath(s);return t instanceof D.TFile?t:null}async createDefaultBoard(){let s=this.plugin.settings.boardPath,t=s.split("/").slice(0,-1).join("/");t&&await _(this.app.vault,t);let a=["---","schema: ai-tasks-board/v1","board_id: ai-tasks-board","statuses: [Unassigned, Todo, Doing, Review, Done]","---","","# AI Tasks Board","","<!-- AI-TASKS:BEGIN -->","## Unassigned","","## Todo","","## Doing","","## Review","","## Done","<!-- AI-TASKS:END -->",""].join(`
`);await this.app.vault.create(s,a)}async snapshotBoard(s,t){let a=at(),i=it(s.path,a),o=i.split("/").slice(0,-1).join("/");await _(this.app.vault,o),await this.app.vault.create(i,t)}async writeBoard(s,t){let a=await this.app.vault.read(s);await this.snapshotBoard(s,a),await this.app.vault.modify(s,t)}renderHeader(s,t){let a=s.createDiv({cls:"ai-tasks-board-header"});a.createDiv({cls:"ai-tasks-board-title",text:"AI Tasks Board"});let i=a.createDiv({cls:"ai-tasks-board-controls"}),o=i.createEl("select",{cls:"ai-tasks-board-select"});o.add(new Option("All statuses","All"));for(let r of F)o.add(new Option(r,r));o.value=this.statusFilter,o.addEventListener("change",async()=>{let r=o.value;this.statusFilter=r==="All"?"All":r,await this.render()});let g=i.createDiv({cls:"ai-tasks-board-tags"}),l=g.createDiv({cls:"ai-tasks-board-tags-title",text:"Tags"}),c=g.createDiv({cls:"ai-tasks-board-tags-list"});if(t.length===0)c.createDiv({cls:"ai-tasks-board-tags-empty",text:"(none)"});else for(let r of t){let d=c.createEl("label",{cls:"ai-tasks-tag"}),u=d.createEl("input",{type:"checkbox"});u.checked=this.tagFilter.has(r),u.addEventListener("change",async()=>{u.checked?this.tagFilter.add(r):this.tagFilter.delete(r),await this.render()}),d.createSpan({text:r})}l.addEventListener("click",async()=>{this.tagFilter.clear(),await this.render()})}shouldShowTask(s){if(this.statusFilter!=="All"&&s.status!==this.statusFilter)return!1;if(this.tagFilter.size>0){for(let t of this.tagFilter)if(s.tags.includes(t))return!0;return!1}return!0}createCard(s,t,a){let i=s.createDiv({cls:"ai-task-card",attr:{"data-uuid":t.uuid}});i.draggable=!0;let o=i.createDiv({cls:"ai-task-card-top"});o.createDiv({cls:"ai-task-title",text:t.title});let g=o.createEl("select",{cls:"ai-task-status"});for(let l of F)g.add(new Option(l,l));if(g.value=t.status,g.addEventListener("change",async()=>{await a(t.uuid,g.value,null)}),t.tags.length>0){let l=i.createDiv({cls:"ai-task-tags"});for(let c of t.tags)l.createSpan({cls:"ai-task-tag",text:c})}return i.addEventListener("dragstart",l=>{var c,r,d;(c=l.dataTransfer)==null||c.setData("text/plain",t.uuid),(r=l.dataTransfer)==null||r.setData("application/x-ai-task-uuid",t.uuid),(d=l.dataTransfer)==null||d.setDragImage(i,8,8),i.classList.add("is-dragging")}),i.addEventListener("dragend",()=>{i.classList.remove("is-dragging")}),i}attachColumnDnD(s,t,a){s.addEventListener("dragover",i=>{i.preventDefault(),s.classList.add("is-drop-target")}),s.addEventListener("dragleave",()=>{s.classList.remove("is-drop-target")}),s.addEventListener("drop",async i=>{var r,d,u,p;i.preventDefault(),s.classList.remove("is-drop-target");let o=((r=i.dataTransfer)==null?void 0:r.getData("application/x-ai-task-uuid"))||((d=i.dataTransfer)==null?void 0:d.getData("text/plain"));if(!o)return;let g=i.target,l=(u=g==null?void 0:g.closest)==null?void 0:u.call(g,".ai-task-card"),c=(p=l==null?void 0:l.getAttribute("data-uuid"))!=null?p:null;await a(o,t,c)})}async render(){var c;let s=this.contentEl;s.empty(),s.addClass("ai-tasks-board-root");let t=await this.getBoardFile();if(!t){let r=s.createDiv({cls:"ai-tasks-board-empty"});r.createDiv({text:`Board file not found: ${this.plugin.settings.boardPath}`}),r.createEl("button",{text:"Create board"}).addEventListener("click",async()=>{await this.createDefaultBoard(),await this.render()});return}let a=await this.app.vault.read(t),i;try{i=x(a)}catch(r){s.createDiv({cls:"ai-tasks-board-error"}).createDiv({text:r instanceof Error?r.message:"Failed to parse Board.md (unknown error)."});return}let o=Array.from(new Set(Array.from(i.sections.values()).flatMap(r=>r.tasks.flatMap(d=>d.tags)))).sort();this.renderHeader(s,o);let g=s.createDiv({cls:"ai-tasks-board-columns"}),l=async(r,d,u)=>{let p=await this.app.vault.read(t),f=M(p,r,d,u);await this.writeBoard(t,f),await this.render()};for(let r of F){let d=g.createDiv({cls:"ai-tasks-column"});d.createDiv({cls:"ai-tasks-column-title",text:r});let u=d.createDiv({cls:"ai-tasks-column-list"});this.attachColumnDnD(u,r,l);let p=i.sections.get(r),f=((c=p==null?void 0:p.tasks)!=null?c:[]).filter(h=>this.shouldShowTask(h));for(let h of f)this.createCard(u,h,l)}}};var E=class extends V.Plugin{async onload(){await this.loadSettings(),this.registerView(v,e=>new y(e,this)),this.addCommand({id:"open-ai-tasks-board",name:"Open AI Tasks board",callback:async()=>{await this.activateView()}}),this.addSettingTab(new b(this.app,this))}onunload(){this.app.workspace.detachLeavesOfType(v)}async activateView(){var a;let s=this.app.workspace.getLeavesOfType(v)[0];if(s){this.app.workspace.revealLeaf(s);return}let t=(a=this.app.workspace.getRightLeaf(!1))!=null?a:this.app.workspace.getLeaf();await t.setViewState({type:v,active:!0}),this.app.workspace.revealLeaf(t)}async loadSettings(){this.settings=Object.assign({},U,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
